var am=Object.defineProperty;var sm=(n,e,t)=>e in n?am(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Gt=(n,e,t)=>sm(n,typeof e!="symbol"?e+"":e,t);import{r as z,a as im,g as lc,R as om}from"./react-CIP6LD3P.js";import{o as cm}from"./vendor-BXWtuYvb.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();var cd={exports:{}},ti={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var um=z,lm=Symbol.for("react.element"),dm=Symbol.for("react.fragment"),hm=Object.prototype.hasOwnProperty,fm=um.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,mm={key:!0,ref:!0,__self:!0,__source:!0};function ud(n,e,t){var r,a={},s=null,i=null;t!==void 0&&(s=""+t),e.key!==void 0&&(s=""+e.key),e.ref!==void 0&&(i=e.ref);for(r in e)hm.call(e,r)&&!mm.hasOwnProperty(r)&&(a[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps,e)a[r]===void 0&&(a[r]=e[r]);return{$$typeof:lm,type:n,key:s,ref:i,props:a,_owner:fm.current}}ti.Fragment=dm;ti.jsx=ud;ti.jsxs=ud;cd.exports=ti;var y=cd.exports,To={},mu=im;To.createRoot=mu.createRoot,To.hydrateRoot=mu.hydrateRoot;function pm(){return y.jsx("header",{className:"bg-white shadow-sm",children:y.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center",children:[y.jsxs("svg",{className:"h-8 w-8 text-primary-600",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[y.jsx("path",{d:"M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z",fill:"currentColor"}),y.jsx("path",{d:"M19.4 13C19.2669 13.6834 19.0224 14.3334 18.6872 14.9217C18.3519 15.5101 17.9308 16.0292 17.4413 16.4533C16.9517 16.8775 16.4012 17.2006 15.8159 17.4153C15.2306 17.6301 14.619 17.7329 14 17.7226C13.3866 17.7329 12.7779 17.6301 12.1953 17.4153C11.6126 17.2006 11.0644 16.8775 10.5764 16.4533C10.0884 16.0292 9.66825 15.5101 9.33251 14.9217C8.99678 14.3334 8.75235 13.6834 8.61914 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),y.jsx("path",{d:"M3 10.5V13.5C3 17.6421 6.35786 21 10.5 21H13.5C17.6421 21 21 17.6421 21 13.5V10.5C21 6.35786 17.6421 3 13.5 3H10.5C6.35786 3 3 6.35786 3 10.5Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),y.jsx("h1",{className:"ml-2 text-xl font-bold text-gray-900",children:"ClearVoiceLingo"})]}),y.jsx("a",{href:"https://github.com/aw09/clearvoicelingo",target:"_blank",rel:"noopener noreferrer",className:"text-gray-500 hover:text-gray-700",children:y.jsx("svg",{className:"h-6 w-6",fill:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:y.jsx("path",{fillRule:"evenodd",d:"M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z",clipRule:"evenodd"})})})]})})}function gm(){return y.jsx("footer",{className:"bg-white border-t border-gray-200 py-4",children:y.jsxs("div",{className:"container mx-auto px-4",children:[y.jsxs("p",{className:"text-center text-sm text-gray-500",children:["Â© ",new Date().getFullYear()," ClearVoiceLingo. All rights reserved."]}),y.jsx("p",{className:"text-center text-xs text-gray-400 mt-1",children:"Built with Web Speech API and IndexedDB"})]})})}var oe;(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{const s={};for(const i of a)s[i]=i;return s},n.getValidEnumValues=a=>{const s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(const o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{const s=[];for(const i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(const i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(oe||(oe={}));var Io;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Io||(Io={}));const j=oe.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),qt=n=>{switch(typeof n){case"undefined":return j.undefined;case"string":return j.string;case"number":return isNaN(n)?j.nan:j.number;case"boolean":return j.boolean;case"function":return j.function;case"bigint":return j.bigint;case"symbol":return j.symbol;case"object":return Array.isArray(n)?j.array:n===null?j.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?j.promise:typeof Map<"u"&&n instanceof Map?j.map:typeof Set<"u"&&n instanceof Set?j.set:typeof Date<"u"&&n instanceof Date?j.date:j.object;default:return j.unknown}},k=oe.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),ym=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:");class at extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(const i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,c=0;for(;c<i.path.length;){const u=i.path[c];c===i.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(t(i))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return a(this),r}static assert(e){if(!(e instanceof at))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,oe.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}at.create=n=>new at(n);const ln=(n,e)=>{let t;switch(n.code){case k.invalid_type:n.received===j.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case k.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,oe.jsonStringifyReplacer)}`;break;case k.unrecognized_keys:t=`Unrecognized key(s) in object: ${oe.joinValues(n.keys,", ")}`;break;case k.invalid_union:t="Invalid input";break;case k.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${oe.joinValues(n.options)}`;break;case k.invalid_enum_value:t=`Invalid enum value. Expected ${oe.joinValues(n.options)}, received '${n.received}'`;break;case k.invalid_arguments:t="Invalid function arguments";break;case k.invalid_return_type:t="Invalid function return type";break;case k.invalid_date:t="Invalid date";break;case k.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:oe.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case k.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case k.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case k.custom:t="Invalid input";break;case k.invalid_intersection_types:t="Intersection results could not be merged";break;case k.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case k.not_finite:t="Number must be finite";break;default:t=e.defaultError,oe.assertNever(n)}return{message:t}};let ld=ln;function _m(n){ld=n}function Ts(){return ld}const Is=n=>{const{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s};if(a.message!==void 0)return{...a,path:s,message:a.message};let o="";const c=r.filter(u=>!!u).slice().reverse();for(const u of c)o=u(i,{data:e,defaultError:o}).message;return{...a,path:s,message:o}},bm=[];function I(n,e){const t=Ts(),r=Is({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===ln?void 0:ln].filter(a=>!!a)});n.common.issues.push(r)}class Fe{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const a of t){if(a.status==="aborted")return V;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const a of t){const s=await a.key,i=await a.value;r.push({key:s,value:i})}return Fe.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const a of t){const{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return V;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value<"u"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}}const V=Object.freeze({status:"aborted"}),Kr=n=>({status:"dirty",value:n}),Ze=n=>({status:"valid",value:n}),Ro=n=>n.status==="aborted",jo=n=>n.status==="dirty",Or=n=>n.status==="valid",ca=n=>typeof Promise<"u"&&n instanceof Promise;function Rs(n,e,t,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(n)}function dd(n,e,t,r,a){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}var C;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(C||(C={}));var Hn,Zn;class Mt{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const pu=(n,e)=>{if(Or(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new at(n.common.issues);return this._error=t,this._error}}};function J(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>{var c,u;const{message:l}=n;return i.code==="invalid_enum_value"?{message:l??o.defaultError}:typeof o.data>"u"?{message:(c=l??r)!==null&&c!==void 0?c:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(u=l??t)!==null&&u!==void 0?u:o.defaultError}},description:a}}class Q{get description(){return this._def.description}_getType(e){return qt(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:qt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Fe,ctx:{common:e.parent.common,data:e.data,parsedType:qt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(ca(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const a={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:qt(e)},s=this._parseSync({data:e,path:a.path,parent:a});return pu(a,s)}"~validate"(e){var t,r;const a={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:qt(e)};if(!this["~standard"].async)try{const s=this._parseSync({data:e,path:[],parent:a});return Or(s)?{value:s.value}:{issues:a.common.issues}}catch(s){!((r=(t=s==null?void 0:s.message)===null||t===void 0?void 0:t.toLowerCase())===null||r===void 0)&&r.includes("encountered")&&(this["~standard"].async=!0),a.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:a}).then(s=>Or(s)?{value:s.value}:{issues:a.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:qt(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(ca(a)?a:Promise.resolve(a));return pu(r,s)}refine(e,t){const r=a=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{const i=e(a),o=()=>s.addIssue({code:k.custom,...r(a)});return typeof Promise<"u"&&i instanceof Promise?i.then(c=>c?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new At({schema:this,typeName:x.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return St.create(this,this._def)}nullable(){return lr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return xt.create(this)}promise(){return hn.create(this,this._def)}or(e){return ha.create([this,e],this._def)}and(e){return fa.create(this,e,this._def)}transform(e){return new At({...J(this._def),schema:this,typeName:x.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new _a({...J(this._def),innerType:this,defaultValue:t,typeName:x.ZodDefault})}brand(){return new dc({typeName:x.ZodBranded,type:this,...J(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new ba({...J(this._def),innerType:this,catchValue:t,typeName:x.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Ta.create(this,e)}readonly(){return wa.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const wm=/^c[^\s-]{8,}$/i,vm=/^[0-9a-z]+$/,xm=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Sm=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Em=/^[a-z0-9_-]{21}$/i,km=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Am=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Pm=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Om="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Ci;const Tm=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Im=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Rm=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,jm=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Cm=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Nm=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,hd="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",$m=new RegExp(`^${hd}$`);function fd(n){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`),e}function Lm(n){return new RegExp(`^${fd(n)}$`)}function md(n){let e=`${hd}T${fd(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Mm(n,e){return!!((e==="v4"||!e)&&Tm.test(n)||(e==="v6"||!e)&&Rm.test(n))}function Fm(n,e){if(!km.test(n))return!1;try{const[t]=n.split("."),r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),a=JSON.parse(atob(r));return!(typeof a!="object"||a===null||!a.typ||!a.alg||e&&a.alg!==e)}catch{return!1}}function Dm(n,e){return!!((e==="v4"||!e)&&Im.test(n)||(e==="v6"||!e)&&jm.test(n))}class bt extends Q{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==j.string){const s=this._getOrReturnCtx(e);return I(s,{code:k.invalid_type,expected:j.string,received:s.parsedType}),V}const r=new Fe;let a;for(const s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),I(a,{code:k.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),I(a,{code:k.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){const i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?I(a,{code:k.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&I(a,{code:k.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")Pm.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"email",code:k.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")Ci||(Ci=new RegExp(Om,"u")),Ci.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"emoji",code:k.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")Sm.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"uuid",code:k.invalid_string,message:s.message}),r.dirty());else if(s.kind==="nanoid")Em.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"nanoid",code:k.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")wm.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"cuid",code:k.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")vm.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"cuid2",code:k.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")xm.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"ulid",code:k.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),I(a,{validation:"url",code:k.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"regex",code:k.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),I(a,{code:k.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),I(a,{code:k.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),I(a,{code:k.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?md(s).test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{code:k.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="date"?$m.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{code:k.invalid_string,validation:"date",message:s.message}),r.dirty()):s.kind==="time"?Lm(s).test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{code:k.invalid_string,validation:"time",message:s.message}),r.dirty()):s.kind==="duration"?Am.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"duration",code:k.invalid_string,message:s.message}),r.dirty()):s.kind==="ip"?Mm(e.data,s.version)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"ip",code:k.invalid_string,message:s.message}),r.dirty()):s.kind==="jwt"?Fm(e.data,s.alg)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"jwt",code:k.invalid_string,message:s.message}),r.dirty()):s.kind==="cidr"?Dm(e.data,s.version)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"cidr",code:k.invalid_string,message:s.message}),r.dirty()):s.kind==="base64"?Cm.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"base64",code:k.invalid_string,message:s.message}),r.dirty()):s.kind==="base64url"?Nm.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"base64url",code:k.invalid_string,message:s.message}),r.dirty()):oe.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:k.invalid_string,...C.errToObj(r)})}_addCheck(e){return new bt({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...C.errToObj(e)})}url(e){return this._addCheck({kind:"url",...C.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...C.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...C.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...C.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...C.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...C.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...C.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...C.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...C.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...C.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...C.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...C.errToObj(e)})}datetime(e){var t,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,local:(r=e==null?void 0:e.local)!==null&&r!==void 0?r:!1,...C.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...C.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...C.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...C.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...C.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...C.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...C.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...C.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...C.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...C.errToObj(t)})}nonempty(e){return this.min(1,C.errToObj(e))}trim(){return new bt({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new bt({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new bt({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}bt.create=n=>{var e;return new bt({checks:[],typeName:x.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...J(n)})};function Um(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}class or extends Q{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==j.number){const s=this._getOrReturnCtx(e);return I(s,{code:k.invalid_type,expected:j.number,received:s.parsedType}),V}let r;const a=new Fe;for(const s of this._def.checks)s.kind==="int"?oe.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),I(r,{code:k.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),I(r,{code:k.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),I(r,{code:k.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?Um(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),I(r,{code:k.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),I(r,{code:k.not_finite,message:s.message}),a.dirty()):oe.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,C.toString(t))}gt(e,t){return this.setLimit("min",e,!1,C.toString(t))}lte(e,t){return this.setLimit("max",e,!0,C.toString(t))}lt(e,t){return this.setLimit("max",e,!1,C.toString(t))}setLimit(e,t,r,a){return new or({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:C.toString(a)}]})}_addCheck(e){return new or({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:C.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:C.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:C.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:C.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:C.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:C.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:C.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:C.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:C.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&oe.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}or.create=n=>new or({checks:[],typeName:x.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...J(n)});class cr extends Q{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==j.bigint)return this._getInvalidInput(e);let r;const a=new Fe;for(const s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),I(r,{code:k.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),I(r,{code:k.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),I(r,{code:k.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):oe.assertNever(s);return{status:a.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return I(t,{code:k.invalid_type,expected:j.bigint,received:t.parsedType}),V}gte(e,t){return this.setLimit("min",e,!0,C.toString(t))}gt(e,t){return this.setLimit("min",e,!1,C.toString(t))}lte(e,t){return this.setLimit("max",e,!0,C.toString(t))}lt(e,t){return this.setLimit("max",e,!1,C.toString(t))}setLimit(e,t,r,a){return new cr({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:C.toString(a)}]})}_addCheck(e){return new cr({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:C.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:C.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:C.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:C.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:C.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}cr.create=n=>{var e;return new cr({checks:[],typeName:x.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...J(n)})};class ua extends Q{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==j.boolean){const r=this._getOrReturnCtx(e);return I(r,{code:k.invalid_type,expected:j.boolean,received:r.parsedType}),V}return Ze(e.data)}}ua.create=n=>new ua({typeName:x.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...J(n)});class Tr extends Q{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==j.date){const s=this._getOrReturnCtx(e);return I(s,{code:k.invalid_type,expected:j.date,received:s.parsedType}),V}if(isNaN(e.data.getTime())){const s=this._getOrReturnCtx(e);return I(s,{code:k.invalid_date}),V}const r=new Fe;let a;for(const s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),I(a,{code:k.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),I(a,{code:k.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):oe.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Tr({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:C.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:C.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}Tr.create=n=>new Tr({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:x.ZodDate,...J(n)});class js extends Q{_parse(e){if(this._getType(e)!==j.symbol){const r=this._getOrReturnCtx(e);return I(r,{code:k.invalid_type,expected:j.symbol,received:r.parsedType}),V}return Ze(e.data)}}js.create=n=>new js({typeName:x.ZodSymbol,...J(n)});class la extends Q{_parse(e){if(this._getType(e)!==j.undefined){const r=this._getOrReturnCtx(e);return I(r,{code:k.invalid_type,expected:j.undefined,received:r.parsedType}),V}return Ze(e.data)}}la.create=n=>new la({typeName:x.ZodUndefined,...J(n)});class da extends Q{_parse(e){if(this._getType(e)!==j.null){const r=this._getOrReturnCtx(e);return I(r,{code:k.invalid_type,expected:j.null,received:r.parsedType}),V}return Ze(e.data)}}da.create=n=>new da({typeName:x.ZodNull,...J(n)});class dn extends Q{constructor(){super(...arguments),this._any=!0}_parse(e){return Ze(e.data)}}dn.create=n=>new dn({typeName:x.ZodAny,...J(n)});class kr extends Q{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Ze(e.data)}}kr.create=n=>new kr({typeName:x.ZodUnknown,...J(n)});class Jt extends Q{_parse(e){const t=this._getOrReturnCtx(e);return I(t,{code:k.invalid_type,expected:j.never,received:t.parsedType}),V}}Jt.create=n=>new Jt({typeName:x.ZodNever,...J(n)});class Cs extends Q{_parse(e){if(this._getType(e)!==j.undefined){const r=this._getOrReturnCtx(e);return I(r,{code:k.invalid_type,expected:j.void,received:r.parsedType}),V}return Ze(e.data)}}Cs.create=n=>new Cs({typeName:x.ZodVoid,...J(n)});class xt extends Q{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==j.array)return I(t,{code:k.invalid_type,expected:j.array,received:t.parsedType}),V;if(a.exactLength!==null){const i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(I(t,{code:i?k.too_big:k.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(I(t,{code:k.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(I(t,{code:k.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new Mt(t,i,t.path,o)))).then(i=>Fe.mergeArray(r,i));const s=[...t.data].map((i,o)=>a.type._parseSync(new Mt(t,i,t.path,o)));return Fe.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new xt({...this._def,minLength:{value:e,message:C.toString(t)}})}max(e,t){return new xt({...this._def,maxLength:{value:e,message:C.toString(t)}})}length(e,t){return new xt({...this._def,exactLength:{value:e,message:C.toString(t)}})}nonempty(e){return this.min(1,e)}}xt.create=(n,e)=>new xt({type:n,minLength:null,maxLength:null,exactLength:null,typeName:x.ZodArray,...J(e)});function qr(n){if(n instanceof _e){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=St.create(qr(r))}return new _e({...n._def,shape:()=>e})}else return n instanceof xt?new xt({...n._def,type:qr(n.element)}):n instanceof St?St.create(qr(n.unwrap())):n instanceof lr?lr.create(qr(n.unwrap())):n instanceof Ft?Ft.create(n.items.map(e=>qr(e))):n}class _e extends Q{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=oe.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==j.object){const u=this._getOrReturnCtx(e);return I(u,{code:k.invalid_type,expected:j.object,received:u.parsedType}),V}const{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Jt&&this._def.unknownKeys==="strip"))for(const u in a.data)i.includes(u)||o.push(u);const c=[];for(const u of i){const l=s[u],d=a.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new Mt(a,d,a.path,u)),alwaysSet:u in a.data})}if(this._def.catchall instanceof Jt){const u=this._def.unknownKeys;if(u==="passthrough")for(const l of o)c.push({key:{status:"valid",value:l},value:{status:"valid",value:a.data[l]}});else if(u==="strict")o.length>0&&(I(a,{code:k.unrecognized_keys,keys:o}),r.dirty());else if(u!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const u=this._def.catchall;for(const l of o){const d=a.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new Mt(a,d,a.path,l)),alwaysSet:l in a.data})}}return a.common.async?Promise.resolve().then(async()=>{const u=[];for(const l of c){const d=await l.key,h=await l.value;u.push({key:d,value:h,alwaysSet:l.alwaysSet})}return u}).then(u=>Fe.mergeObjectSync(r,u)):Fe.mergeObjectSync(r,c)}get shape(){return this._def.shape()}strict(e){return C.errToObj,new _e({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;const c=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=C.errToObj(e).message)!==null&&o!==void 0?o:c}:{message:c}}}:{}})}strip(){return new _e({...this._def,unknownKeys:"strip"})}passthrough(){return new _e({...this._def,unknownKeys:"passthrough"})}extend(e){return new _e({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new _e({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:x.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new _e({...this._def,catchall:e})}pick(e){const t={};return oe.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new _e({...this._def,shape:()=>t})}omit(e){const t={};return oe.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new _e({...this._def,shape:()=>t})}deepPartial(){return qr(this)}partial(e){const t={};return oe.objectKeys(this.shape).forEach(r=>{const a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new _e({...this._def,shape:()=>t})}required(e){const t={};return oe.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof St;)s=s._def.innerType;t[r]=s}}),new _e({...this._def,shape:()=>t})}keyof(){return pd(oe.objectKeys(this.shape))}}_e.create=(n,e)=>new _e({shape:()=>n,unknownKeys:"strip",catchall:Jt.create(),typeName:x.ZodObject,...J(e)});_e.strictCreate=(n,e)=>new _e({shape:()=>n,unknownKeys:"strict",catchall:Jt.create(),typeName:x.ZodObject,...J(e)});_e.lazycreate=(n,e)=>new _e({shape:n,unknownKeys:"strip",catchall:Jt.create(),typeName:x.ZodObject,...J(e)});class ha extends Q{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(const o of s)if(o.result.status==="valid")return o.result;for(const o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=s.map(o=>new at(o.ctx.common.issues));return I(t,{code:k.invalid_union,unionErrors:i}),V}if(t.common.async)return Promise.all(r.map(async s=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s;const i=[];for(const c of r){const u={...t,common:{...t.common,issues:[]},parent:null},l=c._parseSync({data:t.data,path:t.path,parent:u});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:u}),u.common.issues.length&&i.push(u.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;const o=i.map(c=>new at(c));return I(t,{code:k.invalid_union,unionErrors:o}),V}}get options(){return this._def.options}}ha.create=(n,e)=>new ha({options:n,typeName:x.ZodUnion,...J(e)});const Ht=n=>n instanceof pa?Ht(n.schema):n instanceof At?Ht(n.innerType()):n instanceof ga?[n.value]:n instanceof ur?n.options:n instanceof ya?oe.objectValues(n.enum):n instanceof _a?Ht(n._def.innerType):n instanceof la?[void 0]:n instanceof da?[null]:n instanceof St?[void 0,...Ht(n.unwrap())]:n instanceof lr?[null,...Ht(n.unwrap())]:n instanceof dc||n instanceof wa?Ht(n.unwrap()):n instanceof ba?Ht(n._def.innerType):[];class ri extends Q{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==j.object)return I(t,{code:k.invalid_type,expected:j.object,received:t.parsedType}),V;const r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(I(t,{code:k.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),V)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const a=new Map;for(const s of t){const i=Ht(s.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new ri({typeName:x.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...J(r)})}}function Co(n,e){const t=qt(n),r=qt(e);if(n===e)return{valid:!0,data:n};if(t===j.object&&r===j.object){const a=oe.objectKeys(e),s=oe.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(const o of s){const c=Co(n[o],e[o]);if(!c.valid)return{valid:!1};i[o]=c.data}return{valid:!0,data:i}}else if(t===j.array&&r===j.array){if(n.length!==e.length)return{valid:!1};const a=[];for(let s=0;s<n.length;s++){const i=n[s],o=e[s],c=Co(i,o);if(!c.valid)return{valid:!1};a.push(c.data)}return{valid:!0,data:a}}else return t===j.date&&r===j.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class fa extends Q{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if(Ro(s)||Ro(i))return V;const o=Co(s.value,i.value);return o.valid?((jo(s)||jo(i))&&t.dirty(),{status:t.value,value:o.data}):(I(r,{code:k.invalid_intersection_types}),V)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}fa.create=(n,e,t)=>new fa({left:n,right:e,typeName:x.ZodIntersection,...J(t)});class Ft extends Q{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==j.array)return I(r,{code:k.invalid_type,expected:j.array,received:r.parsedType}),V;if(r.data.length<this._def.items.length)return I(r,{code:k.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),V;!this._def.rest&&r.data.length>this._def.items.length&&(I(r,{code:k.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...r.data].map((i,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new Mt(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>Fe.mergeArray(t,i)):Fe.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new Ft({...this._def,rest:e})}}Ft.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ft({items:n,typeName:x.ZodTuple,rest:null,...J(e)})};class ma extends Q{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==j.object)return I(r,{code:k.invalid_type,expected:j.object,received:r.parsedType}),V;const a=[],s=this._def.keyType,i=this._def.valueType;for(const o in r.data)a.push({key:s._parse(new Mt(r,o,r.path,o)),value:i._parse(new Mt(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?Fe.mergeObjectAsync(t,a):Fe.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof Q?new ma({keyType:e,valueType:t,typeName:x.ZodRecord,...J(r)}):new ma({keyType:bt.create(),valueType:e,typeName:x.ZodRecord,...J(t)})}}class Ns extends Q{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==j.map)return I(r,{code:k.invalid_type,expected:j.map,received:r.parsedType}),V;const a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,c],u)=>({key:a._parse(new Mt(r,o,r.path,[u,"key"])),value:s._parse(new Mt(r,c,r.path,[u,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of i){const u=await c.key,l=await c.value;if(u.status==="aborted"||l.status==="aborted")return V;(u.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(u.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const c of i){const u=c.key,l=c.value;if(u.status==="aborted"||l.status==="aborted")return V;(u.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(u.value,l.value)}return{status:t.value,value:o}}}}Ns.create=(n,e,t)=>new Ns({valueType:e,keyType:n,typeName:x.ZodMap,...J(t)});class Ir extends Q{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==j.set)return I(r,{code:k.invalid_type,expected:j.set,received:r.parsedType}),V;const a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(I(r,{code:k.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(I(r,{code:k.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());const s=this._def.valueType;function i(c){const u=new Set;for(const l of c){if(l.status==="aborted")return V;l.status==="dirty"&&t.dirty(),u.add(l.value)}return{status:t.value,value:u}}const o=[...r.data.values()].map((c,u)=>s._parse(new Mt(r,c,r.path,u)));return r.common.async?Promise.all(o).then(c=>i(c)):i(o)}min(e,t){return new Ir({...this._def,minSize:{value:e,message:C.toString(t)}})}max(e,t){return new Ir({...this._def,maxSize:{value:e,message:C.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Ir.create=(n,e)=>new Ir({valueType:n,minSize:null,maxSize:null,typeName:x.ZodSet,...J(e)});class tn extends Q{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==j.function)return I(t,{code:k.invalid_type,expected:j.function,received:t.parsedType}),V;function r(o,c){return Is({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ts(),ln].filter(u=>!!u),issueData:{code:k.invalid_arguments,argumentsError:c}})}function a(o,c){return Is({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ts(),ln].filter(u=>!!u),issueData:{code:k.invalid_return_type,returnTypeError:c}})}const s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof hn){const o=this;return Ze(async function(...c){const u=new at([]),l=await o._def.args.parseAsync(c,s).catch(m=>{throw u.addIssue(r(c,m)),u}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,s).catch(m=>{throw u.addIssue(a(d,m)),u})})}else{const o=this;return Ze(function(...c){const u=o._def.args.safeParse(c,s);if(!u.success)throw new at([r(c,u.error)]);const l=Reflect.apply(i,this,u.data),d=o._def.returns.safeParse(l,s);if(!d.success)throw new at([a(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new tn({...this._def,args:Ft.create(e).rest(kr.create())})}returns(e){return new tn({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new tn({args:e||Ft.create([]).rest(kr.create()),returns:t||kr.create(),typeName:x.ZodFunction,...J(r)})}}class pa extends Q{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}pa.create=(n,e)=>new pa({getter:n,typeName:x.ZodLazy,...J(e)});class ga extends Q{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return I(t,{received:t.data,code:k.invalid_literal,expected:this._def.value}),V}return{status:"valid",value:e.data}}get value(){return this._def.value}}ga.create=(n,e)=>new ga({value:n,typeName:x.ZodLiteral,...J(e)});function pd(n,e){return new ur({values:n,typeName:x.ZodEnum,...J(e)})}class ur extends Q{constructor(){super(...arguments),Hn.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return I(t,{expected:oe.joinValues(r),received:t.parsedType,code:k.invalid_type}),V}if(Rs(this,Hn)||dd(this,Hn,new Set(this._def.values)),!Rs(this,Hn).has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return I(t,{received:t.data,code:k.invalid_enum_value,options:r}),V}return Ze(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return ur.create(e,{...this._def,...t})}exclude(e,t=this._def){return ur.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}}Hn=new WeakMap;ur.create=pd;class ya extends Q{constructor(){super(...arguments),Zn.set(this,void 0)}_parse(e){const t=oe.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==j.string&&r.parsedType!==j.number){const a=oe.objectValues(t);return I(r,{expected:oe.joinValues(a),received:r.parsedType,code:k.invalid_type}),V}if(Rs(this,Zn)||dd(this,Zn,new Set(oe.getValidEnumValues(this._def.values))),!Rs(this,Zn).has(e.data)){const a=oe.objectValues(t);return I(r,{received:r.data,code:k.invalid_enum_value,options:a}),V}return Ze(e.data)}get enum(){return this._def.values}}Zn=new WeakMap;ya.create=(n,e)=>new ya({values:n,typeName:x.ZodNativeEnum,...J(e)});class hn extends Q{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==j.promise&&t.common.async===!1)return I(t,{code:k.invalid_type,expected:j.promise,received:t.parsedType}),V;const r=t.parsedType===j.promise?t.data:Promise.resolve(t.data);return Ze(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}}hn.create=(n,e)=>new hn({type:n,typeName:x.ZodPromise,...J(e)});class At extends Q{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===x.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{I(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){const i=a.transform(r.data,s);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return V;const c=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return c.status==="aborted"?V:c.status==="dirty"||t.value==="dirty"?Kr(c.value):c});{if(t.value==="aborted")return V;const o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?V:o.status==="dirty"||t.value==="dirty"?Kr(o.value):o}}if(a.type==="refinement"){const i=o=>{const c=a.refinement(o,s);if(r.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?V:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?V:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Or(i))return i;const o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>Or(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);oe.assertNever(a)}}At.create=(n,e,t)=>new At({schema:n,typeName:x.ZodEffects,effect:e,...J(t)});At.createWithPreprocess=(n,e,t)=>new At({schema:e,effect:{type:"preprocess",transform:n},typeName:x.ZodEffects,...J(t)});class St extends Q{_parse(e){return this._getType(e)===j.undefined?Ze(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}St.create=(n,e)=>new St({innerType:n,typeName:x.ZodOptional,...J(e)});class lr extends Q{_parse(e){return this._getType(e)===j.null?Ze(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}lr.create=(n,e)=>new lr({innerType:n,typeName:x.ZodNullable,...J(e)});class _a extends Q{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===j.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}_a.create=(n,e)=>new _a({innerType:n,typeName:x.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...J(e)});class ba extends Q{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return ca(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new at(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new at(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}ba.create=(n,e)=>new ba({innerType:n,typeName:x.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...J(e)});class $s extends Q{_parse(e){if(this._getType(e)!==j.nan){const r=this._getOrReturnCtx(e);return I(r,{code:k.invalid_type,expected:j.nan,received:r.parsedType}),V}return{status:"valid",value:e.data}}}$s.create=n=>new $s({typeName:x.ZodNaN,...J(n)});const Bm=Symbol("zod_brand");class dc extends Q{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class Ta extends Q{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?V:s.status==="dirty"?(t.dirty(),Kr(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{const a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?V:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new Ta({in:e,out:t,typeName:x.ZodPipeline})}}class wa extends Q{_parse(e){const t=this._def.innerType._parse(e),r=a=>(Or(a)&&(a.value=Object.freeze(a.value)),a);return ca(t)?t.then(a=>r(a)):r(t)}unwrap(){return this._def.innerType}}wa.create=(n,e)=>new wa({innerType:n,typeName:x.ZodReadonly,...J(e)});function gu(n,e){const t=typeof n=="function"?n(e):typeof n=="string"?{message:n}:n;return typeof t=="string"?{message:t}:t}function gd(n,e={},t){return n?dn.create().superRefine((r,a)=>{var s,i;const o=n(r);if(o instanceof Promise)return o.then(c=>{var u,l;if(!c){const d=gu(e,r),h=(l=(u=d.fatal)!==null&&u!==void 0?u:t)!==null&&l!==void 0?l:!0;a.addIssue({code:"custom",...d,fatal:h})}});if(!o){const c=gu(e,r),u=(i=(s=c.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0;a.addIssue({code:"custom",...c,fatal:u})}}):dn.create()}const zm={object:_e.lazycreate};var x;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(x||(x={}));const Hm=(n,e={message:`Input not instance of ${n.name}`})=>gd(t=>t instanceof n,e),yd=bt.create,_d=or.create,Zm=$s.create,qm=cr.create,bd=ua.create,Vm=Tr.create,Wm=js.create,Jm=la.create,Gm=da.create,Km=dn.create,Xm=kr.create,Qm=Jt.create,Ym=Cs.create,ep=xt.create,tp=_e.create,rp=_e.strictCreate,np=ha.create,ap=ri.create,sp=fa.create,ip=Ft.create,op=ma.create,cp=Ns.create,up=Ir.create,lp=tn.create,dp=pa.create,hp=ga.create,fp=ur.create,mp=ya.create,pp=hn.create,yu=At.create,gp=St.create,yp=lr.create,_p=At.createWithPreprocess,bp=Ta.create,wp=()=>yd().optional(),vp=()=>_d().optional(),xp=()=>bd().optional(),Sp={string:n=>bt.create({...n,coerce:!0}),number:n=>or.create({...n,coerce:!0}),boolean:n=>ua.create({...n,coerce:!0}),bigint:n=>cr.create({...n,coerce:!0}),date:n=>Tr.create({...n,coerce:!0})},Ep=V;var be=Object.freeze({__proto__:null,defaultErrorMap:ln,setErrorMap:_m,getErrorMap:Ts,makeIssue:Is,EMPTY_PATH:bm,addIssueToContext:I,ParseStatus:Fe,INVALID:V,DIRTY:Kr,OK:Ze,isAborted:Ro,isDirty:jo,isValid:Or,isAsync:ca,get util(){return oe},get objectUtil(){return Io},ZodParsedType:j,getParsedType:qt,ZodType:Q,datetimeRegex:md,ZodString:bt,ZodNumber:or,ZodBigInt:cr,ZodBoolean:ua,ZodDate:Tr,ZodSymbol:js,ZodUndefined:la,ZodNull:da,ZodAny:dn,ZodUnknown:kr,ZodNever:Jt,ZodVoid:Cs,ZodArray:xt,ZodObject:_e,ZodUnion:ha,ZodDiscriminatedUnion:ri,ZodIntersection:fa,ZodTuple:Ft,ZodRecord:ma,ZodMap:Ns,ZodSet:Ir,ZodFunction:tn,ZodLazy:pa,ZodLiteral:ga,ZodEnum:ur,ZodNativeEnum:ya,ZodPromise:hn,ZodEffects:At,ZodTransformer:At,ZodOptional:St,ZodNullable:lr,ZodDefault:_a,ZodCatch:ba,ZodNaN:$s,BRAND:Bm,ZodBranded:dc,ZodPipeline:Ta,ZodReadonly:wa,custom:gd,Schema:Q,ZodSchema:Q,late:zm,get ZodFirstPartyTypeKind(){return x},coerce:Sp,any:Km,array:ep,bigint:qm,boolean:bd,date:Vm,discriminatedUnion:ap,effect:yu,enum:fp,function:lp,instanceof:Hm,intersection:sp,lazy:dp,literal:hp,map:cp,nan:Zm,nativeEnum:mp,never:Qm,null:Gm,nullable:yp,number:_d,object:tp,oboolean:xp,onumber:vp,optional:gp,ostring:wp,pipeline:bp,preprocess:_p,promise:pp,record:op,set:up,strictObject:rp,string:yd,symbol:Wm,transformer:yu,tuple:ip,undefined:Jm,union:np,unknown:Xm,void:Ym,NEVER:Ep,ZodIssueCode:k,quotelessJson:ym,ZodError:at});const Ls=[{name:"English",code:"en"},{name:"Indonesian",code:"id"},{name:"Japanese",code:"ja"},{name:"Chinese",code:"zh"},{name:"Korean",code:"ko"},{name:"Spanish",code:"es"},{name:"French",code:"fr"},{name:"German",code:"de"},{name:"Italian",code:"it"}],kp=be.object({result:be.array(be.object({id:be.string().describe("Unique identifier for the translation"),sourceText:be.string().describe("Original text in source language"),targetText:be.string().describe("Translated text in target language"),category:be.object({level:be.string().describe("Proficiency level (N1-N5 for Japanese/HSK for Chinese/CEFR for others)"),place:be.string().describe("Location or context where this phrase would be used"),situation:be.string().describe("Usage context (formal/casual/business etc)")}),pronunciation:be.object({romaji:be.string().optional().describe("Romanized text for target language"),guide:be.string().describe("Pronunciation explanation for target language")})}))}),Ap="clearvoicelingo-db",Pp=2;async function mr(){return cm(Ap,Pp,{upgrade(n){n.objectStoreNames.contains("languagePairs")||n.createObjectStore("languagePairs",{keyPath:"id"}).createIndex("timestamp","timestamp"),n.objectStoreNames.contains("ttsPairs")||n.createObjectStore("ttsPairs",{keyPath:"id"}).createIndex("timestamp","timestamp"),n.objectStoreNames.contains("settings")||n.createObjectStore("settings",{keyPath:"id"})}})}async function Op(n){const t=(await mr()).transaction("languagePairs","readwrite"),r=t.objectStore("languagePairs");for(const a of n)await r.put(a);return await t.done,!0}async function Tp(){return(await mr()).getAll("languagePairs")}async function Ip(n){return await(await mr()).delete("languagePairs",n),!0}async function Rn(n,e){const r=(await mr()).transaction("settings","readwrite");return await r.objectStore("settings").put({id:n,value:e}),await r.done,!0}async function _t(n){const t=await(await mr()).get("settings",n);return t?t.value:null}async function Rp(n){const t=(await mr()).transaction("ttsPairs","readwrite");return await t.objectStore("ttsPairs").put(n),await t.done,!0}async function jp(){return(await mr()).getAll("ttsPairs")}async function Cp(n){return await(await mr()).delete("ttsPairs",n),!0}function _u(n){return new Promise(e=>{const t=()=>window.speechSynthesis.getVoices(),r=t();if(r.length>0){e(r);return}window.speechSynthesis.onvoiceschanged=()=>{e(t())}})}function Np(){if("speechSynthesis"in window){const n=new SpeechSynthesisUtterance("");window.speechSynthesis.speak(n),window.speechSynthesis.cancel(),window.speechSynthesis.getVoices()}}let nr=null,$r=!1;function rn(n,e,t=1,r=1,a=1){return new Promise((s,i)=>{if(!n){i(new Error("No text provided"));return}$r=!1,nr&&(window.speechSynthesis.cancel(),nr=null);const o=new SpeechSynthesisUtterance(n);nr=o,e&&(o.voice=e),o.rate=t,o.pitch=r,o.volume=a;let c=0;const u=3,l=()=>{if($r){nr=null,s();return}o.onend=()=>{$r||(console.log("Speech completed:",n),nr=null,s())},o.onerror=d=>{console.error("Speech error:",d),!$r&&d.error==="interrupted"&&c<u?(c++,console.log(`Retrying speech attempt ${c}...`),setTimeout(l,300)):$r||(nr=null,i(d))};try{window.speechSynthesis.speak(o)}catch(d){console.error("Speech synthesis error:",d),$r||(nr=null,i(d))}};setTimeout(l,100)})}const Yn=()=>{window.speechSynthesis.speaking&&window.speechSynthesis.cancel(),nr=null},No="RFC3986",$o={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:n=>String(n)},$p="RFC1738",Lp=Array.isArray,Tt=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),Ni=1024,Mp=(n,e,t,r,a)=>{if(n.length===0)return n;let s=n;if(typeof n=="symbol"?s=Symbol.prototype.toString.call(n):typeof n!="string"&&(s=String(n)),t==="iso-8859-1")return escape(s).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<s.length;o+=Ni){const c=s.length>=Ni?s.slice(o,o+Ni):s,u=[];for(let l=0;l<c.length;++l){let d=c.charCodeAt(l);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||a===$p&&(d===40||d===41)){u[u.length]=c.charAt(l);continue}if(d<128){u[u.length]=Tt[d];continue}if(d<2048){u[u.length]=Tt[192|d>>6]+Tt[128|d&63];continue}if(d<55296||d>=57344){u[u.length]=Tt[224|d>>12]+Tt[128|d>>6&63]+Tt[128|d&63];continue}l+=1,d=65536+((d&1023)<<10|c.charCodeAt(l)&1023),u[u.length]=Tt[240|d>>18]+Tt[128|d>>12&63]+Tt[128|d>>6&63]+Tt[128|d&63]}i+=u.join("")}return i};function Fp(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function bu(n,e){if(Lp(n)){const t=[];for(let r=0;r<n.length;r+=1)t.push(e(n[r]));return t}return e(n)}const Dp=Object.prototype.hasOwnProperty,wd={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},Rt=Array.isArray,Up=Array.prototype.push,vd=function(n,e){Up.apply(n,Rt(e)?e:[e])},Bp=Date.prototype.toISOString,xe={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:Mp,encodeValuesOnly:!1,format:No,formatter:$o[No],indices:!1,serializeDate(n){return Bp.call(n)},skipNulls:!1,strictNullHandling:!1};function zp(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const $i={};function xd(n,e,t,r,a,s,i,o,c,u,l,d,h,m,f,p,g,w){let b=n,_=w,v=0,E=!1;for(;(_=_.get($i))!==void 0&&!E;){const L=_.get(n);if(v+=1,typeof L<"u"){if(L===v)throw new RangeError("Cyclic object value");E=!0}typeof _.get($i)>"u"&&(v=0)}if(typeof u=="function"?b=u(e,b):b instanceof Date?b=h==null?void 0:h(b):t==="comma"&&Rt(b)&&(b=bu(b,function(L){return L instanceof Date?h==null?void 0:h(L):L})),b===null){if(s)return c&&!p?c(e,xe.encoder,g,"key",m):e;b=""}if(zp(b)||Fp(b)){if(c){const L=p?e:c(e,xe.encoder,g,"key",m);return[(f==null?void 0:f(L))+"="+(f==null?void 0:f(c(b,xe.encoder,g,"value",m)))]}return[(f==null?void 0:f(e))+"="+(f==null?void 0:f(String(b)))]}const O=[];if(typeof b>"u")return O;let T;if(t==="comma"&&Rt(b))p&&c&&(b=bu(b,c)),T=[{value:b.length>0?b.join(",")||null:void 0}];else if(Rt(u))T=u;else{const L=Object.keys(b);T=l?L.sort(l):L}const q=o?String(e).replace(/\./g,"%2E"):String(e),K=r&&Rt(b)&&b.length===1?q+"[]":q;if(a&&Rt(b)&&b.length===0)return K+"[]";for(let L=0;L<T.length;++L){const Z=T[L],ae=typeof Z=="object"&&typeof Z.value<"u"?Z.value:b[Z];if(i&&ae===null)continue;const ge=d&&o?Z.replace(/\./g,"%2E"):Z,A=Rt(b)?typeof t=="function"?t(K,ge):K:K+(d?"."+ge:"["+ge+"]");w.set(n,v);const P=new WeakMap;P.set($i,w),vd(O,xd(ae,A,t,r,a,s,i,o,t==="comma"&&p&&Rt(b)?null:c,u,l,d,h,m,f,p,g,P))}return O}function Hp(n=xe){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||xe.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=No;if(typeof n.format<"u"){if(!Dp.call($o,n.format))throw new TypeError("Unknown format option provided.");t=n.format}const r=$o[t];let a=xe.filter;(typeof n.filter=="function"||Rt(n.filter))&&(a=n.filter);let s;if(n.arrayFormat&&n.arrayFormat in wd?s=n.arrayFormat:"indices"in n?s=n.indices?"indices":"repeat":s=xe.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:xe.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:xe.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:xe.allowEmptyArrays,arrayFormat:s,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:xe.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?xe.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:xe.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:xe.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:xe.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:xe.encodeValuesOnly,filter:a,format:t,formatter:r,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:xe.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:xe.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:xe.strictNullHandling}}function Zp(n,e={}){let t=n;const r=Hp(e);let a,s;typeof r.filter=="function"?(s=r.filter,t=s("",t)):Rt(r.filter)&&(s=r.filter,a=s);const i=[];if(typeof t!="object"||t===null)return"";const o=wd[r.arrayFormat],c=o==="comma"&&r.commaRoundTrip;a||(a=Object.keys(t)),r.sort&&a.sort(r.sort);const u=new WeakMap;for(let h=0;h<a.length;++h){const m=a[h];r.skipNulls&&t[m]===null||vd(i,xd(t[m],m,o,c,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,u))}const l=i.join(r.delimiter);let d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}const Vr="4.89.0";let wu=!1,ea,Sd,Ed,Lo,kd,Ad,Pd,Od,Td;function qp(n,e={auto:!1}){if(wu)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(ea)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${ea}'\``);wu=e.auto,ea=n.kind,Sd=n.fetch,Ed=n.FormData,Lo=n.File,kd=n.ReadableStream,Ad=n.getMultipartRequestOptions,Pd=n.getDefaultAgent,Od=n.fileFromPath,Td=n.isFsReadStream}let Vp=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Wp({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import â¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new Vp(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}ea||qp(Wp(),{auto:!0});class D extends Error{}let Ge=class Mo extends D{constructor(e,t,r,a){super(`${Mo.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a==null?void 0:a["x-request-id"],this.error=t;const s=t;this.code=s==null?void 0:s.code,this.param=s==null?void 0:s.param,this.type=s==null?void 0:s.type}static makeMessage(e,t,r){const a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e||!a)return new ni({message:r,cause:Do(t)});const s=t==null?void 0:t.error;return e===400?new Id(e,s,r,a):e===401?new Rd(e,s,r,a):e===403?new jd(e,s,r,a):e===404?new Cd(e,s,r,a):e===409?new Nd(e,s,r,a):e===422?new $d(e,s,r,a):e===429?new Ld(e,s,r,a):e>=500?new Md(e,s,r,a):new Mo(e,s,r,a)}},nt=class extends Ge{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},ni=class extends Ge{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},ai=class extends ni{constructor({message:e}={}){super({message:e??"Request timed out."})}},Id=class extends Ge{},Rd=class extends Ge{},jd=class extends Ge{},Cd=class extends Ge{},Nd=class extends Ge{},$d=class extends Ge{},Ld=class extends Ge{},Md=class extends Ge{};class Fd extends D{constructor(){super("Could not parse response content as the length limit was reached")}}class Dd extends D{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var Ba=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},yr=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Qe;let si=class{constructor(){Qe.set(this,void 0),this.buffer=new Uint8Array,Ba(this,Qe,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let r=new Uint8Array(this.buffer.length+t.length);r.set(this.buffer),r.set(t,this.buffer.length),this.buffer=r;const a=[];let s;for(;(s=Jp(this.buffer,yr(this,Qe,"f")))!=null;){if(s.carriage&&yr(this,Qe,"f")==null){Ba(this,Qe,s.index,"f");continue}if(yr(this,Qe,"f")!=null&&(s.index!==yr(this,Qe,"f")+1||s.carriage)){a.push(this.decodeText(this.buffer.slice(0,yr(this,Qe,"f")-1))),this.buffer=this.buffer.slice(yr(this,Qe,"f")),Ba(this,Qe,null,"f");continue}const i=yr(this,Qe,"f")!==null?s.preceding-1:s.preceding,o=this.decodeText(this.buffer.slice(0,i));a.push(o),this.buffer=this.buffer.slice(s.index),Ba(this,Qe,null,"f")}return a}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new D(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new D(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new D("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};Qe=new WeakMap;si.NEWLINE_CHARS=new Set([`
`,"\r"]);si.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Jp(n,e){for(let a=e??0;a<n.length;a++){if(n[a]===10)return{preceding:a,index:a+1,carriage:!1};if(n[a]===13)return{preceding:a,index:a+1,carriage:!0}}return null}function Gp(n){for(let r=0;r<n.length-1;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}function Ud(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}let va=class qn{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(const i of Kp(e,t))if(!s){if(i.data.startsWith("[DONE]")){s=!0;continue}if(i.event===null||i.event.startsWith("response.")){let o;try{o=JSON.parse(i.data)}catch(c){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),c}if(o&&o.error)throw new Ge(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(i.data)}catch(c){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),c}if(i.event=="error")throw new Ge(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}s=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{s||t.abort()}}return new qn(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){const i=new si,o=Ud(e);for await(const c of o)for(const u of i.decode(c))yield u;for(const c of i.flush())yield c}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new qn(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){const i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new qn(()=>a(e),this.controller),new qn(()=>a(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new kd({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{const{value:s,done:i}=await t.next();if(i)return a.close();const o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}};async function*Kp(n,e){if(!n.body)throw e.abort(),new D("Attempted to iterate over a response with no body");const t=new Qp,r=new si,a=Ud(n.body);for await(const s of Xp(a))for(const i of r.decode(s)){const o=t.decode(i);o&&(yield o)}for(const s of r.flush()){const i=t.decode(s);i&&(yield i)}}async function*Xp(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let a=new Uint8Array(e.length+r.length);a.set(e),a.set(r,e.length),e=a;let s;for(;(s=Gp(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}let Qp=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=Yp(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}};function Yp(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}const Bd=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",zd=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&ii(n),ii=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",eg=n=>zd(n)||Bd(n)||Td(n);async function Hd(n,e,t){var a;if(n=await n,zd(n))return n;if(Bd(n)){const s=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=ii(s)?[await s.arrayBuffer()]:[s];return new Lo(i,e,t)}const r=await tg(n);if(e||(e=ng(n)??"unknown_file"),!(t!=null&&t.type)){const s=(a=r[0])==null?void 0:a.type;typeof s=="string"&&(t={...t,type:s})}return new Lo(r,e,t)}async function tg(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(ii(n))e.push(await n.arrayBuffer());else if(ag(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${rg(n)}`);return e}function rg(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function ng(n){var e;return Li(n.name)||Li(n.filename)||((e=Li(n.path))==null?void 0:e.split(/[\\/]/).pop())}const Li=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},ag=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",vu=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",fn=async n=>{const e=await sg(n.body);return Ad(e,n)},sg=async n=>{const e=new Ed;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Fo(e,t,r))),e},Fo=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(eg(t)){const r=await Hd(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Fo(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>Fo(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var nn={},ig=function(n,e,t,r,a){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t},og=function(n,e,t,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},za;async function Zd(n){var i;const{response:e}=n;if(n.options.stream)return an("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):va.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type"),r=(i=t==null?void 0:t.split(";")[0])==null?void 0:i.trim();if((r==null?void 0:r.includes("application/json"))||(r==null?void 0:r.endsWith("+json"))){const o=await e.json();return an("response",e.status,e.url,e.headers,o),qd(o,e)}const s=await e.text();return an("response",e.status,e.url,e.headers,s),s}function qd(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}let Vd=class Wd extends Promise{constructor(e,t=Zd){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Wd(this.responsePromise,async t=>qd(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},cg=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=Mi("maxRetries",t),this.timeout=Mi("timeout",r),this.httpAgent=a,this.fetch=s??Sd}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...mg(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${_g()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async a=>{const s=a&&ii(a==null?void 0:a.body)?new DataView(await a.body.arrayBuffer()):(a==null?void 0:a.body)instanceof DataView?a.body:(a==null?void 0:a.body)instanceof ArrayBuffer?new DataView(a.body):a&&ArrayBuffer.isView(a==null?void 0:a.body)?new DataView(a.body.buffer):a==null?void 0:a.body;return{method:e,path:t,...a,body:s}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var f;e={...e};const{method:r,path:a,query:s,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:vu(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,c=this.calculateContentLength(o),u=this.buildURL(a,s);"timeout"in e&&Mi("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const l=e.httpAgent??this.httpAgent??Pd(u),d=e.timeout+1e3;typeof((f=l==null?void 0:l.options)==null?void 0:f.timeout)=="number"&&d>(l.options.timeout??0)&&(l.options.timeout=d),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:e,headers:i,contentLength:c,retryCount:t});return{req:{method:r,...o&&{body:o},headers:h,...l&&{agent:l},signal:e.signal??null},url:u,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:a}){const s={};r&&(s["content-length"]=r);const i=this.defaultHeaders(e);return ku(s,i),ku(s,t),vu(e.body)&&ea!=="node"&&delete s["content-type"],Ha(i,"x-stainless-retry-count")===void 0&&Ha(t,"x-stainless-retry-count")===void 0&&(s["x-stainless-retry-count"]=String(a)),Ha(i,"x-stainless-timeout")===void 0&&Ha(t,"x-stainless-timeout")===void 0&&e.timeout&&(s["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return Ge.generate(e,t,r,a)}request(e,t=null){return new Vd(this.makeRequest(e,t))}async makeRequest(e,t){var d,h;const r=await e,a=r.maxRetries??this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);const{req:s,url:i,timeout:o}=this.buildRequest(r,{retryCount:a-t});if(await this.prepareRequest(s,{url:i,options:r}),an("request",i,r,s.headers),(d=r.signal)!=null&&d.aborted)throw new nt;const c=new AbortController,u=await this.fetchWithTimeout(i,s,o,c).catch(Do);if(u instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new nt;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new ai:new ni({cause:u})}const l=lg(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){const b=`retrying, ${t} attempts remaining`;return an(`response (error; ${b})`,u.status,i,l),this.retryRequest(r,t,l)}const m=await u.text().catch(b=>Do(b).message),f=pg(m),p=f?void 0:m;throw an(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,i,l,p),this.makeStatusError(u.status,f,p,l)}return{response:u,options:r,controller:c}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new ug(this,r,e)}buildURL(e,t){const r=yg(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Gd(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new D(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){const{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());const o=setTimeout(()=>a.abort(),r),c={signal:a.signal,...i};return c.method&&(c.method=c.method.toUpperCase()),this.fetch.call(void 0,e,c).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let a;const s=r==null?void 0:r["retry-after-ms"];if(s){const o=parseFloat(s);Number.isNaN(o)||(a=o)}const i=r==null?void 0:r["retry-after"];if(i&&!a){const o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){const o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Ia(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Vr}`}},Jd=class{constructor(e,t,r,a){za.set(this,void 0),ig(this,za,e),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new D("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await og(this,za,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(za=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}},ug=class extends Vd{constructor(e,t,r){super(t,async a=>new r(e,a.response,await Zd(a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}};const lg=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),dg={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Ie=n=>typeof n=="object"&&n!==null&&!Gd(n)&&Object.keys(n).every(e=>Kd(dg,e)),hg=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":Su(Deno.build.os),"X-Stainless-Arch":xu(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":Su(process.platform),"X-Stainless-Arch":xu(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=fg();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function fg(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}const xu=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Su=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Eu;const mg=()=>Eu??(Eu=hg()),pg=n=>{try{return JSON.parse(n)}catch{return}},gg=/^[a-z][a-z0-9+.-]*:/i,yg=n=>gg.test(n),Ia=n=>new Promise(e=>setTimeout(e,n)),Mi=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new D(`${n} must be an integer`);if(e<0)throw new D(`${n} must be a positive integer`);return e},Do=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(n)},xr=n=>{var e,t,r,a;if(typeof process<"u")return((e=nn==null?void 0:nn[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(a=(r=(t=Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:a.trim()};function Gd(n){if(!n)return!0;for(const e in n)return!1;return!0}function Kd(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function ku(n,e){for(const t in e){if(!Kd(e,t))continue;const r=t.toLowerCase();if(!r)continue;const a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}const Au=new Set(["authorization","api-key"]);function an(n,...e){if(typeof process<"u"&&(nn==null?void 0:nn.DEBUG)==="true"){const t=e.map(r=>{if(!r)return r;if(r.headers){const s={...r,headers:{...r.headers}};for(const i in r.headers)Au.has(i.toLowerCase())&&(s.headers[i]="REDACTED");return s}let a=null;for(const s in r)Au.has(s.toLowerCase())&&(a??(a={...r}),a[s]="REDACTED");return a??r});console.log(`OpenAI:DEBUG:${n}`,...t)}}const _g=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),bg=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",wg=n=>typeof(n==null?void 0:n.get)=="function",Ha=(n,e)=>{var r;const t=e.toLowerCase();if(wg(n)){const a=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(s,i,o)=>i+o.toUpperCase());for(const s of[e,t,e.toUpperCase(),a]){const i=n.get(s);if(i)return i}}for(const[a,s]of Object.entries(n))if(a.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s};function vs(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}let hc=class extends Jd{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}};class Ke extends Jd{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}}let ie=class{constructor(e){this._client=e}},Xd=class extends ie{list(e,t={},r){return Ie(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,vg,{query:t,...r})}},oi=class extends ie{constructor(){super(...arguments),this.messages=new Xd(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return Ie(e)?this.list({},e):this._client.getAPIList("/chat/completions",ci,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}};class ci extends Ke{}class vg extends Ke{}oi.ChatCompletionsPage=ci;oi.Messages=Xd;let ui=class extends ie{constructor(){super(...arguments),this.completions=new oi(this._client)}};ui.Completions=oi;ui.ChatCompletionsPage=ci;class Qd extends ie{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class Yd extends ie{create(e,t){return this._client.post("/audio/transcriptions",fn({body:e,...t,__metadata:{model:e.model}}))}}class eh extends ie{create(e,t){return this._client.post("/audio/translations",fn({body:e,...t,__metadata:{model:e.model}}))}}class Ra extends ie{constructor(){super(...arguments),this.transcriptions=new Yd(this._client),this.translations=new eh(this._client),this.speech=new Qd(this._client)}}Ra.Transcriptions=Yd;Ra.Translations=eh;Ra.Speech=Qd;let fc=class extends ie{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Ie(e)?this.list({},e):this._client.getAPIList("/batches",mc,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}};class mc extends Ke{}fc.BatchesPage=mc;class pc extends ie{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return Ie(e)?this.list({},e):this._client.getAPIList("/assistants",gc,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class gc extends Ke{}pc.AssistantsPage=gc;function Pu(n){return typeof n.parse=="function"}const sn=n=>(n==null?void 0:n.role)==="assistant",th=n=>(n==null?void 0:n.role)==="function",rh=n=>(n==null?void 0:n.role)==="tool";var gt=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},ye=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Uo,xs,Ss,Vn,Wn,Es,Jn,Zt,Gn,Ms,Fs,Wr,nh;class yc{constructor(){Uo.add(this),this.controller=new AbortController,xs.set(this,void 0),Ss.set(this,()=>{}),Vn.set(this,()=>{}),Wn.set(this,void 0),Es.set(this,()=>{}),Jn.set(this,()=>{}),Zt.set(this,{}),Gn.set(this,!1),Ms.set(this,!1),Fs.set(this,!1),Wr.set(this,!1),gt(this,xs,new Promise((e,t)=>{gt(this,Ss,e,"f"),gt(this,Vn,t,"f")}),"f"),gt(this,Wn,new Promise((e,t)=>{gt(this,Es,e,"f"),gt(this,Jn,t,"f")}),"f"),ye(this,xs,"f").catch(()=>{}),ye(this,Wn,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},ye(this,Uo,"m",nh).bind(this))},0)}_connected(){this.ended||(ye(this,Ss,"f").call(this),this._emit("connect"))}get ended(){return ye(this,Gn,"f")}get errored(){return ye(this,Ms,"f")}get aborted(){return ye(this,Fs,"f")}abort(){this.controller.abort()}on(e,t){return(ye(this,Zt,"f")[e]||(ye(this,Zt,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=ye(this,Zt,"f")[e];if(!r)return this;const a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(ye(this,Zt,"f")[e]||(ye(this,Zt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{gt(this,Wr,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){gt(this,Wr,!0,"f"),await ye(this,Wn,"f")}_emit(e,...t){if(ye(this,Gn,"f"))return;e==="end"&&(gt(this,Gn,!0,"f"),ye(this,Es,"f").call(this));const r=ye(this,Zt,"f")[e];if(r&&(ye(this,Zt,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){const a=t[0];!ye(this,Wr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),ye(this,Vn,"f").call(this,a),ye(this,Jn,"f").call(this,a),this._emit("end");return}if(e==="error"){const a=t[0];!ye(this,Wr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),ye(this,Vn,"f").call(this,a),ye(this,Jn,"f").call(this,a),this._emit("end")}}_emitFinal(){}}xs=new WeakMap,Ss=new WeakMap,Vn=new WeakMap,Wn=new WeakMap,Es=new WeakMap,Jn=new WeakMap,Zt=new WeakMap,Gn=new WeakMap,Ms=new WeakMap,Fs=new WeakMap,Wr=new WeakMap,Uo=new WeakSet,nh=function(e){if(gt(this,Ms,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new nt),e instanceof nt)return gt(this,Fs,!0,"f"),this._emit("abort",e);if(e instanceof D)return this._emit("error",e);if(e instanceof Error){const t=new D(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new D(String(e)))};function xg(n,e){const t={...n};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function _c(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function Sg(n,{parser:e,callback:t}){const r={...n};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),r}function ja(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Eg(n,e){return!e||!ah(e)?{...n,choices:n.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:bc(n,e)}function bc(n,e){const t=n.choices.map(r=>{var a;if(r.finish_reason==="length")throw new Fd;if(r.finish_reason==="content_filter")throw new Dd;return{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:((a=r.message.tool_calls)==null?void 0:a.map(s=>Ag(e,s)))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?kg(e,r.message.content):null}}});return{...n,choices:t}}function kg(n,e){var t,r;return((t=n.response_format)==null?void 0:t.type)!=="json_schema"?null:((r=n.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function Ag(n,e){var r;const t=(r=n.tools)==null?void 0:r.find(a=>{var s;return((s=a.function)==null?void 0:s.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:ja(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function Pg(n,e){var r;if(!n)return!1;const t=(r=n.tools)==null?void 0:r.find(a=>{var s;return((s=a.function)==null?void 0:s.name)===e.function.name});return ja(t)||(t==null?void 0:t.function.strict)||!1}function ah(n){var e;return _c(n.response_format)?!0:((e=n.tools)==null?void 0:e.some(t=>ja(t)||t.type==="function"&&t.function.strict===!0))??!1}function Og(n){for(const e of n??[]){if(e.type!=="function")throw new D(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new D(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var We=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Le,Bo,Ds,zo,Ho,Zo,sh,qo;const Ou=10;class ih extends yc{constructor(){super(...arguments),Le.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(th(e)||rh(e))&&e.content)this._emit("functionCallResult",e.content);else if(sn(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(sn(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new D("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),We(this,Le,"m",Bo).call(this)}async finalMessage(){return await this.done(),We(this,Le,"m",Ds).call(this)}async finalFunctionCall(){return await this.done(),We(this,Le,"m",zo).call(this)}async finalFunctionCallResult(){return await this.done(),We(this,Le,"m",Ho).call(this)}async totalUsage(){return await this.done(),We(this,Le,"m",Zo).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=We(this,Le,"m",Ds).call(this);t&&this._emit("finalMessage",t);const r=We(this,Le,"m",Bo).call(this);r&&this._emit("finalContent",r);const a=We(this,Le,"m",zo).call(this);a&&this._emit("finalFunctionCall",a);const s=We(this,Le,"m",Ho).call(this);s!=null&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",We(this,Le,"m",Zo).call(this))}async _createChatCompletion(e,t,r){const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),We(this,Le,"m",sh).call(this,t);const s=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(bc(s,t))}async _runChatCompletion(e,t,r){for(const a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var h;const a="function",{function_call:s="auto",stream:i,...o}=t,c=typeof s!="string"&&(s==null?void 0:s.name),{maxChatCompletions:u=Ou}=r||{},l={};for(const m of t.functions)l[m.name||m.function.name]=m;const d=t.functions.map(m=>({name:m.name||m.function.name,parameters:m.parameters,description:m.description}));for(const m of t.messages)this._addMessage(m,!1);for(let m=0;m<u;++m){const p=(h=(await this._createChatCompletion(e,{...o,function_call:s,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:h.message;if(!p)throw new D("missing message in ChatCompletion response");if(!p.function_call)return;const{name:g,arguments:w}=p.function_call,b=l[g];if(b){if(c&&c!==g){const O=`Invalid function_call: ${JSON.stringify(g)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:a,name:g,content:O});continue}}else{const O=`Invalid function_call: ${JSON.stringify(g)}. Available options are: ${d.map(T=>JSON.stringify(T.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:g,content:O});continue}let _;try{_=Pu(b)?await b.parse(w):w}catch(O){this._addMessage({role:a,name:g,content:O instanceof Error?O.message:String(O)});continue}const v=await b.function(_,this),E=We(this,Le,"m",qo).call(this,v);if(this._addMessage({role:a,name:g,content:E}),c)return}}async _runTools(e,t,r){var m,f,p;const a="tool",{tool_choice:s="auto",stream:i,...o}=t,c=typeof s!="string"&&((m=s==null?void 0:s.function)==null?void 0:m.name),{maxChatCompletions:u=Ou}=r||{},l=t.tools.map(g=>{if(ja(g)){if(!g.$callback)throw new D("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:g.$callback,name:g.function.name,description:g.function.description||"",parameters:g.function.parameters,parse:g.$parseRaw,strict:!0}}}return g}),d={};for(const g of l)g.type==="function"&&(d[g.function.name||g.function.function.name]=g.function);const h="tools"in t?l.map(g=>g.type==="function"?{type:"function",function:{name:g.function.name||g.function.function.name,parameters:g.function.parameters,description:g.function.description,strict:g.function.strict}}:g):void 0;for(const g of t.messages)this._addMessage(g,!1);for(let g=0;g<u;++g){const b=(f=(await this._createChatCompletion(e,{...o,tool_choice:s,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:f.message;if(!b)throw new D("missing message in ChatCompletion response");if(!((p=b.tool_calls)!=null&&p.length))return;for(const _ of b.tool_calls){if(_.type!=="function")continue;const v=_.id,{name:E,arguments:O}=_.function,T=d[E];if(T){if(c&&c!==E){const Z=`Invalid tool_call: ${JSON.stringify(E)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:a,tool_call_id:v,content:Z});continue}}else{const Z=`Invalid tool_call: ${JSON.stringify(E)}. Available options are: ${Object.keys(d).map(ae=>JSON.stringify(ae)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:v,content:Z});continue}let q;try{q=Pu(T)?await T.parse(O):O}catch(Z){const ae=Z instanceof Error?Z.message:String(Z);this._addMessage({role:a,tool_call_id:v,content:ae});continue}const K=await T.function(q,this),L=We(this,Le,"m",qo).call(this,K);if(this._addMessage({role:a,tool_call_id:v,content:L}),c)return}}}}Le=new WeakSet,Bo=function(){return We(this,Le,"m",Ds).call(this).content??null},Ds=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(sn(t)){const{function_call:r,...a}=t,s={...a,content:t.content??null,refusal:t.refusal??null};return r&&(s.function_call=r),s}}throw new D("stream ended without producing a ChatCompletionMessage with role=assistant")},zo=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){const a=this.messages[r];if(sn(a)&&(a!=null&&a.function_call))return a.function_call;if(sn(a)&&((e=a==null?void 0:a.tool_calls)!=null&&e.length))return(t=a.tool_calls.at(-1))==null?void 0:t.function}},Ho=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(th(t)&&t.content!=null||rh(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(r=>{var a;return r.role==="assistant"&&((a=r.tool_calls)==null?void 0:a.some(s=>s.type==="function"&&s.id===t.tool_call_id))}))return t.content}},Zo=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},sh=function(e){if(e.n!=null&&e.n>1)throw new D("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},qo=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class xa extends ih{static runFunctions(e,t,r){const a=new xa,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){const a=new xa,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}_addMessage(e,t=!0){super._addMessage(e,t),sn(e)&&e.content&&this._emit("content",e.content)}}const oh=1,ch=2,uh=4,lh=8,dh=16,hh=32,fh=64,mh=128,ph=256,gh=mh|ph,yh=dh|hh|gh|fh,_h=oh|ch|yh,bh=uh|lh,Tg=_h|bh,Ae={STR:oh,NUM:ch,ARR:uh,OBJ:lh,NULL:dh,BOOL:hh,NAN:fh,INFINITY:mh,MINUS_INFINITY:ph,INF:gh,SPECIAL:yh,ATOM:_h,COLLECTION:bh,ALL:Tg};class Ig extends Error{}class Rg extends Error{}function jg(n,e=Ae.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return Cg(n.trim(),e)}const Cg=(n,e)=>{const t=n.length;let r=0;const a=h=>{throw new Ig(`${h} at position ${r}`)},s=h=>{throw new Rg(`${h} at position ${r}`)},i=()=>(d(),r>=t&&a("Unexpected end of input"),n[r]==='"'?o():n[r]==="{"?c():n[r]==="["?u():n.substring(r,r+4)==="null"||Ae.NULL&e&&t-r<4&&"null".startsWith(n.substring(r))?(r+=4,null):n.substring(r,r+4)==="true"||Ae.BOOL&e&&t-r<4&&"true".startsWith(n.substring(r))?(r+=4,!0):n.substring(r,r+5)==="false"||Ae.BOOL&e&&t-r<5&&"false".startsWith(n.substring(r))?(r+=5,!1):n.substring(r,r+8)==="Infinity"||Ae.INFINITY&e&&t-r<8&&"Infinity".startsWith(n.substring(r))?(r+=8,1/0):n.substring(r,r+9)==="-Infinity"||Ae.MINUS_INFINITY&e&&1<t-r&&t-r<9&&"-Infinity".startsWith(n.substring(r))?(r+=9,-1/0):n.substring(r,r+3)==="NaN"||Ae.NAN&e&&t-r<3&&"NaN".startsWith(n.substring(r))?(r+=3,NaN):l()),o=()=>{const h=r;let m=!1;for(r++;r<t&&(n[r]!=='"'||m&&n[r-1]==="\\");)m=n[r]==="\\"?!m:!1,r++;if(n.charAt(r)=='"')try{return JSON.parse(n.substring(h,++r-Number(m)))}catch(f){s(String(f))}else if(Ae.STR&e)try{return JSON.parse(n.substring(h,r-Number(m))+'"')}catch{return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},c=()=>{r++,d();const h={};try{for(;n[r]!=="}";){if(d(),r>=t&&Ae.OBJ&e)return h;const m=o();d(),r++;try{const f=i();Object.defineProperty(h,m,{value:f,writable:!0,enumerable:!0,configurable:!0})}catch(f){if(Ae.OBJ&e)return h;throw f}d(),n[r]===","&&r++}}catch{if(Ae.OBJ&e)return h;a("Expected '}' at end of object")}return r++,h},u=()=>{r++;const h=[];try{for(;n[r]!=="]";)h.push(i()),d(),n[r]===","&&r++}catch{if(Ae.ARR&e)return h;a("Expected ']' at end of array")}return r++,h},l=()=>{if(r===0){n==="-"&&Ae.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n)}catch(m){if(Ae.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}s(String(m))}}const h=r;for(n[r]==="-"&&r++;n[r]&&!",]}".includes(n[r]);)r++;r==t&&!(Ae.NUM&e)&&a("Unterminated number literal");try{return JSON.parse(n.substring(h,r))}catch{n.substring(h,r)==="-"&&Ae.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(f){s(String(f))}}},d=()=>{for(;r<t&&` 
\r	`.includes(n[r]);)r++};return i()},Tu=n=>jg(n,Ae.ALL^Ae.NUM);var Lr=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},me=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ve,Dt,Mr,Kt,Fi,Za,Di,Ui,Bi,qa,zi,Iu;class Sa extends ih{constructor(e){super(),ve.add(this),Dt.set(this,void 0),Mr.set(this,void 0),Kt.set(this,void 0),Lr(this,Dt,e,"f"),Lr(this,Mr,[],"f")}get currentChatCompletionSnapshot(){return me(this,Kt,"f")}static fromReadableStream(e){const t=new Sa(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const a=new Sa(t);return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){var i;super._createChatCompletion;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),me(this,ve,"m",Fi).call(this);const s=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of s)me(this,ve,"m",Di).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new nt;return this._addChatCompletion(me(this,ve,"m",qa).call(this))}async _fromReadableStream(e,t){var i;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),me(this,ve,"m",Fi).call(this),this._connected();const a=va.fromReadableStream(e,this.controller);let s;for await(const o of a)s&&s!==o.id&&this._addChatCompletion(me(this,ve,"m",qa).call(this)),me(this,ve,"m",Di).call(this,o),s=o.id;if((i=a.controller.signal)!=null&&i.aborted)throw new nt;return this._addChatCompletion(me(this,ve,"m",qa).call(this))}[(Dt=new WeakMap,Mr=new WeakMap,Kt=new WeakMap,ve=new WeakSet,Fi=function(){this.ended||Lr(this,Kt,void 0,"f")},Za=function(t){let r=me(this,Mr,"f")[t.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},me(this,Mr,"f")[t.index]=r,r)},Di=function(t){var a,s,i,o,c,u,l,d,h,m,f,p,g,w,b;if(this.ended)return;const r=me(this,ve,"m",Iu).call(this,t);this._emit("chunk",t,r);for(const _ of t.choices){const v=r.choices[_.index];_.delta.content!=null&&((a=v.message)==null?void 0:a.role)==="assistant"&&((s=v.message)!=null&&s.content)&&(this._emit("content",_.delta.content,v.message.content),this._emit("content.delta",{delta:_.delta.content,snapshot:v.message.content,parsed:v.message.parsed})),_.delta.refusal!=null&&((i=v.message)==null?void 0:i.role)==="assistant"&&((o=v.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:_.delta.refusal,snapshot:v.message.refusal}),((c=_.logprobs)==null?void 0:c.content)!=null&&((u=v.message)==null?void 0:u.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=_.logprobs)==null?void 0:l.content,snapshot:((d=v.logprobs)==null?void 0:d.content)??[]}),((h=_.logprobs)==null?void 0:h.refusal)!=null&&((m=v.message)==null?void 0:m.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(f=_.logprobs)==null?void 0:f.refusal,snapshot:((p=v.logprobs)==null?void 0:p.refusal)??[]});const E=me(this,ve,"m",Za).call(this,v);v.finish_reason&&(me(this,ve,"m",Bi).call(this,v),E.current_tool_call_index!=null&&me(this,ve,"m",Ui).call(this,v,E.current_tool_call_index));for(const O of _.delta.tool_calls??[])E.current_tool_call_index!==O.index&&(me(this,ve,"m",Bi).call(this,v),E.current_tool_call_index!=null&&me(this,ve,"m",Ui).call(this,v,E.current_tool_call_index)),E.current_tool_call_index=O.index;for(const O of _.delta.tool_calls??[]){const T=(g=v.message.tool_calls)==null?void 0:g[O.index];T!=null&&T.type&&((T==null?void 0:T.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(w=T.function)==null?void 0:w.name,index:O.index,arguments:T.function.arguments,parsed_arguments:T.function.parsed_arguments,arguments_delta:((b=O.function)==null?void 0:b.arguments)??""}):(T==null||T.type,void 0))}}},Ui=function(t,r){var i,o,c;if(me(this,ve,"m",Za).call(this,t).done_tool_calls.has(r))return;const s=(i=t.message.tool_calls)==null?void 0:i[r];if(!s)throw new Error("no tool call snapshot");if(!s.type)throw new Error("tool call snapshot missing `type`");if(s.type==="function"){const u=(c=(o=me(this,Dt,"f"))==null?void 0:o.tools)==null?void 0:c.find(l=>l.type==="function"&&l.function.name===s.function.name);this._emit("tool_calls.function.arguments.done",{name:s.function.name,index:r,arguments:s.function.arguments,parsed_arguments:ja(u)?u.$parseRaw(s.function.arguments):u!=null&&u.function.strict?JSON.parse(s.function.arguments):null})}else s.type},Bi=function(t){var a,s;const r=me(this,ve,"m",Za).call(this,t);if(t.message.content&&!r.content_done){r.content_done=!0;const i=me(this,ve,"m",zi).call(this);this._emit("content.done",{content:t.message.content,parsed:i?i.$parseRaw(t.message.content):null})}t.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(a=t.logprobs)!=null&&a.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(s=t.logprobs)!=null&&s.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},qa=function(){if(this.ended)throw new D("stream has ended, this shouldn't happen");const t=me(this,Kt,"f");if(!t)throw new D("request ended without sending any chunks");return Lr(this,Kt,void 0,"f"),Lr(this,Mr,[],"f"),Ng(t,me(this,Dt,"f"))},zi=function(){var r;const t=(r=me(this,Dt,"f"))==null?void 0:r.response_format;return _c(t)?t:null},Iu=function(t){var r,a,s,i;let o=me(this,Kt,"f");const{choices:c,...u}=t;o?Object.assign(o,u):o=Lr(this,Kt,{...u,choices:[]},"f");for(const{delta:l,finish_reason:d,index:h,logprobs:m=null,...f}of t.choices){let p=o.choices[h];if(p||(p=o.choices[h]={finish_reason:d,index:h,message:{},logprobs:m,...f}),m)if(!p.logprobs)p.logprobs=Object.assign({},m);else{const{content:O,refusal:T,...q}=m;Object.assign(p.logprobs,q),O&&((r=p.logprobs).content??(r.content=[]),p.logprobs.content.push(...O)),T&&((a=p.logprobs).refusal??(a.refusal=[]),p.logprobs.refusal.push(...T))}if(d&&(p.finish_reason=d,me(this,Dt,"f")&&ah(me(this,Dt,"f")))){if(d==="length")throw new Fd;if(d==="content_filter")throw new Dd}if(Object.assign(p,f),!l)continue;const{content:g,refusal:w,function_call:b,role:_,tool_calls:v,...E}=l;if(Object.assign(p.message,E),w&&(p.message.refusal=(p.message.refusal||"")+w),_&&(p.message.role=_),b&&(p.message.function_call?(b.name&&(p.message.function_call.name=b.name),b.arguments&&((s=p.message.function_call).arguments??(s.arguments=""),p.message.function_call.arguments+=b.arguments)):p.message.function_call=b),g&&(p.message.content=(p.message.content||"")+g,!p.message.refusal&&me(this,ve,"m",zi).call(this)&&(p.message.parsed=Tu(p.message.content))),v){p.message.tool_calls||(p.message.tool_calls=[]);for(const{index:O,id:T,type:q,function:K,...L}of v){const Z=(i=p.message.tool_calls)[O]??(i[O]={});Object.assign(Z,L),T&&(Z.id=T),q&&(Z.type=q),K&&(Z.function??(Z.function={name:K.name??"",arguments:""})),K!=null&&K.name&&(Z.function.name=K.name),K!=null&&K.arguments&&(Z.function.arguments+=K.arguments,Pg(me(this,Dt,"f"),Z)&&(Z.function.parsed_arguments=Tu(Z.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new va(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Ng(n,e){const{id:t,choices:r,created:a,model:s,system_fingerprint:i,...o}=n,c={...o,id:t,choices:r.map(({message:u,finish_reason:l,index:d,logprobs:h,...m})=>{if(!l)throw new D(`missing finish_reason for choice ${d}`);const{content:f=null,function_call:p,tool_calls:g,...w}=u,b=u.role;if(!b)throw new D(`missing role for choice ${d}`);if(p){const{arguments:_,name:v}=p;if(_==null)throw new D(`missing function_call.arguments for choice ${d}`);if(!v)throw new D(`missing function_call.name for choice ${d}`);return{...m,message:{content:f,function_call:{arguments:_,name:v},role:b,refusal:u.refusal??null},finish_reason:l,index:d,logprobs:h}}return g?{...m,index:d,finish_reason:l,logprobs:h,message:{...w,role:b,content:f,refusal:u.refusal??null,tool_calls:g.map((_,v)=>{const{function:E,type:O,id:T,...q}=_,{arguments:K,name:L,...Z}=E||{};if(T==null)throw new D(`missing choices[${d}].tool_calls[${v}].id
${Va(n)}`);if(O==null)throw new D(`missing choices[${d}].tool_calls[${v}].type
${Va(n)}`);if(L==null)throw new D(`missing choices[${d}].tool_calls[${v}].function.name
${Va(n)}`);if(K==null)throw new D(`missing choices[${d}].tool_calls[${v}].function.arguments
${Va(n)}`);return{...q,id:T,type:O,function:{...Z,name:L,arguments:K}}})}}:{...m,message:{...w,content:f,role:b,refusal:u.refusal??null},finish_reason:l,index:d,logprobs:h}}),created:a,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}};return Eg(c,e)}function Va(n){return JSON.stringify(n)}class on extends Sa{static fromReadableStream(e){const t=new on(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){const a=new on(null),s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){const a=new on(t),s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}}let wh=class extends ie{parse(e,t){return Og(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(r=>bc(r,e))}runFunctions(e,t){return e.stream?on.runFunctions(this._client,e,t):xa.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?on.runTools(this._client,e,t):xa.runTools(this._client,e,t)}stream(e,t){return Sa.createChatCompletion(this._client,e,t)}};class Vo extends ie{constructor(){super(...arguments),this.completions=new wh(this._client)}}(function(n){n.Completions=wh})(Vo||(Vo={}));class vh extends ie{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class xh extends ie{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class li extends ie{constructor(){super(...arguments),this.sessions=new vh(this._client),this.transcriptionSessions=new xh(this._client)}}li.Sessions=vh;li.TranscriptionSessions=xh;var F=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Xe=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Ce,Wo,jt,ks,yt,Sr,Xr,vr,Us,tt,As,Ps,ta,Kn,Xn,Ru,ju,Cu,Nu,$u,Lu,Mu;class wt extends yc{constructor(){super(...arguments),Ce.add(this),Wo.set(this,[]),jt.set(this,{}),ks.set(this,{}),yt.set(this,void 0),Sr.set(this,void 0),Xr.set(this,void 0),vr.set(this,void 0),Us.set(this,void 0),tt.set(this,void 0),As.set(this,void 0),Ps.set(this,void 0),ta.set(this,void 0)}[(Wo=new WeakMap,jt=new WeakMap,ks=new WeakMap,yt=new WeakMap,Sr=new WeakMap,Xr=new WeakMap,vr=new WeakMap,Us=new WeakMap,tt=new WeakMap,As=new WeakMap,Ps=new WeakMap,ta=new WeakMap,Ce=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new wt;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var s;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const a=va.fromReadableStream(e,this.controller);for await(const i of a)F(this,Ce,"m",Kn).call(this,i);if((s=a.controller.signal)!=null&&s.aborted)throw new nt;return this._addRun(F(this,Ce,"m",Xn).call(this))}toReadableStream(){return new va(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a,s){const i=new wt;return i._run(()=>i._runToolAssistantStream(e,t,r,a,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,a,s){var u;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const o={...a,stream:!0},c=await e.submitToolOutputs(t,r,o,{...s,signal:this.controller.signal});this._connected();for await(const l of c)F(this,Ce,"m",Kn).call(this,l);if((u=c.controller.signal)!=null&&u.aborted)throw new nt;return this._addRun(F(this,Ce,"m",Xn).call(this))}static createThreadAssistantStream(e,t,r){const a=new wt;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){const s=new wt;return s._run(()=>s._runAssistantStream(e,t,r,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return F(this,As,"f")}currentRun(){return F(this,Ps,"f")}currentMessageSnapshot(){return F(this,yt,"f")}currentRunStepSnapshot(){return F(this,ta,"f")}async finalRunSteps(){return await this.done(),Object.values(F(this,jt,"f"))}async finalMessages(){return await this.done(),Object.values(F(this,ks,"f"))}async finalRun(){if(await this.done(),!F(this,Sr,"f"))throw Error("Final run was not received.");return F(this,Sr,"f")}async _createThreadAssistantStream(e,t,r){var o;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const s={...t,stream:!0},i=await e.createAndRun(s,{...r,signal:this.controller.signal});this._connected();for await(const c of i)F(this,Ce,"m",Kn).call(this,c);if((o=i.controller.signal)!=null&&o.aborted)throw new nt;return this._addRun(F(this,Ce,"m",Xn).call(this))}async _createAssistantStream(e,t,r,a){var c;const s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...r,stream:!0},o=await e.create(t,i,{...a,signal:this.controller.signal});this._connected();for await(const u of o)F(this,Ce,"m",Kn).call(this,u);if((c=o.controller.signal)!=null&&c.aborted)throw new nt;return this._addRun(F(this,Ce,"m",Xn).call(this))}static accumulateDelta(e,t){for(const[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let s=e[r];if(s==null){e[r]=a;continue}if(r==="index"||r==="type"){e[r]=a;continue}if(typeof s=="string"&&typeof a=="string")s+=a;else if(typeof s=="number"&&typeof a=="number")s+=a;else if(vs(s)&&vs(a))s=this.accumulateDelta(s,a);else if(Array.isArray(s)&&Array.isArray(a)){if(s.every(i=>typeof i=="string"||typeof i=="number")){s.push(...a);continue}for(const i of a){if(!vs(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=s[o];c==null?s.push(i):s[o]=this.accumulateDelta(c,i)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${s}`);e[r]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a,s){return await this._createToolAssistantStream(r,e,t,a,s)}}Kn=function(e){if(!this.ended)switch(Xe(this,As,e,"f"),F(this,Ce,"m",Cu).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":F(this,Ce,"m",Mu).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":F(this,Ce,"m",ju).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":F(this,Ce,"m",Ru).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Xn=function(){if(this.ended)throw new D("stream has ended, this shouldn't happen");if(!F(this,Sr,"f"))throw Error("Final run has not been received");return F(this,Sr,"f")},Ru=function(e){const[t,r]=F(this,Ce,"m",$u).call(this,e,F(this,yt,"f"));Xe(this,yt,t,"f"),F(this,ks,"f")[t.id]=t;for(const a of r){const s=t.content[a.index];(s==null?void 0:s.type)=="text"&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const a of e.data.delta.content){if(a.type=="text"&&a.text){let s=a.text,i=t.content[a.index];if(i&&i.type=="text")this._emit("textDelta",s,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(a.index!=F(this,Xr,"f")){if(F(this,vr,"f"))switch(F(this,vr,"f").type){case"text":this._emit("textDone",F(this,vr,"f").text,F(this,yt,"f"));break;case"image_file":this._emit("imageFileDone",F(this,vr,"f").image_file,F(this,yt,"f"));break}Xe(this,Xr,a.index,"f")}Xe(this,vr,t.content[a.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(F(this,Xr,"f")!==void 0){const a=e.data.content[F(this,Xr,"f")];if(a)switch(a.type){case"image_file":this._emit("imageFileDone",a.image_file,F(this,yt,"f"));break;case"text":this._emit("textDone",a.text,F(this,yt,"f"));break}}F(this,yt,"f")&&this._emit("messageDone",e.data),Xe(this,yt,void 0,"f")}},ju=function(e){const t=F(this,Ce,"m",Nu).call(this,e);switch(Xe(this,ta,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const s of r.step_details.tool_calls)s.index==F(this,Us,"f")?this._emit("toolCallDelta",s,t.step_details.tool_calls[s.index]):(F(this,tt,"f")&&this._emit("toolCallDone",F(this,tt,"f")),Xe(this,Us,s.index,"f"),Xe(this,tt,t.step_details.tool_calls[s.index],"f"),F(this,tt,"f")&&this._emit("toolCallCreated",F(this,tt,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Xe(this,ta,void 0,"f"),e.data.step_details.type=="tool_calls"&&F(this,tt,"f")&&(this._emit("toolCallDone",F(this,tt,"f")),Xe(this,tt,void 0,"f")),this._emit("runStepDone",e.data,t);break}},Cu=function(e){F(this,Wo,"f").push(e),this._emit("event",e)},Nu=function(e){switch(e.event){case"thread.run.step.created":return F(this,jt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=F(this,jt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const a=wt.accumulateDelta(t,r.delta);F(this,jt,"f")[e.data.id]=a}return F(this,jt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":F(this,jt,"f")[e.data.id]=e.data;break}if(F(this,jt,"f")[e.data.id])return F(this,jt,"f")[e.data.id];throw new Error("No snapshot available")},$u=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(const s of a.delta.content)if(s.index in t.content){let i=t.content[s.index];t.content[s.index]=F(this,Ce,"m",Lu).call(this,s,i)}else t.content[s.index]=s,r.push(s);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Lu=function(e,t){return wt.accumulateDelta(t,e)},Mu=function(e){switch(Xe(this,Ps,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Xe(this,Sr,e.data,"f"),F(this,tt,"f")&&(this._emit("toolCallDone",F(this,tt,"f")),Xe(this,tt,void 0,"f"));break}};let wc=class extends ie{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return Ie(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,vc,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}};class vc extends Ke{}wc.MessagesPage=vc;class xc extends ie{retrieve(e,t,r,a={},s){return Ie(a)?this.retrieve(e,t,r,{},a):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,t,r={},a){return Ie(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Sc,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}}class Sc extends Ke{}xc.RunStepsPage=Sc;class Ca extends ie{constructor(){super(...arguments),this.steps=new xc(this._client)}create(e,t,r){const{include:a,...s}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:a},body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return Ie(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Ec,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const a=await this.create(e,t,r);return await this.poll(e,a.id,r)}createAndStream(e,t,r){return wt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){const a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:s,response:i}=await this.retrieve(e,t,{...r,headers:{...r==null?void 0:r.headers,...a}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const c=i.headers.get("openai-poll-after-ms");if(c){const u=parseInt(c);isNaN(u)||(o=u)}}await Ia(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,r){return wt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,a){const s=await this.submitToolOutputs(e,t,r,a);return await this.poll(e,s.id,a)}submitToolOutputsStream(e,t,r,a){return wt.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,a)}}class Ec extends Ke{}Ca.RunsPage=Ec;Ca.Steps=xc;Ca.RunStepsPage=Sc;class _n extends ie{constructor(){super(...arguments),this.runs=new Ca(this._client),this.messages=new wc(this._client)}create(e={},t){return Ie(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return wt.createThreadAssistantStream(e,this._client.beta.threads,t)}}_n.Runs=Ca;_n.RunsPage=Ec;_n.Messages=wc;_n.MessagesPage=vc;let bn=class extends ie{constructor(){super(...arguments),this.realtime=new li(this._client),this.chat=new Vo(this._client),this.assistants=new pc(this._client),this.threads=new _n(this._client)}};bn.Realtime=li;bn.Assistants=pc;bn.AssistantsPage=gc;bn.Threads=_n;let Sh=class extends ie{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};class Eh extends ie{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}let kc=class extends ie{create(e,t){return this._client.post("/files",fn({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Ie(e)?this.list({},e):this._client.getAPIList("/files",Ac,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){const a=new Set(["processed","error","deleted"]),s=Date.now();let i=await this.retrieve(e);for(;!i.status||!a.has(i.status);)if(await Ia(t),i=await this.retrieve(e),Date.now()-s>r)throw new ai({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}};class Ac extends Ke{}kc.FileObjectsPage=Ac;class Pc extends ie{list(e,t={},r){return Ie(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Oc,{query:t,...r})}}class Oc extends Ke{}Pc.FineTuningJobCheckpointsPage=Oc;class wn extends ie{constructor(){super(...arguments),this.checkpoints=new Pc(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Ie(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Tc,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return Ie(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Ic,{query:t,...r})}}class Tc extends Ke{}class Ic extends Ke{}wn.FineTuningJobsPage=Tc;wn.FineTuningJobEventsPage=Ic;wn.Checkpoints=Pc;wn.FineTuningJobCheckpointsPage=Oc;class Na extends ie{constructor(){super(...arguments),this.jobs=new wn(this._client)}}Na.Jobs=wn;Na.FineTuningJobsPage=Tc;Na.FineTuningJobEventsPage=Ic;class kh extends ie{createVariation(e,t){return this._client.post("/images/variations",fn({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",fn({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}let Rc=class extends ie{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",jc,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}};class jc extends hc{}Rc.ModelsPage=jc;class Ah extends ie{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function $g(n,e){return!e||!Mg(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(r=>({...r,parsed:null}))}:t)}:Ph(n,e)}function Ph(n,e){const t=n.output.map(a=>{if(a.type==="function_call")return{...a,parsed_arguments:Ug(e,a)};if(a.type==="message"){const s=a.content.map(i=>i.type==="output_text"?{...i,parsed:Lg(e,i.text)}:i);return{...a,content:s}}return a}),r=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||Oh(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const a of r.output)if(a.type==="message"){for(const s of a.content)if(s.type==="output_text"&&s.parsed!==null)return s.parsed}return null}}),r}function Lg(n,e){var t,r,a,s;return((r=(t=n.text)==null?void 0:t.format)==null?void 0:r.type)!=="json_schema"?null:"$parseRaw"in((a=n.text)==null?void 0:a.format)?((s=n.text)==null?void 0:s.format).$parseRaw(e):JSON.parse(e)}function Mg(n){var e;return!!_c((e=n.text)==null?void 0:e.format)}function Fg(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Dg(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function Ug(n,e){const t=Dg(n.tools??[],e.name);return{...e,...e,parsed_arguments:Fg(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function Oh(n){const e=[];for(const t of n.output)if(t.type==="message")for(const r of t.content)r.type==="output_text"&&e.push(r.text);n.output_text=e.join("")}class Th extends ie{list(e,t={},r){return Ie(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,zg,{query:t,...r})}}var Fr=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Xt=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Dr,Wa,Qt,Ja,Fu,Du,Uu,Bu;class Cc extends yc{constructor(e){super(),Dr.add(this),Wa.set(this,void 0),Qt.set(this,void 0),Ja.set(this,void 0),Fr(this,Wa,e,"f")}static createResponse(e,t,r){const a=new Cc(t);return a._run(()=>a._createResponse(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createResponse(e,t,r){var i;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),Xt(this,Dr,"m",Fu).call(this);const s=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of s)Xt(this,Dr,"m",Du).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new nt;return Xt(this,Dr,"m",Uu).call(this)}[(Wa=new WeakMap,Qt=new WeakMap,Ja=new WeakMap,Dr=new WeakSet,Fu=function(){this.ended||Fr(this,Qt,void 0,"f")},Du=function(t){if(this.ended)return;const r=Xt(this,Dr,"m",Bu).call(this,t);switch(this._emit("event",t),t.type){case"response.output_text.delta":{const a=r.output[t.output_index];if(!a)throw new D(`missing output at index ${t.output_index}`);if(a.type==="message"){const s=a.content[t.content_index];if(!s)throw new D(`missing content at index ${t.content_index}`);if(s.type!=="output_text")throw new D(`expected content to be 'output_text', got ${s.type}`);this._emit("response.output_text.delta",{...t,snapshot:s.text})}break}case"response.function_call_arguments.delta":{const a=r.output[t.output_index];if(!a)throw new D(`missing output at index ${t.output_index}`);a.type==="function_call"&&this._emit("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:this._emit(t.type,t);break}},Uu=function(){if(this.ended)throw new D("stream has ended, this shouldn't happen");const t=Xt(this,Qt,"f");if(!t)throw new D("request ended without sending any events");Fr(this,Qt,void 0,"f");const r=Bg(t,Xt(this,Wa,"f"));return Fr(this,Ja,r,"f"),r},Bu=function(t){let r=Xt(this,Qt,"f");if(!r){if(t.type!=="response.created")throw new D(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return r=Fr(this,Qt,t.response,"f"),r}switch(t.type){case"response.output_item.added":{r.output.push(t.item);break}case"response.content_part.added":{const a=r.output[t.output_index];if(!a)throw new D(`missing output at index ${t.output_index}`);a.type==="message"&&a.content.push(t.part);break}case"response.output_text.delta":{const a=r.output[t.output_index];if(!a)throw new D(`missing output at index ${t.output_index}`);if(a.type==="message"){const s=a.content[t.content_index];if(!s)throw new D(`missing content at index ${t.content_index}`);if(s.type!=="output_text")throw new D(`expected content to be 'output_text', got ${s.type}`);s.text+=t.delta}break}case"response.function_call_arguments.delta":{const a=r.output[t.output_index];if(!a)throw new D(`missing output at index ${t.output_index}`);a.type==="function_call"&&(a.arguments+=t.delta);break}case"response.completed":{Fr(this,Qt,t.response,"f");break}}return r},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Xt(this,Ja,"f");if(!e)throw new D("stream ended without producing a ChatCompletion");return e}}function Bg(n,e){return $g(n,e)}class Nc extends ie{constructor(){super(...arguments),this.inputItems=new Th(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&Oh(r),r))}retrieve(e,t={},r){return Ie(t)?this.retrieve(e,{},t):this._client.get(`/responses/${e}`,{query:t,...r})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(r=>Ph(r,e))}stream(e,t){return Cc.createResponse(this._client,e,t)}}class zg extends Ke{}Nc.InputItems=Th;class Ih extends ie{create(e,t,r){return this._client.post(`/uploads/${e}/parts`,fn({body:t,...r}))}}class $c extends ie{constructor(){super(...arguments),this.parts=new Ih(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}}$c.Parts=Ih;const Hg=async n=>{const e=await Promise.allSettled(n),t=e.filter(a=>a.status==="rejected");if(t.length){for(const a of t)console.error(a.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const r=[];for(const a of e)a.status==="fulfilled"&&r.push(a.value);return r};class di extends ie{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return Ie(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,hi,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const a=await this.create(e,t,r);return await this.poll(e,a.id,r)}async poll(e,t,r){const a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const s=await this.retrieve(e,t,{...r,headers:a}).withResponse(),i=s.data;switch(i.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const c=s.response.headers.get("openai-poll-after-ms");if(c){const u=parseInt(c);isNaN(u)||(o=u)}}await Ia(o);break;case"failed":case"completed":return i}}}async upload(e,t,r){const a=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:a.id},r)}async uploadAndPoll(e,t,r){const a=await this.upload(e,t,r);return await this.poll(e,a.id,r)}content(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Lc,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class hi extends Ke{}class Lc extends hc{}di.VectorStoreFilesPage=hi;di.FileContentResponsesPage=Lc;class Rh extends ie{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const a=await this.create(e,t);return await this.poll(e,a.id,r)}listFiles(e,t,r={},a){return Ie(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,hi,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}async poll(e,t,r){const a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:s,response:i}=await this.retrieve(e,t,{...r,headers:a}).withResponse();switch(s.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const c=i.headers.get("openai-poll-after-ms");if(c){const u=parseInt(c);isNaN(u)||(o=u)}}await Ia(o);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},a){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const s=(a==null?void 0:a.maxConcurrency)??5,i=Math.min(s,t.length),o=this._client,c=t.values(),u=[...r];async function l(h){for(let m of h){const f=await o.files.create({file:m,purpose:"assistants"},a);u.push(f.id)}}const d=Array(i).fill(c).map(l);return await Hg(d),await this.createAndPoll(e,{file_ids:u})}}class pr extends ie{constructor(){super(...arguments),this.files=new di(this._client),this.fileBatches=new Rh(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return Ie(e)?this.list({},e):this._client.getAPIList("/vector_stores",Mc,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}search(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/search`,Fc,{body:t,method:"post",...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class Mc extends Ke{}class Fc extends hc{}pr.VectorStoresPage=Mc;pr.VectorStoreSearchResponsesPage=Fc;pr.Files=di;pr.VectorStoreFilesPage=hi;pr.FileContentResponsesPage=Lc;pr.FileBatches=Rh;var Zg={},jh;let Y=class extends cg{constructor({baseURL:e=xr("OPENAI_BASE_URL"),apiKey:t=xr("OPENAI_API_KEY"),organization:r=xr("OPENAI_ORG_ID")??null,project:a=xr("OPENAI_PROJECT_ID")??null,...s}={}){if(t===void 0)throw new D("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:r,project:a,...s,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&bg())throw new D(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Sh(this),this.chat=new ui(this),this.embeddings=new Eh(this),this.files=new kc(this),this.images=new kh(this),this.audio=new Ra(this),this.moderations=new Ah(this),this.models=new Rc(this),this.fineTuning=new Na(this),this.vectorStores=new pr(this),this.beta=new bn(this),this.batches=new fc(this),this.uploads=new $c(this),this.responses=new Nc(this),this._options=i,this.apiKey=t,this.organization=r,this.project=a}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return Zp(e,{arrayFormat:"brackets"})}};jh=Y;Y.OpenAI=jh;Y.DEFAULT_TIMEOUT=6e5;Y.OpenAIError=D;Y.APIError=Ge;Y.APIConnectionError=ni;Y.APIConnectionTimeoutError=ai;Y.APIUserAbortError=nt;Y.NotFoundError=Cd;Y.ConflictError=Nd;Y.RateLimitError=Ld;Y.BadRequestError=Id;Y.AuthenticationError=Rd;Y.InternalServerError=Md;Y.PermissionDeniedError=jd;Y.UnprocessableEntityError=$d;Y.toFile=Hd;Y.fileFromPath=Od;Y.Completions=Sh;Y.Chat=ui;Y.ChatCompletionsPage=ci;Y.Embeddings=Eh;Y.Files=kc;Y.FileObjectsPage=Ac;Y.Images=kh;Y.Audio=Ra;Y.Moderations=Ah;Y.Models=Rc;Y.ModelsPage=jc;Y.FineTuning=Na;Y.VectorStores=pr;Y.VectorStoresPage=Mc;Y.VectorStoreSearchResponsesPage=Fc;Y.Beta=bn;Y.Batches=fc;Y.BatchesPage=mc;Y.Uploads=$c;Y.Responses=Nc;let qg=class extends Y{constructor({baseURL:e=xr("OPENAI_BASE_URL"),apiKey:t=xr("AZURE_OPENAI_API_KEY"),apiVersion:r=xr("OPENAI_API_VERSION"),endpoint:a,deployment:s,azureADTokenProvider:i,dangerouslyAllowBrowser:o,...c}={}){if(!r)throw new D("The OPENAI_API_VERSION environment variable is missing or empty; either provide it, or instantiate the AzureOpenAI client with an apiVersion option, like new AzureOpenAI({ apiVersion: 'My API Version' }).");if(typeof i=="function"&&(o=!0),!i&&!t)throw new D("Missing credentials. Please pass one of `apiKey` and `azureADTokenProvider`, or set the `AZURE_OPENAI_API_KEY` environment variable.");if(i&&t)throw new D("The `apiKey` and `azureADTokenProvider` arguments are mutually exclusive; only one can be passed at a time.");if(t??(t=zu),c.defaultQuery={...c.defaultQuery,"api-version":r},e){if(a)throw new D("baseURL and endpoint are mutually exclusive")}else{if(a||(a=Zg.AZURE_OPENAI_ENDPOINT),!a)throw new D("Must provide one of the `baseURL` or `endpoint` arguments, or the `AZURE_OPENAI_ENDPOINT` environment variable");e=`${a}/openai`}super({apiKey:t,baseURL:e,...c,...o!==void 0?{dangerouslyAllowBrowser:o}:{}}),this.apiVersion="",this._azureADTokenProvider=i,this.apiVersion=r,this.deploymentName=s}buildRequest(e,t={}){var r;if(Vg.has(e.path)&&e.method==="post"&&e.body!==void 0){if(!vs(e.body))throw new Error("Expected request body to be an object");const a=this.deploymentName||e.body.model||((r=e.__metadata)==null?void 0:r.model);a!==void 0&&!this.baseURL.includes("/deployments")&&(e.path=`/deployments/${a}${e.path}`)}return super.buildRequest(e,t)}async _getAzureADToken(){if(typeof this._azureADTokenProvider=="function"){const e=await this._azureADTokenProvider();if(!e||typeof e!="string")throw new D(`Expected 'azureADTokenProvider' argument to return a string but it returned ${e}`);return e}}authHeaders(e){return{}}async prepareOptions(e){var r;if((r=e.headers)!=null&&r["api-key"])return super.prepareOptions(e);const t=await this._getAzureADToken();if(e.headers??(e.headers={}),t)e.headers.Authorization=`Bearer ${t}`;else if(this.apiKey!==zu)e.headers["api-key"]=this.apiKey;else throw new D("Unable to handle auth");return super.prepareOptions(e)}};const Vg=new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations"]),zu="<Missing Key>";function Hu(n,e=Dc){n=n.trim();const t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function Dc(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="";const t=[];let r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch{return null}}var Wg=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const Jg=lc(Wg);var Ch={exports:{}};const Gg=/[\p{Lu}]/u,Kg=/[\p{Ll}]/u,Zu=/^[\p{Lu}](?![\p{Lu}])/gu,Nh=/([\p{Alpha}\p{N}_]|$)/u,$h=/[_.\- ]+/,Xg=new RegExp("^"+$h.source),qu=new RegExp($h.source+Nh.source,"gu"),Vu=new RegExp("\\d+"+Nh.source,"gu"),Qg=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){const o=n[i];r&&Gg.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&Kg.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},Yg=(n,e)=>(Zu.lastIndex=0,n.replace(Zu,t=>e(t))),ey=(n,e)=>(qu.lastIndex=0,Vu.lastIndex=0,n.replace(qu,(t,r)=>e(r)).replace(Vu,t=>e(t))),Lh=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Qg(n,t,r)),n=n.replace(Xg,""),e.preserveConsecutiveUppercase?n=Yg(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),ey(n,r))};Ch.exports=Lh;Ch.exports.default=Lh;function ty(n,e){return(e==null?void 0:e[n])||Jg(n)}function ry(n,e,t){const r={};for(const a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function Wu(n){return Array.isArray(n)?[...n]:{...n}}function ny(n,e){const t=Wu(n);for(const[r,a]of Object.entries(e)){const[s,...i]=r.split(".").reverse();let o=t;for(const c of i.reverse()){if(o[c]===void 0)break;o[c]=Wu(o[c]),o=o[c]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function Mh(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class Rr{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Mh(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([r])=>{var a;return(a=this.lc_serializable_keys)==null?void 0:a.includes(r)})):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Rr||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r;const[o,...c]=a.split(".").reverse();for(const u of c.reverse()){if(!(u in s)||s[u]===void 0)return;(!(u in i)||i[u]===void 0)&&(typeof s[u]=="object"&&s[u]!=null?i[u]={}:Array.isArray(s[u])&&(i[u]=[])),s=s[u],i=i[u]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:ry(Object.keys(t).length?ny(r,t):r,ty,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function vn(n,e){return typeof n=="string"?n===""?e:typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?fi(n,e)??[...n,...e]:e===""?n:[...n,{type:"text",text:e}]}function ay(n,e){return n==="error"||e==="error"?"error":"success"}function sy(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>t(i,a+1));const s={};for(const i of Object.keys(r))s[i]=t(r[i],a+1);return s}return JSON.stringify(t(n,0),null,2)}class xn extends Rr{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=sy(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}}function qe(n,e){const t={...n};for(const[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=qe(t[r],a);else if(Array.isArray(t[r]))t[r]=fi(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function fi(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{const t=[...n];for(const r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){const a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=qe(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}function iy(n,e){if(!n&&!e)throw new Error("Cannot merge two undefined objects.");if(!n||!e)return n||e;if(typeof n!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof n}
Right ${typeof e}`);if(typeof n=="string"&&typeof e=="string")return n+e;if(Array.isArray(n)&&Array.isArray(e))return fi(n,e);if(typeof n=="object"&&typeof e=="object")return qe(n,e);if(n===e)return n;throw new Error(`Can not merge objects of different types.
Left ${n}
Right ${e}`)}class Sn extends xn{}function oy(n){return typeof n.role=="string"}function mi(n){return typeof(n==null?void 0:n._getType)=="function"}function cy(n){return mi(n)&&typeof n.concat=="function"}class uy extends xn{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class Uc extends Sn{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new Uc({content:vn(this.content,e.content),additional_kwargs:qe(this.additional_kwargs,e.additional_kwargs),response_metadata:qe(this.response_metadata,e.response_metadata),artifact:iy(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:ay(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function ly(n){const e=[],t=[];for(const r of n)if(r.function){const a=r.function.name;try{const s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch{t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}class jr extends xn{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){var a;let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;const s=(a=r.additional_kwargs)==null?void 0:a.tool_calls,i=r.tool_calls;s!=null&&s.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(s!=null&&i===void 0){const[o,c]=ly(s);r.tool_calls=o??[],r.invalid_tool_calls=c??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function En(n){return n._getType()==="ai"}function Ju(n){return n._getType()==="ai"}class Se extends Sn{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const r=[],a=[];for(const s of e.tool_call_chunks){let i={};try{if(i=Dc(s.args||"{}"),i===null||typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:s.name??"",args:i,id:s.id,type:"tool_call"})}catch{a.push({name:s.name,args:s.args,id:s.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){var r,a,s,i,o,c,u,l,d,h,m,f,p,g,w,b,_,v,E,O,T,q,K,L,Z,ae,ge,A,P,M,N,H,$,W,ce,S,R,B,ee,Re;const t={content:vn(this.content,e.content),additional_kwargs:qe(this.additional_kwargs,e.additional_kwargs),response_metadata:qe(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const Ue=fi(this.tool_call_chunks,e.tool_call_chunks);Ue!==void 0&&Ue.length>0&&(t.tool_call_chunks=Ue)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){const Ue={...(((a=(r=this.usage_metadata)==null?void 0:r.input_token_details)==null?void 0:a.audio)!==void 0||((i=(s=e.usage_metadata)==null?void 0:s.input_token_details)==null?void 0:i.audio)!==void 0)&&{audio:(((c=(o=this.usage_metadata)==null?void 0:o.input_token_details)==null?void 0:c.audio)??0)+(((l=(u=e.usage_metadata)==null?void 0:u.input_token_details)==null?void 0:l.audio)??0)},...(((h=(d=this.usage_metadata)==null?void 0:d.input_token_details)==null?void 0:h.cache_read)!==void 0||((f=(m=e.usage_metadata)==null?void 0:m.input_token_details)==null?void 0:f.cache_read)!==void 0)&&{cache_read:(((g=(p=this.usage_metadata)==null?void 0:p.input_token_details)==null?void 0:g.cache_read)??0)+(((b=(w=e.usage_metadata)==null?void 0:w.input_token_details)==null?void 0:b.cache_read)??0)},...(((v=(_=this.usage_metadata)==null?void 0:_.input_token_details)==null?void 0:v.cache_creation)!==void 0||((O=(E=e.usage_metadata)==null?void 0:E.input_token_details)==null?void 0:O.cache_creation)!==void 0)&&{cache_creation:(((q=(T=this.usage_metadata)==null?void 0:T.input_token_details)==null?void 0:q.cache_creation)??0)+(((L=(K=e.usage_metadata)==null?void 0:K.input_token_details)==null?void 0:L.cache_creation)??0)}},Nr={...(((ae=(Z=this.usage_metadata)==null?void 0:Z.output_token_details)==null?void 0:ae.audio)!==void 0||((A=(ge=e.usage_metadata)==null?void 0:ge.output_token_details)==null?void 0:A.audio)!==void 0)&&{audio:(((M=(P=this.usage_metadata)==null?void 0:P.output_token_details)==null?void 0:M.audio)??0)+(((H=(N=e.usage_metadata)==null?void 0:N.output_token_details)==null?void 0:H.audio)??0)},...(((W=($=this.usage_metadata)==null?void 0:$.output_token_details)==null?void 0:W.reasoning)!==void 0||((S=(ce=e.usage_metadata)==null?void 0:ce.output_token_details)==null?void 0:S.reasoning)!==void 0)&&{reasoning:(((B=(R=this.usage_metadata)==null?void 0:R.output_token_details)==null?void 0:B.reasoning)??0)+(((Re=(ee=e.usage_metadata)==null?void 0:ee.output_token_details)==null?void 0:Re.reasoning)??0)}},Tn=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},In=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},nm={input_tokens:Tn.input_tokens+In.input_tokens,output_tokens:Tn.output_tokens+In.output_tokens,total_tokens:Tn.total_tokens+In.total_tokens,...Object.keys(Ue).length>0&&{input_token_details:Ue},...Object.keys(Nr).length>0&&{output_token_details:Nr}};t.usage_metadata=nm}return new Se(t)}}class $a extends xn{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return $a}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}}class pi extends Sn{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new pi({content:vn(this.content,e.content),additional_kwargs:qe(this.additional_kwargs,e.additional_kwargs),response_metadata:qe(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}class gi extends Sn{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new gi({content:vn(this.content,e.content),additional_kwargs:qe(this.additional_kwargs,e.additional_kwargs),response_metadata:qe(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class mn extends xn{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class yi extends Sn{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new yi({content:vn(this.content,e.content),additional_kwargs:qe(this.additional_kwargs,e.additional_kwargs),response_metadata:qe(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class Gu extends xn{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Ea extends Sn{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Ea({content:vn(this.content,e.content),additional_kwargs:qe(this.additional_kwargs,e.additional_kwargs),response_metadata:qe(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function Fh(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function Dh(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}class dy extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}function hy(n){return Dh(n)?n:typeof n.id=="string"&&n.type==="function"&&typeof n.function=="object"&&n.function!==null&&"arguments"in n.function&&typeof n.function.arguments=="string"&&"name"in n.function&&typeof n.function.name=="string"?{id:n.id,args:JSON.parse(n.function.arguments),name:n.function.name,type:"tool_call"}:n}function fy(n){return typeof n=="object"&&n!=null&&n.lc===1&&Array.isArray(n.id)&&n.kwargs!=null&&typeof n.kwargs=="object"}function Hi(n){let e,t;if(fy(n)){const r=n.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?e="function":r==="ToolMessage"||r==="ToolMessageChunk"?e="tool":e="unknown",t=n.kwargs}else{const{type:r,...a}=n;e=r,t=a}if(e==="human"||e==="user")return new mn(t);if(e==="ai"||e==="assistant"){const{tool_calls:r,...a}=t;if(!Array.isArray(r))return new jr(t);const s=r.map(hy);return new jr({...a,tool_calls:s})}else{if(e==="system")return new Gu(t);if(e==="developer")return new Gu({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new uy({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});throw Fh(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(n,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Qn(n){if(typeof n=="string")return new mn(n);if(mi(n))return n;if(Array.isArray(n)){const[e,t]=n;return Hi({type:e,content:t})}else if(oy(n)){const{role:e,...t}=n;return Hi({...t,type:e})}else return Hi(n)}function Uh(n,e="Human",t="AI"){const r=[];for(const a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);const i=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${s}: ${i}${o}`)}return r.join(`
`)}function my(n){var t;const e=n._getType();if(e==="human")return new yi({...n});if(e==="ai"){let r={...n};return"tool_calls"in r&&(r={...r,tool_call_chunks:(t=r.tool_calls)==null?void 0:t.map(a=>({...a,type:"tool_call_chunk",index:void 0,args:JSON.stringify(a.args)}))}),new Se({...r})}else{if(e==="system")return new Ea({...n});if(e==="function")return new gi({...n});if($a.isInstance(n))return new pi({...n});throw new Error("Unknown message type.")}}var _i={exports:{}},Bh={};function lt(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var py=lt;lt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};lt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};lt.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};lt.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};lt.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};lt.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};lt.prototype.start=lt.prototype.try;lt.prototype.errors=function(){return this._errors};lt.prototype.attempts=function(){return this._attempts};lt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e};(function(n){var e=py;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var a in t)r[a]=t[a];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],i=0;i<r.retries;i++)s.push(this.createTimeout(i,r));return t&&t.forever&&!s.length&&s.push(this.createTimeout(i,r)),s.sort(function(o,c){return o-c}),s},n.createTimeout=function(t,r){var a=r.randomize?Math.random()+1:1,s=Math.round(a*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return s=Math.min(s,r.maxTimeout),s},n.wrap=function(t,r,a){if(r instanceof Array&&(a=r,r=null),!a){a=[];for(var s in t)typeof t[s]=="function"&&a.push(s)}for(var i=0;i<a.length;i++){var o=a[i],c=t[o];t[o]=(function(l){var d=n.operation(r),h=Array.prototype.slice.call(arguments,1),m=h.pop();h.push(function(f){d.retry(f)||(f&&(arguments[0]=d.mainError()),m.apply(this,arguments))}),d.attempt(function(){l.apply(t,h)})}).bind(t,c),t[o].options=r}}})(Bh);var gy=Bh;const yy=gy,_y=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class zh extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const by=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},wy=n=>_y.includes(n),Hh=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const a=yy.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof zh)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!wy(i.message))a.stop(),r(i);else{by(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});_i.exports=Hh;_i.exports.default=Hh;_i.exports.AbortError=zh;var vy=_i.exports;const Bs=lc(vy),xy=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function ra(n){return typeof n=="string"&&xy.test(n)}var je=[];for(var Zi=0;Zi<256;++Zi)je.push((Zi+256).toString(16).slice(1));function Sy(n,e=0){return(je[n[e+0]]+je[n[e+1]]+je[n[e+2]]+je[n[e+3]]+"-"+je[n[e+4]]+je[n[e+5]]+"-"+je[n[e+6]]+je[n[e+7]]+"-"+je[n[e+8]]+je[n[e+9]]+"-"+je[n[e+10]]+je[n[e+11]]+je[n[e+12]]+je[n[e+13]]+je[n[e+14]]+je[n[e+15]]).toLowerCase()}var Ga,Ey=new Uint8Array(16);function ky(){if(!Ga&&(Ga=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ga))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ga(Ey)}var Ay=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Ku={randomUUID:Ay};function He(n,e,t){if(Ku.randomUUID&&!n)return Ku.randomUUID();n=n||{};var r=n.random||(n.rng||ky)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Sy(r)}var Zh={},qh={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function a(c,u,l){this.fn=c,this.context=u,this.once=l||!1}function s(c,u,l,d,h){if(typeof l!="function")throw new TypeError("The listener must be a function");var m=new a(l,d||c,h),f=t?t+u:u;return c._events[f]?c._events[f].fn?c._events[f]=[c._events[f],m]:c._events[f].push(m):(c._events[f]=m,c._eventsCount++),c}function i(c,u){--c._eventsCount===0?c._events=new r:delete c._events[u]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var u=[],l,d;if(this._eventsCount===0)return u;for(d in l=this._events)e.call(l,d)&&u.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(l)):u},o.prototype.listeners=function(u){var l=t?t+u:u,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,m=d.length,f=new Array(m);h<m;h++)f[h]=d[h].fn;return f},o.prototype.listenerCount=function(u){var l=t?t+u:u,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(u,l,d,h,m,f){var p=t?t+u:u;if(!this._events[p])return!1;var g=this._events[p],w=arguments.length,b,_;if(g.fn){switch(g.once&&this.removeListener(u,g.fn,void 0,!0),w){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,l),!0;case 3:return g.fn.call(g.context,l,d),!0;case 4:return g.fn.call(g.context,l,d,h),!0;case 5:return g.fn.call(g.context,l,d,h,m),!0;case 6:return g.fn.call(g.context,l,d,h,m,f),!0}for(_=1,b=new Array(w-1);_<w;_++)b[_-1]=arguments[_];g.fn.apply(g.context,b)}else{var v=g.length,E;for(_=0;_<v;_++)switch(g[_].once&&this.removeListener(u,g[_].fn,void 0,!0),w){case 1:g[_].fn.call(g[_].context);break;case 2:g[_].fn.call(g[_].context,l);break;case 3:g[_].fn.call(g[_].context,l,d);break;case 4:g[_].fn.call(g[_].context,l,d,h);break;default:if(!b)for(E=1,b=new Array(w-1);E<w;E++)b[E-1]=arguments[E];g[_].fn.apply(g[_].context,b)}}return!0},o.prototype.on=function(u,l,d){return s(this,u,l,d,!1)},o.prototype.once=function(u,l,d){return s(this,u,l,d,!0)},o.prototype.removeListener=function(u,l,d,h){var m=t?t+u:u;if(!this._events[m])return this;if(!l)return i(this,m),this;var f=this._events[m];if(f.fn)f.fn===l&&(!h||f.once)&&(!d||f.context===d)&&i(this,m);else{for(var p=0,g=[],w=f.length;p<w;p++)(f[p].fn!==l||h&&!f[p].once||d&&f[p].context!==d)&&g.push(f[p]);g.length?this._events[m]=g.length===1?g[0]:g:i(this,m)}return this},o.prototype.removeAllListeners=function(u){var l;return u?(l=t?t+u:u,this._events[l]&&i(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(qh);var Py=qh.exports,bi={exports:{}},Oy=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const Ty=Oy;class Vh extends Error{constructor(e){super(e),this.name="TimeoutError"}}const Wh=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(c){a(c)}return}const i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new Vh(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);Ty(n.then(r,a),()=>{clearTimeout(s)})});bi.exports=Wh;bi.exports.default=Wh;bi.exports.TimeoutError=Vh;var Iy=bi.exports,Bc={},zc={};Object.defineProperty(zc,"__esModule",{value:!0});function Ry(n,e,t){let r=0,a=n.length;for(;a>0;){const s=a/2|0;let i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}zc.default=Ry;Object.defineProperty(Bc,"__esModule",{value:!0});const jy=zc;class Cy{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const a=jy.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}Bc.default=Cy;Object.defineProperty(Zh,"__esModule",{value:!0});const Ny=Py,Jh=Iy,$y=Bc,Ka=()=>{},Ly=new Jh.TimeoutError;class My extends Ny{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Ka,this._resolveIdle=Ka,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:$y.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Ka,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Ka,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{const s=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&t.timeout===void 0?e():Jh.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a(Ly)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var Wt=Zh.default=My;const Fy=(...n)=>fetch(...n),Dy=Symbol.for("ls:fetch_implementation"),U=()=>globalThis[Dy]??Fy,Uy=[400,401,403,404,405,406,407,408],By=[409];let Xu=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Wt?this.queue=new Wt.default({concurrency:this.maxConcurrency}):this.queue=new Wt({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>Bs(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||(a==null?void 0:a.code)==="ECONNABORTED")throw a;const s=a==null?void 0:a.response,i=s==null?void 0:s.status;if(i){if(Uy.includes(+i))throw a;if(By.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>U()(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Qu(n){return typeof(n==null?void 0:n._getType)=="function"}function Yu(n){const e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}function G(n,e){if(!ra(n)){const t=e!==void 0?`Invalid UUID for ${e}: ${n}`:`Invalid UUID: ${n}`;throw new Error(t)}return n}const el={};function Gh(n){el[n]||(console.warn(n),el[n]=!0)}var Jo={exports:{}};const zy="2.0.0",Kh=256,Hy=Number.MAX_SAFE_INTEGER||9007199254740991,Zy=16,qy=Kh-6,Vy=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var wi={MAX_LENGTH:Kh,MAX_SAFE_COMPONENT_LENGTH:Zy,MAX_SAFE_BUILD_LENGTH:qy,MAX_SAFE_INTEGER:Hy,RELEASE_TYPES:Vy,SEMVER_SPEC_VERSION:zy,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},qi={};const Wy=typeof process=="object"&&qi&&qi.NODE_DEBUG&&/\bsemver\b/i.test(qi.NODE_DEBUG)?(...n)=>console.error("SEMVER",...n):()=>{};var vi=Wy;(function(n,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:a}=wi,s=vi;e=n.exports={};const i=e.re=[],o=e.safeRe=[],c=e.src=[],u=e.safeSrc=[],l=e.t={};let d=0;const h="[a-zA-Z0-9-]",m=[["\\s",1],["\\d",a],[h,r]],f=g=>{for(const[w,b]of m)g=g.split(`${w}*`).join(`${w}{0,${b}}`).split(`${w}+`).join(`${w}{1,${b}}`);return g},p=(g,w,b)=>{const _=f(w),v=d++;s(g,v,w),l[g]=v,c[v]=w,u[v]=_,i[v]=new RegExp(w,b?"g":void 0),o[v]=new RegExp(_,b?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),p("MAINVERSION",`(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${c[l.NUMERICIDENTIFIER]}|${c[l.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${c[l.NUMERICIDENTIFIERLOOSE]}|${c[l.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${c[l.PRERELEASEIDENTIFIER]}(?:\\.${c[l.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${c[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[l.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${h}+`),p("BUILD",`(?:\\+(${c[l.BUILDIDENTIFIER]}(?:\\.${c[l.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${c[l.MAINVERSION]}${c[l.PRERELEASE]}?${c[l.BUILD]}?`),p("FULL",`^${c[l.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${c[l.MAINVERSIONLOOSE]}${c[l.PRERELEASELOOSE]}?${c[l.BUILD]}?`),p("LOOSE",`^${c[l.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${c[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${c[l.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:${c[l.PRERELEASE]})?${c[l.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:${c[l.PRERELEASELOOSE]})?${c[l.BUILD]}?)?)?`),p("XRANGE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),p("COERCE",`${c[l.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",c[l.COERCEPLAIN]+`(?:${c[l.PRERELEASE]})?(?:${c[l.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",c[l.COERCE],!0),p("COERCERTLFULL",c[l.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${c[l.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",p("TILDE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${c[l.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",p("CARET",`^${c[l.LONECARET]}${c[l.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${c[l.LONECARET]}${c[l.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${c[l.GTLT]}\\s*(${c[l.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]}|${c[l.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${c[l.XRANGEPLAIN]})\\s+-\\s+(${c[l.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${c[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[l.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(Jo,Jo.exports);var La=Jo.exports;const Jy=Object.freeze({loose:!0}),Gy=Object.freeze({}),Ky=n=>n?typeof n!="object"?Jy:n:Gy;var Hc=Ky;const tl=/^[0-9]+$/,Xh=(n,e)=>{const t=tl.test(n),r=tl.test(e);return t&&r&&(n=+n,e=+e),n===e?0:t&&!r?-1:r&&!t?1:n<e?-1:1},Xy=(n,e)=>Xh(e,n);var Qh={compareIdentifiers:Xh,rcompareIdentifiers:Xy};const Xa=vi,{MAX_LENGTH:rl,MAX_SAFE_INTEGER:Qa}=wi,{safeRe:nl,safeSrc:al,t:Ya}=La,Qy=Hc,{compareIdentifiers:Ur}=Qh;let Yy=class It{constructor(e,t){if(t=Qy(t),e instanceof It){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>rl)throw new TypeError(`version is longer than ${rl} characters`);Xa("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?nl[Ya.LOOSE]:nl[Ya.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>Qa||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Qa||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Qa||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(a=>{if(/^[0-9]+$/.test(a)){const s=+a;if(s>=0&&s<Qa)return s}return a}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Xa("SemVer.compare",this.version,this.options,e),!(e instanceof It)){if(typeof e=="string"&&e===this.version)return 0;e=new It(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof It||(e=new It(e,this.options)),Ur(this.major,e.major)||Ur(this.minor,e.minor)||Ur(this.patch,e.patch)}comparePre(e){if(e instanceof It||(e=new It(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],a=e.prerelease[t];if(Xa("prerelease compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return Ur(r,a)}while(++t)}compareBuild(e){e instanceof It||(e=new It(e,this.options));let t=0;do{const r=this.build[t],a=e.build[t];if(Xa("build compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return Ur(r,a)}while(++t)}inc(e,t,r){if(e.startsWith("pre")){if(!t&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(t){const a=new RegExp(`^${this.options.loose?al[Ya.PRERELEASELOOSE]:al[Ya.PRERELEASE]}$`),s=`-${t}`.match(a);if(!s||s[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const a=Number(r)?1:0;if(this.prerelease.length===0)this.prerelease=[a];else{let s=this.prerelease.length;for(;--s>=0;)typeof this.prerelease[s]=="number"&&(this.prerelease[s]++,s=-2);if(s===-1){if(t===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(a)}}if(t){let s=[t,a];r===!1&&(s=[t]),Ur(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=s):this.prerelease=s}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var Zc=Yy;const sl=Zc,e_=(n,e,t)=>new sl(n,t).compare(new sl(e,t));var kn=e_;const t_=kn,r_=(n,e,t)=>t_(n,e,t)>0;var n_=r_;const a_=kn,s_=(n,e,t)=>a_(n,e,t)<0;var i_=s_;const o_=kn,c_=(n,e,t)=>o_(n,e,t)===0;var u_=c_;const l_=kn,d_=(n,e,t)=>l_(n,e,t)!==0;var h_=d_;const f_=kn,m_=(n,e,t)=>f_(n,e,t)>=0;var p_=m_;const g_=kn,y_=(n,e,t)=>g_(n,e,t)<=0;var __=y_;const b_=u_,w_=h_,v_=n_,x_=p_,S_=i_,E_=__,k_=(n,e,t,r)=>{switch(e){case"===":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n===t;case"!==":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n!==t;case"":case"=":case"==":return b_(n,t,r);case"!=":return w_(n,t,r);case">":return v_(n,t,r);case">=":return x_(n,t,r);case"<":return S_(n,t,r);case"<=":return E_(n,t,r);default:throw new TypeError(`Invalid operator: ${e}`)}};var A_=k_;const{safeRe:bS,t:wS}=La;class P_{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){const a=this.map.keys().next().value;this.delete(a)}this.map.set(e,t)}return this}}var O_=P_,Vi,il;function Ot(){if(il)return Vi;il=1;const n=/\s+/g;class e{constructor(P,M){if(M=a(M),P instanceof e)return P.loose===!!M.loose&&P.includePrerelease===!!M.includePrerelease?P:new e(P.raw,M);if(P instanceof s)return this.raw=P.value,this.set=[[P]],this.formatted=void 0,this;if(this.options=M,this.loose=!!M.loose,this.includePrerelease=!!M.includePrerelease,this.raw=P.trim().replace(n," "),this.set=this.raw.split("||").map(N=>this.parseRange(N.trim())).filter(N=>N.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const N=this.set[0];if(this.set=this.set.filter(H=>!p(H[0])),this.set.length===0)this.set=[N];else if(this.set.length>1){for(const H of this.set)if(H.length===1&&g(H[0])){this.set=[H];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let P=0;P<this.set.length;P++){P>0&&(this.formatted+="||");const M=this.set[P];for(let N=0;N<M.length;N++)N>0&&(this.formatted+=" "),this.formatted+=M[N].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(P){const N=((this.options.includePrerelease&&m)|(this.options.loose&&f))+":"+P,H=r.get(N);if(H)return H;const $=this.options.loose,W=$?c[u.HYPHENRANGELOOSE]:c[u.HYPHENRANGE];P=P.replace(W,ae(this.options.includePrerelease)),i("hyphen replace",P),P=P.replace(c[u.COMPARATORTRIM],l),i("comparator trim",P),P=P.replace(c[u.TILDETRIM],d),i("tilde trim",P),P=P.replace(c[u.CARETTRIM],h),i("caret trim",P);let ce=P.split(" ").map(ee=>b(ee,this.options)).join(" ").split(/\s+/).map(ee=>Z(ee,this.options));$&&(ce=ce.filter(ee=>(i("loose invalid filter",ee,this.options),!!ee.match(c[u.COMPARATORLOOSE])))),i("range list",ce);const S=new Map,R=ce.map(ee=>new s(ee,this.options));for(const ee of R){if(p(ee))return[ee];S.set(ee.value,ee)}S.size>1&&S.has("")&&S.delete("");const B=[...S.values()];return r.set(N,B),B}intersects(P,M){if(!(P instanceof e))throw new TypeError("a Range is required");return this.set.some(N=>w(N,M)&&P.set.some(H=>w(H,M)&&N.every($=>H.every(W=>$.intersects(W,M)))))}test(P){if(!P)return!1;if(typeof P=="string")try{P=new o(P,this.options)}catch{return!1}for(let M=0;M<this.set.length;M++)if(ge(this.set[M],P,this.options))return!0;return!1}}Vi=e;const t=O_,r=new t,a=Hc,s=xi(),i=vi,o=Zc,{safeRe:c,t:u,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:h}=La,{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:f}=wi,p=A=>A.value==="<0.0.0-0",g=A=>A.value==="",w=(A,P)=>{let M=!0;const N=A.slice();let H=N.pop();for(;M&&N.length;)M=N.every($=>H.intersects($,P)),H=N.pop();return M},b=(A,P)=>(i("comp",A,P),A=O(A,P),i("caret",A),A=v(A,P),i("tildes",A),A=q(A,P),i("xrange",A),A=L(A,P),i("stars",A),A),_=A=>!A||A.toLowerCase()==="x"||A==="*",v=(A,P)=>A.trim().split(/\s+/).map(M=>E(M,P)).join(" "),E=(A,P)=>{const M=P.loose?c[u.TILDELOOSE]:c[u.TILDE];return A.replace(M,(N,H,$,W,ce)=>{i("tilde",A,N,H,$,W,ce);let S;return _(H)?S="":_($)?S=`>=${H}.0.0 <${+H+1}.0.0-0`:_(W)?S=`>=${H}.${$}.0 <${H}.${+$+1}.0-0`:ce?(i("replaceTilde pr",ce),S=`>=${H}.${$}.${W}-${ce} <${H}.${+$+1}.0-0`):S=`>=${H}.${$}.${W} <${H}.${+$+1}.0-0`,i("tilde return",S),S})},O=(A,P)=>A.trim().split(/\s+/).map(M=>T(M,P)).join(" "),T=(A,P)=>{i("caret",A,P);const M=P.loose?c[u.CARETLOOSE]:c[u.CARET],N=P.includePrerelease?"-0":"";return A.replace(M,(H,$,W,ce,S)=>{i("caret",A,H,$,W,ce,S);let R;return _($)?R="":_(W)?R=`>=${$}.0.0${N} <${+$+1}.0.0-0`:_(ce)?$==="0"?R=`>=${$}.${W}.0${N} <${$}.${+W+1}.0-0`:R=`>=${$}.${W}.0${N} <${+$+1}.0.0-0`:S?(i("replaceCaret pr",S),$==="0"?W==="0"?R=`>=${$}.${W}.${ce}-${S} <${$}.${W}.${+ce+1}-0`:R=`>=${$}.${W}.${ce}-${S} <${$}.${+W+1}.0-0`:R=`>=${$}.${W}.${ce}-${S} <${+$+1}.0.0-0`):(i("no pr"),$==="0"?W==="0"?R=`>=${$}.${W}.${ce}${N} <${$}.${W}.${+ce+1}-0`:R=`>=${$}.${W}.${ce}${N} <${$}.${+W+1}.0-0`:R=`>=${$}.${W}.${ce} <${+$+1}.0.0-0`),i("caret return",R),R})},q=(A,P)=>(i("replaceXRanges",A,P),A.split(/\s+/).map(M=>K(M,P)).join(" ")),K=(A,P)=>{A=A.trim();const M=P.loose?c[u.XRANGELOOSE]:c[u.XRANGE];return A.replace(M,(N,H,$,W,ce,S)=>{i("xRange",A,N,H,$,W,ce,S);const R=_($),B=R||_(W),ee=B||_(ce),Re=ee;return H==="="&&Re&&(H=""),S=P.includePrerelease?"-0":"",R?H===">"||H==="<"?N="<0.0.0-0":N="*":H&&Re?(B&&(W=0),ce=0,H===">"?(H=">=",B?($=+$+1,W=0,ce=0):(W=+W+1,ce=0)):H==="<="&&(H="<",B?$=+$+1:W=+W+1),H==="<"&&(S="-0"),N=`${H+$}.${W}.${ce}${S}`):B?N=`>=${$}.0.0${S} <${+$+1}.0.0-0`:ee&&(N=`>=${$}.${W}.0${S} <${$}.${+W+1}.0-0`),i("xRange return",N),N})},L=(A,P)=>(i("replaceStars",A,P),A.trim().replace(c[u.STAR],"")),Z=(A,P)=>(i("replaceGTE0",A,P),A.trim().replace(c[P.includePrerelease?u.GTE0PRE:u.GTE0],"")),ae=A=>(P,M,N,H,$,W,ce,S,R,B,ee,Re)=>(_(N)?M="":_(H)?M=`>=${N}.0.0${A?"-0":""}`:_($)?M=`>=${N}.${H}.0${A?"-0":""}`:W?M=`>=${M}`:M=`>=${M}${A?"-0":""}`,_(R)?S="":_(B)?S=`<${+R+1}.0.0-0`:_(ee)?S=`<${R}.${+B+1}.0-0`:Re?S=`<=${R}.${B}.${ee}-${Re}`:A?S=`<${R}.${B}.${+ee+1}-0`:S=`<=${S}`,`${M} ${S}`.trim()),ge=(A,P,M)=>{for(let N=0;N<A.length;N++)if(!A[N].test(P))return!1;if(P.prerelease.length&&!M.includePrerelease){for(let N=0;N<A.length;N++)if(i(A[N].semver),A[N].semver!==s.ANY&&A[N].semver.prerelease.length>0){const H=A[N].semver;if(H.major===P.major&&H.minor===P.minor&&H.patch===P.patch)return!0}return!1}return!0};return Vi}var Wi,ol;function xi(){if(ol)return Wi;ol=1;const n=Symbol("SemVer ANY");class e{static get ANY(){return n}constructor(l,d){if(d=t(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),i("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===n?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(l){const d=this.options.loose?r[a.COMPARATORLOOSE]:r[a.COMPARATOR],h=l.match(d);if(!h)throw new TypeError(`Invalid comparator: ${l}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=n}toString(){return this.value}test(l){if(i("Comparator.test",l,this.options.loose),this.semver===n||l===n)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return s(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new c(this.value,d).test(l.semver):(d=t(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||s(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||s(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}Wi=e;const t=Hc,{safeRe:r,t:a}=La,s=A_,i=vi,o=Zc,c=Ot();return Wi}Ot();Ot();Ot();Ot();Ot();Ot();const T_=xi(),{ANY:vS}=T_;Ot();Ot();Ot();const qc=xi(),{ANY:xS}=qc;new qc(">=0.0.0-0");new qc(">=0.0.0");const Ji=La,cl=wi,ul=Qh;xi();Ot();Ji.re,Ji.src,Ji.t,cl.SEMVER_SPEC_VERSION,cl.RELEASE_TYPES,ul.compareIdentifiers,ul.rcompareIdentifiers;function Yt(n){if(!n||n.split("/").length>2||n.startsWith("/")||n.endsWith("/")||n.split(":").length>2)throw new Error(`Invalid identifier format: ${n}`);const[e,t]=n.split(":"),r=t||"latest";if(e.includes("/")){const[a,s]=e.split("/",2);if(!a||!s)throw new Error(`Invalid identifier format: ${n}`);return[a,s,r]}else{if(!e)throw new Error(`Invalid identifier format: ${n}`);return["-",e,r]}}class I_ extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function ne(n,e,t){let r;if(n.ok){t&&(r=await n.text());return}r=await n.text();const a=`Failed to ${e}. Received status [${n.status}]: ${n.statusText}. Server response: ${r}`;throw n.status===409?new I_(a):new Error(a)}var ll="[...]",R_={result:"[Circular]"},zs=[],Qr=[];const j_=new TextEncoder;function C_(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function es(n){return j_.encode(n)}function Ye(n,e,t,r){var a;try{const s=JSON.stringify(n,e,t);return es(s)}catch(s){if(!((a=s.message)!=null&&a.includes("Converting circular structure to JSON")))return console.warn("[WARNING]: LangSmith received unserializable value."),es("[Unserializable]");console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof r>"u"&&(r=C_()),Go(n,"",0,[],void 0,0,r);let i;try{Qr.length===0?i=JSON.stringify(n,e,t):i=JSON.stringify(n,N_(e),t)}catch{return es("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;zs.length!==0;){const o=zs.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return es(i)}}function Gi(n,e,t,r){var a=Object.getOwnPropertyDescriptor(r,t);a.get!==void 0?a.configurable?(Object.defineProperty(r,t,{value:n}),zs.push([r,t,e,a])):Qr.push([e,t,n]):(r[t]=n,zs.push([r,t,e]))}function Go(n,e,t,r,a,s,i){s+=1;var o;if(typeof n=="object"&&n!==null){for(o=0;o<r.length;o++)if(r[o]===n){Gi(R_,n,e,a);return}if(typeof i.depthLimit<"u"&&s>i.depthLimit){Gi(ll,n,e,a);return}if(typeof i.edgesLimit<"u"&&t+1>i.edgesLimit){Gi(ll,n,e,a);return}if(r.push(n),Array.isArray(n))for(o=0;o<n.length;o++)Go(n[o],o,o,r,n,s,i);else{var c=Object.keys(n);for(o=0;o<c.length;o++){var u=c[o];Go(n[u],u,o,r,n,s,i)}}r.pop()}}function N_(n){return n=typeof n<"u"?n:function(e,t){return t},function(e,t){if(Qr.length>0)for(var r=0;r<Qr.length;r++){var a=Qr[r];if(a[1]===e&&a[0]===t){t=a[2],Qr.splice(r,1);break}}return n.call(this,e,t)}}function dl(n){const e=tf(),t=W_(),r=n.extra??{},a=r.metadata;return n.extra={...r,runtime:{...e,...r==null?void 0:r.runtime},metadata:{...t,...t.revision_id||n.revision_id?{revision_id:n.revision_id??t.revision_id}:{},...a}},n}const $_=n=>{const e=(n==null?void 0:n.toString())??sr("TRACING_SAMPLING_RATE");if(e===void 0)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t},L_=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function M_(n){const e=[];for await(const t of n)e.push(t);return e}function Ki(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const F_=async n=>{if((n==null?void 0:n.status)===429){const e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};function hl(n){return typeof n=="number"?Number(n.toFixed(4)):n}class D_{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise(s=>{t=s}),a=Ye(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){var a;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let r=0;for(;r+(((a=this.peek())==null?void 0:a.size)??0)<e&&this.items.length>0;){const s=this.items.shift();s&&(t.push(s),r+=s.size,this.sizeBytes-=s.size)}if(t.length===0&&this.items.length>0){const s=this.items.shift();t.push(s),r+=s.size,this.sizeBytes-=s.size}return[t.map(s=>({action:s.action,item:s.payload})),()=>t.forEach(s=>s.itemPromiseResolve())]}}const U_=20971520,B_=2500;class ka{constructor(e={}){var r;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new D_}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Ar("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1});const t=ka.getDefaultClientConfig();if(this.tracingSampleRate=$_(e.tracingSamplingRate),this.apiUrl=Ki(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Ki(e.apiKey??t.apiKey),this.webUrl=Ki(e.webUrl??t.webUrl),(r=this.webUrl)!=null&&r.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Xu(e.callerOptions??{}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new Xu({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:F_}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=sr("API_KEY"),t=sr("ENDPOINT")??"https://api.smith.langchain.com",r=sr("HIDE_INPUTS")==="true",a=sr("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:L_(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Yh}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=(t==null?void 0:t.toString())??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(U(),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(s,`Failed to fetch ${e}`),s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(s));const i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(U(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(o,`Failed to fetch ${e}`);const c=r?r(await o.json()):await o.json();if(c.length===0||(yield c,c.length<s))break;a+=c.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){const s=t?{...t}:{};for(;;){const o=await(await this.caller.call(U(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];const c=o.cursors;if(!c||!c.next)break;s.cursor=c.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const a of e)this.filteredPostUuids.has(a.id)?this.filteredPostUuids.delete(a.id):r.push(a);return r}else{const r=[];for(const a of e){const s=a.trace_id??a.id;this.filteredPostUuids.has(s)||(a.id===s?this._shouldSample()?r.push(a):this.filteredPostUuids.add(s):r.push(a))}return r}}async _getBatchSizeLimitBytes(){var t;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((t=e.batch_ingest_config)==null?void 0:t.size_limit_bytes)??U_}async _getMultiPartSupport(){var t;return((t=(await this._ensureServerInfo()).instance_flags)==null?void 0:t.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}const s=this._processBatch(r,a).catch(console.error);t.push(s)}return Promise.all(t)}async _processBatch(e,t){var r;if(!e.length){t();return}try{const a={runCreates:e.filter(i=>i.action==="create").map(i=>i.item),runUpdates:e.filter(i=>i.action==="update").map(i=>i.item)},s=await this._ensureServerInfo();(r=s==null?void 0:s.batch_ingest_config)!=null&&r.use_multipart_endpoint?await this.multipartIngestRuns(a):await this.batchIngestRuns(a)}finally{t()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=dl(e.item));const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await U()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(B_),...this.fetchOptions});return await ne(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch{console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}const s=dl(a),i=await this.caller.call(U(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:Ye(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=(e==null?void 0:e.map(o=>this.prepareRunCreateOrUpdateInputs(o)))??[],a=(t==null?void 0:t.map(o=>this.prepareRunCreateOrUpdateInputs(o)))??[];if(r.length>0&&a.length>0){const o=r.reduce((u,l)=>(l.id&&(u[l.id]=l),u),{}),c=[];for(const u of a)u.id!==void 0&&o[u.id]?o[u.id]={...o[u.id],...u}:c.push(u);r=Object.values(o),a=c}const s={post:r,patch:a};if(!s.post.length&&!s.patch.length)return;const i={post:[],patch:[]};for(const o of["post","patch"]){const c=o,u=s[c].reverse();let l=u.pop();for(;l!==void 0;)i[c].push(l),l=u.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(Ye(i))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(U(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;const r={};let a=[];for(const l of e??[]){const d=this.prepareRunCreateOrUpdateInputs(l);d.id!==void 0&&d.attachments!==void 0&&(r[d.id]=d.attachments),delete d.attachments,a.push(d)}let s=[];for(const l of t??[])s.push(this.prepareRunCreateOrUpdateInputs(l));if(a.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&s.length>0){const l=a.reduce((h,m)=>(m.id&&(h[m.id]=m),h),{}),d=[];for(const h of s)h.id!==void 0&&l[h.id]?l[h.id]={...l[h.id],...h}:d.push(h);a=Object.values(l),s=d}if(a.length===0&&s.length===0)return;const c=[],u=[];for(const[l,d]of[["post",a],["patch",s]])for(const h of d){const{inputs:m,outputs:f,events:p,attachments:g,...w}=h,b={inputs:m,outputs:f,events:p},_=Ye(w);u.push({name:`${l}.${w.id}`,payload:new Blob([_],{type:`application/json; length=${_.length}`})});for(const[v,E]of Object.entries(b)){if(E===void 0)continue;const O=Ye(E);u.push({name:`${l}.${w.id}.${v}`,payload:new Blob([O],{type:`application/json; length=${O.length}`})})}if(w.id!==void 0){const v=r[w.id];if(v){delete r[w.id];for(const[E,O]of Object.entries(v)){let T,q;if(Array.isArray(O)?[T,q]=O:(T=O.mimeType,q=O.data),E.includes(".")){console.warn(`Skipping attachment '${E}' for run ${w.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}u.push({name:`attachment.${w.id}.${E}`,payload:new Blob([q],{type:`${T}; length=${q.byteLength}`})})}}}c.push(`trace=${w.trace_id},id=${w.id}`)}await this._sendMultipartRequest(u,c.join("; "))}async _sendMultipartRequest(e,t){try{const r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=[];for(const c of e)a.push(new Blob([`--${r}\r
`])),a.push(new Blob([`Content-Disposition: form-data; name="${c.name}"\r
`,`Content-Type: ${c.payload.type}\r
\r
`])),a.push(c.payload),a.push(new Blob([`\r
`]));a.push(new Blob([`--${r}--\r
`]));const i=await new Blob(a).arrayBuffer(),o=await this.batchIngestCaller.call(U(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`},body:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(o,"ingest multipart runs",!0)}catch(r){console.warn(`${r.message.trim()}

Context: ${t}`)}}async updateRun(e,t){G(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:r}).catch(console.error);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(U(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:Ye(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(s,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){G(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r!=null&&r.projectName?a=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?a=r==null?void 0:r.projectId:a=(await this.readProject({projectName:sr("PROJECT")||"default"})).id;const s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){const a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await M_(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>((s==null?void 0:s.dotted_order)??"").localeCompare((i==null?void 0:i.dotted_order)??""));for(const s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(const s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:c,isRoot:u,runType:l,error:d,id:h,query:m,filter:f,traceFilter:p,treeFilter:g,limit:w,select:b}=e;let _=[];if(t&&(_=Array.isArray(t)?t:[t]),r){const T=Array.isArray(r)?r:[r],q=await Promise.all(T.map(K=>this.readProject({projectName:K}).then(L=>L.id)));_.push(...q)}const v=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],E={session:_.length?_:null,run_type:l,reference_example:i,query:m,filter:f,trace_filter:p,tree_filter:g,execution_order:c,parent_run:a,start_time:o?o.toISOString():null,error:d,id:h,limit:w,trace:s,select:b||v,is_root:u};let O=0;for await(const T of this._getCursorPaginatedList("/runs/query",E))if(w){if(O>=w)break;if(T.length+O>w){yield*T.slice(0,w-O);break}O+=T.length,yield*T}else yield*T}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:s,projectIds:i,referenceExampleIds:o,startTime:c,endTime:u,error:l,query:d,filter:h,traceFilter:m,treeFilter:f,isRoot:p,dataSourceType:g}){let w=i||[];s&&(w=[...i||[],...await Promise.all(s.map(O=>this.readProject({projectName:O}).then(T=>T.id)))]);const _=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:w,reference_example:o,start_time:c,end_time:u,error:l,query:d,filter:h,trace_filter:m,tree_filter:f,is_root:p,data_source_type:g}).filter(([O,T])=>T!==void 0));return await(await this.caller.call(U(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(_),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||He()};G(e);const s=await(await this.caller.call(U(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){G(e);const t=await this.caller.call(U(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(t,"unshare run",!0)}async readRunSharedLink(e){G(e);const r=await(await this.caller.call(U(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const i of t)r.append("id",i);return G(e),await(await this.caller.call(U(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),G(e);const a=await(await this.caller.call(U(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};G(e);const s=await(await this.caller.call(U(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){G(e);const t=await this.caller.call(U(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(t,"unshare dataset",!0)}async readSharedDataset(e){return G(e),await(await this.caller.call(U(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,t){const r={};t!=null&&t.exampleIds&&(r.id=t.exampleIds);const a=new URLSearchParams;Object.entries(r).forEach(([o,c])=>{Array.isArray(c)?c.forEach(u=>a.append(o,u)):a.append(o,c)});const s=await this.caller.call(U(),`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await s.json();if(!s.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${s.status}
Message: ${i.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){const o=a?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,u=s||{};r&&(u.metadata=r);const l={name:e,extra:u,description:t};i!==null&&(l.reference_dataset_id=i);const d=await this.caller.call(U(),c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(d,"create project"),await d.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=s;a&&(c={...c||{},metadata:a});const u={name:t,extra:c,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(U(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(l,"update project"),await l.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)G(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");const s=await this.caller.call(U(),`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)G(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());const i=await this._get(a,s);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i,metadata:o}={}){const c=new URLSearchParams;if(e!==void 0)for(const u of e)c.append("id",u);if(t!==void 0&&c.append("name",t),r!==void 0&&c.append("name_contains",r),a!==void 0)c.append("reference_dataset",a);else if(s!==void 0){const u=await this.readDataset({datasetName:s});c.append("reference_dataset",u.id)}i!==void 0&&c.append("reference_free",i.toString()),o!==void 0&&c.append("metadata",JSON.stringify(o));for await(const u of this._getPaginated("/sessions",c))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,G(r);const a=await this.caller.call(U(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(a,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){const c=`${this.apiUrl}/datasets/upload`,u=new FormData;u.append("file",e,t),r.forEach(h=>{u.append("input_keys",h)}),a.forEach(h=>{u.append("output_keys",h)}),s&&u.append("description",s),i&&u.append("data_type",i),o&&u.append("name",o);const l=await this.caller.call(U(),c,{method:"POST",headers:this.headers,body:u,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(l,"upload CSV"),await l.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:s,metadata:i}={}){const o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),a&&(o.inputs_schema_definition=a),s&&(o.outputs_schema_definition=s);const c=await this.caller.call(U(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(c,"create dataset"),await c.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)G(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");const s=await this._get(r,a);let i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s,metadata:i}={}){const o="/datasets",c=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const u of r)c.append("id",u);a!==void 0&&c.append("name",a),s!==void 0&&c.append("name_contains",s),i!==void 0&&c.append("metadata",JSON.stringify(i));for await(const u of this._getPaginated(o,c))yield*u}async updateDataset(e){const{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:r})).id;G(s);const i=await this.caller.call(U(),`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(i,"update dataset"),await i.json()}async updateDatasetTag(e){const{datasetId:t,datasetName:r,asOf:a,tag:s}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:r})).id;G(i);const o=await this.caller.call(U(),`${this.apiUrl}/datasets/${i}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({as_of:typeof a=="string"?a:a.toISOString(),tag:s}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(o,"update dataset tags")}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)G(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");const s=await this.caller.call(U(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(s,`delete ${r}`),await s.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(!a&&!t)throw new Error("Must provide either datasetName or datasetId");if(a&&t)throw new Error("Must provide either datasetName or datasetId, not both");a||(a=(await this.readDataset({datasetName:t})).id),G(a);const s={tag:r},i=await this.caller.call(U(),`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:a}={}){const s={limit:r,inputs:e};a!==void 0&&(s.filter=a),G(t);const i=await this.caller.call(U(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,t,r){var l;if(fl(e)&&(t!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let a=t?r==null?void 0:r.datasetId:e.dataset_id;const s=t?r==null?void 0:r.datasetName:e.dataset_name;if(a===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:s})).id);const i=(t?r==null?void 0:r.createdAt:e.created_at)||new Date;let o;fl(e)?o=e:o={inputs:e,outputs:t,created_at:i==null?void 0:i.toISOString(),id:r==null?void 0:r.exampleId,metadata:r==null?void 0:r.metadata,split:r==null?void 0:r.split,source_run_id:r==null?void 0:r.sourceRunId,use_source_run_io:r==null?void 0:r.useSourceRunIO,use_source_run_attachments:r==null?void 0:r.useSourceRunAttachments,attachments:r==null?void 0:r.attachments};const c=await this._uploadExamplesMultipart(a,[o]);return await this.readExample(((l=c.example_ids)==null?void 0:l[0])??He())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const b=e;let _=b[0].dataset_id;const v=b[0].dataset_name;if(_===void 0&&v===void 0)throw new Error("Must provide either datasetName or datasetId");if(_!==void 0&&v!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");_===void 0&&(_=(await this.readDataset({datasetName:v})).id);const E=await this._uploadExamplesMultipart(_,b);return await Promise.all(E.example_ids.map(T=>this.readExample(T)))}const{inputs:t,outputs:r,metadata:a,splits:s,sourceRunIds:i,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:u,exampleIds:l,datasetId:d,datasetName:h}=e;if(t===void 0)throw new Error("Must provide inputs when using legacy parameters");let m=d;const f=h;if(m===void 0&&f===void 0)throw new Error("Must provide either datasetName or datasetId");if(m!==void 0&&f!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");m===void 0&&(m=(await this.readDataset({datasetName:f})).id);const p=t.map((b,_)=>({dataset_id:m,inputs:b,outputs:r==null?void 0:r[_],metadata:a==null?void 0:a[_],split:s==null?void 0:s[_],id:l==null?void 0:l[_],attachments:u==null?void 0:u[_],source_run_id:i==null?void 0:i[_],use_source_run_io:o==null?void 0:o[_],use_source_run_attachments:c==null?void 0:c[_]})),g=await this._uploadExamplesMultipart(m,p);return await Promise.all(g.example_ids.map(b=>this.readExample(b)))}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map(i=>Qu(i)?Yu(i):i),s=Qu(t)?Yu(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){G(e);const t=`/examples/${e}`,r=await this._get(t),{attachment_urls:a,...s}=r,i=s;return a&&(i.attachments=Object.entries(a).reduce((o,[c,u])=>(o[c.slice(11)]={presigned_url:u.presigned_url,mime_type:u.mime_type},o),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o,limit:c,offset:u,filter:l,includeAttachments:d}={}){let h;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(t!==void 0)h=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const m=new URLSearchParams({dataset:h}),f=a?typeof a=="string"?a:a==null?void 0:a.toISOString():void 0;f&&m.append("as_of",f);const p=i??!0;if(m.append("inline_s3_urls",p.toString()),r!==void 0)for(const w of r)m.append("id",w);if(s!==void 0)for(const w of s)m.append("splits",w);if(o!==void 0){const w=JSON.stringify(o);m.append("metadata",w)}c!==void 0&&m.append("limit",c.toString()),u!==void 0&&m.append("offset",u.toString()),l!==void 0&&m.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(w=>m.append("select",w));let g=0;for await(const w of this._getPaginated("/examples",m)){for(const b of w){const{attachment_urls:_,...v}=b,E=v;_&&(E.attachments=Object.entries(_).reduce((O,[T,q])=>(O[T.slice(11)]={presigned_url:q.presigned_url,mime_type:q.mime_type||void 0},O),{})),yield E,g++}if(c!==void 0&&g>=c)break}}async deleteExample(e){G(e);const t=`/examples/${e}`,r=await this.caller.call(U(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(r,`delete ${t}`),await r.json()}async updateExample(e,t){let r;t?r=e:r=e.id,G(r);let a;t?a={id:r,...t}:a=e;let s;return a.dataset_id!==void 0?s=a.dataset_id:s=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(s,[a])}async updateExamples(e){let t;return e[0].dataset_id===void 0?t=(await this.readExample(e[0].id)).dataset_id:t=e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:r,tag:a}){let s;if(e?s=e:s=(await this.readDataset({datasetName:t})).id,G(s),r&&a||!r&&!a)throw new Error("Exactly one of asOf and tag must be specified.");const i=new URLSearchParams;r!==void 0&&i.append("as_of",typeof r=="string"?r:r.toISOString()),a!==void 0&&i.append("tag",a);const o=await this.caller.call(U(),`${this.apiUrl}/datasets/${s}/version?${i.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(o,"read dataset version"),await o.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,G(a);const s=new URLSearchParams,i=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return i&&s.append("as_of",i),await this._get(`/datasets/${a}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:s=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,G(i);const o={split_name:r,examples:a.map(u=>(G(u),u)),remove:s},c=await this.caller.call(U(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(c,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){Gh("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,s),[c,u]=await this._logEvaluationFeedback(o,i,r);return u[0]}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:u,feedbackId:l,feedbackConfig:d,projectId:h,comparativeExperimentId:m}){var b;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const f={type:c??"api",metadata:o??{}};u!==void 0&&(f==null?void 0:f.metadata)!==void 0&&!f.metadata.__run&&(f.metadata.__run={run_id:u}),(f==null?void 0:f.metadata)!==void 0&&((b=f.metadata.__run)==null?void 0:b.run_id)!==void 0&&G(f.metadata.__run.run_id);const p={id:l??He(),run_id:e,key:t,score:hl(r),value:a,correction:s,comment:i,feedback_source:f,comparative_experiment_id:m,feedbackConfig:d,session_id:h},g=`${this.apiUrl}/feedback`,w=await this.caller.call(U(),g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(w,"create feedback",!0),p}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){const i={};t!=null&&(i.score=hl(t)),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),G(e);const o=await this.caller.call(U(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(o,"update feedback",!0)}async readFeedback(e){G(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){G(e);const t=`/feedback/${e}`,r=await this.caller.call(U(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const s of t)a.append("key",s);if(r)for(const s of r)a.append("source",s);for await(const s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){const s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(U(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){var l;if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(l=a??new Date)==null?void 0:l.toISOString(),extra:{}};return i&&(c.extra.metadata=i),await(await this.caller.call(U(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){G(e);const t=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:Array.isArray(e)?t=e:t=[e],t}async _logEvaluationFeedback(e,t,r){const a=this._selectEvalResults(e),s=[];for(const i of a){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let c=null;i.targetRunId?c=i.targetRunId:t&&(c=t.id),s.push(await this.createFeedback(c,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[a,s]}async logEvaluationFeedback(e,t,r){const[a]=await this._logEvaluationFeedback(e,t,r);return a}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:a,limit:s}=e,i=new URLSearchParams;t&&t.forEach((c,u)=>{G(c,`queueIds[${u}]`),i.append("ids",c)}),r&&i.append("name",r),a&&i.append("name_contains",a),i.append("limit",(s!==void 0?Math.min(s,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",i))if(yield*c,o++,s!==void 0&&o>=s)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:a}=e,s={name:t,description:r,id:a||He()},i=await this.caller.call(U(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(s).filter(([c,u])=>u!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(i,"create annotation queue"),await i.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:r,description:a}=t,s=await this.caller.call(U(),`${this.apiUrl}/annotation-queues/${G(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(s,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(U(),`${this.apiUrl}/annotation-queues/${G(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const r=await this.caller.call(U(),`${this.apiUrl}/annotation-queues/${G(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((a,s)=>G(a,`runIds[${s}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${G(e,"queueId")}/run`,a=await this.caller.call(U(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(a,"get run from annotation queue"),await a.json()}async deleteRunFromAnnotationQueue(e,t){const r=await this.caller.call(U(),`${this.apiUrl}/annotation-queues/${G(e,"queueId")}/runs/${G(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(r,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){const t=await this.caller.call(U(),`${this.apiUrl}/annotation-queues/${G(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(t,"get size from annotation queue"),await t.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(U(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){const a=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),s=new Error(`Error ${t.status}: ${t.statusText}
${a}`);throw s.statusCode=t.status,s}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,a,s]=Yt(e),i=await this.caller.call(U(),`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(i,`${t?"like":"unlike"} prompt`),await i.json()}async _getPromptUrl(e){const[t,r,a]=Yt(e);if(await this._currentTenantIsOwner(t)){const s=await this._getSettings();return a!=="latest"?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${s.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${s.id}`}else return a!=="latest"?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&t.append("is_public",e.isPublic.toString()),e!=null&&e.query&&t.append("query",e.query);for await(const r of this._getPaginated("/repos",t,a=>a.repos))yield*r}async getPrompt(e){const[t,r,a]=Yt(e),s=await this.caller.call(U(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(s.status===404)return null;await ne(s,"get prompt");const i=await s.json();return i.repo?i.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t!=null&&t.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[a,s,i]=Yt(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);const o={repo_handle:s,...(t==null?void 0:t.description)&&{description:t.description},...(t==null?void 0:t.readme)&&{readme:t.readme},...(t==null?void 0:t.tags)&&{tags:t.tags},is_public:!!(t!=null&&t.isPublic)},c=await this.caller.call(U(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(c,"create prompt");const{repo:u}=await c.json();return u}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[a,s,i]=Yt(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${a}/${s}`):r==null?void 0:r.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},u=await this.caller.call(U(),`${this.apiUrl}/commits/${a}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(u,"create commit");const l=await u.json();return this._getPromptUrl(`${a}/${s}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){var o;if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const c of t){const u=c.id,l={...c.metadata&&{metadata:c.metadata},...c.split&&{split:c.split}},d=Ye(l),h=new Blob([d],{type:"application/json"});if(r.append(u,h),c.inputs){const m=Ye(c.inputs),f=new Blob([m],{type:"application/json"});r.append(`${u}.inputs`,f)}if(c.outputs){const m=Ye(c.outputs),f=new Blob([m],{type:"application/json"});r.append(`${u}.outputs`,f)}if(c.attachments)for(const[m,f]of Object.entries(c.attachments)){let p,g;Array.isArray(f)?[p,g]=f:(p=f.mimeType,g=f.data);const w=new Blob([g],{type:`${p}; length=${g.byteLength}`});r.append(`${u}.attachment.${m}`,w)}if(c.attachments_operations){const m=Ye(c.attachments_operations),f=new Blob([m],{type:"application/json"});r.append(`${u}.attachments_operations`,f)}}const a=e??((o=t[0])==null?void 0:o.dataset_id);return await(await this.caller.call(U(),`${this.apiUrl}/v1/platform/datasets/${a}/examples`,{method:"PATCH",headers:this.headers,body:r})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const i of t){const o=(i.id??He()).toString(),c={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},u=Ye(c),l=new Blob([u],{type:"application/json"});if(r.append(o,l),i.inputs){const d=Ye(i.inputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.inputs`,h)}if(i.outputs){const d=Ye(i.outputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.outputs`,h)}if(i.attachments)for(const[d,h]of Object.entries(i.attachments)){let m,f;Array.isArray(h)?[m,f]=h:(m=h.mimeType,f=h.data);const p=new Blob([f],{type:`${m}; length=${f.byteLength}`});r.append(`${o}.attachment.${d}`,p)}}return await(await this.caller.call(U(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,a]=Yt(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const s={};if((t==null?void 0:t.description)!==void 0&&(s.description=t.description),(t==null?void 0:t.readme)!==void 0&&(s.readme=t.readme),(t==null?void 0:t.tags)!==void 0&&(s.tags=t.tags),(t==null?void 0:t.isPublic)!==void 0&&(s.is_public=t.isPublic),(t==null?void 0:t.isArchived)!==void 0&&(s.is_archived=t.isArchived),Object.keys(s).length===0)throw new Error("No valid update options provided");const i=await this.caller.call(U(),`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",body:JSON.stringify(s),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ne(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,a]=Yt(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return await(await this.caller.call(U(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,t){const[r,a,s]=Yt(e),i=await this.caller.call(U(),`${this.apiUrl}/commits/${r}/${a}/${s}${t!=null&&t.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ne(i,"pull prompt commit");const o=await i.json();return{owner:r,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t==null?void 0:t.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(a=>a!=="object")&&await this.updatePrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}):await this.createPrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}),t!=null&&t.object?await this.createCommit(e,t==null?void 0:t.object,{parentCommitHash:t==null?void 0:t.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[s,i]=this.parseTokenOrUrl(e,r),o=new ka({apiUrl:s,apiKey:"placeholder"}),c=await o.readSharedDataset(i),u=a||c.name;try{if(await this.hasDataset({datasetId:u})){console.log(`Dataset ${u} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(i),d=await this.createDataset(u,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(h=>h.inputs),outputs:l.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${u}. You should delete it manually.`),h}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return G(e),[t,e]}catch{}try{const i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){const o=i[i.length-r];return[t,o]}else throw new Error(`Invalid public ${a} URL: ${e}`)}catch{throw new Error(`Invalid public ${a} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}}function fl(n){return"dataset_id"in n||"dataset_name"in n}const Yh="0.3.14";var na={};let Ut;const z_=()=>typeof window<"u"&&typeof window.document<"u",H_=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Z_=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),ef=()=>typeof Deno<"u",q_=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!ef(),V_=()=>Ut||(z_()?Ut="browser":q_()?Ut="node":H_()?Ut="webworker":Z_()?Ut="jsdom":ef()?Ut="deno":Ut="other",Ut);let Xi;function tf(){if(Xi===void 0){const n=V_(),e=G_();Xi={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Yh,...e}}return Xi}function W_(){const n=J_()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,a]of Object.entries(n))(r.startsWith("LANGCHAIN_")||r.startsWith("LANGSMITH_"))&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function J_(){try{return typeof process<"u"&&na?Object.entries(na).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function Ar(n){try{return typeof process<"u"?na==null?void 0:na[n]:void 0}catch{return}}function sr(n){return Ar(`LANGSMITH_${n}`)||Ar(`LANGCHAIN_${n}`)}let Qi;function G_(){if(Qi!==void 0)return Qi;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=Ar(t);r!==void 0&&(e[t]=r)}return Qi=e,e}const K_=n=>!!["TRACING_V2","TRACING"].find(t=>sr(t)==="true"),Yi=Symbol.for("lc:context_variables");function X_(n){return n.replace(/[-:.]/g,"")}function Q_(n,e,t=1){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return X_(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}class Hs{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){const t=e.split(",");let r={},a=[];for(const s of t){const[i,o]=s.split("="),c=decodeURIComponent(o);i==="langsmith-metadata"?r=JSON.parse(c):i==="langsmith-tags"&&(a=c.split(","))}return new Hs(r,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}}class rt{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),rf(e)){Object.assign(this,{...e});return}const t=rt.getDefaultConfig(),{metadata:r,...a}=e,s=a.client??rt.getSharedClient(),i={...r,...(o=a==null?void 0:a.extra)==null?void 0:o.metadata};if(a.extra={...a.extra,metadata:i},Object.assign(this,{...t,...a,client:s}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const c=Q_(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+c:this.dotted_order=c}}static getDefaultConfig(){return{id:He(),run_type:"chain",project_name:sr("PROJECT")??Ar("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:Ar("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Ar("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return rt.sharedClient||(rt.sharedClient=new ka),rt.sharedClient}createChild(e){var c,u,l,d,h,m;const t=this.child_execution_order+1,r=new rt({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Yi in this&&(r[Yi]=this[Yi]);const a=Symbol.for("lc:child_config"),s=((c=e.extra)==null?void 0:c[a])??this.extra[a];if(eb(s)){const f={...s},p=Y_(f.callbacks)?(l=(u=f.callbacks).copy)==null?void 0:l.call(u):void 0;p&&(Object.assign(p,{_parentRunId:r.id}),(m=(h=(d=p.handlers)==null?void 0:d.find(nf))==null?void 0:h.updateFromRunTree)==null||m.call(h,r),f.callbacks=p),r.extra[a]=f}const i=new Set;let o=this;for(;o!=null&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),a){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){var c;const a=e.extra??{};if(a.runtime||(a.runtime={}),t)for(const[u,l]of Object.entries(t))a.runtime[u]||(a.runtime[u]=l);let s,i;return r?(i=(c=e.parent_run)==null?void 0:c.id,s=[]):(s=e.child_runs.map(u=>this._convertToCreate(u,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:a,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:s,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const t=tf(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e){Gh("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const a of this.child_runs)await a.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(){var e;try{const t={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:(e=this.parent_run)==null?void 0:e.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,t)}catch(t){console.error(`Error in patchRun for run ${this.id}`,t)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){var u,l,d,h;const r=e==null?void 0:e.callbacks;let a,s,i,o=K_();if(r){const m=((u=r==null?void 0:r.getParentRunId)==null?void 0:u.call(r))??"",f=(l=r==null?void 0:r.handlers)==null?void 0:l.find(p=>(p==null?void 0:p.name)=="langchain_tracer");a=(d=f==null?void 0:f.getRun)==null?void 0:d.call(f,m),s=f==null?void 0:f.projectName,i=f==null?void 0:f.client,o=o||!!f}return a?new rt({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:i,tracingEnabled:o,project_name:s,tags:[...new Set(((a==null?void 0:a.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(h=a==null?void 0:a.extra)==null?void 0:h.metadata,...e==null?void 0:e.metadata}}}).createChild(t):new rt({...t,client:i,tracingEnabled:o,project_name:s})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){var u;const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||typeof a!="string")return;const s=a.trim(),i=s.split(".").map(l=>{const[d,h]=l.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=i[0].uuid,c={...t,name:(t==null?void 0:t.name)??"parent",run_type:(t==null?void 0:t.run_type)??"chain",start_time:(t==null?void 0:t.start_time)??Date.now(),id:(u=i.at(-1))==null?void 0:u.uuid,trace_id:o,dotted_order:s};if(r.baggage&&typeof r.baggage=="string"){const l=Hs.fromHeader(r.baggage);c.metadata=l.metadata,c.tags=l.tags}return new rt(c)}toHeaders(e){var r;const t={"langsmith-trace":this.dotted_order,baggage:new Hs((r=this.extra)==null?void 0:r.metadata,this.tags).toHeader()};if(e)for(const[a,s]of Object.entries(t))e.set(a,s);return t}}Object.defineProperty(rt,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function rf(n){return n!==void 0&&typeof n.createChild=="function"&&typeof n.postRun=="function"}function nf(n){return typeof n=="object"&&n!=null&&typeof n.name=="string"&&n.name==="langchain_tracer"}function ml(n){return Array.isArray(n)&&n.some(e=>nf(e))}function Y_(n){return typeof n=="object"&&n!=null&&Array.isArray(n.handlers)}function eb(n){var e;return n!==void 0&&typeof n.callbacks=="object"&&(ml((e=n.callbacks)==null?void 0:e.handlers)||ml(n.callbacks))}let tb=class{getStore(){}run(e,t){return t()}};const eo=Symbol.for("ls:tracing_async_local_storage"),rb=new tb;let nb=class{getInstance(){return globalThis[eo]??rb}initializeGlobalInstance(e){globalThis[eo]===void 0&&(globalThis[eo]=e)}};const ab=new nb,sb=()=>{const n=ab.getInstance().getStore();if(!rf(n))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function and that tracing is enabled."].join(`
`));return n};function Vc(n){return typeof n=="function"&&"langsmith:traceable"in n}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const ib=Object.prototype.hasOwnProperty;function Ko(n,e){return ib.call(n,e)}function Xo(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Ko(n,t)&&e.push(t);return e}function Nt(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Qo(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Br(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function ob(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function Yo(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(Yo(n[t]))return!0}else if(typeof n=="object"){const t=Xo(n),r=t.length;for(var e=0;e<r;e++)if(Yo(n[t[e]]))return!0}}return!1}function pl(n,e){const t=[n];for(const r in e){const a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}class cb extends Error{constructor(e,t,r,a,s){super(pl(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=pl(e,{name:t,index:r,operation:a,tree:s})}}const we=cb,Yr={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=ec(t,this.path);r&&(r=Nt(r));const a=aa(t,{op:"remove",path:this.from}).removed;return aa(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=ec(t,this.from);return aa(t,{op:"add",path:this.path,value:Nt(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:qs(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var ub={add:function(n,e,t){return Qo(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Yr.move,copy:Yr.copy,test:Yr.test,_get:Yr._get};function ec(n,e){if(e=="")return n;var t={op:"_get",path:e};return aa(n,t),t.value}function aa(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):tc(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=ec(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=qs(n,e.value),i.test===!1)throw new we("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new we("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=Nt(n));const o=(e.path||"").split("/");let c=n,u=1,l=o.length,d,h,m;for(typeof t=="function"?m=t:m=tc;;){if(h=o[u],h&&h.indexOf("~")!=-1&&(h=ob(h)),a&&(h=="__proto__"||h=="prototype"&&u>0&&o[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(c[h]===void 0?d=o.slice(0,u).join("/"):u==l-1&&(d=e.path),d!==void 0&&m(e,0,n,d)),u++,Array.isArray(c)){if(h==="-")h=c.length;else{if(t&&!Qo(h))throw new we("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);Qo(h)&&(h=~~h)}if(u>=l){if(t&&e.op==="add"&&h>c.length)throw new we("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);const f=ub[e.op].call(e,c,h,n);if(f.test===!1)throw new we("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return f}}else if(u>=l){const f=Yr[e.op].call(e,c,h,n);if(f.test===!1)throw new we("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return f}if(c=c[h],t&&u<l&&(!c||typeof c!="object"))throw new we("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function Zs(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new we("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=Nt(n));const s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=aa(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function tc(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new we("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Yr[n.op]){if(typeof n.path!="string")throw new we("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new we('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new we("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new we("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&Yo(n.value))throw new we("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new we("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new we("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=lb([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new we("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new we("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function lb(n,e,t){try{if(!Array.isArray(n))throw new we("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Zs(Nt(e),Nt(n),t||!0);else{t=t||tc;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof we)return a;throw a}}function qs(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!qs(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!qs(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2013-2021 Joachim Wester
 * MIT license
 */function af(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=Xo(e),i=Xo(n),o=!1,c=i.length-1;c>=0;c--){var u=i[c],l=n[u];if(Ko(e,u)&&!(e[u]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var d=e[u];typeof l=="object"&&l!=null&&typeof d=="object"&&d!=null&&Array.isArray(l)===Array.isArray(d)?af(l,d,t,r+"/"+Br(u),a):l!==d&&(a&&t.push({op:"test",path:r+"/"+Br(u),value:Nt(l)}),t.push({op:"replace",path:r+"/"+Br(u),value:Nt(d)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+Br(u),value:Nt(l)}),t.push({op:"remove",path:r+"/"+Br(u)}),o=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}))}if(!(!o&&s.length==i.length))for(var c=0;c<s.length;c++){var u=s[c];!Ko(n,u)&&e[u]!==void 0&&t.push({op:"add",path:r+"/"+Br(u),value:Nt(e[u])})}}}function db(n,e,t=!1){var r=[];return af(n,e,r,"",t),r}var to={};const hb=()=>typeof window<"u"&&typeof window.document<"u",fb=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",mb=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Wc=()=>typeof Deno<"u",pb=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Wc(),sf=()=>{let n;return hb()?n="browser":pb()?n="node":fb()?n="webworker":mb()?n="jsdom":Wc()?n="deno":n="other",n};let ro;async function gb(){return ro===void 0&&(ro={library:"langchain-js",runtime:sf()}),ro}function Pe(n){try{return typeof process<"u"?to==null?void 0:to[n]:Wc()?Deno==null?void 0:Deno.env.get(n):void 0}catch{return}}class yb{}function _b(n){return"lc_prefer_streaming"in n&&n.lc_prefer_streaming}class Ma extends yb{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Mh(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Pe("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Rr.prototype.toJSON.call(this)}toJSONNotImplemented(){return Rr.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends Ma{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:He()}),Object.assign(this,e)}}return new t}}const bb=n=>{const e=n;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"};function no(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function wb(n){return n.replace(/[-:.]/g,"")}function vb(n,e,t){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return wb(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}function jn(n){return typeof n._addRunToRunMap=="function"}class Fa extends Ma{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=vb(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){const a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,s,i,o,c){const u=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:c??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,a,s,i,o,c){var l,d;const u=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,a,s,i,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onLLMStart)==null?void 0:d.call(this,u)),u}_createRunForChatModelStart(e,t,r,a,s,i,o,c){const u=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:c??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,a,s,i,o,c){var l,d;const u=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,a,s,i,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onLLMStart)==null?void 0:d.call(this,u)),u}async handleLLMEnd(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...s},await((o=this.onLLMEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleLLMError(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...s},await((o=this.onLLMError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForChainStart(e,t,r,a,s,i,o,c){const u=this._getExecutionOrder(a),l=Date.now(),d={id:r,name:c??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:u,child_execution_order:u,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,r,a,s,i,o,c){var l,d;const u=this.runMap.get(r)??this._createRunForChainStart(e,t,r,a,s,i,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onChainStart)==null?void 0:d.call(this,u)),u}async handleChainEnd(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=no(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=no(s.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=no(s.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForToolStart(e,t,r,a,s,i,o){const c=this._getExecutionOrder(a),u=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{input:t},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,r,a,s,i,o){var u,l;const c=this.runMap.get(r)??this._createRunForToolStart(e,t,r,a,s,i,o);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((l=this.onToolStart)==null?void 0:l.call(this,c)),c}async handleToolEnd(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onToolEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onToolError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentAction)==null?void 0:s.call(this,r))}async handleAgentEnd(e,t){var a;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentEnd)==null?void 0:a.call(this,r)))}_createRunForRetrieverStart(e,t,r,a,s,i,o){const c=this._getExecutionOrder(a),u=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{query:t},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,r,a,s,i,o){var u,l;const c=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,a,s,i,o);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((l=this.onRetrieverStart)==null?void 0:l.call(this,c)),c}async handleRetrieverEnd(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var a;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((a=this.onText)==null?void 0:a.call(this,r)))}async handleLLMNewToken(e,t,r,a,s,i){var c;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}}var Jc={exports:{}};Jc.exports;(function(n){const t=(s=0)=>i=>`\x1B[${38+s};5;${i}m`,r=(s=0)=>(i,o,c)=>`\x1B[${38+s};2;${i};${o};${c}m`;function a(){const s=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,c]of Object.entries(i)){for(const[u,l]of Object.entries(c))i[u]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},c[u]=i[u],s.set(l[0],l[1]);Object.defineProperty(i,o,{value:c,enumerable:!1})}return Object.defineProperty(i,"codes",{value:s,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=t(),i.color.ansi16m=r(),i.bgColor.ansi256=t(10),i.bgColor.ansi16m=r(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,c,u)=>o===c&&c===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:u}=c.groups;u.length===3&&(u=u.split("").map(d=>d+d).join(""));const l=Number.parseInt(u,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(n,"exports",{enumerable:!0,get:a})})(Jc);var xb=Jc.exports;const of=lc(xb);function Be(n,e){return`${n.open}${e}${n.close}`}function ct(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function gl(n){return typeof n=="string"?n.trim():n==null?n:ct(n,n.toString())}function er(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:Ve}=of;class yl extends Fa{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{const o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?Be(of.bold,o):o}).join(" > ");return Be(Ve.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.green,"[chain/start]")} [${t}] Entering Chain run with input: ${ct(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.cyan,"[chain/end]")} [${t}] [${er(e)}] Exiting Chain run with output: ${ct(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.red,"[chain/error]")} [${t}] [${er(e)}] Chain run errored with error: ${ct(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${Be(Ve.green,"[llm/start]")} [${t}] Entering LLM run with input: ${ct(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.cyan,"[llm/end]")} [${t}] [${er(e)}] Exiting LLM run with output: ${ct(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.red,"[llm/error]")} [${t}] [${er(e)}] LLM run errored with error: ${ct(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.green,"[tool/start]")} [${t}] Entering Tool run with input: "${gl(e.inputs.input)}"`)}onToolEnd(e){var r;const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.cyan,"[tool/end]")} [${t}] [${er(e)}] Exiting Tool run with output: "${gl((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.red,"[tool/error]")} [${t}] [${er(e)}] Tool run errored with error: ${ct(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${ct(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.cyan,"[retriever/end]")} [${t}] [${er(e)}] Exiting Retriever run with output: ${ct(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${Be(Ve.red,"[retriever/error]")} [${t}] [${er(e)}] Retriever run errored with error: ${ct(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${Be(Ve.blue,"[agent/action]")} [${r}] Agent selected action: ${ct(t.actions[t.actions.length-1],"[action]")}`)}}let ao;const Sb=()=>{if(ao===void 0){const n=Pe("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};ao=new ka(n)}return ao};class sa extends Fa{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??Pe("LANGCHAIN_PROJECT")??Pe("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??Sb();const s=sa.getTraceableRunTree();s&&this.updateFromRunTree(s)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await gb()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id,extra:e.extra};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e;const r=new Set;for(;t.parent_run&&!(r.has(t.id)||(r.add(t.id),!t.parent_run));)t=t.parent_run;r.clear();const a=[t];for(;a.length>0;){const s=a.shift();!s||r.has(s.id)||(r.add(s.id),this.runMap.set(s.id,s),s.child_runs&&a.push(...s.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const t={},r=[];for(const[a,s]of this.runMap){const i=new rt({...s,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[a]=i,r.push([a,s.dotted_order])}r.sort((a,s)=>!a[1]||!s[1]?0:a[1].localeCompare(s[1]));for(const[a]of r){const s=this.runMap.get(a),i=t[a];if(!(!s||!i)&&s.parent_run_id){const o=t[s.parent_run_id];o&&(o.child_runs.push(i),i.parent_run=o)}}return t[e]}static getTraceableRunTree(){try{return sb()}catch{return}}}const cf=Symbol.for("ls:tracing_async_local_storage"),Os=Symbol.for("lc:context_variables"),Eb=n=>{globalThis[cf]=n},Aa=()=>globalThis[cf];let ia;function kb(){const n="default"in Wt?Wt.default:Wt;return new n({autoStart:!0,concurrency:1})}function Ab(){return typeof ia>"u"&&(ia=kb()),ia}async function Ee(n,e){if(e===!0){const t=Aa();t!==void 0?await t.run(void 0,async()=>n()):await n()}else ia=Ab(),ia.add(async()=>{const t=Aa();t!==void 0?await t.run(void 0,async()=>n()):await n()})}const Pb=n=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>Pe(t)==="true");function uf(n){var r;const e=Aa();if(e===void 0)return;const t=e.getStore();return(r=t==null?void 0:t[Os])==null?void 0:r[n]}const Ob=Symbol("lc:configure_hooks"),Tb=()=>uf(Ob)||[];class Ib{setHandler(e){return this.setHandlers([e])}}class Si{constructor(e,t,r,a,s,i,o,c){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:c})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,t,this.runId,this.tags,this.metadata))}catch(c){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${c}`),i.raiseError)throw c}},i.awaitHandlers)))}}class Rb extends Si{getChild(e){const t=new Je(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw a}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`),t.raiseError)throw e}},t.awaitHandlers)))}}class _l extends Si{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>Ee(async()=>{var c;if(!o.ignoreLLM)try{await((c=o.handleLLMNewToken)==null?void 0:c.call(o,e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(c){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${c}`),i.raiseError)throw c}},i.awaitHandlers)))}async handleLLMEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(c){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${c}`),i.raiseError)throw c}},i.awaitHandlers)))}}class jb extends Si{getChild(e){const t=new Je(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(c){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${c}`),i.raiseError)throw c}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(c){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${c}`),i.raiseError)throw c}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}}class Cb extends Si{getChild(e){const t=new Je(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}}class Je extends Ib{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(t==null?void 0:t.handlers)??this.handlers,this.inheritableHandlers=(t==null?void 0:t.inheritableHandlers)??this.inheritableHandlers,this.tags=(t==null?void 0:t.tags)??this.tags,this.inheritableTags=(t==null?void 0:t.inheritableTags)??this.inheritableTags,this.metadata=(t==null?void 0:t.metadata)??this.metadata,this.inheritableMetadata=(t==null?void 0:t.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,c=void 0){return Promise.all(t.map(async(u,l)=>{const d=l===0&&r?r:He();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return jn(h)&&h._createRunForLLMStart(e,[u],d,this._parentRunId,s,this.tags,this.metadata,c),Ee(async()=>{var m;try{await((m=h.handleLLMStart)==null?void 0:m.call(h,e,[u],d,this._parentRunId,s,this.tags,this.metadata,c))}catch(f){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${f}`),h.raiseError)throw f}},h.awaitHandlers)})),new _l(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,c=void 0){return Promise.all(t.map(async(u,l)=>{const d=l===0&&r?r:He();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return jn(h)&&h._createRunForChatModelStart(e,[u],d,this._parentRunId,s,this.tags,this.metadata,c),Ee(async()=>{var m,f;try{if(h.handleChatModelStart)await((m=h.handleChatModelStart)==null?void 0:m.call(h,e,[u],d,this._parentRunId,s,this.tags,this.metadata,c));else if(h.handleLLMStart){const p=Uh(u);await((f=h.handleLLMStart)==null?void 0:f.call(h,e,[p],d,this._parentRunId,s,this.tags,this.metadata,c))}}catch(p){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`),h.raiseError)throw p}},h.awaitHandlers)})),new _l(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=He(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreChain)return jn(c)&&c._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,o),Ee(async()=>{var u;try{await((u=c.handleChainStart)==null?void 0:u.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,a,o))}catch(l){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleChainStart: ${l}`),c.raiseError)throw l}},c.awaitHandlers)})),new jb(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=He(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreAgent)return jn(c)&&c._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),Ee(async()=>{var u;try{await((u=c.handleToolStart)==null?void 0:u.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleToolStart: ${l}`),c.raiseError)throw l}},c.awaitHandlers)})),new Cb(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=He(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreRetriever)return jn(c)&&c._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),Ee(async()=>{var u;try{await((u=c.handleRetrieverStart)==null?void 0:u.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${l}`),c.raiseError)throw l}},c.awaitHandlers)})),new Rb(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreCustomEvent)try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,t,r,this.tags,this.metadata))}catch(c){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${c}`),i.raiseError)throw c}},i.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new Je(this._parentRunId);for(const a of this.handlers){const s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(const a of this.tags){const s=this.inheritableTags.includes(a);r.addTags([a],s)}for(const a of Object.keys(this.metadata)){const s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(const a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends Ma{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:He()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static configure(e,t,r,a,s,i,o){return this._configureSync(e,t,r,a,s,i,o)}static _configureSync(e,t,r,a,s,i,o){var h,m;let c;(e||t)&&(Array.isArray(e)||!e?(c=new Je,c.setHandlers((e==null?void 0:e.map(Vs))??[],!0)):c=e,c=c.copy(Array.isArray(t)?t.map(Vs):t==null?void 0:t.handlers,!1));const u=Pe("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=((h=sa.getTraceableRunTree())==null?void 0:h.tracingEnabled)||Pb(),d=l||(Pe("LANGCHAIN_TRACING")??!1);if(u||d){if(c||(c=new Je),u&&!c.handlers.some(f=>f.name===yl.prototype.name)){const f=new yl;c.addHandler(f,!0)}if(d&&!c.handlers.some(f=>f.name==="langchain_tracer")&&l){const f=new sa;c.addHandler(f,!0),c._parentRunId=((m=sa.getTraceableRunTree())==null?void 0:m.id)??c._parentRunId}}for(const{contextVar:f,inheritable:p=!0,handlerClass:g,envVar:w}of Tb()){const b=w&&Pe(w)==="true"&&g;let _;const v=f!==void 0?uf(f):void 0;v&&bb(v)?_=v:b&&(_=new g({})),_!==void 0&&(c||(c=new Je),c.handlers.some(E=>E.name===_.name)||c.addHandler(_,p))}return(r||a)&&c&&(c.addTags(r??[]),c.addTags(a??[],!1)),(s||i)&&c&&(c.addMetadata(s??{}),c.addMetadata(i??{},!1)),c}}function Vs(n){return"name"in n?n:Ma.fromMethods(n)}class Nb{getStore(){}run(e,t){return t()}enterWith(e){}}const $b=new Nb,bl=Symbol.for("lc:child_config");class Lb{getInstance(){return Aa()??$b}getRunnableConfig(){var t,r;return(r=(t=this.getInstance().getStore())==null?void 0:t.extra)==null?void 0:r[bl]}runWithConfig(e,t,r){var l;const a=Je._configureSync(e==null?void 0:e.callbacks,void 0,e==null?void 0:e.tags,void 0,e==null?void 0:e.metadata),s=this.getInstance(),i=s.getStore(),o=a==null?void 0:a.getParentRunId(),c=(l=a==null?void 0:a.handlers)==null?void 0:l.find(d=>(d==null?void 0:d.name)==="langchain_tracer");let u;return c&&o?u=c.convertToRunTree(o):r||(u=new rt({name:"<runnable_lambda>",tracingEnabled:!1})),u&&(u.extra={...u.extra,[bl]:e}),i!==void 0&&i[Os]!==void 0&&(u===void 0&&(u={}),u[Os]=i[Os]),s.run(u,t)}initializeGlobalInstance(e){Aa()===void 0&&Eb(e)}}const dr=new Lb,so=25;async function Et(n){return Je._configureSync(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function wl(...n){const e={};for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){const a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(r==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(r==="callbacks"){const a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{const i=a.copy();for(const o of s)i.addHandler(Vs(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){const i=s.copy();for(const o of a)i.addHandler(Vs(o),!0);e.callbacks=i}else e.callbacks=new Je(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{const a=r;e[a]=t[a]??e[a]}return e}const Mb=new Set(["string","number","boolean"]);function le(n){var r;const e=dr.getRunnableConfig();let t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:a,runName:s,...i}=e;t=Object.entries(i).reduce((o,[c,u])=>(u!==void 0&&(o[c]=u),o),t)}if(n&&(t=Object.entries(n).reduce((a,[s,i])=>(i!==void 0&&(a[s]=i),a),t)),t!=null&&t.configurable)for(const a of Object.keys(t.configurable))Mb.has(typeof t.configurable[a])&&!((r=t.metadata)!=null&&r[a])&&(t.metadata||(t.metadata={}),t.metadata[a]=t.configurable[a]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");const a=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,a])):t.signal=a,delete t.timeout}return t}function Me(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){const o=le(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}function pn(n){return n?{configurable:n.configurable,recursionLimit:n.recursionLimit,callbacks:n.callbacks,tags:n.tags,metadata:n.metadata,maxConcurrency:n.maxConcurrency,timeout:n.timeout,signal:n.signal}:void 0}async function hr(n,e){if(e===void 0)return n;let t;return Promise.race([n.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,a)=>{t=()=>{a(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&a(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}class st extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new st({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new st({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function lf(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){const s=await n.next();for(const i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function kt(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=kt(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class An{constructor(e){var t;Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??((t=this.config)==null?void 0:t.signal),this.setup=new Promise((r,a)=>{dr.runWithConfig(pn(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(r,a):this.firstResult.then(s=>r(void 0),a)},!0)})}async next(...e){var t;return(t=this.signal)==null||t.throwIfAborted(),this.firstResultUsed?dr.runWithConfig(pn(this.config),this.signal?async()=>hr(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function Fb(n,e,t,r,...a){const s=new An({generator:e,startSetup:t,signal:r}),i=await s.setup;return{output:n(s,i,...a),setup:i}}class ar{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=Zs({},t);return new Pa({ops:t,state:r[r.length-1].newDocument})}}class Pa extends ar{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=Zs(this.state,e.ops);return new Pa({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=Zs({},e.ops);return new Pa({ops:e.ops,state:t[t.length-1].newDocument})}}const Db=n=>n.name==="log_stream_tracer";async function vl(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function xl(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function Ub(n){return n!==void 0&&n.message!==void 0}class Sl extends Fa{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=st.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>{var s;return(s=this.includeTags)==null?void 0:s.includes(a)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>{var s;return!((s=this.excludeTags)!=null&&s.includes(a))})),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const a=this.keyMapByRunId[e];a&&await this.writer.write(new ar({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var a;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new ar({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await vl(e,this._schemaFormat)),await this.writer.write(new ar({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await vl(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await xl(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new ar({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new ar({ops:[{op:"replace",path:"/final_output",value:await xl(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const a=this.keyMapByRunId[e.id];if(a===void 0)return;const s=e.inputs.messages!==void 0;let i;s?Ub(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new Se({id:`run-${e.id}`,content:t}):i=t;const o=new ar({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}}const El="__run";class gn{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new gn({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class fr extends gn{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new fr({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function ts({name:n,serialized:e}){return n!==void 0?n:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const Bb=n=>n.name==="event_stream_tracer";class zb extends Fa{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=st.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>{var s;return(s=this.includeTags)==null?void 0:s.includes(a)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>{var s;return!((s=this.excludeTags)!=null&&s.includes(a))})),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}function s(o,c){return o==="llm"&&typeof c=="string"?new gn({text:c}):c}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(c=>{o=c}),this.tappedPromises.set(e,i);try{const c={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...c,data:{chunk:s(a.runType,r.value)}},a),yield r.value;for await(const u of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...c,data:{chunk:s(a.runType,u)}},a),yield u}finally{o()}}else{yield r.value;for await(const o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){var i,o;const t=ts(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);const s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},a)}async onLLMNewToken(e,t,r){const a=this.runInfoMap.get(e.id);let s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(a.runType==="chat_model")i="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?s=new Se({content:t,id:`run-${e.id}`}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",(r==null?void 0:r.chunk)===void 0?s=new gn({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}}async onLLMEnd(e){var i,o,c;const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const a=(i=e.outputs)==null?void 0:i.generations;let s;if(t.runType==="chat_model"){for(const u of a??[]){if(s!==void 0)break;s=(o=u[0])==null?void 0:o.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a==null?void 0:a.map(u=>u.map(l=>({text:l.text,generationInfo:l.generationInfo}))),llmOutput:((c=e.outputs)==null?void 0:c.llmOutput)??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){var i,o;const t=ts(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:t,runType:e.run_type};let s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},a)}async onChainEnd(e){var o;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){var a,s;const t=ts(e),r={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{}},r)}async onToolEnd(e){var a;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=((a=e.outputs)==null?void 0:a.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){var s,i;const t=ts(e),a={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:((i=e.extra)==null?void 0:i.metadata)??{}},a)}async onRetrieverEnd(e){var r;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((r=e.outputs)==null?void 0:r.documents)??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}const Hb=[400,401,402,403,404,405,406,407,409],Zb=n=>{var t,r;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=((t=n==null?void 0:n.response)==null?void 0:t.status)??(n==null?void 0:n.status);if(e&&Hb.includes(+e))throw n;if(((r=n==null?void 0:n.error)==null?void 0:r.code)==="insufficient_quota"){const a=new Error(n==null?void 0:n.message);throw a.name="InsufficientQuotaError",a}};class Gc{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Zb;const t="default"in Wt?Wt.default:Wt;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Bs(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}class df extends Fa{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function Kc(n){return n?n.lc_runnable:!1}class qb{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}}const Vb=Symbol("Let zodToJsonSchema decide on which parser to use"),Wb={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Jb=n=>({...Wb,...n}),Gb=n=>{const e=Jb(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function hf(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function he(n,e,t,r,a){n[e]=t,hf(n,e,r,a)}function Kb(){return{}}function Xb(n,e){var r,a,s;const t={type:"array"};return(r=n.type)!=null&&r._def&&((s=(a=n.type)==null?void 0:a._def)==null?void 0:s.typeName)!==x.ZodAny&&(t.items=de(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&he(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&he(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(he(t,"minItems",n.exactLength.value,n.exactLength.message,e),he(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Qb(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?he(t,"minimum",r.value,r.message,e):he(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),he(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?he(t,"maximum",r.value,r.message,e):he(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),he(t,"maximum",r.value,r.message,e));break;case"multipleOf":he(t,"multipleOf",r.value,r.message,e);break}return t}function Yb(){return{type:"boolean"}}function ff(n,e){return de(n.type._def,e)}const ew=(n,e)=>de(n.innerType._def,e);function mf(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>mf(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return tw(n,e)}}const tw=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":he(t,"minimum",r.value,r.message,e);break;case"max":he(t,"maximum",r.value,r.message,e);break}return t};function rw(n,e){return{...de(n.innerType._def,e),default:n.defaultValue()}}function nw(n,e){return e.effectStrategy==="input"?de(n.schema._def,e):{}}function aw(n){return{type:"string",enum:Array.from(n.values)}}const sw=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function iw(n,e){const t=[de(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),de(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(s=>{if(sw(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){const{additionalProperties:o,...c}=s;i=c}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function ow(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let io;const dt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(io===void 0&&(io=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),io),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function pf(n,e){const t={type:"string"};if(n.checks)for(const r of n.checks)switch(r.kind){case"min":he(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":he(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":ht(t,"email",r.message,e);break;case"format:idn-email":ht(t,"idn-email",r.message,e);break;case"pattern:zod":ze(t,dt.email,r.message,e);break}break;case"url":ht(t,"uri",r.message,e);break;case"uuid":ht(t,"uuid",r.message,e);break;case"regex":ze(t,r.regex,r.message,e);break;case"cuid":ze(t,dt.cuid,r.message,e);break;case"cuid2":ze(t,dt.cuid2,r.message,e);break;case"startsWith":ze(t,RegExp(`^${oo(r.value,e)}`),r.message,e);break;case"endsWith":ze(t,RegExp(`${oo(r.value,e)}$`),r.message,e);break;case"datetime":ht(t,"date-time",r.message,e);break;case"date":ht(t,"date",r.message,e);break;case"time":ht(t,"time",r.message,e);break;case"duration":ht(t,"duration",r.message,e);break;case"length":he(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),he(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":{ze(t,RegExp(oo(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&ht(t,"ipv4",r.message,e),r.version!=="v4"&&ht(t,"ipv6",r.message,e);break}case"base64url":ze(t,dt.base64url,r.message,e);break;case"jwt":ze(t,dt.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&ze(t,dt.ipv4Cidr,r.message,e),r.version!=="v4"&&ze(t,dt.ipv6Cidr,r.message,e);break}case"emoji":ze(t,dt.emoji(),r.message,e);break;case"ulid":{ze(t,dt.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{ht(t,"binary",r.message,e);break}case"contentEncoding:base64":{he(t,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{ze(t,dt.base64,r.message,e);break}}break}case"nanoid":ze(t,dt.nanoid,r.message,e)}return t}function oo(n,e){return e.patternStrategy==="escape"?uw(n):n}const cw=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function uw(n){let e="";for(let t=0;t<n.length;t++)cw.has(n[t])||(e+="\\"),e+=n[t];return e}function ht(n,e,t,r){var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):he(n,"format",e,t,r)}function ze(n,e,t,r){var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:kl(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):he(n,"pattern",kl(e,r),t,r)}function kl(n,e){var c;if(!e.applyRegexFlags||!n.flags)return n.source;const t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source;let a="",s=!1,i=!1,o=!1;for(let u=0;u<r.length;u++){if(s){a+=r[u],s=!1;continue}if(t.i){if(i){if(r[u].match(/[a-z]/)){o?(a+=r[u],a+=`${r[u-2]}-${r[u]}`.toUpperCase(),o=!1):r[u+1]==="-"&&((c=r[u+2])!=null&&c.match(/[a-z]/))?(a+=r[u],o=!0):a+=`${r[u]}${r[u].toUpperCase()}`;continue}}else if(r[u].match(/[a-z]/)){a+=`[${r[u]}${r[u].toUpperCase()}]`;continue}}if(t.m){if(r[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(t.s&&r[u]==="."){a+=i?`${r[u]}\r
`:`[${r[u]}\r
]`;continue}a+=r[u],r[u]==="\\"?s=!0:i&&r[u]==="]"?i=!1:!i&&r[u]==="["&&(i=!0)}try{new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a}function gf(n,e){var r,a,s,i,o,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===x.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((u,l)=>({...u,[l]:de(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??{}}),{}),additionalProperties:e.rejectedAdditionalProperties};const t={type:"object",additionalProperties:de(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===x.ZodString&&((s=n.keyType._def.checks)!=null&&s.length)){const{type:u,...l}=pf(n.keyType._def,e);return{...t,propertyNames:l}}else{if(((i=n.keyType)==null?void 0:i._def.typeName)===x.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(((o=n.keyType)==null?void 0:o._def.typeName)===x.ZodBranded&&n.keyType._def.type._def.typeName===x.ZodString&&((c=n.keyType._def.type._def.checks)!=null&&c.length)){const{type:u,...l}=ff(n.keyType._def,e);return{...t,propertyNames:l}}}return t}function lw(n,e){if(e.mapStrategy==="record")return gf(n,e);const t=de(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=de(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function dw(n){const e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function hw(){return{not:{}}}function fw(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Ws={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function mw(n,e){if(e.target==="openApi3")return Al(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Ws&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((a,s)=>{const i=Ws[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((a,s)=>{const i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){const a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Al(n,e)}const Al=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>de(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function pw(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Ws[n.innerType._def.typeName],nullable:!0}:{type:[Ws[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=de(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=de(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function gw(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",hf(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?he(t,"minimum",r.value,r.message,e):he(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),he(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?he(t,"maximum",r.value,r.message,e):he(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),he(t,"maximum",r.value,r.message,e));break;case"multipleOf":he(t,"multipleOf",r.value,r.message,e);break}return t}function yw(n,e){const t=e.target==="openAi",r={type:"object",properties:{}},a=[],s=n.shape();for(const o in s){let c=s[o];if(c===void 0||c._def===void 0)continue;let u=bw(c);u&&t&&(c instanceof St&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),u=!1);const l=de(c._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});l!==void 0&&(r.properties[o]=l,u||a.push(o))}a.length&&(r.required=a);const i=_w(n,e);return i!==void 0&&(r.additionalProperties=i),r}function _w(n,e){if(n.catchall._def.typeName!=="ZodNever")return de(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(n.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function bw(n){try{return n.isOptional()}catch{return!0}}const ww=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return de(n.innerType._def,e);const t=de(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},vw=(n,e)=>{if(e.pipeStrategy==="input")return de(n.in._def,e);if(e.pipeStrategy==="output")return de(n.out._def,e);const t=de(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=de(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function xw(n,e){return de(n.type._def,e)}function Sw(n,e){const r={type:"array",uniqueItems:!0,items:de(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&he(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&he(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Ew(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>de(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:de(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>de(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function kw(){return{not:{}}}function Aw(){return{}}const Pw=(n,e)=>de(n.innerType._def,e),Ow=(n,e,t)=>{switch(e){case x.ZodString:return pf(n,t);case x.ZodNumber:return gw(n,t);case x.ZodObject:return yw(n,t);case x.ZodBigInt:return Qb(n,t);case x.ZodBoolean:return Yb();case x.ZodDate:return mf(n,t);case x.ZodUndefined:return kw();case x.ZodNull:return fw(t);case x.ZodArray:return Xb(n,t);case x.ZodUnion:case x.ZodDiscriminatedUnion:return mw(n,t);case x.ZodIntersection:return iw(n,t);case x.ZodTuple:return Ew(n,t);case x.ZodRecord:return gf(n,t);case x.ZodLiteral:return ow(n,t);case x.ZodEnum:return aw(n);case x.ZodNativeEnum:return dw(n);case x.ZodNullable:return pw(n,t);case x.ZodOptional:return ww(n,t);case x.ZodMap:return lw(n,t);case x.ZodSet:return Sw(n,t);case x.ZodLazy:return()=>n.getter()._def;case x.ZodPromise:return xw(n,t);case x.ZodNaN:case x.ZodNever:return hw();case x.ZodEffects:return nw(n,t);case x.ZodAny:return Kb();case x.ZodUnknown:return Aw();case x.ZodDefault:return rw(n,t);case x.ZodBranded:return ff(n,t);case x.ZodReadonly:return Pw(n,t);case x.ZodCatch:return ew(n,t);case x.ZodPipeline:return vw(n,t);case x.ZodFunction:case x.ZodVoid:case x.ZodSymbol:return;default:return(r=>{})()}};function de(n,e,t=!1){var o;const r=e.seen.get(n);if(e.override){const c=(o=e.override)==null?void 0:o.call(e,n,e,r,t);if(c!==Vb)return c}if(r&&!t){const c=Tw(r,e);if(c!==void 0)return c}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const s=Ow(n,n.typeName,e),i=typeof s=="function"?de(s(),e):s;if(i&&Rw(n,e,i),e.postProcess){const c=e.postProcess(i,n,e);return a.jsonSchema=i,c}return a.jsonSchema=i,i}const Tw=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:Iw(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Iw=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Rw=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),Cr=(n,e)=>{const t=Gb(e),r=void 0,a=e==null?void 0:e.name,s=de(n._def,t,!1)??{},i=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function co(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}const jw=["*","_","`"];function Cw(n){let e="";for(const[t,r]of Object.entries(n))e+=`	classDef ${t} ${r};
`;return e}function Nw(n,e,t){const{firstNode:r,lastNode:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=t??{};let u=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){const m="default",f={[m]:"{0}({1})"};r!==void 0&&(f[r]="{0}([{1}]):::first"),a!==void 0&&(f[a]="{0}([{1}]):::last");for(const[p,g]of Object.entries(n)){const w=g.name.split(":").pop()??"";let _=jw.some(E=>w.startsWith(E)&&w.endsWith(E))?`<p>${w}</p>`:w;Object.keys(g.metadata??{}).length&&(_+=`<hr/><small><em>${Object.entries(g.metadata??{}).map(([E,O])=>`${E} = ${O}`).join(`
`)}</em></small>`);const v=(f[p]??f[m]).replace("{0}",co(p)).replace("{1}",_);u+=`	${v}
`}}const l={};for(const m of e){const f=m.source.split(":"),p=m.target.split(":"),g=f.filter((w,b)=>w===p[b]).join(":");l[g]||(l[g]=[]),l[g].push(m)}const d=new Set;function h(m,f){const p=m.length===1&&m[0].source===m[0].target;if(f&&!p){const g=f.split(":").pop();if(d.has(g))throw new Error(`Found duplicate subgraph '${g}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(g),u+=`	subgraph ${g}
`}for(const g of m){const{source:w,target:b,data:_,conditional:v}=g;let E="";if(_!==void 0){let O=_;const T=O.split(" ");T.length>c&&(O=Array.from({length:Math.ceil(T.length/c)},(q,K)=>T.slice(K*c,(K+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),E=v?` -. &nbsp;${O}&nbsp; .-> `:` -- &nbsp;${O}&nbsp; --> `}else E=v?" -.-> ":" --> ";u+=`	${co(w)}${E}${co(b)};
`}for(const g in l)g.startsWith(`${f}:`)&&g!==f&&h(l[g],g);f&&!p&&(u+=`	end
`)}h(l[""]??[],"");for(const m in l)!m.includes(":")&&m!==""&&h(l[m],m);return i&&(u+=Cw(s??{})),u}async function $w(n,e){let{backgroundColor:t="white"}=e??{};const r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));const a=`https://mermaid.ink/img/${r}?bgColor=${t}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}function Lw(n,e){if(n!==void 0&&!ra(n))return n;if(Kc(e))try{let t=e.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t}catch{return e.getName()}else return e.name??"UnknownSchema"}function Mw(n){return Kc(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...Cr(n.data.schema),title:n.data.name}}}class Ei{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=ra(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...Mw(t)})),edges:this.edges.map(t=>{const r={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(r.data=t.data),typeof t.conditional<"u"&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const a=t??He(),s={id:a,data:e,name:Lw(t,e),metadata:r};return this.nodes[a]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const s={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(s),s}firstNode(){return Pl(this)}lastNode(){return Ol(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(u=>u.id).every(ra)&&(r="");const s=u=>r?`${r}:${u}`:u;Object.entries(e.nodes).forEach(([u,l])=>{this.nodes[s(u)]={...l,id:s(u)}});const i=e.edges.map(u=>({...u,source:s(u.source),target:s(u.target)}));this.edges=[...this.edges,...i];const o=e.firstNode(),c=e.lastNode();return[o?{id:s(o.id),data:o.data}:void 0,c?{id:s(c.id),data:c.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&Pl(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&Ol(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(a=>[a.id,a.name])),t=new Map;Object.values(e).forEach(a=>{t.set(a,(t.get(a)||0)+1)});const r=a=>{const s=e[a];return ra(a)&&t.get(s)===1?s:a};return new Ei({nodes:Object.fromEntries(Object.entries(this.nodes).map(([a,s])=>[r(a),{...s,id:r(a)}])),edges:this.edges.map(a=>({...a,source:r(a.source),target:r(a.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:s}=e??{},i=this.reid(),o=i.firstNode(),c=i.lastNode();return Nw(i.nodes,i.edges,{firstNode:o==null?void 0:o.id,lastNode:c==null?void 0:c.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:s})}async drawMermaidPng(e){const t=this.drawMermaid(e);return $w(t,{backgroundColor:e==null?void 0:e.backgroundColor})}}function Pl(n,e=[]){const t=new Set(n.edges.filter(a=>!e.includes(a.source)).map(a=>a.target)),r=[];for(const a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function Ol(n,e=[]){const t=new Set(n.edges.filter(a=>!e.includes(a.target)).map(a=>a.source)),r=[];for(const a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function Fw(n){const e=new TextEncoder,t=new ReadableStream({async start(r){for await(const a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return st.fromReadableStream(t)}function Tl(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}const Dw=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function rc(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*Il(n,e){for(;;){const{value:t,done:r}=dr.runWithConfig(pn(n),e.next.bind(e),!0);if(r)break;yield t}}async function*nc(n,e){const t=e[Symbol.asyncIterator]();for(;;){const{value:r,done:a}=await dr.runWithConfig(pn(n),t.next.bind(e),!0);if(a)break;yield r}}function Oe(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class Te extends Rr{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Pr({bound:this,kwargs:e,config:{}})}map(){return new Js({bound:this})}withRetry(e){return new Uw({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Pr({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new zw({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(le);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>le(s===0?e:r))}return Array.from({length:t},()=>le(e))}async batch(e,t,r){var c;const a=this._getOptionsList(t??{},e.length),s=((c=a[0])==null?void 0:c.maxConcurrency)??(r==null?void 0:r.maxConcurrency),i=new Gc({maxConcurrency:s,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>i.call(async()=>{try{return await this.invoke(u,a[l])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=le(t),a=new An({generator:this._streamIterator(e,r),config:r});return await a.setup,st.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=le(e):t=le({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const a=le(r),s=await Et(a),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),Oe(t,"input"),a.runId,a==null?void 0:a.runType,void 0,void 0,(a==null?void 0:a.runName)??this.getName()));delete a.runId;let o;try{const c=e.call(this,t,a,i);o=await hr(c,r==null?void 0:r.signal)}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd(Oe(o,"output"))),o}async _batchWithConfig(e,t,r,a){var u;const s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(Et)),o=await Promise.all(i.map(async(l,d)=>{const h=await(l==null?void 0:l.handleChainStart(this.toJSON(),Oe(t[d],"input"),s[d].runId,s[d].runType,void 0,void 0,s[d].runName??this.getName()));return delete s[d].runId,h}));let c;try{const l=e.call(this,t,s,o,a);c=await hr(l,(u=s==null?void 0:s[0])==null?void 0:u.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(Oe(c,"output")))),c}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0;const c=le(r),u=await Et(c);async function*l(){for await(const h of e){if(s)if(a===void 0)a=h;else try{a=kt(a,h)}catch{a=void 0,s=!1}yield h}}let d;try{const h=await Fb(t.bind(this),l(),async()=>u==null?void 0:u.handleChainStart(this.toJSON(),{input:""},c.runId,c.runType,void 0,void 0,c.runName??this.getName()),r==null?void 0:r.signal,c);delete c.runId,d=h.setup;const m=d==null?void 0:d.handlers.find(Bb);let f=h.output;m!==void 0&&d!==void 0&&(f=m.tapOutputIterable(d.runId,f));const p=d==null?void 0:d.handlers.find(Db);p!==void 0&&d!==void 0&&(f=p.tapOutputIterable(d.runId,f));for await(const g of f)if(yield g,o)if(i===void 0)i=g;else try{i=kt(i,g)}catch{i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:Oe(a,"input")})),h}await(d==null?void 0:d.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:Oe(a,"input")}))}getGraph(e){const t=new Ei,r=t.addNode({name:`${this.getName()}Input`,schema:be.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:be.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new $t({first:this,last:Er(e)})}pick(e){return this.pipe(new Hw(e))}assign(e){return this.pipe(new yf(new Pn({steps:e})))}async*transform(e,t){let r;for await(const a of e)r===void 0?r=a:r=kt(r,a);yield*this._streamIterator(r,le(t))}async*streamLog(e,t,r){const a=new Sl({...r,autoClose:!1,_schemaFormat:"original"}),s=le(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){const{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{const c=a.copy();c.addHandler(t,!0),r.callbacks=c}const s=this.stream(e,r);async function i(){try{const c=await s;for await(const u of c){const l=new ar({ops:[{op:"add",path:"/streamed_output/-",value:u}]});await t.writer.write(l)}}finally{await t.writer.close()}}const o=i();try{for await(const c of t)yield c}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?Fw(a):st.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){var f;const a=new zb({...r,autoClose:!1}),s=le(t),i=s.runId??He();s.runId=i;const o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{const p=o.copy();p.addHandler(a,!0),s.callbacks=p}const c=new AbortController,u=this;async function l(){try{let p;t!=null&&t.signal?"any"in AbortSignal?p=AbortSignal.any([c.signal,t.signal]):(p=t.signal,t.signal.addEventListener("abort",()=>{c.abort()},{once:!0})):p=c.signal;const g=await u.stream(e,{...s,signal:p}),w=a.tapOutputIterable(i,g);for await(const b of w)if(c.signal.aborted)break}finally{await a.finish()}}const d=l();let h=!1,m;try{for await(const p of a){if(!h){p.data.input=e,h=!0,m=p.run_id,yield p;continue}p.run_id===m&&p.event.endsWith("_end")&&(f=p.data)!=null&&f.input&&delete p.data.input,yield p}}finally{c.abort(),await d}}async*_streamEventsV1(e,t,r){let a,s=!1;const i=le(t),o=i.tags??[],c=i.metadata??{},u=i.runName??this.getName(),l=new Sl({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new qb({...r}),h=this._streamLog(e,l,i);for await(const f of h){if(a?a=a.concat(f):a=Pa.fromRunLogPatch(f),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;const b={...a.state},_={run_id:b.id,event:`on_${b.type}_start`,name:u,tags:o,metadata:c,data:{input:e}};d.includeEvent(_,b.type)&&(yield _)}const p=f.ops.filter(b=>b.path.startsWith("/logs/")).map(b=>b.path.split("/")[2]),g=[...new Set(p)];for(const b of g){let _,v={};const E=a.state.logs[b];if(E.end_time===void 0?E.streamed_output.length>0?_="stream":_="start":_="end",_==="start")E.inputs!==void 0&&(v.input=E.inputs);else if(_==="end")E.inputs!==void 0&&(v.input=E.inputs),v.output=E.final_output;else if(_==="stream"){const O=E.streamed_output.length;if(O!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${O} instead. Encountered in: "${E.name}"`);v={chunk:E.streamed_output[0]},E.streamed_output=[]}yield{event:`on_${E.type}_${_}`,name:E.name,run_id:E.id,tags:E.tags,metadata:E.metadata,data:v}}const{state:w}=a;if(w.streamed_output.length>0){const b=w.streamed_output.length;if(b!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${b} instead. Encountered in: "${w.name}"`);const _={chunk:w.streamed_output[0]};w.streamed_output=[];const v={event:`on_${w.type}_stream`,run_id:w.id,tags:o,metadata:c,name:u,data:_};d.includeEvent(v,w.type)&&(yield v)}}const m=a==null?void 0:a.state;if(m!==void 0){const f={event:`on_${m.type}_end`,name:u,run_id:m.id,tags:o,metadata:c,data:{output:m.final_output}};d.includeEvent(f,m.type)&&(yield f)}}static isRunnable(e){return Kc(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Pr({bound:this,config:{},configFactories:[a=>({callbacks:[new df({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return Zw(this,e)}}class Pr extends Te{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=wl(this.config,...e);return wl(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(le(t),this.kwargs))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(le(s),this.kwargs))):await this._mergeConfig(le(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(le(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(le(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(le(t),this.kwargs))}streamEvents(e,t,r){const a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(le(t),a.kwargs),version:t.version},r)};return st.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&Te.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new Pr({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new df({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class Js extends Te{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Js({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,Me(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new Js({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class Uw extends Pr{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return Me(t,{callbacks:r==null?void 0:r.getChild(a)})}async _invoke(e,t,r){return Bs(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){const s={};try{await Bs(async i=>{const o=e.map((h,m)=>m).filter(h=>s[h.toString()]===void 0||s[h.toString()]instanceof Error),c=o.map(h=>e[h]),u=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),l=await super.batch(c,u,{...a,returnExceptions:!0});let d;for(let h=0;h<l.length;h+=1){const m=l[h],f=o[h];m instanceof Error&&d===void 0&&(d=m,d.input=c[h]),s[f.toString()]=m}if(d)throw d;return l},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((a==null?void 0:a.returnExceptions)!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class $t extends Te{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){var c;const r=le(t),a=await Et(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i=e,o;try{const u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1){const h=u[l].invoke(i,Me(r,{callbacks:s==null?void 0:s.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));i=await hr(h,t==null?void 0:t.signal)}if((c=t==null?void 0:t.signal)!=null&&c.aborted)throw new Error("Aborted");o=await this.last.invoke(i,Me(r,{callbacks:s==null?void 0:s.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(u){throw await(s==null?void 0:s.handleChainError(u)),u}return await(s==null?void 0:s.handleChainEnd(Oe(o,"output"))),o}async batch(e,t,r){var c;const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(Et)),i=await Promise.all(s.map(async(u,l)=>{const d=await(u==null?void 0:u.handleChainStart(this.toJSON(),Oe(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName));return delete a[l].runId,d}));let o=e;try{for(let u=0;u<this.steps.length;u+=1){const d=this.steps[u].batch(o,i.map((h,m)=>{const f=h==null?void 0:h.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`);return Me(a[m],{callbacks:f})}),r);o=await hr(d,(c=a[0])==null?void 0:c.signal)}}catch(u){throw await Promise.all(i.map(l=>l==null?void 0:l.handleChainError(u))),u}return await Promise.all(i.map(u=>u==null?void 0:u.handleChainEnd(Oe(o,"output")))),o}async*_streamIterator(e,t){var d;const r=await Et(t),{runId:a,...s}=t??{},i=await(r==null?void 0:r.handleChainStart(this.toJSON(),Oe(e,"input"),a,void 0,void 0,void 0,s==null?void 0:s.runName)),o=[this.first,...this.middle,this.last];let c=!0,u;async function*l(){yield e}try{let h=o[0].transform(l(),Me(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let m=1;m<o.length;m+=1)h=await o[m].transform(h,Me(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));for await(const m of h)if((d=t==null?void 0:t.signal)==null||d.throwIfAborted(),yield m,c)if(u===void 0)u=m;else try{u=kt(u,m)}catch{u=void 0,c=!1}}catch(h){throw await(i==null?void 0:i.handleChainError(h)),h}await(i==null?void 0:i.handleChainEnd(Oe(u,"output")))}getGraph(e){const t=new Ei;let r=null;return this.steps.forEach((a,s)=>{const i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return $t.isRunnableSequence(e)?new $t({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new $t({first:this.first,middle:[...this.middle,this.last],last:Er(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Te.isRunnable(e)}static from([e,...t],r){let a={};return typeof r=="string"?a.name=r:r!==void 0&&(a=r),new $t({...a,first:Er(e),middle:t.slice(0,-1).map(Er),last:Er(t[t.length-1])})}}class Pn extends Te{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=Er(r)}static from(e){return new Pn({steps:e})}async invoke(e,t){const r=le(t),a=await Et(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;const i={};try{const o=Object.entries(this.steps).map(async([c,u])=>{i[c]=await u.invoke(e,Me(r,{callbacks:s==null?void 0:s.getChild(`map:key:${c}`)}))});await hr(Promise.all(o),t==null?void 0:t.signal)}catch(o){throw await(s==null?void 0:s.handleChainError(o)),o}return await(s==null?void 0:s.handleChainEnd(i)),i}async*_transform(e,t,r){const a={...this.steps},s=lf(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,c],u)=>{const l=c.transform(s[u],Me(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){const o=Promise.race(i.values()),{key:c,result:u,gen:l}=await hr(o,r==null?void 0:r.signal);i.delete(c),u.done||(yield{[c]:u.value},i.set(c,l.next().then(d=>({key:c,gen:l,result:d}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=le(t),s=new An({generator:this.transform(r(),a),config:a});return await s.setup,st.fromAsyncGenerator(s)}}class Xc extends Te{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Vc(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[r]=this._getOptionsList(t??{},1),a=await Et(r),s=this.func(Me(r,{callbacks:a}),e);return hr(s,r==null?void 0:r.signal)}async*_streamIterator(e,t){var s,i;const[r]=this._getOptionsList(t??{},1),a=await this.invoke(e,t);if(rc(a)){for await(const o of a)(s=r==null?void 0:r.signal)==null||s.throwIfAborted(),yield o;return}if(Dw(a)){for(;;){(i=r==null?void 0:r.signal)==null||i.throwIfAborted();const o=a.next();if(o.done)break;yield o.value}return}yield a}static from(e){return new Xc({func:e})}}function Bw(n){if(Vc(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class On extends Te{static lc_name(){return"RunnableLambda"}constructor(e){if(Vc(e.func))return Xc.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Bw(e.func),this.func=e.func}static from(e){return new On({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{const i=Me(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((t==null?void 0:t.recursionLimit)??so)-1});dr.runWithConfig(pn(i),async()=>{var o,c;try{let u=await this.func(e,{...i});if(u&&Te.isRunnable(u)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");u=await u.invoke(e,{...i,recursionLimit:(i.recursionLimit??so)-1})}else if(rc(u)){let l;for await(const d of nc(i,u))if((o=t==null?void 0:t.signal)==null||o.throwIfAborted(),l===void 0)l=d;else try{l=kt(l,d)}catch{l=d}u=l}else if(Tl(u)){let l;for(const d of Il(i,u))if((c=t==null?void 0:t.signal)==null||c.throwIfAborted(),l===void 0)l=d;else try{l=kt(l,d)}catch{l=d}u=l}a(u)}catch(u){s(u)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){var o,c;let a;for await(const u of e)if(a===void 0)a=u;else try{a=kt(a,u)}catch{a=u}const s=Me(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??so)-1}),i=await new Promise((u,l)=>{dr.runWithConfig(pn(s),async()=>{try{const d=await this.func(a,{...s,config:s});u(d)}catch(d){l(d)}})});if(i&&Te.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const u=await i.stream(a,s);for await(const l of u)yield l}else if(rc(i))for await(const u of nc(s,i))(o=r==null?void 0:r.signal)==null||o.throwIfAborted(),yield u;else if(Tl(i))for(const u of Il(s,i))(c=r==null?void 0:r.signal)==null||c.throwIfAborted(),yield u;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=le(t),s=new An({generator:this.transform(r(),a),config:a});return await s.setup,st.fromAsyncGenerator(s)}}class zw extends Te{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=le(t),a=await Et(r),{runId:s,...i}=r,o=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),s,void 0,void 0,void 0,i==null?void 0:i.runName)),c=Me(i,{callbacks:o==null?void 0:o.getChild()});return await dr.runWithConfig(c,async()=>{var d;let l;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{const m=await h.invoke(e,c);return await(o==null?void 0:o.handleChainEnd(Oe(m,"output"))),m}catch(m){l===void 0&&(l=m)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,t){var d;const r=le(t),a=await Et(r),{runId:s,...i}=r,o=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),s,void 0,void 0,void 0,i==null?void 0:i.runName));let c,u;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();const m=Me(i,{callbacks:o==null?void 0:o.getChild()});try{const f=await h.stream(e,m);u=nc(m,f);break}catch(f){c===void 0&&(c=f)}}if(u===void 0){const h=c??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let l;try{for await(const h of u){yield h;try{l=l===void 0?l:kt(l,h)}catch{l=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(Oe(l,"output")))}async batch(e,t,r){var c;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>Et(u))),i=await Promise.all(s.map(async(u,l)=>{const d=await(u==null?void 0:u.handleChainStart(this.toJSON(),Oe(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName));return delete a[l].runId,d}));let o;for(const u of this.runnables()){(c=a[0].signal)==null||c.throwIfAborted();try{const l=await u.batch(e,i.map((d,h)=>Me(a[h],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(i.map((d,h)=>d==null?void 0:d.handleChainEnd(Oe(l[h],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(i.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function Er(n){if(typeof n=="function")return new On({func:n});if(Te.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=Er(r);return new Pn({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class yf extends Te{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Pn&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const a=this.mapper.getStepsKeys(),[s,i]=lf(e),o=this.mapper.transform(i,Me(r,{callbacks:t==null?void 0:t.getChild()})),c=o.next();for await(const u of s){if(typeof u!="object"||Array.isArray(u))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof u}`);const l=Object.fromEntries(Object.entries(u).filter(([d])=>!a.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await c).value;for await(const u of o)yield u}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=le(t),s=new An({generator:this.transform(r(),a),config:a});return await s.setup,st.fromAsyncGenerator(s)}}class Hw extends Te{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=le(t),s=new An({generator:this.transform(r(),a),config:a});return await s.setup,st.fromAsyncGenerator(s)}}class Rl extends Pr{constructor(e){const t=$t.from([On.from(async r=>{let a;if(Dh(r))try{a=await this.schema.parseAsync(r.args)}catch{throw new dy("Received tool input did not match expected schema",JSON.stringify(r.args))}else a=r;return a}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function Zw(n,e){var a;const t=e.name??n.getName(),r=e.description??((a=e.schema)==null?void 0:a.description);return e.schema.constructor===be.ZodString?new Rl({name:t,description:r,schema:be.object({input:be.string()}).transform(s=>s.input),bound:n}):new Rl({name:t,description:r,schema:e.schema,bound:n})}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var qw=typeof window=="object"?window:{},X="0123456789abcdef".split(""),Vw=[-2147483648,8388608,32768,128],ft=[24,16,8,0],ke=[];function Pt(n){n?(ke[0]=ke[16]=ke[1]=ke[2]=ke[3]=ke[4]=ke[5]=ke[6]=ke[7]=ke[8]=ke[9]=ke[10]=ke[11]=ke[12]=ke[13]=ke[14]=ke[15]=0,this.blocks=ke):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Pt.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===qw.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<ft[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<ft[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<ft[a++&3],i[a>>2]|=(128|t&63)<<ft[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<ft[a++&3],i[a>>2]|=(128|t>>6&63)<<ft[a++&3],i[a>>2]|=(128|t&63)<<ft[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<ft[a++&3],i[a>>2]|=(128|t>>12&63)<<ft[a++&3],i[a>>2]|=(128|t>>6&63)<<ft[a++&3],i[a>>2]|=(128|t&63)<<ft[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Pt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=Vw[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};Pt.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,c=this.blocks;for(i=16;i<80;++i)o=c[i-3]^c[i-8]^c[i-14]^c[i-16],c[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+c[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+c[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+c[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+c[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+c[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+c[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+c[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+c[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+c[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+c[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+c[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+c[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+c[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+c[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+c[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+c[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+c[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+c[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+c[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+c[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};Pt.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return X[n>>28&15]+X[n>>24&15]+X[n>>20&15]+X[n>>16&15]+X[n>>12&15]+X[n>>8&15]+X[n>>4&15]+X[n&15]+X[e>>28&15]+X[e>>24&15]+X[e>>20&15]+X[e>>16&15]+X[e>>12&15]+X[e>>8&15]+X[e>>4&15]+X[e&15]+X[t>>28&15]+X[t>>24&15]+X[t>>20&15]+X[t>>16&15]+X[t>>12&15]+X[t>>8&15]+X[t>>4&15]+X[t&15]+X[r>>28&15]+X[r>>24&15]+X[r>>20&15]+X[r>>16&15]+X[r>>12&15]+X[r>>8&15]+X[r>>4&15]+X[r&15]+X[a>>28&15]+X[a>>24&15]+X[a>>20&15]+X[a>>16&15]+X[a>>12&15]+X[a>>8&15]+X[a>>4&15]+X[a&15]};Pt.prototype.toString=Pt.prototype.hex;Pt.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};Pt.prototype.array=Pt.prototype.digest;Pt.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};const Ww=n=>new Pt(!0).update(n).hex(),jl=(...n)=>Ww(n.join("_"));class Jw{}const Gw=new Map;class Qc extends Jw{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(jl(e,t))??null)}async update(e,t,r){this.cache.set(jl(e,t),r)}static global(){return new Qc(Gw)}}class _f extends Rr{}class Kw extends _f{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new mn(this.value)]}}class Xw extends _f{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Uh(this.messages)}toChatMessages(){return this.messages}}var ki={};ki.byteLength=ev;ki.toByteArray=rv;ki.fromByteArray=sv;var Ct=[],ut=[],Qw=typeof Uint8Array<"u"?Uint8Array:Array,uo="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var zr=0,Yw=uo.length;zr<Yw;++zr)Ct[zr]=uo[zr],ut[uo.charCodeAt(zr)]=zr;ut[45]=62;ut[95]=63;function bf(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function ev(n){var e=bf(n),t=e[0],r=e[1];return(t+r)*3/4-r}function tv(n,e,t){return(e+t)*3/4-t}function rv(n){var e,t=bf(n),r=t[0],a=t[1],s=new Qw(tv(n,r,a)),i=0,o=a>0?r-4:r,c;for(c=0;c<o;c+=4)e=ut[n.charCodeAt(c)]<<18|ut[n.charCodeAt(c+1)]<<12|ut[n.charCodeAt(c+2)]<<6|ut[n.charCodeAt(c+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=ut[n.charCodeAt(c)]<<2|ut[n.charCodeAt(c+1)]>>4,s[i++]=e&255),a===1&&(e=ut[n.charCodeAt(c)]<<10|ut[n.charCodeAt(c+1)]<<4|ut[n.charCodeAt(c+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function nv(n){return Ct[n>>18&63]+Ct[n>>12&63]+Ct[n>>6&63]+Ct[n&63]}function av(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(nv(r));return a.join("")}function sv(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(av(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(Ct[e>>2]+Ct[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(Ct[e>>10]+Ct[e>>4&63]+Ct[e<<2&63]+"=")),a.join("")}var iv=Object.defineProperty,ov=(n,e,t)=>e in n?iv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,cv=(n,e,t)=>(ov(n,e+"",t),t);function uv(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){const s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){const a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function lv(n,e){return n.length===1?[e.get(n.join(","))]:uv(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function dv(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var ac=class{constructor(n,e){Gt(this,"specialTokens");Gt(this,"inverseSpecialTokens");Gt(this,"patStr");Gt(this,"textEncoder",new TextEncoder);Gt(this,"textDecoder",new TextDecoder("utf-8"));Gt(this,"rankMap",new Map);Gt(this,"textMap",new Map);this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{const[s,i,...o]=a.split(" "),c=Number.parseInt(i,10);return o.forEach((u,l)=>r[u]=c+l),r},{});for(const[r,a]of Object.entries(t)){const s=ki.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),a=ac.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(u=>!i.has(u)):t);if(o.size>0){const u=ac.specialTokenRegex([...o]),l=n.match(u);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let c=0;for(;;){let u=null,l=c;for(;a.lastIndex=l,u=a.exec(n),!(u==null||i.has(u[0]));)l=u.index+1;const d=(u==null?void 0:u.index)??n.length;for(const m of n.substring(c,d).matchAll(r)){const f=this.textEncoder.encode(m[0]),p=this.rankMap.get(f.join(","));if(p!=null){s.push(p);continue}s.push(...lv(f,this.rankMap))}if(u==null)break;let h=this.specialTokens[u[0]];s.push(h),c=u.index+u[0].length}return s}decode(n){const e=[];let t=0;for(let s=0;s<n.length;++s){const i=n[s],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let a=0;for(const s of e)r.set(s,a),a+=s.length;return this.textDecoder.decode(r)}},wf=ac;cv(wf,"specialTokenRegex",n=>new RegExp(n.map(e=>dv(e)).join("|"),"g"));function hv(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"o3-mini":case"o3-mini-2025-01-31":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}const rs={},fv=new Gc({});async function mv(n){return n in rs||(rs[n]=fv.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new wf(e)).catch(e=>{throw delete rs[n],e})),await rs[n]}async function pv(n){return mv(hv(n))}const gv=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;function Yc(n){return typeof n!="object"||!n?!1:!!("type"in n&&n.type==="function"&&"function"in n&&typeof n.function=="object"&&n.function&&"name"in n.function&&"parameters"in n.function)}const yv=()=>!1;class _v extends Te{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??yv(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class bv extends _v{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){const{cache:a,...s}=r;super({callbacks:e??t,...s}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof a=="object"?this.cache=a:a?this.cache=Qc.global():this.cache=void 0,this.caller=new Gc(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await pv("modelName"in this?gv(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new Kw(e):Array.isArray(e)?new Xw(e.map(Qn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class yn extends Te{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const r=le(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){const r=le(t);let a,s=!0;for await(const i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=kt(a,i)}catch{a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new yf(new Pn({steps:e}))}}function eu(n){return typeof(n==null?void 0:n.parse)=="function"}class Vt extends bv{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){const r=Vt._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){var r;if(this._streamResponseChunks===Vt.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const s=Vt._convertInputToPromptValue(e).toChatMessages(),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(t),c={...i.metadata,...this.getLsParams(o)},u=await Je.configure(i.callbacks,this.callbacks,i.tags,this.tags,c,this.metadata,{verbose:this.verbose}),l={options:o,invocation_params:this==null?void 0:this.invocationParams(o),batch_size:1},d=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),[s],i.runId,void 0,l,void 0,void 0,i.runName));let h,m;try{for await(const f of this._streamResponseChunks(s,o,d==null?void 0:d[0])){if(f.message.id==null){const p=(r=d==null?void 0:d.at(0))==null?void 0:r.runId;p!=null&&f.message._updateId(`run-${p}`)}f.message.response_metadata={...f.generationInfo,...f.message.response_metadata},yield f.message,h?h=h.concat(f):h=f,Ju(f.message)&&f.message.usage_metadata!==void 0&&(m={tokenUsage:{promptTokens:f.message.usage_metadata.input_tokens,completionTokens:f.message.usage_metadata.output_tokens,totalTokens:f.message.usage_metadata.total_tokens}})}}catch(f){throw await Promise.all((d??[]).map(p=>p==null?void 0:p.handleLLMError(f))),f}await Promise.all((d??[]).map(f=>f==null?void 0:f.handleLLMEnd({generations:[[h]],llmOutput:m})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r,a){var d,h;const s=e.map(m=>m.map(Qn));let i;if(a!==void 0&&a.length===s.length)i=a;else{const m={...r.metadata,...this.getLsParams(t)},f=await Je.configure(r.callbacks,this.callbacks,r.tags,this.tags,m,this.metadata,{verbose:this.verbose}),p={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1};i=await(f==null?void 0:f.handleChatModelStart(this.toJSON(),s,r.runId,void 0,p,void 0,void 0,r.runName))}const o=[],c=[];if(!!(i!=null&&i[0].handlers.find(_b))&&!this.disableStreaming&&s.length===1&&this._streamResponseChunks!==Vt.prototype._streamResponseChunks)try{const m=await this._streamResponseChunks(s[0],t,i==null?void 0:i[0]);let f,p;for await(const g of m){if(g.message.id==null){const w=(d=i==null?void 0:i.at(0))==null?void 0:d.runId;w!=null&&g.message._updateId(`run-${w}`)}f===void 0?f=g:f=kt(f,g),Ju(g.message)&&g.message.usage_metadata!==void 0&&(p={tokenUsage:{promptTokens:g.message.usage_metadata.input_tokens,completionTokens:g.message.usage_metadata.output_tokens,totalTokens:g.message.usage_metadata.total_tokens}})}if(f===void 0)throw new Error("Received empty response from chat model call.");o.push([f]),await(i==null?void 0:i[0].handleLLMEnd({generations:o,llmOutput:p}))}catch(m){throw await(i==null?void 0:i[0].handleLLMError(m)),m}else{const m=await Promise.allSettled(s.map((f,p)=>this._generate(f,{...t,promptIndex:p},i==null?void 0:i[p])));await Promise.all(m.map(async(f,p)=>{var g,w,b;if(f.status==="fulfilled"){const _=f.value;for(const v of _.generations){if(v.message.id==null){const E=(g=i==null?void 0:i.at(0))==null?void 0:g.runId;E!=null&&v.message._updateId(`run-${E}`)}v.message.response_metadata={...v.generationInfo,...v.message.response_metadata}}return _.generations.length===1&&(_.generations[0].message.response_metadata={..._.llmOutput,..._.generations[0].message.response_metadata}),o[p]=_.generations,c[p]=_.llmOutput,(w=i==null?void 0:i[p])==null?void 0:w.handleLLMEnd({generations:[_.generations],llmOutput:_.llmOutput})}else return await((b=i==null?void 0:i[p])==null?void 0:b.handleLLMError(f.reason)),Promise.reject(f.reason)}))}const l={generations:o,llmOutput:c.length?(h=this._combineLLMOutput)==null?void 0:h.call(this,...c):void 0};return Object.defineProperty(l,El,{value:i?{runIds:i==null?void 0:i.map(m=>m.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){const i=e.map(g=>g.map(Qn)),o={...s.metadata,...this.getLsParams(a)},c=await Je.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),u={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},l=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),i,s.runId,void 0,u,void 0,void 0,s.runName)),d=[],m=(await Promise.allSettled(i.map(async(g,w)=>{const b=Vt._convertInputToPromptValue(g).toString(),_=await t.lookup(b,r);return _==null&&d.push(w),_}))).map((g,w)=>({result:g,runManager:l==null?void 0:l[w]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),f=[];await Promise.all(m.map(async({result:g,runManager:w},b)=>{if(g.status==="fulfilled"){const _=g.value;return f[b]=_.map(v=>("message"in v&&mi(v.message)&&En(v.message)&&(v.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),v.generationInfo={...v.generationInfo,tokenUsage:{}},v)),_.length&&await(w==null?void 0:w.handleLLMNewToken(_[0].text)),w==null?void 0:w.handleLLMEnd({generations:[_]},void 0,void 0,void 0,{cached:!0})}else return await(w==null?void 0:w.handleLLMError(g.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(g.reason)}));const p={generations:f,missingPromptIndices:d,startedRunManagers:l};return Object.defineProperty(p,El,{value:l?{runIds:l==null?void 0:l.map(g=>g.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){let a;Array.isArray(t)?a={stop:t}:a=t;const s=e.map(f=>f.map(Qn)),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(a);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(s,o,i);const{cache:c}=this,u=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({messages:s,cache:c,llmStringKey:u,parsedOptions:o,handledOptions:i});let m={};if(d.length>0){const f=await this._generateUncached(d.map(p=>s[p]),o,i,h!==void 0?d.map(p=>h==null?void 0:h[p]):void 0);await Promise.all(f.generations.map(async(p,g)=>{const w=d[g];l[w]=p;const b=Vt._convertInputToPromptValue(s[w]).toString();return c.update(b,u,p)})),m=f.llmOutput??{}}return{generations:l,llmOutput:m}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(Qn)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const a=new mn(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t!=null&&t.strict)throw new Error('"strict" mode is not supported for this model by default.');const r=e,a=t==null?void 0:t.name,s=r.description??"A function available to call.",i=t==null?void 0:t.method,o=t==null?void 0:t.includeRaw;if(i==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let c=a??"extract",u;eu(r)?u=[{type:"function",function:{name:c,description:s,parameters:Cr(r)}}]:("name"in r&&(c=r.name),u=[{type:"function",function:{name:c,description:s,parameters:r}}]);const l=this.bindTools(u),d=On.from(p=>{if(!p.tool_calls||p.tool_calls.length===0)throw new Error("No tool calls found in the response.");const g=p.tool_calls.find(w=>w.name===c);if(!g)throw new Error(`No tool call found with name ${c}.`);return g.args});if(!o)return l.pipe(d).withConfig({runName:"StructuredOutput"});const h=yn.assign({parsed:(p,g)=>d.invoke(p.raw,g)}),m=yn.assign({parsed:()=>null}),f=h.withFallbacks({fallbacks:[m]});return $t.from([{raw:l},f]).withConfig({runName:"StructuredOutputRunnable"})}}class vf extends Te{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"})}}class xf extends vf{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class Oa extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Fh(this,"OUTPUT_PARSING_FAILURE")}}function sc(n,e){const t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;const r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!sc(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;const r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(const i of r)if(!sc(n[i],e[i]))return!1;return!0}return n===e}class wv extends xf{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class Sf extends wv{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let t,r;for await(const a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if(cy(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new fr({message:a,text:a.content})}else if(mi(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new fr({message:my(a),text:a.content})}else s=new gn({text:a});r===void 0?r=s:r=r.concat(s);const i=await this.parsePartialResult([r]);i!=null&&!sc(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}getFormatInstructions(){return""}}class Cl extends xf{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const t=be.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,be.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Cr(this.schema))}
\`\`\`
`}async parse(e){try{const r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new Oa(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class Nl extends Sf{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?db(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Hu(e[0].text)}async parse(e){return Hu(e,JSON.parse)}getFormatInstructions(){return""}}function tu(n,e){if(n.function===void 0)return;let t;if(e!=null&&e.partial)try{t=Dc(n.function.arguments??"{}")}catch{return}else try{t=JSON.parse(n.function.arguments)}catch(a){throw new Oa([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${a.message}`].join(`
`))}const r={name:n.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(r.id=n.id),r}function vv(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function Ef(n,e){var t,r;return{name:(t=n.function)==null?void 0:t.name,args:(r=n.function)==null?void 0:r.arguments,id:n.id,error:e,type:"invalid_tool_call"}}class xv extends Sf{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var i;const r=e[0].message;let a;if(En(r)&&((i=r.tool_calls)!=null&&i.length)?a=r.tool_calls.map(o=>{const{id:c,...u}=o;return this.returnId?{id:c,...u}:u}):r.additional_kwargs.tool_calls!==void 0&&(a=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(c=>tu(c,{returnId:this.returnId,partial:t}))),!a)return[];const s=[];for(const o of a)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};s.push(c)}return s}}class $l extends xv{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Oa(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const r=(await super.parsePartialResult(e)).filter(s=>s.type===this.keyName);let a=r;if(r.length)return this.returnId||(a=r.map(s=>s.args)),this.returnSingle?a[0]:a}async parseResult(e){const r=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName);let a=r;return r.length?(this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))):void 0}}const Sv=Symbol("Let zodToJsonSchema decide on which parser to use"),Ll={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Ev=n=>typeof n=="string"?{...Ll,basePath:["#"],definitions:{},name:n}:{...Ll,basePath:["#"],definitions:{},...n},ic=n=>"_def"in n?n._def:n;function kv(n){if(!n)return!0;for(const e in n)return!1;return!0}const Av=n=>{const e=Ev(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[ic(a),{def:ic(a),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function kf(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function fe(n,e,t,r,a){n[e]=t,kf(n,e,r,a)}function Pv(){return{}}function Ov(n,e){var r,a;const t={type:"array"};return((a=(r=n.type)==null?void 0:r._def)==null?void 0:a.typeName)!==x.ZodAny&&(t.items=ue(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&fe(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&fe(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(fe(t,"minItems",n.exactLength.value,n.exactLength.message,e),fe(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Tv(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?fe(t,"minimum",r.value,r.message,e):fe(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),fe(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?fe(t,"maximum",r.value,r.message,e):fe(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),fe(t,"maximum",r.value,r.message,e));break;case"multipleOf":fe(t,"multipleOf",r.value,r.message,e);break}return t}function Iv(){return{type:"boolean"}}function Rv(n,e){return ue(n.type._def,e)}const jv=(n,e)=>ue(n.innerType._def,e);function Af(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>Af(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Cv(n,e)}}const Cv=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":fe(t,"minimum",r.value,r.message,e);break;case"max":fe(t,"maximum",r.value,r.message,e);break}return t};function Nv(n,e){return{...ue(n.innerType._def,e),default:n.defaultValue()}}function $v(n,e,t){return e.effectStrategy==="input"?ue(n.schema._def,e,t):{}}function Lv(n){return{type:"string",enum:[...n.values]}}const Mv=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Fv(n,e){const t=[ue(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),ue(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(s=>{if(Mv(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){const{additionalProperties:o,...c}=s;i=c}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function Dv(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let lo;const _r={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(lo===void 0&&(lo=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),lo),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Pf(n,e){const t={type:"string"};function r(a){return e.patternStrategy==="escape"?Uv(a):a}if(n.checks)for(const a of n.checks)switch(a.kind){case"min":fe(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":fe(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":mt(t,"email",a.message,e);break;case"format:idn-email":mt(t,"idn-email",a.message,e);break;case"pattern:zod":pt(t,_r.email,a.message,e);break}break;case"url":mt(t,"uri",a.message,e);break;case"uuid":mt(t,"uuid",a.message,e);break;case"regex":pt(t,a.regex,a.message,e);break;case"cuid":pt(t,_r.cuid,a.message,e);break;case"cuid2":pt(t,_r.cuid2,a.message,e);break;case"startsWith":pt(t,RegExp(`^${r(a.value)}`),a.message,e);break;case"endsWith":pt(t,RegExp(`${r(a.value)}$`),a.message,e);break;case"datetime":mt(t,"date-time",a.message,e);break;case"date":mt(t,"date",a.message,e);break;case"time":mt(t,"time",a.message,e);break;case"duration":mt(t,"duration",a.message,e);break;case"length":fe(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),fe(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{pt(t,RegExp(r(a.value)),a.message,e);break}case"ip":{a.version!=="v6"&&mt(t,"ipv4",a.message,e),a.version!=="v4"&&mt(t,"ipv6",a.message,e);break}case"emoji":pt(t,_r.emoji,a.message,e);break;case"ulid":{pt(t,_r.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{mt(t,"binary",a.message,e);break}case"contentEncoding:base64":{fe(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{pt(t,_r.base64,a.message,e);break}}break}case"nanoid":pt(t,_r.nanoid,a.message,e)}return t}const Uv=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),mt=(n,e,t,r)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):fe(n,"format",e,t,r)},pt=(n,e,t,r)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Ml(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):fe(n,"pattern",Ml(e,r),t,r)},Ml=(n,e)=>{var u;const t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;const r={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},a=r.i?t.source.toLowerCase():t.source;let s="",i=!1,o=!1,c=!1;for(let l=0;l<a.length;l++){if(i){s+=a[l],i=!1;continue}if(r.i){if(o){if(a[l].match(/[a-z]/)){c?(s+=a[l],s+=`${a[l-2]}-${a[l]}`.toUpperCase(),c=!1):a[l+1]==="-"&&((u=a[l+2])!=null&&u.match(/[a-z]/))?(s+=a[l],c=!0):s+=`${a[l]}${a[l].toUpperCase()}`;continue}}else if(a[l].match(/[a-z]/)){s+=`[${a[l]}${a[l].toUpperCase()}]`;continue}}if(r.m){if(a[l]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(a[l]==="$"){s+=`($|(?=[\r
]))`;continue}}if(r.s&&a[l]==="."){s+=o?`${a[l]}\r
`:`[${a[l]}\r
]`;continue}s+=a[l],a[l]==="\\"?i=!0:o&&a[l]==="]"?o=!1:!o&&a[l]==="["&&(o=!0)}try{const l=new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s};function Of(n,e){var r,a,s,i;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===x.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((o,c)=>({...o,[c]:ue(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:ue(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===x.ZodString&&((s=n.keyType._def.checks)!=null&&s.length)){const o=Object.entries(Pf(n.keyType._def,e)).reduce((c,[u,l])=>u==="type"?c:{...c,[u]:l},{});return{...t,propertyNames:o}}else if(((i=n.keyType)==null?void 0:i._def.typeName)===x.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function Bv(n,e){if(e.mapStrategy==="record")return Of(n,e);const t=ue(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=ue(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function zv(n){const e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function Hv(){return{not:{}}}function Zv(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Gs={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function qv(n,e){if(e.target==="openApi3")return Fl(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Gs&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((a,s)=>{const i=Gs[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((a,s)=>{const i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){const a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Fl(n,e)}const Fl=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>ue(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function Vv(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Gs[n.innerType._def.typeName],nullable:!0}:{type:[Gs[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=ue(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=ue(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Wv(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",kf(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?fe(t,"minimum",r.value,r.message,e):fe(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),fe(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?fe(t,"maximum",r.value,r.message,e):fe(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),fe(t,"maximum",r.value,r.message,e));break;case"multipleOf":fe(t,"multipleOf",r.value,r.message,e);break}return t}function Jv(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":ue(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":ue(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Gv(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((r,[a,s])=>{if(s===void 0||s._def===void 0)return r;const i=ue(s._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return i===void 0?r:{properties:{...r.properties,[a]:i},required:s.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,a]}},{properties:{},required:[]}),additionalProperties:Jv(n,e)};return t.required.length||delete t.required,t}const Kv=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return ue(n.innerType._def,e);const t=ue(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Xv=(n,e)=>{if(e.pipeStrategy==="input")return ue(n.in._def,e);if(e.pipeStrategy==="output")return ue(n.out._def,e);const t=ue(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=ue(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function Qv(n,e){return ue(n.type._def,e)}function Yv(n,e){const r={type:"array",uniqueItems:!0,items:ue(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&fe(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&fe(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function e0(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>ue(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:ue(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>ue(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function t0(){return{not:{}}}function r0(){return{}}const n0=(n,e)=>ue(n.innerType._def,e);function ue(n,e,t=!1){var i;const r=e.seen.get(n);if(e.override){const o=(i=e.override)==null?void 0:i.call(e,n,e,r,t);if(o!==Sv)return o}if(r&&!t){const o=a0(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const s=i0(n,n.typeName,e,t);return s&&o0(n,e,s),a.jsonSchema=s,s}const a0=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"extract-to-root":const t=n.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=n.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:s0(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((r,a)=>e.currentPath[a]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},s0=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},i0=(n,e,t,r)=>{switch(e){case x.ZodString:return Pf(n,t);case x.ZodNumber:return Wv(n,t);case x.ZodObject:return Gv(n,t);case x.ZodBigInt:return Tv(n,t);case x.ZodBoolean:return Iv();case x.ZodDate:return Af(n,t);case x.ZodUndefined:return t0();case x.ZodNull:return Zv(t);case x.ZodArray:return Ov(n,t);case x.ZodUnion:case x.ZodDiscriminatedUnion:return qv(n,t);case x.ZodIntersection:return Fv(n,t);case x.ZodTuple:return e0(n,t);case x.ZodRecord:return Of(n,t);case x.ZodLiteral:return Dv(n,t);case x.ZodEnum:return Lv(n);case x.ZodNativeEnum:return zv(n);case x.ZodNullable:return Vv(n,t);case x.ZodOptional:return Kv(n,t);case x.ZodMap:return Bv(n,t);case x.ZodSet:return Yv(n,t);case x.ZodLazy:return ue(n.getter()._def,t);case x.ZodPromise:return Qv(n,t);case x.ZodNaN:case x.ZodNever:return Hv();case x.ZodEffects:return $v(n,t,r);case x.ZodAny:return Pv();case x.ZodUnknown:return r0();case x.ZodDefault:return Nv(n,t);case x.ZodBranded:return Rv(n,t);case x.ZodReadonly:return n0(n,t);case x.ZodCatch:return jv(n,t);case x.ZodPipeline:return Xv(n,t);case x.ZodFunction:case x.ZodVoid:case x.ZodSymbol:return;default:return(a=>{})()}},o0=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),c0=(n,e)=>{const t=Av(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,a=ue(n._def,r===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,r]},!1)??{},s=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;s!==void 0&&(a.title=s);const i=(()=>{if(kv(t.definitions))return;const c={},u=new Set;for(let l=0;l<500;l++){const d=Object.entries(t.definitions).filter(([h])=>!u.has(h));if(d.length===0)break;for(const[h,m]of d)c[h]=ue(ic(m),{...t,currentPath:[...t.basePath,t.definitionPath,h]},!0)??{},u.add(h)}return c})(),o=r===void 0?i?{...a,[t.definitionPath]:i}:a:t.nameStrategy==="duplicate-ref"?{...a,...i||t.seenRefs.size?{[t.definitionPath]:{...i,...t.seenRefs.size?{[r]:a}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,r].join("/"),[t.definitionPath]:{...i,[r]:a}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function Tf(n,e){return c0(n,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function u0(n,e,t){return xg({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:Tf(n,{name:e})}},r=>n.parse(JSON.parse(r)))}function l0(n){return Sg({type:"function",function:{name:n.name,parameters:Tf(n.parameters,{name:n.name}),strict:!0,...n.description?{description:n.description}:void 0}},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))})}function If(n){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i,azureOpenAIEndpoint:o}=n;if((r||i)&&a&&e)return`${a}/${e}`;if((r||i)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||i){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return s}function d0(n,e){const t=typeof e=="number"?void 0:e;return{name:n.name,description:n.description,parameters:Cr(n.schema),...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}}function h0(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function f0(n){return n!==void 0&&Te.isRunnable(n)&&"lc_name"in n.constructor&&typeof n.constructor.lc_name=="function"&&n.constructor.lc_name()==="RunnableToolLike"}function m0(n){return!!n&&typeof n=="object"&&"name"in n&&"schema"in n&&eu(n.schema)}function Rf(n){return m0(n)||f0(n)||h0(n)}function ns(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function ho(n){let e;return n.constructor.name===ai.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===nt.name?(e=new Error(n.message),e.name="AbortError"):n.status===400&&n.message.includes("tool_calls")?e=ns(n,"INVALID_TOOL_RESULTS"):n.status===401?e=ns(n,"MODEL_AUTHENTICATION"):n.status===429?e=ns(n,"MODEL_RATE_LIMIT"):n.status===404?e=ns(n,"MODEL_NOT_FOUND"):e=n,e}function Dl(n){if(n)return n==="any"||n==="required"?"required":n==="auto"?"auto":n==="none"?"none":typeof n=="string"?{type:"function",function:{name:n}}:n}function p0(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function g0(n){const e=["namespace functions {",""];for(const t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(jf(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function jf(n,e){var r;const t=[];for(const[a,s]of Object.entries(n.properties??{}))s.description&&e<2&&t.push(`// ${s.description}`),(r=n.required)!=null&&r.includes(a)?t.push(`${a}: ${Ks(s,e)},`):t.push(`${a}?: ${Ks(s,e)},`);return t.map(a=>" ".repeat(e)+a).join(`
`)}function Ks(n,e){if(p0(n))return n.anyOf.map(t=>Ks(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",jf(n,e+2),"}"].join(`
`);case"array":return n.items?`${Ks(n.items,e)}[]`:"any[]";default:return""}}function y0(n,e){let t;if(Rf(n)){const r=l0({name:n.name,parameters:n.schema,description:n.description});r.function.parameters?t={type:r.type,function:{name:r.function.name,description:r.function.description,parameters:r.function.parameters,...(e==null?void 0:e.strict)!==void 0?{strict:e.strict}:{}}}:t={type:"function",function:d0(n,e)}}else t=n;return(e==null?void 0:e.strict)!==void 0&&(t.function.strict=e.strict),t}function _0(n){return n.role!=="system"&&n.role!=="developer"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function ru(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!$a.isInstance(n))throw new Error("Invalid generic chat message");return _0(n)}default:throw new Error(`Unknown message type: ${e}`)}}function Ul(n,e){return n.flatMap(t=>{var s;let r=ru(t);r==="system"&&nu(e)&&(r="developer");const a={role:r,content:t.content};if(t.name!=null&&(a.name=t.name),t.additional_kwargs.function_call!=null&&(a.function_call=t.additional_kwargs.function_call,a.content=null),En(t)&&((s=t.tool_calls)!=null&&s.length)?(a.tool_calls=t.tool_calls.map(vv),a.content=null):(t.additional_kwargs.tool_calls!=null&&(a.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(a.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){const i={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[a,i]}return a})}const en="__openai_function_call_ids__";function Bl(n,e){return n.flatMap(t=>{var a,s;let r=ru(t);if(r==="system"&&nu(e)&&(r="developer"),r==="function")throw new Error("Function messages are not supported in Responses API");if(r==="tool"){const i=t;return((a=i.additional_kwargs)==null?void 0:a.type)==="computer_call_output"?{type:"computer_call_output",output:typeof i.content=="string"?{type:"computer_screenshot",image_url:i.content}:Array.isArray(i.content)?i.content.find(c=>c.type==="computer_screenshot"):i.content,call_id:i.tool_call_id}:{type:"function_call_output",call_id:i.tool_call_id,id:i.id,output:typeof i.content!="string"?JSON.stringify(i.content):i.content}}if(r==="assistant"){const i=t.additional_kwargs[en];if(En(t)&&((s=t.tool_calls)!=null&&s.length))return t.tool_calls.map(c=>({type:"function_call",name:c.name,arguments:JSON.stringify(c.args),call_id:c.id,id:i==null?void 0:i[c.id]}));if(t.additional_kwargs.tool_calls!=null)return t.additional_kwargs.tool_calls.map(c=>({type:"function_call",name:c.function.name,call_id:c.id,id:i==null?void 0:i[c.id],arguments:c.function.arguments}));let{content:o}=t;return t.additional_kwargs.refusal!=null&&(typeof o=="string"&&(o=[{type:"output_text",text:o,annotations:[]}]),o=[...o,{type:"refusal",refusal:t.additional_kwargs.refusal}]),{type:"message",role:"assistant",content:typeof o=="string"?o:o.flatMap(c=>c.type==="text"?{type:"output_text",text:c.text,annotations:c.annotations??[]}:c.type==="output_text"||c.type==="refusal"?c:[])}}return r==="user"?{type:"message",role:"user",content:typeof t.content=="string"?t.content:t.content.flatMap(i=>{if(i.type==="text")return{type:"input_text",text:i.text};if(i.type==="image_url"){const o=typeof i.image_url=="string"?i.image_url:i.image_url.url,c=typeof i.image_url=="string"?"auto":i.image_url.detail;return{type:"input_image",image_url:o,detail:c}}return i.type==="input_text"||i.type==="input_image"||i.type==="input_file"?i:[]})}:[]})}function Cf(n){if(n.error){const i=new Error(n.error.message);throw i.name=n.error.code,i}const e=[],t=[],r=[],a={model:n.model,created_at:n.created_at,id:n.id,incomplete_details:n.incomplete_details,metadata:n.metadata,object:n.object,status:n.status,user:n.user,model_name:n.model},s={};for(const i of n.output)if(i.type==="message")e.push(...i.content.map(o=>o.type==="output_text"?("parsed"in o&&o.parsed!=null&&(s.parsed=o.parsed),{type:"text",text:o.text,annotations:o.annotations}):o));else if(i.type==="function_call"){const o={function:{name:i.name,arguments:i.arguments},id:i.call_id};try{t.push(tu(o,{returnId:!0}))}catch(c){let u;typeof c=="object"&&c!=null&&"message"in c&&typeof c.message=="string"&&(u=c.message),r.push(Ef(o,u))}s[en]??(s[en]={}),s[en][i.call_id]=i.id}else i.type==="reasoning"?s.reasoning=i:(s.tool_outputs??(s.tool_outputs=[]),s.tool_outputs.push(i));return new jr({id:n.id,content:e,tool_calls:t,invalid_tool_calls:r,usage_metadata:n.usage,additional_kwargs:s,response_metadata:a})}function b0(n){var c,u;const e=[];let t={},r;const a=[],s={},i={};let o;if(n.type==="response.output_text.delta")e.push({type:"text",text:n.delta,index:n.content_index});else if(n.type==="response.output_text.annotation.added")e.push({type:"text",text:"",annotations:[n.annotation],index:n.content_index});else if(n.type==="response.output_item.added"&&n.item.type==="message")o=n.item.id;else if(n.type==="response.output_item.added"&&n.item.type==="function_call")a.push({type:"tool_call_chunk",name:n.item.name,args:n.item.arguments,id:n.item.id,index:n.output_index}),i[en]={[n.item.call_id]:n.item.id};else if(n.type==="response.output_item.done"&&(n.item.type==="web_search_call"||n.item.type==="file_search_call"))i.tool_outputs=[n.item];else if(n.type==="response.created")s.id=n.response.id,s.model_name=n.response.model,s.model=n.response.model;else if(n.type==="response.completed"){const l=Cf(n.response);r=n.response.usage,((u=(c=n.response.text)==null?void 0:c.format)==null?void 0:u.type)==="json_schema"&&(i.parsed??(i.parsed=JSON.parse(l.text)));for(const[d,h]of Object.entries(n.response))d!=="id"&&(s[d]=h)}else if(n.type==="response.function_call_arguments.delta")a.push({type:"tool_call_chunk",args:n.delta,index:n.output_index});else if(n.type==="response.web_search_call.completed"||n.type==="response.file_search_call.completed")t={tool_outputs:{id:n.item_id,type:n.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(n.type==="response.refusal.done")i.refusal=n.refusal;else return null;return new fr({text:e.map(l=>l.text).join(""),message:new Se({id:o,content:e,tool_call_chunks:a,usage_metadata:r,additional_kwargs:i,response_metadata:s}),generationInfo:t})}function fo(n){return"type"in n&&n.type!=="function"}function w0(n){return n!=null&&typeof n=="object"&&"type"in n&&n.type!=="function"}function zl(n,e){return Yc(n)?(e==null?void 0:e.strict)!==void 0?{...n,function:{...n.function,strict:e.strict}}:n:y0(n,e)}function nu(n){return(n==null?void 0:n.startsWith("o1"))||(n==null?void 0:n.startsWith("o3"))}class au extends Vt{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming"]}constructor(e){var t,r;super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.openAIApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.openAIApiKey)??((t=e==null?void 0:e.configuration)==null?void 0:t.apiKey)??Pe("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=((r=e==null?void 0:e.configuration)==null?void 0:r.organization)??Pe("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelName=this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this==null?void 0:this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=e==null?void 0:e.reasoningEffort,this.maxTokens=(e==null?void 0:e.maxCompletionTokens)??(e==null?void 0:e.maxTokens),this.useResponsesApi=(e==null?void 0:e.useResponsesApi)??this.useResponsesApi,this.model==="o1"&&(this.disableStreaming=!0),this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return(t==null?void 0:t.strict)!==void 0?r=t.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(a=>fo(a)?a:zl(a,{strict:r})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&as(e.json_schema.schema)?u0(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){var o,c;let r;if((e==null?void 0:e.strict)!==void 0?r=e.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this._useResponseApi(e)){const u={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e==null?void 0:e.previous_response_id,truncation:e==null?void 0:e.truncation,include:e==null?void 0:e.include,tools:(o=e==null?void 0:e.tools)!=null&&o.length?e.tools.map(d=>fo(d)?d:Yc(d)?{type:"function",name:d.function.name,parameters:d.function.parameters,description:d.function.description,strict:r}:null).filter(d=>d!==null):void 0,tool_choice:w0(e==null?void 0:e.tool_choice)?e==null?void 0:e.tool_choice:(()=>{const d=Dl(e==null?void 0:e.tool_choice);if(typeof d=="object"&&"type"in d)return{type:"function",name:d.function.name}})(),text:(()=>{if(e!=null&&e.text)return e.text;const d=this.createResponseFormat(e==null?void 0:e.response_format);return(d==null?void 0:d.type)==="json_schema"?d.json_schema.schema!=null?{format:{type:"json_schema",schema:d.json_schema.schema,description:d.json_schema.description,name:d.json_schema.name,strict:d.json_schema.strict}}:void 0:{format:d}})(),parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,...this.modelKwargs},l=(e==null?void 0:e.reasoning_effort)??this.reasoningEffort;return l!==void 0&&(u.reasoning={effort:l}),u}let a={};(e==null?void 0:e.stream_options)!==void 0?a={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t!=null&&t.streaming)&&(a={stream_options:{include_usage:!0}});const s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(c=e==null?void 0:e.tools)!=null&&c.length?e.tools.map(u=>zl(u,{strict:r})):void 0,tool_choice:Dl(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...a,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(s.prediction=e.prediction);const i=(e==null?void 0:e.reasoning_effort)??this.reasoningEffort;return i!==void 0&&(s.reasoning_effort=i),nu(s.model)?s.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:s.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,s}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const r=e.tool_calls;switch(e.role){case"assistant":{const a=[],s=[];for(const c of r??[])try{a.push(tu(c,{returnId:!0}))}catch(u){s.push(Ef(c,u.message))}const i={function_call:e.function_call,tool_calls:r};this.__includeRawResponse!==void 0&&(i.__raw_response=t);const o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(i.audio=e.audio),new jr({content:e.content||"",tool_calls:a,invalid_tool_calls:s,additional_kwargs:i,response_metadata:o,id:t.id})}default:return new $a(e.content||"",e.role??"unknown")}}_convertOpenAIDeltaToBaseMessageChunk(e,t,r){var c,u;const a=e.role??r,s=e.content??"";let i;e.function_call?i={function_call:e.function_call}:e.tool_calls?i={tool_calls:e.tool_calls}:i={},this.__includeRawResponse&&(i.__raw_response=t),e.audio&&(i.audio={...e.audio,index:t.choices[0].index});const o={usage:{...t.usage}};if(a==="user")return new yi({content:s,response_metadata:o});if(a==="assistant"){const l=[];if(Array.isArray(e.tool_calls))for(const d of e.tool_calls)l.push({name:(c=d.function)==null?void 0:c.name,args:(u=d.function)==null?void 0:u.arguments,id:d.id,index:d.index,type:"tool_call_chunk"});return new Se({content:s,tool_call_chunks:l,additional_kwargs:i,id:t.id,response_metadata:o})}else return a==="system"?new Ea({content:s,response_metadata:o}):a==="developer"?new Ea({content:s,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):a==="function"?new gi({content:s,additional_kwargs:i,name:e.name,response_metadata:o}):a==="tool"?new Uc({content:s,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:o}):new pi({content:s,role:a,response_metadata:o})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var u,l,d,h,m,f,p,g,w,b;if(this._useResponseApi(t)){const _=await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:Bl(e,this.model),stream:!0},t);for await(const v of _){const E=b0(v);E!=null&&(yield E)}return}const a=Ul(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:a,stream:!0};let i;const o=await this.completionWithRetry(s,t);let c;for await(const _ of o){const v=(u=_==null?void 0:_.choices)==null?void 0:u[0];if(_.usage&&(c=_.usage),!v)continue;const{delta:E}=v;if(!E)continue;const O=this._convertOpenAIDeltaToBaseMessageChunk(E,_,i);i=E.role??i;const T={prompt:t.promptIndex??0,completion:v.index??0};if(typeof O.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const q={...T};v.finish_reason!=null&&(q.finish_reason=v.finish_reason,q.system_fingerprint=_.system_fingerprint,q.model_name=_.model),this.logprobs&&(q.logprobs=v.logprobs);const K=new fr({message:O,text:O.content,generationInfo:q});yield K,await(r==null?void 0:r.handleLLMNewToken(K.text??"",T,void 0,void 0,void 0,{chunk:K}))}if(c){const _={...((l=c.prompt_tokens_details)==null?void 0:l.audio_tokens)!==null&&{audio:(d=c.prompt_tokens_details)==null?void 0:d.audio_tokens},...((h=c.prompt_tokens_details)==null?void 0:h.cached_tokens)!==null&&{cache_read:(m=c.prompt_tokens_details)==null?void 0:m.cached_tokens}},v={...((f=c.completion_tokens_details)==null?void 0:f.audio_tokens)!==null&&{audio:(p=c.completion_tokens_details)==null?void 0:p.audio_tokens},...((g=c.completion_tokens_details)==null?void 0:g.reasoning_tokens)!==null&&{reasoning:(w=c.completion_tokens_details)==null?void 0:w.reasoning_tokens}};yield new fr({message:new Se({content:"",response_metadata:{usage:{...c}},usage_metadata:{input_tokens:c.prompt_tokens,output_tokens:c.completion_tokens,total_tokens:c.total_tokens,...Object.keys(_).length>0&&{input_token_details:_},...Object.keys(v).length>0&&{output_token_details:v}}}),text:""})}if((b=t.signal)!=null&&b.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,r){var o;const a=this.invocationParams(t);if(a.stream){const c=this._streamResponseChunks(e,t,r);let u;for await(const l of c)l.message.response_metadata={...l.generationInfo,...l.message.response_metadata},u=(u==null?void 0:u.concat(l))??l;return{generations:u?[u]:[],llmOutput:{estimatedTokenUsage:(o=u==null?void 0:u.message)==null?void 0:o.usage_metadata}}}const s=Bl(e,this.model),i=await this.responseApiWithRetry({input:s,...a},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});return{generations:[{text:i.output_text,message:Cf(i)}],llmOutput:{id:i.id,estimatedTokenUsage:i.usage?{promptTokens:i.usage.input_tokens,completionTokens:i.usage.output_tokens,totalTokens:i.usage.total_tokens}:void 0}}}_useResponseApi(e){var a;const t=(a=e==null?void 0:e.tools)==null?void 0:a.some(fo),r=(e==null?void 0:e.previous_response_id)!=null||(e==null?void 0:e.text)!=null||(e==null?void 0:e.truncation)!=null||(e==null?void 0:e.include)!=null;return this.useResponsesApi||t||r}async _generate(e,t,r){var o,c;if(this._useResponseApi(t))return this._responseApiGenerate(e,t,r);const a={},s=this.invocationParams(t),i=Ul(e,this.model);if(s.stream){const u=this._streamResponseChunks(e,t,r),l={};for await(const g of u){g.message.response_metadata={...g.generationInfo,...g.message.response_metadata};const w=((o=g.generationInfo)==null?void 0:o.completion)??0;l[w]===void 0?l[w]=g:l[w]=l[w].concat(g)}const d=Object.entries(l).sort(([g],[w])=>parseInt(g,10)-parseInt(w,10)).map(([g,w])=>w),{functions:h,function_call:m}=this.invocationParams(t),f=await this.getEstimatedTokenCountFromPrompt(e,h,m),p=await this.getNumTokensFromGenerations(d);return a.input_tokens=f,a.output_tokens=p,a.total_tokens=f+p,{generations:d,llmOutput:{estimatedTokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}else{let u;t.response_format&&t.response_format.type==="json_schema"?u=await this.betaParsedCompletionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}):u=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});const{completion_tokens:l,prompt_tokens:d,total_tokens:h,prompt_tokens_details:m,completion_tokens_details:f}=(u==null?void 0:u.usage)??{};l&&(a.output_tokens=(a.output_tokens??0)+l),d&&(a.input_tokens=(a.input_tokens??0)+d),h&&(a.total_tokens=(a.total_tokens??0)+h),((m==null?void 0:m.audio_tokens)!==null||(m==null?void 0:m.cached_tokens)!==null)&&(a.input_token_details={...(m==null?void 0:m.audio_tokens)!==null&&{audio:m==null?void 0:m.audio_tokens},...(m==null?void 0:m.cached_tokens)!==null&&{cache_read:m==null?void 0:m.cached_tokens}}),((f==null?void 0:f.audio_tokens)!==null||(f==null?void 0:f.reasoning_tokens)!==null)&&(a.output_token_details={...(f==null?void 0:f.audio_tokens)!==null&&{audio:f==null?void 0:f.audio_tokens},...(f==null?void 0:f.reasoning_tokens)!==null&&{reasoning:f==null?void 0:f.reasoning_tokens}});const p=[];for(const g of(u==null?void 0:u.choices)??[]){const b={text:((c=g.message)==null?void 0:c.content)??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(g.message??{role:"assistant"},u)};b.generationInfo={...g.finish_reason?{finish_reason:g.finish_reason}:{},...g.logprobs?{logprobs:g.logprobs}:{}},En(b.message)&&(b.message.usage_metadata=a),b.message=new jr(Object.fromEntries(Object.entries(b.message).filter(([_])=>!_.startsWith("lc_")))),p.push(b)}return{generations:p,llmOutput:{tokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){const s=g0(t);a+=await this.getNumTokens(s),a+=9}return t&&e.find(s=>s._getType()==="system")&&(a-=4),r==="none"?a+=1:typeof r=="object"&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var a;return(a=r.message.additional_kwargs)!=null&&a.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,a)=>r+a,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;this.model==="gpt-3.5-turbo-0301"?(r=4,a=-1):(r=3,a=1);const s=await Promise.all(e.map(async i=>{var h,m,f,p,g,w;const o=await this.getNumTokens(i.content),c=await this.getNumTokens(ru(i)),u=i.name!==void 0?a+await this.getNumTokens(i.name):0;let l=o+r+c+u;const d=i;if(d._getType()==="function"&&(l-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(l+=3),(m=d==null?void 0:d.additional_kwargs.function_call)!=null&&m.name&&(l+=await this.getNumTokens((f=d.additional_kwargs.function_call)==null?void 0:f.name)),(p=d.additional_kwargs.function_call)!=null&&p.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((g=d.additional_kwargs.function_call)==null?void 0:g.arguments)))}catch(b){console.error("Error parsing function arguments",b,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((w=d.additional_kwargs.function_call)==null?void 0:w.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(a){throw ho(a)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{var a,s;const r=this._getClientOptions(t);try{return((s=(a=e.text)==null?void 0:a.format)==null?void 0:s.type)==="json_schema"&&!e.stream?await this.client.responses.parse(e,r):await this.client.responses.create(e,r)}catch(i){throw ho(i)}})}async betaParsedCompletionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(a){throw ho(a)}})}_getClientOptions(e){if(!this.client){const r={baseURL:this.clientConfig.baseURL},a=If(r),s={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new Y(s)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let r,a,s,i;v0(e)?(r=e.schema,a=e.name,s=e.method,i=e.includeRaw):(r=e,a=t==null?void 0:t.name,s=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw);let o,c;if((t==null?void 0:t.strict)!==void 0&&s==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"?s===void 0&&(s="jsonSchema"):s==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`),s==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),as(r)?c=Cl.fromZodSchema(r):c=new Nl;else if(s==="jsonSchema")if(o=this.bind({response_format:{type:"json_schema",json_schema:{name:a??"extract",description:r.description,schema:r,strict:t==null?void 0:t.strict}}}),as(r)){const h=Cl.fromZodSchema(r);c=On.from(m=>"parsed"in m.additional_kwargs?m.additional_kwargs.parsed:h)}else c=new Nl;else{let h=a??"extract";if(as(r)){const m=Cr(r);o=this.bind({tools:[{type:"function",function:{name:h,description:m.description,parameters:m}}],tool_choice:{type:"function",function:{name:h}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),c=new $l({returnSingle:!0,keyName:h,zodSchema:r})}else{let m;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(m=r,h=r.name):(h=r.title??h,m={name:h,description:r.description??"",parameters:r}),o=this.bind({tools:[{type:"function",function:m}],tool_choice:{type:"function",function:{name:h}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),c=new $l({returnSingle:!0,keyName:h})}}if(!i)return o.pipe(c);const u=yn.assign({parsed:(h,m)=>c.invoke(h.raw,m)}),l=yn.assign({parsed:()=>null}),d=u.withFallbacks({fallbacks:[l]});return $t.from([{raw:o},d])}}function as(n){return typeof(n==null?void 0:n.parse)=="function"}function v0(n){return n!==void 0&&typeof n.schema=="object"}class x0 extends au{_llmType(){return"azure_openai"}get lc_aliases(){return{...super.lc_aliases,openAIApiKey:"openai_api_key",openAIApiVersion:"openai_api_version",openAIBasePath:"openai_api_base",deploymentName:"deployment_name",azureOpenAIEndpoint:"azure_endpoint",azureOpenAIApiVersion:"openai_api_version",azureOpenAIBasePath:"openai_api_base",azureOpenAIApiDeploymentName:"deployment_name"}}get lc_secrets(){return{...super.lc_secrets,azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}get lc_serializable_keys(){return[...super.lc_serializable_keys,"azureOpenAIApiKey","azureOpenAIApiVersion","azureOpenAIBasePath","azureOpenAIEndpoint","azureOpenAIApiInstanceName","azureOpenAIApiDeploymentName","deploymentName","openAIApiKey","openAIApiVersion"]}constructor(e){if(super(e),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.azureOpenAIApiKey=(e==null?void 0:e.azureOpenAIApiKey)??(e==null?void 0:e.openAIApiKey)??(e==null?void 0:e.apiKey)??Pe("AZURE_OPENAI_API_KEY"),this.azureOpenAIApiInstanceName=(e==null?void 0:e.azureOpenAIApiInstanceName)??Pe("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e==null?void 0:e.azureOpenAIApiDeploymentName)??(e==null?void 0:e.deploymentName)??Pe("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(e==null?void 0:e.azureOpenAIApiVersion)??(e==null?void 0:e.openAIApiVersion)??Pe("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(e==null?void 0:e.azureOpenAIBasePath)??Pe("AZURE_OPENAI_BASE_PATH"),this.azureOpenAIEndpoint=(e==null?void 0:e.azureOpenAIEndpoint)??Pe("AZURE_OPENAI_ENDPOINT"),this.azureADTokenProvider=e==null?void 0:e.azureADTokenProvider,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("Azure OpenAI API key or Token Provider not found")}getLsParams(e){const t=super.getLsParams(e);return t.ls_provider="azure",t}_getClientOptions(e){var r;if(!this.client){const a={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},s=If(a),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=a.azureOpenAIApiKey),i.baseURL||delete i.baseURL;let o=sf();(o==="node"||o==="deno")&&(o=`(${o}/${process.version}; ${process.platform}; ${process.arch})`);const c=(r=i.defaultHeaders)==null?void 0:r["User-Agent"];i.defaultHeaders={...i.defaultHeaders,"User-Agent":`langchainjs-azure-openai/2.0.0 (${o})${c?` ${c}`:""}`},this.client=new qg({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,deployment:this.azureOpenAIApiDeploymentName,...i})}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}toJSON(){const e=super.toJSON();function t(r){return typeof r=="object"&&r!=null}if(t(e)&&t(e.kwargs)){if(delete e.kwargs.azure_openai_base_path,delete e.kwargs.azure_openai_api_deployment_name,delete e.kwargs.azure_openai_api_key,delete e.kwargs.azure_openai_api_version,delete e.kwargs.azure_open_ai_base_path,!e.kwargs.azure_endpoint&&this.azureOpenAIEndpoint&&(e.kwargs.azure_endpoint=this.azureOpenAIEndpoint),!e.kwargs.azure_endpoint&&this.azureOpenAIBasePath){const r=this.azureOpenAIBasePath.split("/openai/deployments/");if(r.length===2&&r[0].startsWith("http")){const[a]=r;e.kwargs.azure_endpoint=a}}if(!e.kwargs.azure_endpoint&&this.azureOpenAIApiInstanceName&&(e.kwargs.azure_endpoint=`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/`),!e.kwargs.deployment_name&&this.azureOpenAIApiDeploymentName&&(e.kwargs.deployment_name=this.azureOpenAIApiDeploymentName),!e.kwargs.deployment_name&&this.azureOpenAIBasePath){const r=this.azureOpenAIBasePath.split("/openai/deployments/");if(r.length===2){const[,a]=r;e.kwargs.deployment_name=a}}e.kwargs.azure_endpoint&&e.kwargs.deployment_name&&e.kwargs.openai_api_base&&delete e.kwargs.openai_api_base,e.kwargs.azure_openai_api_instance_name&&e.kwargs.azure_endpoint&&delete e.kwargs.azure_openai_api_instance_name}return e}withStructuredOutput(e,t){const r={...t};return this.model.startsWith("gpt-4o")&&(r==null?void 0:r.method)===void 0&&(r.method="functionCalling"),super.withStructuredOutput(e,r)}}class S0 extends au{static lc_name(){return"ChatDeepSeek"}_llmType(){return"deepseek"}get lc_secrets(){return{apiKey:"DEEPSEEK_API_KEY"}}constructor(e){const t=(e==null?void 0:e.apiKey)||Pe("DEEPSEEK_API_KEY");if(!t)throw new Error('Deepseek API key not found. Please set the DEEPSEEK_API_KEY environment variable or pass the key into "apiKey" field.');super({...e,apiKey:t,configuration:{baseURL:"https://api.deepseek.com",...e==null?void 0:e.configuration}}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","deepseek"]})}_convertOpenAIDeltaToBaseMessageChunk(e,t,r){const a=super._convertOpenAIDeltaToBaseMessageChunk(e,t,r);return a.additional_kwargs.reasoning_content=e.reasoning_content,a}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const r=super._convertOpenAIChatCompletionMessageToBaseMessage(e,t);return r.additional_kwargs.reasoning_content=e.reasoning_content,r}withStructuredOutput(e,t){const r={...t};return(r==null?void 0:r.method)===void 0&&(r.method="functionCalling"),super.withStructuredOutput(e,r)}}const Jr="0.37.0";let Hl=!1,oa,Nf,oc,$f,Lf,Mf;function E0(n,e={auto:!1}){if(Hl)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${n.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(oa)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${n.kind}'\` after \`import '@anthropic-ai/sdk/shims/${oa}'\``);Hl=e.auto,oa=n.kind,Nf=n.fetch,oc=n.File,$f=n.ReadableStream,Lf=n.getDefaultAgent,Mf=n.fileFromPath}class k0{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function A0({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import â¦ from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new k0(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:i=>!1}}oa||E0(A0(),{auto:!0});class se extends Error{}class De extends se{constructor(e,t,r,a){super(`${De.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a==null?void 0:a["request-id"],this.error=t}static makeMessage(e,t,r){const a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e||!a)return new Ai({message:r,cause:cc(t)});const s=t;return e===400?new Df(e,s,r,a):e===401?new Uf(e,s,r,a):e===403?new Bf(e,s,r,a):e===404?new zf(e,s,r,a):e===409?new Hf(e,s,r,a):e===422?new Zf(e,s,r,a):e===429?new qf(e,s,r,a):e>=500?new Vf(e,s,r,a):new De(e,s,r,a)}}class vt extends De{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Ai extends De{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Ff extends Ai{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Df extends De{}class Uf extends De{}class Bf extends De{}class zf extends De{}class Hf extends De{}class Zf extends De{}class qf extends De{}class Vf extends De{}var ss=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},br=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},et;class Da{constructor(){et.set(this,void 0),this.buffer=new Uint8Array,ss(this,et,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let r=new Uint8Array(this.buffer.length+t.length);r.set(this.buffer),r.set(t,this.buffer.length),this.buffer=r;const a=[];let s;for(;(s=P0(this.buffer,br(this,et,"f")))!=null;){if(s.carriage&&br(this,et,"f")==null){ss(this,et,s.index,"f");continue}if(br(this,et,"f")!=null&&(s.index!==br(this,et,"f")+1||s.carriage)){a.push(this.decodeText(this.buffer.slice(0,br(this,et,"f")-1))),this.buffer=this.buffer.slice(br(this,et,"f")),ss(this,et,null,"f");continue}const i=br(this,et,"f")!==null?s.preceding-1:s.preceding,o=this.decodeText(this.buffer.slice(0,i));a.push(o),this.buffer=this.buffer.slice(s.index),ss(this,et,null,"f")}return a}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new se(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new se(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new se("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}et=new WeakMap;Da.NEWLINE_CHARS=new Set([`
`,"\r"]);Da.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function P0(n,e){for(let a=e??0;a<n.length;a++){if(n[a]===10)return{preceding:a,index:a+1,carriage:!1};if(n[a]===13)return{preceding:a,index:a+1,carriage:!0}}return null}function O0(n){for(let r=0;r<n.length-1;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}function su(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Lt{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(const i of T0(e,t)){if(i.event==="completion")try{yield JSON.parse(i.data)}catch(o){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),o}if(i.event==="message_start"||i.event==="message_delta"||i.event==="message_stop"||i.event==="content_block_start"||i.event==="content_block_delta"||i.event==="content_block_stop")try{yield JSON.parse(i.data)}catch(o){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),o}if(i.event!=="ping"&&i.event==="error")throw De.generate(void 0,`SSE Error: ${i.data}`,i.data,Gf(e.headers))}s=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{s||t.abort()}}return new Lt(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){const i=new Da,o=su(e);for await(const c of o)for(const u of i.decode(c))yield u;for(const c of i.flush())yield c}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new Lt(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){const i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new Lt(()=>a(e),this.controller),new Lt(()=>a(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new $f({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{const{value:s,done:i}=await t.next();if(i)return a.close();const o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}}async function*T0(n,e){if(!n.body)throw e.abort(),new se("Attempted to iterate over a response with no body");const t=new R0,r=new Da,a=su(n.body);for await(const s of I0(a))for(const i of r.decode(s)){const o=t.decode(i);o&&(yield o)}for(const s of r.flush()){const i=t.decode(s);i&&(yield i)}}async function*I0(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let a=new Uint8Array(e.length+r.length);a.set(e),a.set(r,e.length),e=a;let s;for(;(s=O0(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}class R0{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=j0(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}}function j0(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}const C0=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",N0=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Pi(n),Pi=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function";async function $0(n,e,t){var a;if(n=await n,N0(n))return n;if(C0(n)){const s=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=Pi(s)?[await s.arrayBuffer()]:[s];return new oc(i,e,t)}const r=await L0(n);if(e||(e=F0(n)??"unknown_file"),!(t!=null&&t.type)){const s=(a=r[0])==null?void 0:a.type;typeof s=="string"&&(t={...t,type:s})}return new oc(r,e,t)}async function L0(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Pi(n))e.push(await n.arrayBuffer());else if(D0(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${M0(n)}`);return e}function M0(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function F0(n){var e;return mo(n.name)||mo(n.filename)||((e=mo(n.path))==null?void 0:e.split(/[\\/]/).pop())}const mo=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},D0=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Zl=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var cn={},U0=function(n,e,t,r,a){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t},B0=function(n,e,t,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},is;async function Wf(n){const{response:e}=n;if(n.options.stream)return un("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Lt.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){const s=await e.json();return un("response",e.status,e.url,e.headers,s),Jf(s,e)}const a=await e.text();return un("response",e.status,e.url,e.headers,a),a}function Jf(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}class Oi extends Promise{constructor(e,t=Wf){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Oi(this.responsePromise,async t=>Jf(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class z0{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=po("maxRetries",t),this.timeout=po("timeout",r),this.httpAgent=a,this.fetch=s??Nf}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...J0(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Y0()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async a=>{const s=a&&Pi(a==null?void 0:a.body)?new DataView(await a.body.arrayBuffer()):(a==null?void 0:a.body)instanceof DataView?a.body:(a==null?void 0:a.body)instanceof ArrayBuffer?new DataView(a.body):a&&ArrayBuffer.isView(a==null?void 0:a.body)?new DataView(a.body.buffer):a==null?void 0:a.body;return{method:e,path:t,...a,body:s}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var f;e={...e};const{method:r,path:a,query:s,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:Zl(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,c=this.calculateContentLength(o),u=this.buildURL(a,s);"timeout"in e&&po("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const l=e.httpAgent??this.httpAgent??Lf(u),d=e.timeout+1e3;typeof((f=l==null?void 0:l.options)==null?void 0:f.timeout)=="number"&&d>(l.options.timeout??0)&&(l.options.timeout=d),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:e,headers:i,contentLength:c,retryCount:t});return{req:{method:r,...o&&{body:o},headers:h,...l&&{agent:l},signal:e.signal??null},url:u,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:a}){const s={};r&&(s["content-length"]=r);const i=this.defaultHeaders(e);return Jl(s,i),Jl(s,t),Zl(e.body)&&oa!=="node"&&delete s["content-type"],os(i,"x-stainless-retry-count")===void 0&&os(t,"x-stainless-retry-count")===void 0&&(s["x-stainless-retry-count"]=String(a)),os(i,"x-stainless-timeout")===void 0&&os(t,"x-stainless-timeout")===void 0&&e.timeout&&(s["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(s,t),s}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new se("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return De.generate(e,t,r,a)}request(e,t=null){return new Oi(this.makeRequest(e,t))}async makeRequest(e,t){var d,h;const r=await e,a=r.maxRetries??this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);const{req:s,url:i,timeout:o}=this.buildRequest(r,{retryCount:a-t});if(await this.prepareRequest(s,{url:i,options:r}),un("request",i,r,s.headers),(d=r.signal)!=null&&d.aborted)throw new vt;const c=new AbortController,u=await this.fetchWithTimeout(i,s,o,c).catch(cc);if(u instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new vt;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new Ff:new Ai({cause:u})}const l=Gf(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){const b=`retrying, ${t} attempts remaining`;return un(`response (error; ${b})`,u.status,i,l),this.retryRequest(r,t,l)}const m=await u.text().catch(b=>cc(b).message),f=G0(m),p=f?void 0:m;throw un(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,i,l,p),this.makeStatusError(u.status,f,p,l)}return{response:u,options:r,controller:c}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new Z0(this,r,e)}buildURL(e,t){const r=X0(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Xs(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new se(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){const{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());const o=setTimeout(()=>a.abort(),r),c={signal:a.signal,...i};c.method&&(c.method=c.method.toUpperCase());const u=60*1e3,l=setTimeout(()=>{var d,h;if(c&&((d=c==null?void 0:c.agent)!=null&&d.sockets))for(const m of Object.values((h=c==null?void 0:c.agent)==null?void 0:h.sockets).flat())m!=null&&m.setKeepAlive&&m.setKeepAlive(!0,u)},u);return this.fetch.call(void 0,e,c).finally(()=>{clearTimeout(o),clearTimeout(l)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let a;const s=r==null?void 0:r["retry-after-ms"];if(s){const o=parseFloat(s);Number.isNaN(o)||(a=o)}const i=r==null?void 0:r["retry-after"];if(i&&!a){const o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){const o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Q0(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Jr}`}}class H0{constructor(e,t,r,a){is.set(this,void 0),U0(this,is,e),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new se("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await B0(this,is,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(is=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Z0 extends Oi{constructor(e,t,r){super(t,async a=>new r(e,a.response,await Wf(a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const Gf=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),q0={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ir=n=>typeof n=="object"&&n!==null&&!Xs(n)&&Object.keys(n).every(e=>Kf(q0,e)),V0=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Jr,"X-Stainless-OS":Vl(Deno.build.os),"X-Stainless-Arch":ql(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Jr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Jr,"X-Stainless-OS":Vl(process.platform),"X-Stainless-Arch":ql(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=W0();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Jr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Jr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function W0(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}const ql=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Vl=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Wl;const J0=()=>Wl??(Wl=V0()),G0=n=>{try{return JSON.parse(n)}catch{return}},K0=/^[a-z][a-z0-9+.-]*:/i,X0=n=>K0.test(n),Q0=n=>new Promise(e=>setTimeout(e,n)),po=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new se(`${n} must be an integer`);if(e<0)throw new se(`${n} must be a positive integer`);return e},cc=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(String(n))},go=n=>{var e,t,r,a;if(typeof process<"u")return((e=cn==null?void 0:cn[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(a=(r=(t=Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:a.trim()};function Xs(n){if(!n)return!0;for(const e in n)return!1;return!0}function Kf(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Jl(n,e){for(const t in e){if(!Kf(e,t))continue;const r=t.toLowerCase();if(!r)continue;const a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function un(n,...e){typeof process<"u"&&(cn==null?void 0:cn.DEBUG)==="true"&&console.log(`Anthropic:DEBUG:${n}`,...e)}const Y0=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),ex=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",tx=n=>typeof(n==null?void 0:n.get)=="function",os=(n,e)=>{var r;const t=e.toLowerCase();if(tx(n)){const a=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(s,i,o)=>i+o.toUpperCase());for(const s of[e,t,e.toUpperCase(),a]){const i=n.get(s);if(i)return i}}for(const[a,s]of Object.entries(n))if(a.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s};class Ti extends H0{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.has_more=r.has_more||!1,this.first_id=r.first_id||null,this.last_id=r.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var t;if((t=this.options.query)!=null&&t.before_id){const r=this.first_id;return r?{params:{before_id:r}}:null}const e=this.last_id;return e?{params:{after_id:e}}:null}}class gr{constructor(e){this._client=e}}let iu=class extends gr{retrieve(e,t){return this._client.get(`/v1/models/${e}?beta=true`,t)}list(e={},t){return ir(e)?this.list({},e):this._client.getAPIList("/v1/models?beta=true",ou,{query:e,...t})}};class ou extends Ti{}iu.BetaModelInfosPage=ou;class Ii{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){const e=new Da;for await(const t of this.iterator)for(const r of e.decode(t))yield JSON.parse(r);for(const t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new se("Attempted to iterate over a response with no body");return new Ii(su(e.body),t)}}let cu=class extends gr{create(e,t){const{betas:r,...a}=e;return this._client.post("/v1/messages/batches?beta=true",{body:a,...t,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...t==null?void 0:t.headers}})}retrieve(e,t={},r){if(ir(t))return this.retrieve(e,{},t);const{betas:a}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...r,headers:{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}list(e={},t){if(ir(e))return this.list({},e);const{betas:r,...a}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",uu,{query:a,...t,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...t==null?void 0:t.headers}})}delete(e,t={},r){if(ir(t))return this.delete(e,{},t);const{betas:a}=t;return this._client.delete(`/v1/messages/batches/${e}?beta=true`,{...r,headers:{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}cancel(e,t={},r){if(ir(t))return this.cancel(e,{},t);const{betas:a}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...r,headers:{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}async results(e,t={},r){if(ir(t))return this.results(e,{},t);const a=await this.retrieve(e);if(!a.results_url)throw new se(`No batch \`results_url\`; Has it finished processing? ${a.processing_status} - ${a.id}`);const{betas:s}=t;return this._client.get(a.results_url,{...r,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...r==null?void 0:r.headers},__binaryResponse:!0})._thenUnwrap((i,o)=>Ii.fromResponse(o.response,o.controller))}};class uu extends Ti{}cu.BetaMessageBatchesPage=uu;const rx=n=>{let e=0,t=[];for(;e<n.length;){let r=n[e];if(r==="\\"){e++;continue}if(r==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(r==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(r==="["){t.push({type:"paren",value:"["}),e++;continue}if(r==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(r===":"){t.push({type:"separator",value:":"}),e++;continue}if(r===","){t.push({type:"delimiter",value:","}),e++;continue}if(r==='"'){let o="",c=!1;for(r=n[++e];r!=='"';){if(e===n.length){c=!0;break}if(r==="\\"){if(e++,e===n.length){c=!0;break}o+=r+n[e],r=n[++e]}else o+=r,r=n[++e]}r=n[++e],c||t.push({type:"string",value:o});continue}if(r&&/\s/.test(r)){e++;continue}let s=/[0-9]/;if(r&&s.test(r)||r==="-"||r==="."){let o="";for(r==="-"&&(o+=r,r=n[++e]);r&&s.test(r)||r===".";)o+=r,r=n[++e];t.push({type:"number",value:o});continue}let i=/[a-z]/i;if(r&&i.test(r)){let o="";for(;r&&i.test(r)&&e!==n.length;)o+=r,r=n[++e];if(o=="true"||o=="false"||o==="null")t.push({type:"name",value:o});else{e++;continue}continue}e++}return t},Gr=n=>{if(n.length===0)return n;let e=n[n.length-1];switch(e.type){case"separator":return n=n.slice(0,n.length-1),Gr(n);case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return n=n.slice(0,n.length-1),Gr(n);case"string":let r=n[n.length-2];if((r==null?void 0:r.type)==="delimiter")return n=n.slice(0,n.length-1),Gr(n);if((r==null?void 0:r.type)==="brace"&&r.value==="{")return n=n.slice(0,n.length-1),Gr(n);break;case"delimiter":return n=n.slice(0,n.length-1),Gr(n)}return n},nx=n=>{let e=[];return n.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?n.push({type:"brace",value:"}"}):t==="]"&&n.push({type:"paren",value:"]"})}),n},ax=n=>{let e="";return n.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Xf=n=>JSON.parse(ax(nx(Gr(rx(n)))));var Ne=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},te=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},it,tr,Cn,cs,Nn,$n,us,Ln,Bt,Mn,ls,ds,Hr,hs,fs,yo,Gl,_o,bo,wo,vo,Kl;const Xl="__json_buf";class Qs{constructor(){it.add(this),this.messages=[],this.receivedMessages=[],tr.set(this,void 0),this.controller=new AbortController,Cn.set(this,void 0),cs.set(this,()=>{}),Nn.set(this,()=>{}),$n.set(this,void 0),us.set(this,()=>{}),Ln.set(this,()=>{}),Bt.set(this,{}),Mn.set(this,!1),ls.set(this,!1),ds.set(this,!1),Hr.set(this,!1),hs.set(this,void 0),fs.set(this,void 0),_o.set(this,e=>{if(Ne(this,ls,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new vt),e instanceof vt)return Ne(this,ds,!0,"f"),this._emit("abort",e);if(e instanceof se)return this._emit("error",e);if(e instanceof Error){const t=new se(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new se(String(e)))}),Ne(this,Cn,new Promise((e,t)=>{Ne(this,cs,e,"f"),Ne(this,Nn,t,"f")}),"f"),Ne(this,$n,new Promise((e,t)=>{Ne(this,us,e,"f"),Ne(this,Ln,t,"f")}),"f"),te(this,Cn,"f").catch(()=>{}),te(this,$n,"f").catch(()=>{})}get response(){return te(this,hs,"f")}get request_id(){return te(this,fs,"f")}async withResponse(){const e=await te(this,Cn,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){const t=new Qs;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){const a=new Qs;for(const s of t.messages)a._addMessageParam(s);return a._run(()=>a._createMessage(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},te(this,_o,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){var o;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),te(this,it,"m",bo).call(this);const{response:s,data:i}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(s);for await(const c of i)te(this,it,"m",wo).call(this,c);if((o=i.controller.signal)!=null&&o.aborted)throw new vt;te(this,it,"m",vo).call(this)}_connected(e){this.ended||(Ne(this,hs,e,"f"),Ne(this,fs,e==null?void 0:e.headers.get("request-id"),"f"),te(this,cs,"f").call(this,e),this._emit("connect"))}get ended(){return te(this,Mn,"f")}get errored(){return te(this,ls,"f")}get aborted(){return te(this,ds,"f")}abort(){this.controller.abort()}on(e,t){return(te(this,Bt,"f")[e]||(te(this,Bt,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=te(this,Bt,"f")[e];if(!r)return this;const a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(te(this,Bt,"f")[e]||(te(this,Bt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{Ne(this,Hr,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){Ne(this,Hr,!0,"f"),await te(this,$n,"f")}get currentMessage(){return te(this,tr,"f")}async finalMessage(){return await this.done(),te(this,it,"m",yo).call(this)}async finalText(){return await this.done(),te(this,it,"m",Gl).call(this)}_emit(e,...t){if(te(this,Mn,"f"))return;e==="end"&&(Ne(this,Mn,!0,"f"),te(this,us,"f").call(this));const r=te(this,Bt,"f")[e];if(r&&(te(this,Bt,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){const a=t[0];!te(this,Hr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),te(this,Nn,"f").call(this,a),te(this,Ln,"f").call(this,a),this._emit("end");return}if(e==="error"){const a=t[0];!te(this,Hr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),te(this,Nn,"f").call(this,a),te(this,Ln,"f").call(this,a),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",te(this,it,"m",yo).call(this))}async _fromReadableStream(e,t){var s;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),te(this,it,"m",bo).call(this),this._connected(null);const a=Lt.fromReadableStream(e,this.controller);for await(const i of a)te(this,it,"m",wo).call(this,i);if((s=a.controller.signal)!=null&&s.aborted)throw new vt;te(this,it,"m",vo).call(this)}[(tr=new WeakMap,Cn=new WeakMap,cs=new WeakMap,Nn=new WeakMap,$n=new WeakMap,us=new WeakMap,Ln=new WeakMap,Bt=new WeakMap,Mn=new WeakMap,ls=new WeakMap,ds=new WeakMap,Hr=new WeakMap,hs=new WeakMap,fs=new WeakMap,_o=new WeakMap,it=new WeakSet,yo=function(){if(this.receivedMessages.length===0)throw new se("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Gl=function(){if(this.receivedMessages.length===0)throw new se("stream ended without producing a Message with role=assistant");const t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new se("stream ended without producing a content block with type=text");return t.join(" ")},bo=function(){this.ended||Ne(this,tr,void 0,"f")},wo=function(t){if(this.ended)return;const r=te(this,it,"m",Kl).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{const a=r.content.at(-1);switch(t.delta.type){case"text_delta":{a.type==="text"&&this._emit("text",t.delta.text,a.text||"");break}case"citations_delta":{a.type==="text"&&this._emit("citation",t.delta.citation,a.citations??[]);break}case"input_json_delta":{a.type==="tool_use"&&a.input&&this._emit("inputJson",t.delta.partial_json,a.input);break}case"thinking_delta":{a.type==="thinking"&&this._emit("thinking",t.delta.thinking,a.thinking);break}case"signature_delta":{a.type==="thinking"&&this._emit("signature",a.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{Ne(this,tr,r,"f");break}}},vo=function(){if(this.ended)throw new se("stream has ended, this shouldn't happen");const t=te(this,tr,"f");if(!t)throw new se("request ended without sending any chunks");return Ne(this,tr,void 0,"f"),t},Kl=function(t){let r=te(this,tr,"f");if(t.type==="message_start"){if(r)throw new se(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new se(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,r;case"content_block_start":return r.content.push(t.content_block),r;case"content_block_delta":{const a=r.content.at(t.index);switch(t.delta.type){case"text_delta":{(a==null?void 0:a.type)==="text"&&(a.text+=t.delta.text);break}case"citations_delta":{(a==null?void 0:a.type)==="text"&&(a.citations??(a.citations=[]),a.citations.push(t.delta.citation));break}case"input_json_delta":{if((a==null?void 0:a.type)==="tool_use"){let s=a[Xl]||"";s+=t.delta.partial_json,Object.defineProperty(a,Xl,{value:s,enumerable:!1,writable:!0}),s&&(a.input=Xf(s))}break}case"thinking_delta":{(a==null?void 0:a.type)==="thinking"&&(a.thinking+=t.delta.thinking);break}case"signature_delta":{(a==null?void 0:a.type)==="thinking"&&(a.signature=t.delta.signature);break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("streamEvent",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Lt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}const Ql={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};let Ri=class extends gr{constructor(){super(...arguments),this.batches=new cu(this._client)}create(e,t){const{betas:r,...a}=e;return a.model in Ql&&console.warn(`The model '${a.model}' is deprecated and will reach end-of-life on ${Ql[a.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:a,timeout:this._client._options.timeout??(a.stream?6e5:this._client._calculateNonstreamingTimeout(a.max_tokens)),...t,headers:{...(r==null?void 0:r.toString())!=null?{"anthropic-beta":r==null?void 0:r.toString()}:void 0,...t==null?void 0:t.headers},stream:e.stream??!1})}stream(e,t){return Qs.createMessage(this,e,t)}countTokens(e,t){const{betas:r,...a}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:a,...t,headers:{"anthropic-beta":[...r??[],"token-counting-2024-11-01"].toString(),...t==null?void 0:t.headers}})}};Ri.Batches=cu;Ri.BetaMessageBatchesPage=uu;class Ua extends gr{constructor(){super(...arguments),this.models=new iu(this._client),this.messages=new Ri(this._client)}}Ua.Models=iu;Ua.BetaModelInfosPage=ou;Ua.Messages=Ri;class Qf extends gr{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}}class lu extends gr{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/v1/messages/batches/${e}`,t)}list(e={},t){return ir(e)?this.list({},e):this._client.getAPIList("/v1/messages/batches",du,{query:e,...t})}delete(e,t){return this._client.delete(`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){const r=await this.retrieve(e);if(!r.results_url)throw new se(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);return this._client.get(r.results_url,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})._thenUnwrap((a,s)=>Ii.fromResponse(s.response,s.controller))}}class du extends Ti{}lu.MessageBatchesPage=du;var $e=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},re=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ot,rr,Fn,ms,Dn,Un,ps,Bn,zt,zn,gs,ys,Zr,_s,bs,xo,Yl,So,Eo,ko,Ao,ed;const td="__json_buf";class Ys{constructor(){ot.add(this),this.messages=[],this.receivedMessages=[],rr.set(this,void 0),this.controller=new AbortController,Fn.set(this,void 0),ms.set(this,()=>{}),Dn.set(this,()=>{}),Un.set(this,void 0),ps.set(this,()=>{}),Bn.set(this,()=>{}),zt.set(this,{}),zn.set(this,!1),gs.set(this,!1),ys.set(this,!1),Zr.set(this,!1),_s.set(this,void 0),bs.set(this,void 0),So.set(this,e=>{if($e(this,gs,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new vt),e instanceof vt)return $e(this,ys,!0,"f"),this._emit("abort",e);if(e instanceof se)return this._emit("error",e);if(e instanceof Error){const t=new se(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new se(String(e)))}),$e(this,Fn,new Promise((e,t)=>{$e(this,ms,e,"f"),$e(this,Dn,t,"f")}),"f"),$e(this,Un,new Promise((e,t)=>{$e(this,ps,e,"f"),$e(this,Bn,t,"f")}),"f"),re(this,Fn,"f").catch(()=>{}),re(this,Un,"f").catch(()=>{})}get response(){return re(this,_s,"f")}get request_id(){return re(this,bs,"f")}async withResponse(){const e=await re(this,Fn,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){const t=new Ys;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){const a=new Ys;for(const s of t.messages)a._addMessageParam(s);return a._run(()=>a._createMessage(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},re(this,So,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){var o;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),re(this,ot,"m",Eo).call(this);const{response:s,data:i}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(s);for await(const c of i)re(this,ot,"m",ko).call(this,c);if((o=i.controller.signal)!=null&&o.aborted)throw new vt;re(this,ot,"m",Ao).call(this)}_connected(e){this.ended||($e(this,_s,e,"f"),$e(this,bs,e==null?void 0:e.headers.get("request-id"),"f"),re(this,ms,"f").call(this,e),this._emit("connect"))}get ended(){return re(this,zn,"f")}get errored(){return re(this,gs,"f")}get aborted(){return re(this,ys,"f")}abort(){this.controller.abort()}on(e,t){return(re(this,zt,"f")[e]||(re(this,zt,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=re(this,zt,"f")[e];if(!r)return this;const a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(re(this,zt,"f")[e]||(re(this,zt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{$e(this,Zr,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){$e(this,Zr,!0,"f"),await re(this,Un,"f")}get currentMessage(){return re(this,rr,"f")}async finalMessage(){return await this.done(),re(this,ot,"m",xo).call(this)}async finalText(){return await this.done(),re(this,ot,"m",Yl).call(this)}_emit(e,...t){if(re(this,zn,"f"))return;e==="end"&&($e(this,zn,!0,"f"),re(this,ps,"f").call(this));const r=re(this,zt,"f")[e];if(r&&(re(this,zt,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){const a=t[0];!re(this,Zr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),re(this,Dn,"f").call(this,a),re(this,Bn,"f").call(this,a),this._emit("end");return}if(e==="error"){const a=t[0];!re(this,Zr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),re(this,Dn,"f").call(this,a),re(this,Bn,"f").call(this,a),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",re(this,ot,"m",xo).call(this))}async _fromReadableStream(e,t){var s;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),re(this,ot,"m",Eo).call(this),this._connected(null);const a=Lt.fromReadableStream(e,this.controller);for await(const i of a)re(this,ot,"m",ko).call(this,i);if((s=a.controller.signal)!=null&&s.aborted)throw new vt;re(this,ot,"m",Ao).call(this)}[(rr=new WeakMap,Fn=new WeakMap,ms=new WeakMap,Dn=new WeakMap,Un=new WeakMap,ps=new WeakMap,Bn=new WeakMap,zt=new WeakMap,zn=new WeakMap,gs=new WeakMap,ys=new WeakMap,Zr=new WeakMap,_s=new WeakMap,bs=new WeakMap,So=new WeakMap,ot=new WeakSet,xo=function(){if(this.receivedMessages.length===0)throw new se("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Yl=function(){if(this.receivedMessages.length===0)throw new se("stream ended without producing a Message with role=assistant");const t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new se("stream ended without producing a content block with type=text");return t.join(" ")},Eo=function(){this.ended||$e(this,rr,void 0,"f")},ko=function(t){if(this.ended)return;const r=re(this,ot,"m",ed).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{const a=r.content.at(-1);switch(t.delta.type){case"text_delta":{a.type==="text"&&this._emit("text",t.delta.text,a.text||"");break}case"citations_delta":{a.type==="text"&&this._emit("citation",t.delta.citation,a.citations??[]);break}case"input_json_delta":{a.type==="tool_use"&&a.input&&this._emit("inputJson",t.delta.partial_json,a.input);break}case"thinking_delta":{a.type==="thinking"&&this._emit("thinking",t.delta.thinking,a.thinking);break}case"signature_delta":{a.type==="thinking"&&this._emit("signature",a.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{$e(this,rr,r,"f");break}}},Ao=function(){if(this.ended)throw new se("stream has ended, this shouldn't happen");const t=re(this,rr,"f");if(!t)throw new se("request ended without sending any chunks");return $e(this,rr,void 0,"f"),t},ed=function(t){let r=re(this,rr,"f");if(t.type==="message_start"){if(r)throw new se(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new se(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,r;case"content_block_start":return r.content.push(t.content_block),r;case"content_block_delta":{const a=r.content.at(t.index);switch(t.delta.type){case"text_delta":{(a==null?void 0:a.type)==="text"&&(a.text+=t.delta.text);break}case"citations_delta":{(a==null?void 0:a.type)==="text"&&(a.citations??(a.citations=[]),a.citations.push(t.delta.citation));break}case"input_json_delta":{if((a==null?void 0:a.type)==="tool_use"){let s=a[td]||"";s+=t.delta.partial_json,Object.defineProperty(a,td,{value:s,enumerable:!1,writable:!0}),s&&(a.input=Xf(s))}break}case"thinking_delta":{(a==null?void 0:a.type)==="thinking"&&(a.thinking+=t.delta.thinking);break}case"signature_delta":{(a==null?void 0:a.type)==="thinking"&&(a.signature=t.delta.signature);break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("streamEvent",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Lt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}class ji extends gr{constructor(){super(...arguments),this.batches=new lu(this._client)}create(e,t){return e.model in rd&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${rd[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??(e.stream?6e5:this._client._calculateNonstreamingTimeout(e.max_tokens)),...t,stream:e.stream??!1})}stream(e,t){return Ys.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}}const rd={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};ji.Batches=lu;ji.MessageBatchesPage=du;class hu extends gr{retrieve(e,t){return this._client.get(`/v1/models/${e}`,t)}list(e={},t){return ir(e)?this.list({},e):this._client.getAPIList("/v1/models",fu,{query:e,...t})}}class fu extends Ti{}hu.ModelInfosPage=fu;var Yf;class pe extends z0{constructor({baseURL:e=go("ANTHROPIC_BASE_URL"),apiKey:t=go("ANTHROPIC_API_KEY")??null,authToken:r=go("ANTHROPIC_AUTH_TOKEN")??null,...a}={}){const s={apiKey:t,authToken:r,...a,baseURL:e||"https://api.anthropic.com"};if(!s.dangerouslyAllowBrowser&&ex())throw new se(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Qf(this),this.messages=new ji(this),this.models=new hu(this),this.beta=new Ua(this),this._options=s,this.apiKey=t,this.authToken=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"])&&t["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&t.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){const t=this.apiKeyAuth(e),r=this.bearerAuth(e);return t!=null&&!Xs(t)?t:r!=null&&!Xs(r)?r:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}}Yf=pe;pe.Anthropic=Yf;pe.HUMAN_PROMPT=`

Human:`;pe.AI_PROMPT=`

Assistant:`;pe.DEFAULT_TIMEOUT=6e5;pe.AnthropicError=se;pe.APIError=De;pe.APIConnectionError=Ai;pe.APIConnectionTimeoutError=Ff;pe.APIUserAbortError=vt;pe.NotFoundError=zf;pe.ConflictError=Hf;pe.RateLimitError=qf;pe.BadRequestError=Df;pe.AuthenticationError=Uf;pe.InternalServerError=Vf;pe.PermissionDeniedError=Bf;pe.UnprocessableEntityError=Zf;pe.toFile=$0;pe.fileFromPath=Mf;pe.Completions=Qf;pe.Messages=ji;pe.Models=hu;pe.ModelInfosPage=fu;pe.Beta=Ua;const{HUMAN_PROMPT:jS,AI_PROMPT:CS}=pe;class nd extends vf{static lc_name(){return"AnthropicToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","anthropic","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){let t=e;if(typeof e=="string")try{t=JSON.parse(e)}catch(a){throw new Oa(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(a.message)}`,e)}else t=e;if(this.zodSchema===void 0)return t;const r=await this.zodSchema.safeParseAsync(t);if(r.success)return r.data;throw new Oa(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(r.error.errors)}`,JSON.stringify(t,null,2))}async parseResult(e){const t=e.flatMap(s=>{const{message:i}=s;return Array.isArray(i.content)?em(i.content)[0]:[]});if(t[0]===void 0)throw new Error("No parseable tool calls provided to AnthropicToolsOutputParser.");const[r]=t;return await this._validateResult(r.args)}}function em(n){const e=[];for(const t of n)t.type==="tool_use"&&e.push({name:t.name,args:t.input,id:t.id,type:"tool_call"});return e}function sx(n){if(n)return n==="any"?{type:"any"}:n==="auto"?{type:"auto"}:typeof n=="string"?{type:"tool",name:n}:n}function ad(n){const e=/^data:(image\/.+);base64,(.+)$/,t=n.match(e);if(t===null)throw new Error(["Anthropic only supports base64-encoded images currently.","Example: data:image/png;base64,/9j/4AAQSk..."].join(`

`));return{type:"base64",media_type:t[1]??"",data:t[2]??""}}function ix(n){const e=[];for(const t of n)if(t._getType()==="tool")if(typeof t.content=="string"){const r=e[e.length-1];(r==null?void 0:r._getType())==="human"&&Array.isArray(r.content)&&"type"in r.content[0]&&r.content[0].type==="tool_result"?r.content.push({type:"tool_result",content:t.content,tool_use_id:t.tool_call_id}):e.push(new mn({content:[{type:"tool_result",content:t.content,tool_use_id:t.tool_call_id}]}))}else e.push(new mn({content:[{type:"tool_result",content:uc(t.content),tool_use_id:t.tool_call_id}]}));else e.push(t);return e}function sd(n){if(n.id===void 0)throw new Error('Anthropic requires all tool calls to have an "id".');return{type:"tool_use",id:n.id,name:n.name,input:n.args}}function uc(n){const e=["tool_use","tool_result","input_json_delta"],t=["text","text_delta"];return typeof n=="string"?n:n.map(a=>{const s="cache_control"in a?a.cache_control:void 0;if(a.type==="image_url"){let i;return typeof a.image_url=="string"?i=ad(a.image_url):i=ad(a.image_url.url),{type:"image",source:i,...s?{cache_control:s}:{}}}else{if(a.type==="document")return{...a,...s?{cache_control:s}:{}};if(a.type==="thinking")return{type:"thinking",thinking:a.thinking,signature:a.signature,...s?{cache_control:s}:{}};if(a.type==="redacted_thinking")return{type:"redacted_thinking",data:a.data,...s?{cache_control:s}:{}};if(t.find(i=>i===a.type)&&"text"in a)return{type:"text",text:a.text,...s?{cache_control:s}:{}};if(e.find(i=>i===a.type)){const i={...a};if("index"in i&&delete i.index,i.type==="input_json_delta"&&(i.type="tool_use"),"input"in i)try{i.input=JSON.parse(i.input)}catch{}return{...i,...s?{cache_control:s}:{}}}else throw new Error("Unsupported message content format")}})}function id(n){const e=ix(n);let t;e.length>0&&e[0]._getType()==="system"&&(t=n[0].content);const a=(t!==void 0?e.slice(1):e).map(s=>{var o;let i;if(s._getType()==="human")i="user";else if(s._getType()==="ai")i="assistant";else if(s._getType()==="tool")i="user";else throw s._getType()==="system"?new Error("System messages are only permitted as the first passed message."):new Error(`Message type "${s._getType()}" is not supported.`);if(En(s)&&((o=s.tool_calls)!=null&&o.length)){if(typeof s.content=="string")return s.content===""?{role:i,content:s.tool_calls.map(sd)}:{role:i,content:[{type:"text",text:s.content},...s.tool_calls.map(sd)]};{const{content:c}=s;return!s.tool_calls.every(l=>c.find(d=>(d.type==="tool_use"||d.type==="input_json_delta")&&d.id===l.id))&&console.warn('The "tool_calls" field on a message is only respected if content is a string.'),{role:i,content:uc(s.content)}}}else return{role:i,content:uc(s.content)}});return{messages:ox(a),system:t}}function ox(n){if(!n||n.length<=1)return n;const e=[];let t=n[0];const r=s=>typeof s=="string"?[{type:"text",text:s}]:s,a=s=>s.role!=="user"||typeof s.content=="string"?!1:Array.isArray(s.content)&&s.content.every(i=>i.type==="tool_result");for(let s=1;s<n.length;s+=1){const i=n[s];a(t)&&a(i)?t={...t,content:[...r(t.content),...r(i.content)]}:(e.push(t),t=i)}return e.push(t),e}function cx(n,e){var t;if(n.type==="message_start"){const{content:r,usage:a,...s}=n.message,i={};for(const[d,h]of Object.entries(s))h!=null&&(i[d]=h);const{input_tokens:o,output_tokens:c,...u}=a??{},l={input_tokens:o,output_tokens:c,total_tokens:o+c,input_token_details:{cache_creation:u.cache_creation_input_tokens,cache_read:u.cache_read_input_tokens}};return{chunk:new Se({content:e.coerceContentToString?"":[],additional_kwargs:i,usage_metadata:e.streamUsage?l:void 0,response_metadata:{usage:{...u}},id:n.message.id})}}else if(n.type==="message_delta"){const r={input_tokens:0,output_tokens:n.usage.output_tokens,total_tokens:n.usage.output_tokens,input_token_details:{cache_creation:n.usage.cache_creation_input_tokens,cache_read:n.usage.cache_read_input_tokens}};return{chunk:new Se({content:e.coerceContentToString?"":[],additional_kwargs:{...n.delta},usage_metadata:e.streamUsage?r:void 0})}}else if(n.type==="content_block_start"&&["tool_use","document"].includes(n.content_block.type)){const r=n.content_block;let a;return r.type==="tool_use"?a=[{id:r.id,index:n.index,name:r.name,args:""}]:a=[],{chunk:new Se({content:e.coerceContentToString?"":[{index:n.index,...n.content_block,input:""}],additional_kwargs:{},tool_call_chunks:a})}}else if(n.type==="content_block_delta"&&["text_delta","citations_delta","thinking_delta","signature_delta"].includes(n.delta.type)){if(e.coerceContentToString&&"text"in n.delta)return{chunk:new Se({content:n.delta.text})};{const r=n.delta;return"citation"in r&&(r.citations=[r.citation],delete r.citation),r.type==="thinking_delta"||r.type==="signature_delta"?{chunk:new Se({content:[{index:n.index,...r,type:"thinking"}]})}:{chunk:new Se({content:[{index:n.index,...r,type:"text"}]})}}}else{if(n.type==="content_block_delta"&&n.delta.type==="input_json_delta")return{chunk:new Se({content:e.coerceContentToString?"":[{index:n.index,input:n.delta.partial_json,type:n.delta.type}],additional_kwargs:{},tool_call_chunks:[{index:n.index,args:n.delta.partial_json}]})};if(n.type==="content_block_start"&&n.content_block.type==="text"){const r=(t=n.content_block)==null?void 0:t.text;if(r!==void 0)return{chunk:new Se({content:e.coerceContentToString?r:[{index:n.index,...n.content_block}],additional_kwargs:{}})}}else{if(n.type==="content_block_start"&&n.content_block.type==="redacted_thinking")return{chunk:new Se({content:e.coerceContentToString?"":[{index:n.index,...n.content_block}]})};if(n.type==="content_block_start"&&n.content_block.type==="thinking"){const r=n.content_block.thinking;return{chunk:new Se({content:e.coerceContentToString?r:[{index:n.index,...n.content_block}]})}}}}return null}function ux(n,e){const t=e.usage,r=t!=null?{input_tokens:t.input_tokens??0,output_tokens:t.output_tokens??0,total_tokens:(t.input_tokens??0)+(t.output_tokens??0),input_token_details:{cache_creation:t.cache_creation_input_tokens,cache_read:t.cache_read_input_tokens}}:void 0;if(n.length===1&&n[0].type==="text")return[{text:n[0].text,message:new jr({content:n[0].text,additional_kwargs:e,usage_metadata:r,response_metadata:e,id:e.id})}];{const a=em(n);return[{text:"",message:new jr({content:n,additional_kwargs:e,tool_calls:a,usage_metadata:r,response_metadata:e,id:e.id})}]}}function ws(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function od(n){let e;return n.status===400&&n.message.includes("tool")?e=ws(n,"INVALID_TOOL_RESULTS"):n.status===401?e=ws(n,"MODEL_AUTHENTICATION"):n.status===404?e=ws(n,"MODEL_NOT_FOUND"):n.status===429?e=ws(n,"MODEL_RATE_LIMIT"):e=n,e}function lx(n){return!!(n.tools&&n.tools.length>0)}function dx(n){for(const e of n.messages??[])if(typeof e.content!="string"){for(const t of e.content??[])if(typeof t=="object"&&t!=null&&t.type==="document"&&typeof t.citations=="object"&&t.citations.enabled)return!0}return!1}function hx(n){return!!(n.thinking&&n.thinking.type==="enabled")}function fx(n){return"input_schema"in n}function mx(n){if(typeof n.content=="string")return n.content;if(Array.isArray(n.content)&&n.content.length>=1&&"input"in n.content[0])return typeof n.content[0].input=="string"?n.content[0].input:JSON.stringify(n.content[0].input);if(Array.isArray(n.content)&&n.content.length>=1&&"text"in n.content[0])return n.content[0].text}class px extends Vt{static lc_name(){return"ChatAnthropic"}get lc_secrets(){return{anthropicApiKey:"ANTHROPIC_API_KEY",apiKey:"ANTHROPIC_API_KEY"}}get lc_aliases(){return{modelName:"model"}}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"anthropicApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"invocationKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clientOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thinking",{enumerable:!0,configurable:!0,writable:!0,value:{type:"disabled"}}),Object.defineProperty(this,"batchClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamingClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"createClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.anthropicApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.anthropicApiKey)??Pe("ANTHROPIC_API_KEY"),!this.anthropicApiKey&&!(e!=null&&e.createClient))throw new Error("Anthropic API key not found");this.clientOptions=(e==null?void 0:e.clientOptions)??{},this.apiKey=this.anthropicApiKey,this.apiUrl=e==null?void 0:e.anthropicApiUrl,this.modelName=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.model=this.modelName,this.invocationKwargs=(e==null?void 0:e.invocationKwargs)??{},this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topK=(e==null?void 0:e.topK)??this.topK,this.topP=(e==null?void 0:e.topP)??this.topP,this.maxTokens=(e==null?void 0:e.maxTokensToSample)??(e==null?void 0:e.maxTokens)??this.maxTokens,this.stopSequences=(e==null?void 0:e.stopSequences)??this.stopSequences,this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.thinking=(e==null?void 0:e.thinking)??this.thinking,this.createClient=(e==null?void 0:e.createClient)??(t=>new pe(t))}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"anthropic",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}formatStructuredToolToAnthropic(e){if(!(!e||!e.length))return e.map(t=>{if(fx(t))return t;if(Yc(t))return{name:t.function.name,description:t.function.description,input_schema:t.function.parameters};if(Rf(t))return{name:t.name,description:t.description,input_schema:Cr(t.schema)};throw new Error(`Unknown tool type passed to ChatAnthropic: ${JSON.stringify(t,null,2)}`)})}bindTools(e,t){return this.bind({tools:this.formatStructuredToolToAnthropic(e),...t})}invocationParams(e){const t=sx(e==null?void 0:e.tool_choice);if(this.thinking.type==="enabled"){if(this.topK!==-1)throw new Error("topK is not supported when thinking is enabled");if(this.topP!==-1)throw new Error("topP is not supported when thinking is enabled");if(this.temperature!==1)throw new Error("temperature is not supported when thinking is enabled");return{model:this.model,stop_sequences:(e==null?void 0:e.stop)??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e==null?void 0:e.tools),tool_choice:t,thinking:this.thinking,...this.invocationKwargs}}return{model:this.model,temperature:this.temperature,top_k:this.topK,top_p:this.topP,stop_sequences:(e==null?void 0:e.stop)??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e==null?void 0:e.tools),tool_choice:t,thinking:this.thinking,...this.invocationKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams()}}identifyingParams(){return{model_name:this.model,...this.invocationParams()}}async*_streamResponseChunks(e,t,r){var u;const a=this.invocationParams(t),s=id(e),i={...a,...s,stream:!0},o=!lx(i)&&!dx(i)&&!hx(i),c=await this.createStreamWithRetry(i,{headers:t.headers});for await(const l of c){if((u=t.signal)!=null&&u.aborted)throw c.controller.abort(),new Error("AbortError: User aborted the request.");const d=this.streamUsage??t.streamUsage,h=cx(l,{streamUsage:d,coerceContentToString:o});if(!h)continue;const{chunk:m}=h,f=mx(m),p=new fr({message:new Se({content:m.content,additional_kwargs:m.additional_kwargs,tool_call_chunks:m.tool_call_chunks,usage_metadata:d?m.usage_metadata:void 0,response_metadata:m.response_metadata,id:m.id}),text:f??""});yield p,await(r==null?void 0:r.handleLLMNewToken(f??"",void 0,void 0,void 0,void 0,{chunk:p}))}}async _generateNonStreaming(e,t,r){const a=await this.completionWithRetry({...t,stream:!1,...id(e)},r),{content:s,...i}=a,o=ux(s,i),{role:c,type:u,...l}=i;return{generations:o,llmOutput:l}}async _generate(e,t,r){if(this.stopSequences&&t.stop)throw new Error('"stopSequence" parameter found in input and default params');const a=this.invocationParams(t);if(a.stream){let s;const i=this._streamResponseChunks(e,t,r);for await(const o of i)s===void 0?s=o:s=s.concat(o);if(s===void 0)throw new Error("No chunks returned from Anthropic API.");return{generations:[{text:s.text,message:s.message}]}}else return this._generateNonStreaming(e,a,{signal:t.signal,headers:t.headers})}async createStreamWithRetry(e,t){if(!this.streamingClient){const a=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.streamingClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...a,apiKey:this.apiKey,maxRetries:0})}const r=async()=>{try{return await this.streamingClient.messages.create({...e,...this.invocationKwargs,stream:!0},t)}catch(a){throw od(a)}};return this.caller.call(r)}async completionWithRetry(e,t){if(!this.batchClient){const a=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.batchClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...a,apiKey:this.apiKey,maxRetries:0})}const r=async()=>{try{return await this.batchClient.messages.create({...e,...this.invocationKwargs},t)}catch(a){throw od(a)}};return this.caller.callWithOptions({signal:t.signal??void 0},r)}_llmType(){return"anthropic"}withStructuredOutput(e,t){var f;const r=e,a=t==null?void 0:t.name,s=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw;if(s==="jsonMode")throw new Error('Anthropic only supports "functionCalling" as a method.');let o=a??"extract",c,u;if(eu(r)){const p=Cr(r);u=[{name:o,description:p.description??"A function available to call.",input_schema:p}],c=new nd({returnSingle:!0,keyName:o,zodSchema:r})}else{let p;typeof r.name=="string"&&typeof r.description=="string"&&typeof r.input_schema=="object"&&r.input_schema!=null?(p=r,o=r.name):p={name:o,description:r.description??"",input_schema:r},u=[p],c=new nd({returnSingle:!0,keyName:o})}let l;if(((f=this.thinking)==null?void 0:f.type)==="enabled"){const p="Anthropic structured output relies on forced tool calling, which is not supported when `thinking` is enabled. This method will raise OutputParserException if tool calls are not generated. Consider disabling `thinking` or adjust your prompt to ensure the tool is called.";console.warn(p),l=this.bind({tools:u});const g=w=>{if(!w.tool_calls||w.tool_calls.length===0)throw new Error(p);return w};l=l.pipe(g)}else l=this.bind({tools:u,tool_choice:{type:"tool",name:o}});if(!i)return l.pipe(c).withConfig({runName:"ChatAnthropicStructuredOutput"});const d=yn.assign({parsed:(p,g)=>c.invoke(p.raw,g)}),h=yn.assign({parsed:()=>null}),m=d.withFallbacks({fallbacks:[h]});return $t.from([{raw:l},m]).withConfig({runName:"StructuredOutputRunnable"})}}class gx extends px{}let wr=null;const yx=()=>{if(!wr)throw new Error("API not configured");let n;switch(wr.provider){case"azure":const e=wr;n=new x0({azureOpenAIApiKey:e.apiKey,azureOpenAIApiInstanceName:e.azureInstanceName,azureOpenAIEndpoint:e.azureEndpoint,azureOpenAIApiDeploymentName:e.azureDeployment,azureOpenAIApiVersion:e.azureApiVersion,modelName:e.model});case"deepseek":const t=wr;n=new S0({apiKey:t.apiKey,modelName:t.model});case"anthropic":const r=wr;n=new gx({anthropicApiKey:r.apiKey,modelName:r.model});case"openai":default:const a=wr;n=new au({openAIApiKey:a.apiKey,modelName:a.model})}return n.withStructuredOutput(kp)},ei=n=>{wr=n},_x=async(n,e,t)=>{var i,o;const r=yx(),a=(i=Ls.find(c=>c.code===e))==null?void 0:i.name,s=(o=Ls.find(c=>c.code===t))==null?void 0:o.name;try{return(await r.invoke([{role:"system",content:`You are a language learning assistant specializing in translations from source language: '${a}' to target language:'${s}'. `},{role:"user",content:n}])).result}catch(c){throw console.error("Translation failed:",c),new Error(`Translation failed: ${c instanceof Error?c.message:"Unknown error"}`)}};function bx(){const[n,e]=z.useState(""),[t,r]=z.useState("en"),[a,s]=z.useState("ja"),[i,o]=z.useState([]),[c,u]=z.useState([]),[l,d]=z.useState(void 0),[h,m]=z.useState(void 0),[f,p]=z.useState([]),[g,w]=z.useState([]),[b,_]=z.useState(!1),[v,E]=z.useState(!1),[O,T]=z.useState(-1),[q,K]=z.useState(1),[L,Z]=z.useState(""),[ae,ge]=z.useState(!1),A=z.useRef(!1);z.useEffect(()=>{(async()=>{try{const B=await jp();w(B)}catch(B){console.error("Error loading TTS pairs:",B)}})(),(async()=>{try{const B=await _u();P(B,t,a)}catch(B){Z("Failed to load voices. Please try again."),console.error("Error loading voices:",B)}})()},[]),z.useEffect(()=>{(async()=>{try{const R=await _u();P(R,t,a)}catch(R){Z("Failed to update voices. Please try again."),console.error("Error updating voices:",R)}})()},[t,a]);const P=(S,R,B)=>{const ee=S.filter(Ue=>Ue.lang.includes(R)),Re=S.filter(Ue=>Ue.lang.includes(B));o(ee),u(Re),ee.length>0&&!l&&d(ee[0]),Re.length>0&&!h&&m(Re[0])},M=async()=>{if(!n.trim()){Z("Please enter some text to generate language pairs.");return}Z(""),_(!0);try{const R=(await _x(n.trim(),t,a)).map(B=>({id:Date.now().toString()+Math.random().toString(36).substring(2,9),sourceText:B.sourceText,targetText:B.targetText,sourceLang:t,targetLang:a,timestamp:new Date().toISOString(),pronunciation:B.pronunciation,category:B.category}));p([...f,...R]),await Op(R),e("")}catch(S){Z(`Failed to generate language pairs: ${S instanceof Error?S.message:"Unknown error"}`),console.error("Error generating pairs:",S)}finally{_(!1)}},N=async(S,R)=>{try{const B={id:Date.now().toString()+Math.random().toString(36).substring(2,9),text:S,voice:{name:R.name,lang:R.lang},rate:q,timestamp:new Date().toISOString()};await Rp(B),w([...g,B])}catch(B){console.error("Error saving TTS pair:",B),Z("Failed to save TTS pair")}},H=async S=>{if(S<0||S>=f.length)return;let R=!0;T(S),E(!0);const B=async(ee,Re,Ue=2)=>{for(let Nr=0;Nr<=Ue;Nr++)try{if(!Re)throw new Error("No voice selected");await rn(ee,Re,q);return}catch(Tn){if(Nr===Ue)throw Tn;await new Promise(In=>setTimeout(In,500))}};try{await B(f[S].sourceText,l),l&&await N(f[S].sourceText,l),await new Promise(ee=>setTimeout(ee,1e3)),R&&(await B(f[S].targetText,h),h&&await N(f[S].targetText,h))}catch(ee){console.error("Detailed speaking error:",ee),Z(`Failed to speak text: ${ee instanceof Error?ee.message:"Unknown error"}`)}finally{E(!1),T(-1)}},$=()=>{Yn(),E(!1),T(-1)},W=async(S,R,B=2)=>{for(let ee=0;ee<=B;ee++)try{if(!R)throw new Error("No voice selected");await rn(S,R,q);return}catch(Re){if(ee===B)throw Re;await new Promise(Ue=>setTimeout(Ue,500))}},ce=async()=>{if(!l||!h){Z("Please select both source and target voices");return}console.log(`Selected source and target voice: ${l.name} and ${h.name}`),A.current=!0,E(!0);const S=.2;try{for(let R=0;R<f.length&&!(!A.current||(T(R),await W(f[R].sourceText,l),!A.current));R++)await new Promise(B=>setTimeout(B,S)),await W(f[R].targetText,h),R<f.length-1&&await new Promise(B=>setTimeout(B,1e3))}catch(R){Z(`Failed to speak: ${R instanceof Error?R.message:"Unknown error"}`)}finally{A.current=!1,E(!1),T(-1)}};return y.jsxs("div",{className:"card p-6",children:[y.jsxs("div",{className:"flex justify-between items-center mb-4",children:[y.jsx("h2",{className:"text-xl font-semibold",children:"Text-to-Speech Generator"}),y.jsx("button",{className:"btn btn-primary",onClick:()=>ge(!ae),children:ae?"Hide TTS Menu":"Show TTS Menu"})]}),ae?y.jsxs("div",{className:"mb-6",children:[y.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Saved TTS Pairs"}),y.jsx("div",{className:"space-y-4",children:g.map(S=>y.jsxs("div",{className:"flex items-center justify-between p-3 border rounded",children:[y.jsxs("div",{children:[y.jsx("p",{className:"font-medium",children:S.text}),y.jsxs("p",{className:"text-sm text-gray-600",children:["Voice: ",S.voice.name," (",S.voice.lang,") - Rate: ",S.rate]})]}),y.jsxs("div",{className:"flex space-x-2",children:[y.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>{const R=i.find(B=>B.name===S.voice.name)||c.find(B=>B.name===S.voice.name);R&&rn(S.text,R,S.rate)},children:"Play"}),y.jsx("button",{className:"btn btn-sm btn-error",onClick:async()=>{await Cp(S.id),w(g.filter(R=>R.id!==S.id))},children:"Delete"})]})]},S.id))})]}):null,L&&y.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4",role:"alert",children:y.jsx("p",{children:L})}),y.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[y.jsxs("div",{children:[y.jsx("label",{htmlFor:"sourceLang",className:"block text-sm font-medium text-gray-700 mb-1",children:"Source Language"}),y.jsx("select",{id:"sourceLang",className:"select w-full",value:t,onChange:S=>r(S.target.value),disabled:v,children:Ls.map(S=>y.jsx("option",{value:S.code,children:S.name},S.code))})]}),y.jsxs("div",{children:[y.jsx("label",{htmlFor:"targetLang",className:"block text-sm font-medium text-gray-700 mb-1",children:"Target Language"}),y.jsx("select",{id:"targetLang",className:"select w-full",value:a,onChange:S=>s(S.target.value),disabled:v,children:Ls.map(S=>y.jsx("option",{value:S.code,children:S.name},S.code))})]})]}),y.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[y.jsxs("div",{children:[y.jsx("label",{htmlFor:"sourceVoice",className:"block text-sm font-medium text-gray-700 mb-1",children:"Source Voice"}),y.jsx("select",{id:"sourceVoice",className:"select w-full",value:l?l.name:"",onChange:S=>{const R=i.find(B=>B.name===S.target.value);d(R)},disabled:v||i.length===0,children:i.length===0?y.jsx("option",{value:"",children:"No voices available"}):i.map(S=>y.jsxs("option",{value:S.name,children:[S.name," (",S.lang,")"]},S.name))})]}),y.jsxs("div",{children:[y.jsx("label",{htmlFor:"targetVoice",className:"block text-sm font-medium text-gray-700 mb-1",children:"Target Voice"}),y.jsx("select",{id:"targetVoice",className:"select w-full",value:h?h.name:"",onChange:S=>{const R=c.find(B=>B.name===S.target.value);m(R)},disabled:v||c.length===0,children:c.length===0?y.jsx("option",{value:"",children:"No voices available"}):c.map(S=>y.jsxs("option",{value:S.name,children:[S.name," (",S.lang,")"]},S.name))})]})]}),y.jsxs("div",{className:"mb-4",children:[y.jsxs("label",{htmlFor:"rate",className:"block text-sm font-medium text-gray-700 mb-1",children:["Speech Rate: ",q.toFixed(1)]}),y.jsx("input",{id:"rate",type:"range",min:"0.5",max:"2",step:"0.1",value:q,onChange:S=>K(parseFloat(S.target.value)),className:"w-full",disabled:v})]}),y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"text",className:"block text-sm font-medium text-gray-700 mb-1",children:"Text"}),y.jsx("textarea",{id:"text",className:"input w-full h-24",value:n,onChange:S=>e(S.target.value),placeholder:"Enter text to generate language pairs...",disabled:v||b})]}),y.jsx("div",{className:"flex justify-end mb-6",children:y.jsx("button",{className:"btn btn-primary",onClick:M,disabled:v||b||!n.trim(),children:b?"Generating...":"Generate Pair"})}),y.jsxs("div",{children:[y.jsxs("h3",{className:"text-lg font-medium mb-2",children:["Generated Pairs (",f.length,")"]}),f.length===0?y.jsx("p",{className:"text-gray-500 italic",children:"No pairs generated yet. Enter text above to get started."}):y.jsxs(y.Fragment,{children:[y.jsx("div",{className:"flex justify-end mb-3",children:y.jsx("button",{className:"btn btn-secondary",onClick:ce,disabled:v||f.length===0,children:v?"Stop Speaking":"Speak All Pairs"})}),y.jsx("div",{className:"space-y-3",children:f.map((S,R)=>y.jsx("div",{className:`p-3 border rounded-md ${O===R?"border-primary-500 bg-primary-50":"border-gray-200"}`,children:y.jsxs("div",{className:"flex justify-between items-start mb-2",children:[y.jsxs("div",{children:[y.jsx("p",{className:"font-medium",children:S.sourceText}),y.jsx("p",{className:"text-gray-600",children:S.targetText})]}),y.jsx("div",{className:"flex space-x-2",children:y.jsx("button",{className:`p-2 rounded-full ${v&&O===R?"bg-red-100 text-red-600":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,onClick:()=>v&&O===R?$():H(R),title:v&&O===R?"Stop Speaking":"Speak",children:v&&O===R?y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}):y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10c0-1.105-.448-2.105-1.172-2.828a1 1 0 010-1.415z",clipRule:"evenodd"})})})})]})},S.id))})]})]})]})}const wx=[{character:"ã¢",romaji:"a"},{character:"ã¤",romaji:"i"},{character:"ã¦",romaji:"u"},{character:"ã¨",romaji:"e"},{character:"ãª",romaji:"o"},{character:"ã«",romaji:"ka"},{character:"ã­",romaji:"ki"},{character:"ã¯",romaji:"ku"},{character:"ã±",romaji:"ke"},{character:"ã³",romaji:"ko"},{character:"ãµ",romaji:"sa"},{character:"ã·",romaji:"shi"},{character:"ã¹",romaji:"su"},{character:"ã»",romaji:"se"},{character:"ã½",romaji:"so"},{character:"ã¿",romaji:"ta"},{character:"ã",romaji:"chi"},{character:"ã",romaji:"tsu"},{character:"ã",romaji:"te"},{character:"ã",romaji:"to"},{character:"ã",romaji:"na"},{character:"ã",romaji:"ni"},{character:"ã",romaji:"nu"},{character:"ã",romaji:"ne"},{character:"ã",romaji:"no"},{character:"ã",romaji:"ha"},{character:"ã",romaji:"hi"},{character:"ã",romaji:"fu"},{character:"ã",romaji:"he"},{character:"ã",romaji:"ho"},{character:"ã",romaji:"ma"},{character:"ã",romaji:"mi"},{character:"ã ",romaji:"mu"},{character:"ã¡",romaji:"me"},{character:"ã¢",romaji:"mo"},{character:"ã¤",romaji:"ya"},{character:"ã¦",romaji:"yu"},{character:"ã¨",romaji:"yo"},{character:"ã©",romaji:"ra"},{character:"ãª",romaji:"ri"},{character:"ã«",romaji:"ru"},{character:"ã¬",romaji:"re"},{character:"ã­",romaji:"ro"},{character:"ã¯",romaji:"wa"},{character:"ã²",romaji:"wo"},{character:"ã³",romaji:"n"},{character:"ã¬",romaji:"ga"},{character:"ã®",romaji:"gi"},{character:"ã°",romaji:"gu"},{character:"ã²",romaji:"ge"},{character:"ã´",romaji:"go"},{character:"ã¶",romaji:"za"},{character:"ã¸",romaji:"ji"},{character:"ãº",romaji:"zu"},{character:"ã¼",romaji:"ze"},{character:"ã¾",romaji:"zo"},{character:"ã",romaji:"da"},{character:"ã",romaji:"ji"},{character:"ã",romaji:"zu"},{character:"ã",romaji:"de"},{character:"ã",romaji:"do"},{character:"ã",romaji:"ba"},{character:"ã",romaji:"bi"},{character:"ã",romaji:"bu"},{character:"ã",romaji:"be"},{character:"ã",romaji:"bo"},{character:"ã",romaji:"pa"},{character:"ã",romaji:"pi"},{character:"ã",romaji:"pu"},{character:"ã",romaji:"pe"},{character:"ã",romaji:"po"}],vx=[{character:"ã",romaji:"a"},{character:"ã",romaji:"i"},{character:"ã",romaji:"u"},{character:"ã",romaji:"e"},{character:"ã",romaji:"o"},{character:"ã",romaji:"ka"},{character:"ã",romaji:"ki"},{character:"ã",romaji:"ku"},{character:"ã",romaji:"ke"},{character:"ã",romaji:"ko"},{character:"ã",romaji:"sa"},{character:"ã",romaji:"shi"},{character:"ã",romaji:"su"},{character:"ã",romaji:"se"},{character:"ã",romaji:"so"},{character:"ã",romaji:"ta"},{character:"ã¡",romaji:"chi"},{character:"ã¤",romaji:"tsu"},{character:"ã¦",romaji:"te"},{character:"ã¨",romaji:"to"},{character:"ãª",romaji:"na"},{character:"ã«",romaji:"ni"},{character:"ã¬",romaji:"nu"},{character:"ã­",romaji:"ne"},{character:"ã®",romaji:"no"},{character:"ã¯",romaji:"ha"},{character:"ã²",romaji:"hi"},{character:"ãµ",romaji:"fu"},{character:"ã¸",romaji:"he"},{character:"ã»",romaji:"ho"},{character:"ã¾",romaji:"ma"},{character:"ã¿",romaji:"mi"},{character:"ã",romaji:"mu"},{character:"ã",romaji:"me"},{character:"ã",romaji:"mo"},{character:"ã",romaji:"ya"},{character:"ã",romaji:"yu"},{character:"ã",romaji:"yo"},{character:"ã",romaji:"ra"},{character:"ã",romaji:"ri"},{character:"ã",romaji:"ru"},{character:"ã",romaji:"re"},{character:"ã",romaji:"ro"},{character:"ã",romaji:"wa"},{character:"ã",romaji:"wo"},{character:"ã",romaji:"n"},{character:"ã",romaji:"ga"},{character:"ã",romaji:"gi"},{character:"ã",romaji:"gu"},{character:"ã",romaji:"ge"},{character:"ã",romaji:"go"},{character:"ã",romaji:"za"},{character:"ã",romaji:"ji"},{character:"ã",romaji:"zu"},{character:"ã",romaji:"ze"},{character:"ã",romaji:"zo"},{character:"ã ",romaji:"da"},{character:"ã¢",romaji:"ji"},{character:"ã¥",romaji:"zu"},{character:"ã§",romaji:"de"},{character:"ã©",romaji:"do"},{character:"ã°",romaji:"ba"},{character:"ã³",romaji:"bi"},{character:"ã¶",romaji:"bu"},{character:"ã¹",romaji:"be"},{character:"ã¼",romaji:"bo"},{character:"ã±",romaji:"pa"},{character:"ã´",romaji:"pi"},{character:"ã·",romaji:"pu"},{character:"ãº",romaji:"pe"},{character:"ã½",romaji:"po"}],xx={ã:{character:"ã",sound:"a",mnemonic:'Looks like an "Antenna" on a house.'},ã:{character:"ã",sound:"i",mnemonic:'Two people standing together, saying "ii" (ãã = good in Japanese).'},ã:{character:"ã",sound:"u",mnemonic:'Looks like a "U"-shaped worm.'},ã:{character:"ã",sound:"e",mnemonic:'Looks like an "Energetic" person doing a dance.'},ã:{character:"ã",sound:"o",mnemonic:'Looks like an "Olympic" runner with a medal.'},ã:{character:"ã",sound:"ka",mnemonic:'Looks like a "Kite" flying in the sky.'},ã:{character:"ã",sound:"ki",mnemonic:'Looks like a "Key" with teeth at the bottom.'},ã:{character:"ã",sound:"ku",mnemonic:`Looks like a bird's beak saying "Coo!".`},ã:{character:"ã",sound:"ke",mnemonic:'Looks like a "Keg" with a spout.'},ã:{character:"ã",sound:"ko",mnemonic:'Looks like two "Coiled" worms.'},ã:{character:"ã",sound:"sa",mnemonic:'Looks like a "Sail" on a boat.'},ã:{character:"ã",sound:"shi",mnemonic:`Looks like a "Sheep's" head with a curved horn.`},ã:{character:"ã",sound:"su",mnemonic:'Looks like a "Swing" hanging from a tree.'},ã:{character:"ã",sound:"se",mnemonic:'Looks like a "Sail" with a wave underneath.'},ã:{character:"ã",sound:"so",mnemonic:'Looks like a "Sewing" thread curling.'},ã:{character:"ã",sound:"ta",mnemonic:'Looks like a "Taco" with a line on top.'},ã¡:{character:"ã¡",sound:"chi",mnemonic:'Looks like a "Cheese wedge" with a bite taken out.'},ã¤:{character:"ã¤",sound:"tsu",mnemonic:'Looks like a "Tsunami" wave.'},ã¦:{character:"ã¦",sound:"te",mnemonic:'Looks like a "Tennis racket" swinging.'},ã¨:{character:"ã¨",sound:"to",mnemonic:'Looks like a "Toe" with a nail sticking out.'},ãª:{character:"ãª",sound:"na",mnemonic:'Looks like a "Knot" tied in a rope.'},ã«:{character:"ã«",sound:"ni",mnemonic:'Looks like a "Knee" bending while kneeling.'},ã¬:{character:"ã¬",sound:"nu",mnemonic:'Looks like a "Noodle" with a loop.'},ã­:{character:"ã­",sound:"ne",mnemonic:'Looks like a "Net" catching fish.'},ã®:{character:"ã®",sound:"no",mnemonic:'Looks like the letter "NO" as a swirling motion.'},ã¯:{character:"ã¯",sound:"ha",mnemonic:'Looks like "Hawaii" where the sun sets on the beach.'},ã²:{character:"ã²",sound:"hi",mnemonic:'Looks like a "Hee-hee" smile.'},ãµ:{character:"ãµ",sound:"fu",mnemonic:'Looks like a "Fuji" mountain with wind blowing.'},ã¸:{character:"ã¸",sound:"he",mnemonic:'Looks like a "Hill" (ã¸ also means "direction" or "to" in Japanese).'},ã»:{character:"ã»",sound:"ho",mnemonic:'Looks like a "Hot" fire with flames.'},ã¾:{character:"ã¾",sound:"ma",mnemonic:'Looks like a "Mama" holding a baby.'},ã¿:{character:"ã¿",sound:"mi",mnemonic:'Looks like a "Meat skewer" with two sticks.'},ã:{character:"ã",sound:"mu",mnemonic:'Looks like a "Moose" with curled antlers.'},ã:{character:"ã",sound:"me",mnemonic:'Looks like an "Eye" (ã means "eye" in Japanese).'},ã:{character:"ã",sound:"mo",mnemonic:'Looks like a "Fishing hook" catching something.'},ã:{character:"ã",sound:"ya",mnemonic:'Looks like a "Yak" with curved horns.'},ã:{character:"ã",sound:"yu",mnemonic:'Looks like a "U-turn" sign.'},ã:{character:"ã",sound:"yo",mnemonic:'Looks like a "Yoga" person stretching.'},ã:{character:"ã",sound:"ra",mnemonic:'Looks like a "Rabbit" with long ears.'},ã:{character:"ã",sound:"ri",mnemonic:'Looks like two "Reeds" growing in water.'},ã:{character:"ã",sound:"ru",mnemonic:'Looks like a "Loop" of thread.'},ã:{character:"ã",sound:"re",mnemonic:'Looks like a "Ledge" sticking out of a wall.'},ã:{character:"ã",sound:"ro",mnemonic:'Looks like a "Road" turning at an angle.'},ã:{character:"ã",sound:"wa",mnemonic:'Looks like a "Wasp" buzzing around.'},ã:{character:"ã",sound:"wo (o)",mnemonic:'Looks like a "Warped road" curving.'},ã:{character:"ã",sound:"n",mnemonic:'Looks like an "End" of a road curving down.'},ã:{character:"ã",sound:"ga",mnemonic:'A "Kite" that caught a "Gust" of wind (ã + dakuten).'},ã:{character:"ã",sound:"gi",mnemonic:`A "Key" that's "Gleaming" (ã + dakuten).`},ã:{character:"ã",sound:"gu",mnemonic:'A bird saying "Good!" instead of "Coo!" (ã + dakuten).'},ã:{character:"ã",sound:"ge",mnemonic:'A "Keg" being opened, making a "Geyser" (ã + dakuten).'},ã:{character:"ã",sound:"go",mnemonic:'Two worms that are "Going" somewhere (ã + dakuten).'},ã:{character:"ã",sound:"za",mnemonic:'A "Sail" caught in a "Zippy" wind (ã + dakuten).'},ã:{character:"ã",sound:"ji",mnemonic:'A "Sheep" making a "Jittery" movement (ã + dakuten).'},ã:{character:"ã",sound:"zu",mnemonic:'A "Swing" making a "Zoom" sound (ã + dakuten).'},ã:{character:"ã",sound:"ze",mnemonic:'A "Sail" in a "Zephyr" wind (ã + dakuten).'},ã:{character:"ã",sound:"zo",mnemonic:'A "Sewing" thread in a "Zone" (ã + dakuten).'},ã :{character:"ã ",sound:"da",mnemonic:'A "Taco" with "Daring" toppings (ã + dakuten).'},ã¢:{character:"ã¢",sound:"ji",mnemonic:'A "Cheese wedge" on a "Dinner" plate (ã¡ + dakuten).'},ã¥:{character:"ã¥",sound:"zu",mnemonic:'A "Tsunami" going down a "Drain" (ã¤ + dakuten).'},ã§:{character:"ã§",sound:"de",mnemonic:'A "Tennis racket" in a "Demo" match (ã¦ + dakuten).'},ã©:{character:"ã©",sound:"do",mnemonic:'A "Toe" with a "Door" nail (ã¨ + dakuten).'},ã°:{character:"ã°",sound:"ba",mnemonic:'"Hawaii" with "Bamboo" trees (ã¯ + dakuten).'},ã³:{character:"ã³",sound:"bi",mnemonic:'A "Hee-hee" smile saying "Bee-bee" (ã² + dakuten).'},ã¶:{character:"ã¶",sound:"bu",mnemonic:'"Fuji" mountain with a "Bull" climbing it (ãµ + dakuten).'},ã¹:{character:"ã¹",sound:"be",mnemonic:'A "Hill" with a "Bell" on top (ã¸ + dakuten).'},ã¼:{character:"ã¼",sound:"bo",mnemonic:'A "Hot" fire in a "Boat" (ã» + dakuten).'},ã±:{character:"ã±",sound:"pa",mnemonic:'"Hawaii" with "Palm" trees (ã¯ + handakuten).'},ã´:{character:"ã´",sound:"pi",mnemonic:'A "Hee-hee" smile saying "Pee-pee" (ã² + handakuten).'},ã·:{character:"ã·",sound:"pu",mnemonic:'"Fuji" mountain with a "Puff" of smoke (ãµ + handakuten).'},ãº:{character:"ãº",sound:"pe",mnemonic:'A "Hill" with a "Peg" on top (ã¸ + handakuten).'},ã½:{character:"ã½",sound:"po",mnemonic:'A "Hot" fire in a "Pot" (ã» + handakuten).'}};function Sx(n){return xx[n]}const Ex=[{character:"ä½ ",romaji:"nÇ"},{character:"å¥½",romaji:"hÇo"},{character:"æ",romaji:"wÇ"},{character:"æ¯",romaji:"shÃ¬"},{character:"äºº",romaji:"rÃ©n"},{character:"ä»",romaji:"tÄ"},{character:"å¥¹",romaji:"tÄ"},{character:"ç",romaji:"de"},{character:"äº",romaji:"le"},{character:"ä¸",romaji:"bÃ¹"},{character:"å¨",romaji:"zÃ i"},{character:"æ",romaji:"yÇu"},{character:"è¿",romaji:"zhÃ¨"},{character:"ä¸ª",romaji:"gÃ¨"},{character:"ä»¬",romaji:"men"},{character:"æ¥",romaji:"lÃ¡i"},{character:"å»",romaji:"qÃ¹"},{character:"å",romaji:"hÃ©"},{character:"å°±",romaji:"jiÃ¹"},{character:"è¯´",romaji:"shuÅ"}],kx=[{character:"Ð",romaji:"a"},{character:"Ð",romaji:"b"},{character:"Ð",romaji:"v"},{character:"Ð",romaji:"g"},{character:"Ð",romaji:"d"},{character:"Ð",romaji:"ye"},{character:"Ð",romaji:"yo"},{character:"Ð",romaji:"zh"},{character:"Ð",romaji:"z"},{character:"Ð",romaji:"i"},{character:"Ð",romaji:"y"},{character:"Ð",romaji:"k"},{character:"Ð",romaji:"l"},{character:"Ð",romaji:"m"},{character:"Ð",romaji:"n"},{character:"Ð",romaji:"o"},{character:"Ð",romaji:"p"},{character:"Ð ",romaji:"r"},{character:"Ð¡",romaji:"s"},{character:"Ð¢",romaji:"t"},{character:"Ð£",romaji:"u"},{character:"Ð¤",romaji:"f"},{character:"Ð¥",romaji:"kh"},{character:"Ð¦",romaji:"ts"},{character:"Ð§",romaji:"ch"},{character:"Ð¨",romaji:"sh"},{character:"Ð©",romaji:"shch"},{character:"Ðª",romaji:'"hard sign"'},{character:"Ð«",romaji:"y"},{character:"Ð¬",romaji:'"soft sign"'},{character:"Ð­",romaji:"e"},{character:"Ð®",romaji:"yu"},{character:"Ð¯",romaji:"ya"}],tm=[{id:"katakana",name:"Katakana",description:"Japanese syllabary used for foreign words and emphasis",characters:wx,language:"ja"},{id:"hiragana",name:"Hiragana",description:"Japanese syllabary used for native words and grammar",characters:vx,language:"ja"},{id:"chinese",name:"Chinese Characters",description:"Common Chinese characters (Hanzi/Kanji)",characters:Ex,language:"zh"},{id:"cyrillic",name:"Cyrillic Alphabet",description:"Used in Russian and many Slavic languages",characters:kx,language:"ru"}];function Po(n){return tm.find(e=>e.id===n)}const Ax=(n,e)=>{switch(e){case"hiragana":return Sx(n);default:return}};function Px({writingSystemId:n="katakana",onSystemChange:e}){const[t,r]=z.useState(Po(n)),[a,s]=z.useState(null),[i,o]=z.useState(null),[c,u]=z.useState(null),[l,d]=z.useState(!1),[h,m]=z.useState(0),[f,p]=z.useState(0),[g,w]=z.useState(!1),[b,_]=z.useState(null),[v,E]=z.useState(!0);z.useEffect(()=>{const ae=Po(n);r(ae)},[n]);const O=()=>{if(o(null),u(null),d(!1),_(null),E(!0),!t||t.characters.length===0)return;const ae=Math.floor(Math.random()*t.characters.length),ge=t.characters[ae];let A=[ge.romaji];for(;A.length<4;){const P=Math.floor(Math.random()*t.characters.length),M=t.characters[P].romaji;A.includes(M)||A.push(M)}A=A.sort(()=>Math.random()-.5),s({character:ge,options:A,correctAnswer:ge.romaji})};z.useEffect(()=>{O()},[t]);const T=ae=>{if(i!==null)return;o(ae);const ge=ae===(a==null?void 0:a.correctAnswer);if(u(ge),ge)m(A=>A+1),_(null),setTimeout(()=>{O()},2e3);else if(E(!1),t&&a){const A=Ax(a.character.character,t.id);_((A==null?void 0:A.mnemonic)||null)}p(A=>A+1),d(!0)},q=async()=>{if(!(!a||!t)){w(!0);try{const ge=(await window.speechSynthesis.getVoices()).find(A=>A.lang.includes(t.language));ge?await rn(a.character.character,ge):await rn(a.character.romaji)}catch(ae){console.error("Error pronouncing character:",ae)}finally{w(!1)}}},K=f>0?Math.round(h/f*100):0,L=ae=>{const ge=ae.target.value,A=Po(ge);r(A),m(0),p(0),e&&e(ge)},Z=()=>{O()};return!t||!a?y.jsx("div",{className:"flex justify-center items-center py-12",children:y.jsxs("svg",{className:"animate-spin h-8 w-8 text-primary-600",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[y.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),y.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):y.jsxs("div",{className:"p-4",children:[y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"writingSystem",className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Writing System"}),y.jsx("select",{id:"writingSystem",className:"select w-full mb-4",value:t.id,onChange:L,children:tm.map(ae=>y.jsxs("option",{value:ae.id,children:[ae.name," - ",ae.description]},ae.id))})]}),y.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[y.jsxs("div",{children:[y.jsxs("span",{className:"font-medium",children:["Score: ",h,"/",f]}),y.jsxs("div",{className:"text-sm text-gray-500",children:["Accuracy: ",K,"%"]})]}),y.jsx("button",{className:"btn btn-secondary",onClick:O,children:"Skip Question"})]}),y.jsxs("div",{className:"flex flex-col items-center mb-8",children:[y.jsx("div",{className:"text-8xl mb-4",children:a.character.character}),y.jsx("button",{className:`p-2 rounded-full ${g?"bg-red-100 text-red-600":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,onClick:g?Yn:q,disabled:g,children:g?y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}):y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071a1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),y.jsx("div",{className:"text-center mb-6",children:y.jsx("h3",{className:"text-lg font-medium",children:"Choose the correct reading:"})}),y.jsx("div",{className:"grid grid-cols-2 gap-4",children:a.options.map((ae,ge)=>y.jsx("button",{className:`p-4 text-lg font-medium text-center rounded-lg border-2 transition-colors
              ${i===ae?c?"bg-green-100 border-green-500 text-green-700":"bg-red-100 border-red-500 text-red-700":l&&ae===a.correctAnswer?"bg-green-100 border-green-500 text-green-700":"bg-white border-gray-200 hover:bg-gray-50"}`,onClick:()=>T(ae),disabled:i!==null,children:ae},ge))}),l&&y.jsxs("div",{className:"mt-6 text-center",children:[y.jsx("p",{className:c?"text-green-600 font-medium":"text-red-600 font-medium",children:c?"Correct!":`Wrong! The correct answer is ${a.correctAnswer}`}),!c&&b&&y.jsxs("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:[y.jsx("h4",{className:"font-medium text-yellow-800 mb-1",children:"Mnemonic Tip:"}),y.jsx("p",{className:"text-yellow-700",children:b})]}),!c&&!v&&y.jsx("button",{className:"mt-6 btn btn-primary",onClick:Z,children:"Next Question"})]})]})}function Ox(){const[n,e]=z.useState([]),[t,r]=z.useState(0),[a,s]=z.useState(!1),[i,o]=z.useState(!1),[c,u]=z.useState(!0),[l,d]=z.useState(""),[h,m]=z.useState(""),[f,p]=z.useState("quiz"),[g,w]=z.useState("hiragana");z.useEffect(()=>{(async()=>{try{u(!0);const Z=await Tp();e(Z)}catch(Z){d("Failed to load flashcards. Please try again."),console.error("Error loading flashcards:",Z)}finally{u(!1)}})()},[]);const b=h?n.filter(L=>L.sourceText===h||L.targetText===h):n,_=b[t]||null,v=()=>{s(!a)},E=()=>{Yn(),o(!1),s(!1),r(L=>L>=b.length-1?0:L+1)},O=()=>{Yn(),o(!1),s(!1),r(L=>L<=0?b.length-1:L-1)},T=async()=>{if(_){o(!0);try{const L=a?_.targetText:_.sourceText;await rn(L)}catch(L){console.error("Error speaking text:",L)}finally{o(!1)}}},q=async()=>{if(_)try{await Ip(_.id),e(L=>L.filter(Z=>Z.id!==_.id)),t>=b.length-1&&r(Math.max(0,b.length-2))}catch(L){d("Failed to delete flashcard. Please try again."),console.error("Error deleting flashcard:",L)}},K=L=>{w(L)};return y.jsxs("div",{className:"card p-6",children:[y.jsxs("div",{className:"flex justify-between items-center mb-4",children:[y.jsx("h2",{className:"text-xl font-semibold",children:"Flashcards"}),y.jsxs("div",{className:"inline-flex rounded-md shadow-sm",role:"group",children:[y.jsx("button",{type:"button",className:`px-4 py-2 text-sm font-medium ${f==="standard"?"bg-primary-600 text-white":"bg-white text-gray-700 hover:bg-gray-50"} rounded-l-lg border`,onClick:()=>p("standard"),children:"Standard Cards"}),y.jsx("button",{type:"button",className:`px-4 py-2 text-sm font-medium ${f==="quiz"?"bg-primary-600 text-white":"bg-white text-gray-700 hover:bg-gray-50"} rounded-r-lg border`,onClick:()=>p("quiz"),children:"Alphabet Quiz"})]})]}),l&&y.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4",role:"alert",children:y.jsx("p",{children:l})}),f==="quiz"?y.jsx(Px,{writingSystemId:g,onSystemChange:K}):y.jsxs(y.Fragment,{children:[y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"filterLang",className:"block text-sm font-medium text-gray-700 mb-1",children:"Filter by Language"}),y.jsxs("select",{id:"filterLang",className:"select w-full",value:h,onChange:L=>{m(L.target.value),r(0),s(!1)},children:[y.jsx("option",{value:"",children:"All Languages"}),y.jsx("option",{value:"en-US",children:"English (US)"}),y.jsx("option",{value:"es-ES",children:"Spanish (Spain)"}),y.jsx("option",{value:"fr-FR",children:"French (France)"}),y.jsx("option",{value:"de-DE",children:"German (Germany)"}),y.jsx("option",{value:"it-IT",children:"Italian (Italy)"}),y.jsx("option",{value:"ja-JP",children:"Japanese (Japan)"}),y.jsx("option",{value:"ko-KR",children:"Korean (Korea)"}),y.jsx("option",{value:"zh-CN",children:"Chinese (China)"})]})]}),c?y.jsx("div",{className:"flex justify-center items-center py-12",children:y.jsxs("svg",{className:"animate-spin h-8 w-8 text-primary-600",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[y.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),y.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):b.length===0?y.jsxs("div",{className:"text-center py-8",children:[y.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","aria-hidden":"true",children:y.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"})}),y.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No flashcards"}),y.jsx("p",{className:"mt-1 text-sm text-gray-500",children:h?"No flashcards match your filter.":"Generate some language pairs in the Text-to-Speech tab to get started."})]}):y.jsxs("div",{children:[y.jsxs("div",{className:`relative h-64 w-full cursor-pointer transition-transform duration-500 ${a?"rotate-y-180":""}`,onClick:v,children:[y.jsxs("div",{className:`absolute inset-0 flex flex-col items-center justify-center p-6 border-2 rounded-lg ${a?"hidden":"block"} ${i?"border-primary-500":"border-gray-200"}`,children:[y.jsx("p",{className:"text-sm text-gray-500 mb-2",children:_==null?void 0:_.sourceText}),y.jsx("p",{className:"text-xl text-center",children:_==null?void 0:_.sourceText}),y.jsx("p",{className:"text-sm text-gray-500 mt-4",children:"Tap to flip"})]}),y.jsxs("div",{className:`absolute inset-0 flex flex-col items-center justify-center p-6 border-2 rounded-lg ${a?"block":"hidden"} ${i?"border-primary-500":"border-gray-200"}`,children:[y.jsx("p",{className:"text-sm text-gray-500 mb-2",children:_==null?void 0:_.targetText}),y.jsx("p",{className:"text-xl text-center",children:_==null?void 0:_.targetText}),y.jsx("p",{className:"text-sm text-gray-500 mt-4",children:"Tap to flip"})]})]}),y.jsxs("div",{className:"flex justify-between items-center mt-6",children:[y.jsxs("div",{className:"flex space-x-2",children:[y.jsx("button",{className:"p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:O,title:"Previous Card",children:y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z",clipRule:"evenodd"})})}),y.jsx("button",{className:"p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:E,title:"Next Card",children:y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z",clipRule:"evenodd"})})})]}),y.jsx("p",{className:"text-sm text-gray-500",children:b.length>0?`${t+1} / ${b.length}`:"0 / 0"}),y.jsxs("div",{className:"flex space-x-2",children:[y.jsx("button",{className:`p-2 rounded-full ${i?"bg-red-100 text-red-600":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,onClick:i?Yn:T,title:i?"Stop Speaking":"Speak",disabled:!_,children:i?y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}):y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071a1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z",clipRule:"evenodd"})})}),y.jsx("button",{className:"p-2 rounded-full bg-gray-100 text-red-600 hover:bg-red-100",onClick:q,title:"Delete Card",disabled:!_,children:y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})]})]})]})]})}const Tx=["claude-3-haiku-20240307"],Ix=["deepseek-chat","deepseek-reasoning"],Oo=["gpt-4","gpt4o-copilot"],Rx=n=>{switch(n){case"openai":return Oo[0];case"azure":return Oo[1];case"deepseek":return Ix[0];case"anthropic":return Tx[0];default:return Oo[0]}};function jx(){const[n,e]=z.useState(""),[t,r]=z.useState(""),[a,s]=z.useState("2023-05-15"),[i,o]=z.useState(""),[c,u]=z.useState("openai"),[l,d]=z.useState(!1),[h,m]=z.useState(!1),[f,p]=z.useState("");z.useEffect(()=>{(async()=>{try{const b=await _t("api_provider"),_=await _t("azure_instance_name"),v=await _t("azure_api_version"),E=await _t("azure_api_base");b&&u(b),_&&r(_),v&&s(v),E&&o(E);const T=`${b||"openai"}_api_key`,q=await _t(T);q&&e(q)}catch(b){p("Failed to load settings. Please try again."),console.error("Error loading settings:",b)}})()},[]),z.useEffect(()=>{(async()=>{try{const b=`${c}_api_key`,_=await _t(b);e(_||"")}catch(b){console.error("Error loading API key for provider:",b)}})()},[c]);const g=async w=>{w.preventDefault(),d(!0),m(!1),p("");try{const b=`${c}_api_key`;await Rn(b,n),await Rn("azure_instance_name",t),await Rn("azure_api_version",a),await Rn("azure_api_base",i),await Rn("api_provider",c);try{const _=Rx(c),v={provider:c,apiKey:n,model:_};ei(c==="azure"?{...v,provider:"azure",azureInstanceName:t,azureEndpoint:i,azureDeployment:"gpt4o-copilot",azureApiVersion:a}:v)}catch(_){console.error("Error configuring API:",_)}m(!0),setTimeout(()=>{m(!1)},3e3)}catch(b){p("Failed to save settings. Please try again."),console.error("Error saving settings:",b)}finally{d(!1)}};return y.jsxs("div",{className:"card p-6",children:[y.jsx("h2",{className:"text-xl font-semibold mb-4",children:"API Settings"}),f&&y.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4",role:"alert",children:y.jsx("p",{children:f})}),h&&y.jsx("div",{className:"bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4",role:"alert",children:y.jsx("p",{children:"Settings saved successfully!"})}),y.jsxs("form",{onSubmit:g,children:[y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"apiProvider",className:"block text-sm font-medium text-gray-700 mb-1",children:"API Provider"}),y.jsxs("select",{id:"apiProvider",className:"input w-full",value:c,onChange:w=>u(w.target.value),children:[y.jsx("option",{value:"openai",children:"OpenAI"}),y.jsx("option",{value:"azure",children:"Azure OpenAI"}),y.jsx("option",{value:"deepseek",children:"Deepseek"}),y.jsx("option",{value:"anthropic",children:"Anthropic"})]})]}),y.jsxs("div",{className:"mb-4",children:[y.jsxs("label",{htmlFor:"apiKey",className:"block text-sm font-medium text-gray-700 mb-1",children:[c.charAt(0).toUpperCase()+c.slice(1)," API Key"]}),y.jsx("input",{type:"password",id:"apiKey",className:"input w-full",value:n,onChange:w=>e(w.target.value),placeholder:`Enter your ${c.charAt(0).toUpperCase()+c.slice(1)} API key`}),y.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Your API key will be stored securely in your browser."})]}),c==="azure"&&y.jsxs(y.Fragment,{children:[y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"azureApiBase",className:"block text-sm font-medium text-gray-700 mb-1",children:"Azure API Base URL"}),y.jsx("input",{type:"text",id:"azureApiBase",className:"input w-full",value:i,onChange:w=>o(w.target.value),placeholder:"e.g., https://your-resource.openai.azure.com"})]}),y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"azureInstanceName",className:"block text-sm font-medium text-gray-700 mb-1",children:"Azure Instance Name"}),y.jsx("input",{type:"text",id:"azureInstanceName",className:"input w-full",value:t,onChange:w=>r(w.target.value),placeholder:"e.g., your-resource"})]}),y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"azureApiVersion",className:"block text-sm font-medium text-gray-700 mb-1",children:"Azure API Version"}),y.jsx("input",{type:"text",id:"azureApiVersion",className:"input w-full",value:a,onChange:w=>s(w.target.value),placeholder:"e.g., 2023-05-15"})]})]}),y.jsx("button",{type:"submit",className:"btn btn-primary w-full",children:l?"Saving...":"Save Settings"})]})]})}function Cx(){const[n,e]=z.useState("flashcards"),[t,r]=z.useState(!0);return z.useEffect(()=>{const a="speechSynthesis"in window;r(a),a&&Np(),(async()=>{try{const i=await _t("api_provider");if(!i)return;const o=`${i}_api_key`,c=await _t(o);if(!c)return;const l={provider:i,apiKey:c,model:i==="openai"?"gpt-4":i==="azure"?"gpt4o-copilot":i==="deepseek"?"deepseek-chat":i==="anthropic"?"claude-3-haiku-20240307":"gpt-4"};ei(i==="azure"?{...l,provider:"azure",azureEndpoint:await _t("azure_api_base"),azureInstanceName:await _t("azure_instance_name"),azureDeployment:"gpt4o-copilot",azureApiVersion:await _t("azure_api_version")}:l),console.log("API configured successfully on startup"),console.log("API configuration:",l)}catch(i){console.error("Error loading API configuration on startup:",i)}})()},[]),y.jsxs("div",{className:"min-h-screen flex flex-col",children:[y.jsx(pm,{}),y.jsxs("main",{className:"flex-grow container mx-auto px-4 py-6",children:[!t&&y.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6",role:"alert",children:y.jsx("p",{children:"Your browser doesn't support Text-to-Speech functionality. Please try a different browser."})}),y.jsx("div",{className:"flex justify-center mb-6",children:y.jsxs("div",{className:"inline-flex rounded-md shadow-sm",role:"group",children:[y.jsx("button",{type:"button",className:`px-4 py-2 text-sm font-medium ${n==="tts"?"bg-primary-600 text-white":"bg-white text-gray-700 hover:bg-gray-50"} ${n==="tts"?"":"border-r border-gray-200"} rounded-l-lg`,onClick:()=>e("tts"),children:"Text-to-Speech"}),y.jsx("button",{type:"button",className:`px-4 py-2 text-sm font-medium ${n==="flashcards"?"bg-primary-600 text-white":"bg-white text-gray-700 hover:bg-gray-50"} ${n==="flashcards"?"":"border-r border-gray-200"}`,onClick:()=>e("flashcards"),children:"Flashcards"}),y.jsx("button",{type:"button",className:`px-4 py-2 text-sm font-medium rounded-r-lg ${n==="settings"?"bg-primary-600 text-white":"bg-white text-gray-700 hover:bg-gray-50"}`,onClick:()=>e("settings"),children:"Settings"})]})}),n==="tts"?y.jsx(bx,{}):n==="flashcards"?y.jsx(Ox,{}):y.jsx(jx,{})]}),y.jsx(gm,{})]})}const rm=document.getElementById("root");if(!rm)throw new Error("Failed to find the root element");To.createRoot(rm).render(y.jsx(om.StrictMode,{children:y.jsx(Cx,{})}));
