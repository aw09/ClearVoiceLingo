var rm=Object.defineProperty;var nm=(n,e,t)=>e in n?rm(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Gt=(n,e,t)=>nm(n,typeof e!="symbol"?e+"":e,t);import{r as K,a as am,g as cu,R as sm}from"./react-CIP6LD3P.js";import{o as im}from"./vendor-BXWtuYvb.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();var od={exports:{}},ti={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var om=K,um=Symbol.for("react.element"),cm=Symbol.for("react.fragment"),lm=Object.prototype.hasOwnProperty,dm=om.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,hm={key:!0,ref:!0,__self:!0,__source:!0};function ud(n,e,t){var r,a={},s=null,i=null;t!==void 0&&(s=""+t),e.key!==void 0&&(s=""+e.key),e.ref!==void 0&&(i=e.ref);for(r in e)lm.call(e,r)&&!hm.hasOwnProperty(r)&&(a[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps,e)a[r]===void 0&&(a[r]=e[r]);return{$$typeof:um,type:n,key:s,ref:i,props:a,_owner:dm.current}}ti.Fragment=cm;ti.jsx=ud;ti.jsxs=ud;od.exports=ti;var y=od.exports,Oo={},fc=am;Oo.createRoot=fc.createRoot,Oo.hydrateRoot=fc.hydrateRoot;function fm(){return y.jsx("header",{className:"bg-white shadow-sm",children:y.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center",children:[y.jsxs("svg",{className:"h-8 w-8 text-primary-600",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[y.jsx("path",{d:"M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z",fill:"currentColor"}),y.jsx("path",{d:"M19.4 13C19.2669 13.6834 19.0224 14.3334 18.6872 14.9217C18.3519 15.5101 17.9308 16.0292 17.4413 16.4533C16.9517 16.8775 16.4012 17.2006 15.8159 17.4153C15.2306 17.6301 14.619 17.7329 14 17.7226C13.3866 17.7329 12.7779 17.6301 12.1953 17.4153C11.6126 17.2006 11.0644 16.8775 10.5764 16.4533C10.0884 16.0292 9.66825 15.5101 9.33251 14.9217C8.99678 14.3334 8.75235 13.6834 8.61914 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),y.jsx("path",{d:"M3 10.5V13.5C3 17.6421 6.35786 21 10.5 21H13.5C17.6421 21 21 17.6421 21 13.5V10.5C21 6.35786 17.6421 3 13.5 3H10.5C6.35786 3 3 6.35786 3 10.5Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),y.jsx("h1",{className:"ml-2 text-xl font-bold text-gray-900",children:"ClearVoiceLingo"})]}),y.jsx("a",{href:"https://github.com/aw09/clearvoicelingo",target:"_blank",rel:"noopener noreferrer",className:"text-gray-500 hover:text-gray-700",children:y.jsx("svg",{className:"h-6 w-6",fill:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:y.jsx("path",{fillRule:"evenodd",d:"M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z",clipRule:"evenodd"})})})]})})}function mm(){return y.jsx("footer",{className:"bg-white border-t border-gray-200 py-4",children:y.jsxs("div",{className:"container mx-auto px-4",children:[y.jsxs("p",{className:"text-center text-sm text-gray-500",children:["© ",new Date().getFullYear()," ClearVoiceLingo. All rights reserved."]}),y.jsx("p",{className:"text-center text-xs text-gray-400 mt-1",children:"Built with Web Speech API and IndexedDB"})]})})}const Ts=[{name:"English",code:"en"},{name:"Indonesian",code:"id"},{name:"Japanese",code:"ja"},{name:"Chinese",code:"zh"},{name:"Korean",code:"ko"},{name:"Spanish",code:"es"},{name:"French",code:"fr"},{name:"German",code:"de"},{name:"Italian",code:"it"}],pm="clearvoicelingo-db",gm=2;async function mr(){return im(pm,gm,{upgrade(n){n.objectStoreNames.contains("languagePairs")||n.createObjectStore("languagePairs",{keyPath:"id"}).createIndex("timestamp","timestamp"),n.objectStoreNames.contains("ttsPairs")||n.createObjectStore("ttsPairs",{keyPath:"id"}).createIndex("timestamp","timestamp"),n.objectStoreNames.contains("settings")||n.createObjectStore("settings",{keyPath:"id"})}})}async function _m(n){const t=(await mr()).transaction("languagePairs","readwrite"),r=t.objectStore("languagePairs");for(const a of n)await r.put(a);return await t.done,!0}async function ym(){return(await mr()).getAll("languagePairs")}async function bm(n){return await(await mr()).delete("languagePairs",n),!0}async function In(n,e){const r=(await mr()).transaction("settings","readwrite");return await r.objectStore("settings").put({id:n,value:e}),await r.done,!0}async function gt(n){const t=await(await mr()).get("settings",n);return t?t.value:null}async function wm(n){const t=(await mr()).transaction("ttsPairs","readwrite");return await t.objectStore("ttsPairs").put(n),await t.done,!0}async function vm(){return(await mr()).getAll("ttsPairs")}async function xm(n){return await(await mr()).delete("ttsPairs",n),!0}function mc(n){return new Promise(e=>{const t=()=>window.speechSynthesis.getVoices(),r=t();if(r.length>0){e(r);return}window.speechSynthesis.onvoiceschanged=()=>{e(t())}})}function Em(){if("speechSynthesis"in window){const n=new SpeechSynthesisUtterance("");window.speechSynthesis.speak(n),window.speechSynthesis.cancel(),window.speechSynthesis.getVoices()}}let nr=null,Lr=!1;function bs(n,e,t=1,r=1,a=1){return new Promise((s,i)=>{if(!n){i(new Error("No text provided"));return}Lr=!1,nr&&(window.speechSynthesis.cancel(),nr=null);const o=new SpeechSynthesisUtterance(n);nr=o,e&&(o.voice=e),o.rate=t,o.pitch=r,o.volume=a;let u=0;const c=3,l=()=>{if(Lr){nr=null,s();return}o.onend=()=>{Lr||(console.log("Speech completed:",n),nr=null,s())},o.onerror=d=>{console.error("Speech error:",d),!Lr&&d.error==="interrupted"&&u<c?(u++,console.log(`Retrying speech attempt ${u}...`),setTimeout(l,300)):Lr||(nr=null,i(d))};try{window.speechSynthesis.speak(o)}catch(d){console.error("Speech synthesis error:",d),Lr||(nr=null,i(d))}};setTimeout(l,100)})}const ws=()=>{window.speechSynthesis.speaking&&window.speechSynthesis.cancel(),nr=null},To="RFC3986",Io={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:n=>String(n)},Sm="RFC1738",Am=Array.isArray,Ot=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),$i=1024,km=(n,e,t,r,a)=>{if(n.length===0)return n;let s=n;if(typeof n=="symbol"?s=Symbol.prototype.toString.call(n):typeof n!="string"&&(s=String(n)),t==="iso-8859-1")return escape(s).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<s.length;o+=$i){const u=s.length>=$i?s.slice(o,o+$i):s,c=[];for(let l=0;l<u.length;++l){let d=u.charCodeAt(l);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||a===Sm&&(d===40||d===41)){c[c.length]=u.charAt(l);continue}if(d<128){c[c.length]=Ot[d];continue}if(d<2048){c[c.length]=Ot[192|d>>6]+Ot[128|d&63];continue}if(d<55296||d>=57344){c[c.length]=Ot[224|d>>12]+Ot[128|d>>6&63]+Ot[128|d&63];continue}l+=1,d=65536+((d&1023)<<10|u.charCodeAt(l)&1023),c[c.length]=Ot[240|d>>18]+Ot[128|d>>12&63]+Ot[128|d>>6&63]+Ot[128|d&63]}i+=c.join("")}return i};function Pm(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function pc(n,e){if(Am(n)){const t=[];for(let r=0;r<n.length;r+=1)t.push(e(n[r]));return t}return e(n)}const Om=Object.prototype.hasOwnProperty,cd={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},It=Array.isArray,Tm=Array.prototype.push,ld=function(n,e){Tm.apply(n,It(e)?e:[e])},Im=Date.prototype.toISOString,ve={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:km,encodeValuesOnly:!1,format:To,formatter:Io[To],indices:!1,serializeDate(n){return Im.call(n)},skipNulls:!1,strictNullHandling:!1};function Rm(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const Ni={};function dd(n,e,t,r,a,s,i,o,u,c,l,d,h,m,f,p,g,b){let w=n,_=b,v=0,S=!1;for(;(_=_.get(Ni))!==void 0&&!S;){const oe=_.get(n);if(v+=1,typeof oe<"u"){if(oe===v)throw new RangeError("Cyclic object value");S=!0}typeof _.get(Ni)>"u"&&(v=0)}if(typeof c=="function"?w=c(e,w):w instanceof Date?w=h==null?void 0:h(w):t==="comma"&&It(w)&&(w=pc(w,function(oe){return oe instanceof Date?h==null?void 0:h(oe):oe})),w===null){if(s)return u&&!p?u(e,ve.encoder,g,"key",m):e;w=""}if(Rm(w)||Pm(w)){if(u){const oe=p?e:u(e,ve.encoder,g,"key",m);return[(f==null?void 0:f(oe))+"="+(f==null?void 0:f(u(w,ve.encoder,g,"value",m)))]}return[(f==null?void 0:f(e))+"="+(f==null?void 0:f(String(w)))]}const P=[];if(typeof w>"u")return P;let O;if(t==="comma"&&It(w))p&&u&&(w=pc(w,u)),O=[{value:w.length>0?w.join(",")||null:void 0}];else if(It(c))O=c;else{const oe=Object.keys(w);O=l?oe.sort(l):oe}const H=o?String(e).replace(/\./g,"%2E"):String(e),re=r&&It(w)&&w.length===1?H+"[]":H;if(a&&It(w)&&w.length===0)return re+"[]";for(let oe=0;oe<O.length;++oe){const V=O[oe],Fe=typeof V=="object"&&typeof V.value<"u"?V.value:w[V];if(i&&Fe===null)continue;const Pt=d&&o?V.replace(/\./g,"%2E"):V,I=It(w)?typeof t=="function"?t(re,Pt):re:re+(d?"."+Pt:"["+Pt+"]");b.set(n,v);const k=new WeakMap;k.set(Ni,b),ld(P,dd(Fe,I,t,r,a,s,i,o,t==="comma"&&p&&It(w)?null:u,c,l,d,h,m,f,p,g,k))}return P}function Cm(n=ve){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||ve.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=To;if(typeof n.format<"u"){if(!Om.call(Io,n.format))throw new TypeError("Unknown format option provided.");t=n.format}const r=Io[t];let a=ve.filter;(typeof n.filter=="function"||It(n.filter))&&(a=n.filter);let s;if(n.arrayFormat&&n.arrayFormat in cd?s=n.arrayFormat:"indices"in n?s=n.indices?"indices":"repeat":s=ve.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:ve.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:ve.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:ve.allowEmptyArrays,arrayFormat:s,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:ve.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?ve.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:ve.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:ve.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:ve.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:ve.encodeValuesOnly,filter:a,format:t,formatter:r,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:ve.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:ve.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:ve.strictNullHandling}}function $m(n,e={}){let t=n;const r=Cm(e);let a,s;typeof r.filter=="function"?(s=r.filter,t=s("",t)):It(r.filter)&&(s=r.filter,a=s);const i=[];if(typeof t!="object"||t===null)return"";const o=cd[r.arrayFormat],u=o==="comma"&&r.commaRoundTrip;a||(a=Object.keys(t)),r.sort&&a.sort(r.sort);const c=new WeakMap;for(let h=0;h<a.length;++h){const m=a[h];r.skipNulls&&t[m]===null||ld(i,dd(t[m],m,o,u,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}const l=i.join(r.delimiter);let d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}const Vr="4.89.0";let gc=!1,Yn,hd,fd,Ro,md,pd,gd,_d,yd;function Nm(n,e={auto:!1}){if(gc)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(Yn)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${Yn}'\``);gc=e.auto,Yn=n.kind,hd=n.fetch,fd=n.FormData,Ro=n.File,md=n.ReadableStream,pd=n.getMultipartRequestOptions,gd=n.getDefaultAgent,_d=n.fileFromPath,yd=n.isFsReadStream}let jm=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Lm({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new jm(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}Yn||Nm(Lm(),{auto:!0});class M extends Error{}let We=class Co extends M{constructor(e,t,r,a){super(`${Co.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a==null?void 0:a["x-request-id"],this.error=t;const s=t;this.code=s==null?void 0:s.code,this.param=s==null?void 0:s.param,this.type=s==null?void 0:s.type}static makeMessage(e,t,r){const a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e||!a)return new ri({message:r,cause:No(t)});const s=t==null?void 0:t.error;return e===400?new bd(e,s,r,a):e===401?new wd(e,s,r,a):e===403?new vd(e,s,r,a):e===404?new xd(e,s,r,a):e===409?new Ed(e,s,r,a):e===422?new Sd(e,s,r,a):e===429?new Ad(e,s,r,a):e>=500?new kd(e,s,r,a):new Co(e,s,r,a)}},tt=class extends We{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},ri=class extends We{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},ni=class extends ri{constructor({message:e}={}){super({message:e??"Request timed out."})}},bd=class extends We{},wd=class extends We{},vd=class extends We{},xd=class extends We{},Ed=class extends We{},Sd=class extends We{},Ad=class extends We{},kd=class extends We{};class Pd extends M{constructor(){super("Could not parse response content as the length limit was reached")}}class Od extends M{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var Da=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},yr=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ke;let ai=class{constructor(){Ke.set(this,void 0),this.buffer=new Uint8Array,Da(this,Ke,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let r=new Uint8Array(this.buffer.length+t.length);r.set(this.buffer),r.set(t,this.buffer.length),this.buffer=r;const a=[];let s;for(;(s=Mm(this.buffer,yr(this,Ke,"f")))!=null;){if(s.carriage&&yr(this,Ke,"f")==null){Da(this,Ke,s.index,"f");continue}if(yr(this,Ke,"f")!=null&&(s.index!==yr(this,Ke,"f")+1||s.carriage)){a.push(this.decodeText(this.buffer.slice(0,yr(this,Ke,"f")-1))),this.buffer=this.buffer.slice(yr(this,Ke,"f")),Da(this,Ke,null,"f");continue}const i=yr(this,Ke,"f")!==null?s.preceding-1:s.preceding,o=this.decodeText(this.buffer.slice(0,i));a.push(o),this.buffer=this.buffer.slice(s.index),Da(this,Ke,null,"f")}return a}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new M(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new M(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new M("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};Ke=new WeakMap;ai.NEWLINE_CHARS=new Set([`
`,"\r"]);ai.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Mm(n,e){for(let a=e??0;a<n.length;a++){if(n[a]===10)return{preceding:a,index:a+1,carriage:!1};if(n[a]===13)return{preceding:a,index:a+1,carriage:!0}}return null}function Fm(n){for(let r=0;r<n.length-1;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}function Td(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}let ia=class zn{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(const i of Dm(e,t))if(!s){if(i.data.startsWith("[DONE]")){s=!0;continue}if(i.event===null||i.event.startsWith("response.")){let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(o&&o.error)throw new We(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(i.event=="error")throw new We(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}s=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{s||t.abort()}}return new zn(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){const i=new ai,o=Td(e);for await(const u of o)for(const c of i.decode(u))yield c;for(const u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new zn(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){const i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new zn(()=>a(e),this.controller),new zn(()=>a(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new md({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{const{value:s,done:i}=await t.next();if(i)return a.close();const o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}};async function*Dm(n,e){if(!n.body)throw e.abort(),new M("Attempted to iterate over a response with no body");const t=new Bm,r=new ai,a=Td(n.body);for await(const s of Um(a))for(const i of r.decode(s)){const o=t.decode(i);o&&(yield o)}for(const s of r.flush()){const i=t.decode(s);i&&(yield i)}}async function*Um(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let a=new Uint8Array(e.length+r.length);a.set(e),a.set(r,e.length),e=a;let s;for(;(s=Fm(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}let Bm=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=zm(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}};function zm(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}const Id=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",Rd=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&si(n),si=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Zm=n=>Rd(n)||Id(n)||yd(n);async function Cd(n,e,t){var a;if(n=await n,Rd(n))return n;if(Id(n)){const s=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=si(s)?[await s.arrayBuffer()]:[s];return new Ro(i,e,t)}const r=await Hm(n);if(e||(e=Vm(n)??"unknown_file"),!(t!=null&&t.type)){const s=(a=r[0])==null?void 0:a.type;typeof s=="string"&&(t={...t,type:s})}return new Ro(r,e,t)}async function Hm(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(si(n))e.push(await n.arrayBuffer());else if(Wm(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${qm(n)}`);return e}function qm(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function Vm(n){var e;return ji(n.name)||ji(n.filename)||((e=ji(n.path))==null?void 0:e.split(/[\\/]/).pop())}const ji=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},Wm=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",_c=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",ln=async n=>{const e=await Jm(n.body);return pd(e,n)},Jm=async n=>{const e=new fd;return await Promise.all(Object.entries(n||{}).map(([t,r])=>$o(e,t,r))),e},$o=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(Zm(t)){const r=await Cd(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>$o(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>$o(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var rn={},Gm=function(n,e,t,r,a){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t},Km=function(n,e,t,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ua;async function $d(n){var i;const{response:e}=n;if(n.options.stream)return nn("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):ia.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type"),r=(i=t==null?void 0:t.split(";")[0])==null?void 0:i.trim();if((r==null?void 0:r.includes("application/json"))||(r==null?void 0:r.endsWith("+json"))){const o=await e.json();return nn("response",e.status,e.url,e.headers,o),Nd(o,e)}const s=await e.text();return nn("response",e.status,e.url,e.headers,s),s}function Nd(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}let jd=class Ld extends Promise{constructor(e,t=$d){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Ld(this.responsePromise,async t=>Nd(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Xm=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=Li("maxRetries",t),this.timeout=Li("timeout",r),this.httpAgent=a,this.fetch=s??hd}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...np(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${op()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async a=>{const s=a&&si(a==null?void 0:a.body)?new DataView(await a.body.arrayBuffer()):(a==null?void 0:a.body)instanceof DataView?a.body:(a==null?void 0:a.body)instanceof ArrayBuffer?new DataView(a.body):a&&ArrayBuffer.isView(a==null?void 0:a.body)?new DataView(a.body.buffer):a==null?void 0:a.body;return{method:e,path:t,...a,body:s}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var f;e={...e};const{method:r,path:a,query:s,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:_c(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),c=this.buildURL(a,s);"timeout"in e&&Li("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const l=e.httpAgent??this.httpAgent??gd(c),d=e.timeout+1e3;typeof((f=l==null?void 0:l.options)==null?void 0:f.timeout)=="number"&&d>(l.options.timeout??0)&&(l.options.timeout=d),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:e,headers:i,contentLength:u,retryCount:t});return{req:{method:r,...o&&{body:o},headers:h,...l&&{agent:l},signal:e.signal??null},url:c,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:a}){const s={};r&&(s["content-length"]=r);const i=this.defaultHeaders(e);return vc(s,i),vc(s,t),_c(e.body)&&Yn!=="node"&&delete s["content-type"],Ba(i,"x-stainless-retry-count")===void 0&&Ba(t,"x-stainless-retry-count")===void 0&&(s["x-stainless-retry-count"]=String(a)),Ba(i,"x-stainless-timeout")===void 0&&Ba(t,"x-stainless-timeout")===void 0&&e.timeout&&(s["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return We.generate(e,t,r,a)}request(e,t=null){return new jd(this.makeRequest(e,t))}async makeRequest(e,t){var d,h;const r=await e,a=r.maxRetries??this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);const{req:s,url:i,timeout:o}=this.buildRequest(r,{retryCount:a-t});if(await this.prepareRequest(s,{url:i,options:r}),nn("request",i,r,s.headers),(d=r.signal)!=null&&d.aborted)throw new tt;const u=new AbortController,c=await this.fetchWithTimeout(i,s,o,u).catch(No);if(c instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new tt;if(t)return this.retryRequest(r,t);throw c.name==="AbortError"?new ni:new ri({cause:c})}const l=Qm(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const w=`retrying, ${t} attempts remaining`;return nn(`response (error; ${w})`,c.status,i,l),this.retryRequest(r,t,l)}const m=await c.text().catch(w=>No(w).message),f=ap(m),p=f?void 0:m;throw nn(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,p),this.makeStatusError(c.status,f,p,l)}return{response:c,options:r,controller:u}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new Ym(this,r,e)}buildURL(e,t){const r=ip(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Fd(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new M(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){const{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());const o=setTimeout(()=>a.abort(),r),u={signal:a.signal,...i};return u.method&&(u.method=u.method.toUpperCase()),this.fetch.call(void 0,e,u).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let a;const s=r==null?void 0:r["retry-after-ms"];if(s){const o=parseFloat(s);Number.isNaN(o)||(a=o)}const i=r==null?void 0:r["retry-after"];if(i&&!a){const o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){const o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Pa(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Vr}`}},Md=class{constructor(e,t,r,a){Ua.set(this,void 0),Gm(this,Ua,e),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new M("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await Km(this,Ua,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ua=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}},Ym=class extends jd{constructor(e,t,r){super(t,async a=>new r(e,a.response,await $d(a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}};const Qm=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),ep={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Te=n=>typeof n=="object"&&n!==null&&!Fd(n)&&Object.keys(n).every(e=>Dd(ep,e)),tp=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":bc(Deno.build.os),"X-Stainless-Arch":yc(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":bc(process.platform),"X-Stainless-Arch":yc(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=rp();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Vr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function rp(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}const yc=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",bc=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let wc;const np=()=>wc??(wc=tp()),ap=n=>{try{return JSON.parse(n)}catch{return}},sp=/^[a-z][a-z0-9+.-]*:/i,ip=n=>sp.test(n),Pa=n=>new Promise(e=>setTimeout(e,n)),Li=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new M(`${n} must be an integer`);if(e<0)throw new M(`${n} must be a positive integer`);return e},No=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(n)},Er=n=>{var e,t,r,a;if(typeof process<"u")return((e=rn==null?void 0:rn[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(a=(r=(t=Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:a.trim()};function Fd(n){if(!n)return!0;for(const e in n)return!1;return!0}function Dd(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function vc(n,e){for(const t in e){if(!Dd(e,t))continue;const r=t.toLowerCase();if(!r)continue;const a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}const xc=new Set(["authorization","api-key"]);function nn(n,...e){if(typeof process<"u"&&(rn==null?void 0:rn.DEBUG)==="true"){const t=e.map(r=>{if(!r)return r;if(r.headers){const s={...r,headers:{...r.headers}};for(const i in r.headers)xc.has(i.toLowerCase())&&(s.headers[i]="REDACTED");return s}let a=null;for(const s in r)xc.has(s.toLowerCase())&&(a??(a={...r}),a[s]="REDACTED");return a??r});console.log(`OpenAI:DEBUG:${n}`,...t)}}const op=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),up=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",cp=n=>typeof(n==null?void 0:n.get)=="function",Ba=(n,e)=>{var r;const t=e.toLowerCase();if(cp(n)){const a=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(s,i,o)=>i+o.toUpperCase());for(const s of[e,t,e.toUpperCase(),a]){const i=n.get(s);if(i)return i}}for(const[a,s]of Object.entries(n))if(a.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s};function vs(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}let lu=class extends Md{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}};class Je extends Md{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}}let ae=class{constructor(e){this._client=e}},Ud=class extends ae{list(e,t={},r){return Te(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,lp,{query:t,...r})}},ii=class extends ae{constructor(){super(...arguments),this.messages=new Ud(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return Te(e)?this.list({},e):this._client.getAPIList("/chat/completions",oi,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}};class oi extends Je{}class lp extends Je{}ii.ChatCompletionsPage=oi;ii.Messages=Ud;let ui=class extends ae{constructor(){super(...arguments),this.completions=new ii(this._client)}};ui.Completions=ii;ui.ChatCompletionsPage=oi;class Bd extends ae{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class zd extends ae{create(e,t){return this._client.post("/audio/transcriptions",ln({body:e,...t,__metadata:{model:e.model}}))}}class Zd extends ae{create(e,t){return this._client.post("/audio/translations",ln({body:e,...t,__metadata:{model:e.model}}))}}class Oa extends ae{constructor(){super(...arguments),this.transcriptions=new zd(this._client),this.translations=new Zd(this._client),this.speech=new Bd(this._client)}}Oa.Transcriptions=zd;Oa.Translations=Zd;Oa.Speech=Bd;let du=class extends ae{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Te(e)?this.list({},e):this._client.getAPIList("/batches",hu,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}};class hu extends Je{}du.BatchesPage=hu;class fu extends ae{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return Te(e)?this.list({},e):this._client.getAPIList("/assistants",mu,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class mu extends Je{}fu.AssistantsPage=mu;function Ec(n){return typeof n.parse=="function"}const an=n=>(n==null?void 0:n.role)==="assistant",Hd=n=>(n==null?void 0:n.role)==="function",qd=n=>(n==null?void 0:n.role)==="tool";var mt=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},pe=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},jo,xs,Es,Zn,Hn,Ss,qn,zt,Vn,Is,Rs,Wr,Vd;class pu{constructor(){jo.add(this),this.controller=new AbortController,xs.set(this,void 0),Es.set(this,()=>{}),Zn.set(this,()=>{}),Hn.set(this,void 0),Ss.set(this,()=>{}),qn.set(this,()=>{}),zt.set(this,{}),Vn.set(this,!1),Is.set(this,!1),Rs.set(this,!1),Wr.set(this,!1),mt(this,xs,new Promise((e,t)=>{mt(this,Es,e,"f"),mt(this,Zn,t,"f")}),"f"),mt(this,Hn,new Promise((e,t)=>{mt(this,Ss,e,"f"),mt(this,qn,t,"f")}),"f"),pe(this,xs,"f").catch(()=>{}),pe(this,Hn,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},pe(this,jo,"m",Vd).bind(this))},0)}_connected(){this.ended||(pe(this,Es,"f").call(this),this._emit("connect"))}get ended(){return pe(this,Vn,"f")}get errored(){return pe(this,Is,"f")}get aborted(){return pe(this,Rs,"f")}abort(){this.controller.abort()}on(e,t){return(pe(this,zt,"f")[e]||(pe(this,zt,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=pe(this,zt,"f")[e];if(!r)return this;const a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(pe(this,zt,"f")[e]||(pe(this,zt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{mt(this,Wr,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){mt(this,Wr,!0,"f"),await pe(this,Hn,"f")}_emit(e,...t){if(pe(this,Vn,"f"))return;e==="end"&&(mt(this,Vn,!0,"f"),pe(this,Ss,"f").call(this));const r=pe(this,zt,"f")[e];if(r&&(pe(this,zt,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){const a=t[0];!pe(this,Wr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),pe(this,Zn,"f").call(this,a),pe(this,qn,"f").call(this,a),this._emit("end");return}if(e==="error"){const a=t[0];!pe(this,Wr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),pe(this,Zn,"f").call(this,a),pe(this,qn,"f").call(this,a),this._emit("end")}}_emitFinal(){}}xs=new WeakMap,Es=new WeakMap,Zn=new WeakMap,Hn=new WeakMap,Ss=new WeakMap,qn=new WeakMap,zt=new WeakMap,Vn=new WeakMap,Is=new WeakMap,Rs=new WeakMap,Wr=new WeakMap,jo=new WeakSet,Vd=function(e){if(mt(this,Is,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new tt),e instanceof tt)return mt(this,Rs,!0,"f"),this._emit("abort",e);if(e instanceof M)return this._emit("error",e);if(e instanceof Error){const t=new M(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new M(String(e)))};function dp(n,e){const t={...n};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function gu(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function hp(n,{parser:e,callback:t}){const r={...n};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),r}function Ta(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function fp(n,e){return!e||!Wd(e)?{...n,choices:n.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:_u(n,e)}function _u(n,e){const t=n.choices.map(r=>{var a;if(r.finish_reason==="length")throw new Pd;if(r.finish_reason==="content_filter")throw new Od;return{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:((a=r.message.tool_calls)==null?void 0:a.map(s=>pp(e,s)))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?mp(e,r.message.content):null}}});return{...n,choices:t}}function mp(n,e){var t,r;return((t=n.response_format)==null?void 0:t.type)!=="json_schema"?null:((r=n.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function pp(n,e){var r;const t=(r=n.tools)==null?void 0:r.find(a=>{var s;return((s=a.function)==null?void 0:s.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:Ta(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function gp(n,e){var r;if(!n)return!1;const t=(r=n.tools)==null?void 0:r.find(a=>{var s;return((s=a.function)==null?void 0:s.name)===e.function.name});return Ta(t)||(t==null?void 0:t.function.strict)||!1}function Wd(n){var e;return gu(n.response_format)?!0:((e=n.tools)==null?void 0:e.some(t=>Ta(t)||t.type==="function"&&t.function.strict===!0))??!1}function _p(n){for(const e of n??[]){if(e.type!=="function")throw new M(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new M(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var qe=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ne,Lo,Cs,Mo,Fo,Do,Jd,Uo;const Sc=10;class Gd extends pu{constructor(){super(...arguments),Ne.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Hd(e)||qd(e))&&e.content)this._emit("functionCallResult",e.content);else if(an(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(an(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new M("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),qe(this,Ne,"m",Lo).call(this)}async finalMessage(){return await this.done(),qe(this,Ne,"m",Cs).call(this)}async finalFunctionCall(){return await this.done(),qe(this,Ne,"m",Mo).call(this)}async finalFunctionCallResult(){return await this.done(),qe(this,Ne,"m",Fo).call(this)}async totalUsage(){return await this.done(),qe(this,Ne,"m",Do).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=qe(this,Ne,"m",Cs).call(this);t&&this._emit("finalMessage",t);const r=qe(this,Ne,"m",Lo).call(this);r&&this._emit("finalContent",r);const a=qe(this,Ne,"m",Mo).call(this);a&&this._emit("finalFunctionCall",a);const s=qe(this,Ne,"m",Fo).call(this);s!=null&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",qe(this,Ne,"m",Do).call(this))}async _createChatCompletion(e,t,r){const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),qe(this,Ne,"m",Jd).call(this,t);const s=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(_u(s,t))}async _runChatCompletion(e,t,r){for(const a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var h;const a="function",{function_call:s="auto",stream:i,...o}=t,u=typeof s!="string"&&(s==null?void 0:s.name),{maxChatCompletions:c=Sc}=r||{},l={};for(const m of t.functions)l[m.name||m.function.name]=m;const d=t.functions.map(m=>({name:m.name||m.function.name,parameters:m.parameters,description:m.description}));for(const m of t.messages)this._addMessage(m,!1);for(let m=0;m<c;++m){const p=(h=(await this._createChatCompletion(e,{...o,function_call:s,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:h.message;if(!p)throw new M("missing message in ChatCompletion response");if(!p.function_call)return;const{name:g,arguments:b}=p.function_call,w=l[g];if(w){if(u&&u!==g){const P=`Invalid function_call: ${JSON.stringify(g)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,name:g,content:P});continue}}else{const P=`Invalid function_call: ${JSON.stringify(g)}. Available options are: ${d.map(O=>JSON.stringify(O.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:g,content:P});continue}let _;try{_=Ec(w)?await w.parse(b):b}catch(P){this._addMessage({role:a,name:g,content:P instanceof Error?P.message:String(P)});continue}const v=await w.function(_,this),S=qe(this,Ne,"m",Uo).call(this,v);if(this._addMessage({role:a,name:g,content:S}),u)return}}async _runTools(e,t,r){var m,f,p;const a="tool",{tool_choice:s="auto",stream:i,...o}=t,u=typeof s!="string"&&((m=s==null?void 0:s.function)==null?void 0:m.name),{maxChatCompletions:c=Sc}=r||{},l=t.tools.map(g=>{if(Ta(g)){if(!g.$callback)throw new M("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:g.$callback,name:g.function.name,description:g.function.description||"",parameters:g.function.parameters,parse:g.$parseRaw,strict:!0}}}return g}),d={};for(const g of l)g.type==="function"&&(d[g.function.name||g.function.function.name]=g.function);const h="tools"in t?l.map(g=>g.type==="function"?{type:"function",function:{name:g.function.name||g.function.function.name,parameters:g.function.parameters,description:g.function.description,strict:g.function.strict}}:g):void 0;for(const g of t.messages)this._addMessage(g,!1);for(let g=0;g<c;++g){const w=(f=(await this._createChatCompletion(e,{...o,tool_choice:s,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:f.message;if(!w)throw new M("missing message in ChatCompletion response");if(!((p=w.tool_calls)!=null&&p.length))return;for(const _ of w.tool_calls){if(_.type!=="function")continue;const v=_.id,{name:S,arguments:P}=_.function,O=d[S];if(O){if(u&&u!==S){const V=`Invalid tool_call: ${JSON.stringify(S)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,tool_call_id:v,content:V});continue}}else{const V=`Invalid tool_call: ${JSON.stringify(S)}. Available options are: ${Object.keys(d).map(Fe=>JSON.stringify(Fe)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:v,content:V});continue}let H;try{H=Ec(O)?await O.parse(P):P}catch(V){const Fe=V instanceof Error?V.message:String(V);this._addMessage({role:a,tool_call_id:v,content:Fe});continue}const re=await O.function(H,this),oe=qe(this,Ne,"m",Uo).call(this,re);if(this._addMessage({role:a,tool_call_id:v,content:oe}),u)return}}}}Ne=new WeakSet,Lo=function(){return qe(this,Ne,"m",Cs).call(this).content??null},Cs=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(an(t)){const{function_call:r,...a}=t,s={...a,content:t.content??null,refusal:t.refusal??null};return r&&(s.function_call=r),s}}throw new M("stream ended without producing a ChatCompletionMessage with role=assistant")},Mo=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){const a=this.messages[r];if(an(a)&&(a!=null&&a.function_call))return a.function_call;if(an(a)&&((e=a==null?void 0:a.tool_calls)!=null&&e.length))return(t=a.tool_calls.at(-1))==null?void 0:t.function}},Fo=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Hd(t)&&t.content!=null||qd(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(r=>{var a;return r.role==="assistant"&&((a=r.tool_calls)==null?void 0:a.some(s=>s.type==="function"&&s.id===t.tool_call_id))}))return t.content}},Do=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Jd=function(e){if(e.n!=null&&e.n>1)throw new M("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Uo=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class oa extends Gd{static runFunctions(e,t,r){const a=new oa,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){const a=new oa,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}_addMessage(e,t=!0){super._addMessage(e,t),an(e)&&e.content&&this._emit("content",e.content)}}const Kd=1,Xd=2,Yd=4,Qd=8,eh=16,th=32,rh=64,nh=128,ah=256,sh=nh|ah,ih=eh|th|sh|rh,oh=Kd|Xd|ih,uh=Yd|Qd,yp=oh|uh,Ae={STR:Kd,NUM:Xd,ARR:Yd,OBJ:Qd,NULL:eh,BOOL:th,NAN:rh,INFINITY:nh,MINUS_INFINITY:ah,INF:sh,SPECIAL:ih,ATOM:oh,COLLECTION:uh,ALL:yp};class bp extends Error{}class wp extends Error{}function vp(n,e=Ae.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return xp(n.trim(),e)}const xp=(n,e)=>{const t=n.length;let r=0;const a=h=>{throw new bp(`${h} at position ${r}`)},s=h=>{throw new wp(`${h} at position ${r}`)},i=()=>(d(),r>=t&&a("Unexpected end of input"),n[r]==='"'?o():n[r]==="{"?u():n[r]==="["?c():n.substring(r,r+4)==="null"||Ae.NULL&e&&t-r<4&&"null".startsWith(n.substring(r))?(r+=4,null):n.substring(r,r+4)==="true"||Ae.BOOL&e&&t-r<4&&"true".startsWith(n.substring(r))?(r+=4,!0):n.substring(r,r+5)==="false"||Ae.BOOL&e&&t-r<5&&"false".startsWith(n.substring(r))?(r+=5,!1):n.substring(r,r+8)==="Infinity"||Ae.INFINITY&e&&t-r<8&&"Infinity".startsWith(n.substring(r))?(r+=8,1/0):n.substring(r,r+9)==="-Infinity"||Ae.MINUS_INFINITY&e&&1<t-r&&t-r<9&&"-Infinity".startsWith(n.substring(r))?(r+=9,-1/0):n.substring(r,r+3)==="NaN"||Ae.NAN&e&&t-r<3&&"NaN".startsWith(n.substring(r))?(r+=3,NaN):l()),o=()=>{const h=r;let m=!1;for(r++;r<t&&(n[r]!=='"'||m&&n[r-1]==="\\");)m=n[r]==="\\"?!m:!1,r++;if(n.charAt(r)=='"')try{return JSON.parse(n.substring(h,++r-Number(m)))}catch(f){s(String(f))}else if(Ae.STR&e)try{return JSON.parse(n.substring(h,r-Number(m))+'"')}catch{return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},u=()=>{r++,d();const h={};try{for(;n[r]!=="}";){if(d(),r>=t&&Ae.OBJ&e)return h;const m=o();d(),r++;try{const f=i();Object.defineProperty(h,m,{value:f,writable:!0,enumerable:!0,configurable:!0})}catch(f){if(Ae.OBJ&e)return h;throw f}d(),n[r]===","&&r++}}catch{if(Ae.OBJ&e)return h;a("Expected '}' at end of object")}return r++,h},c=()=>{r++;const h=[];try{for(;n[r]!=="]";)h.push(i()),d(),n[r]===","&&r++}catch{if(Ae.ARR&e)return h;a("Expected ']' at end of array")}return r++,h},l=()=>{if(r===0){n==="-"&&Ae.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n)}catch(m){if(Ae.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}s(String(m))}}const h=r;for(n[r]==="-"&&r++;n[r]&&!",]}".includes(n[r]);)r++;r==t&&!(Ae.NUM&e)&&a("Unterminated number literal");try{return JSON.parse(n.substring(h,r))}catch{n.substring(h,r)==="-"&&Ae.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(f){s(String(f))}}},d=()=>{for(;r<t&&` 
\r	`.includes(n[r]);)r++};return i()},Ac=n=>vp(n,Ae.ALL^Ae.NUM);var Mr=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},fe=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},we,Ft,Fr,Kt,Mi,za,Fi,Di,Ui,Za,Bi,kc;class ua extends Gd{constructor(e){super(),we.add(this),Ft.set(this,void 0),Fr.set(this,void 0),Kt.set(this,void 0),Mr(this,Ft,e,"f"),Mr(this,Fr,[],"f")}get currentChatCompletionSnapshot(){return fe(this,Kt,"f")}static fromReadableStream(e){const t=new ua(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const a=new ua(t);return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){var i;super._createChatCompletion;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),fe(this,we,"m",Mi).call(this);const s=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of s)fe(this,we,"m",Fi).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new tt;return this._addChatCompletion(fe(this,we,"m",Za).call(this))}async _fromReadableStream(e,t){var i;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),fe(this,we,"m",Mi).call(this),this._connected();const a=ia.fromReadableStream(e,this.controller);let s;for await(const o of a)s&&s!==o.id&&this._addChatCompletion(fe(this,we,"m",Za).call(this)),fe(this,we,"m",Fi).call(this,o),s=o.id;if((i=a.controller.signal)!=null&&i.aborted)throw new tt;return this._addChatCompletion(fe(this,we,"m",Za).call(this))}[(Ft=new WeakMap,Fr=new WeakMap,Kt=new WeakMap,we=new WeakSet,Mi=function(){this.ended||Mr(this,Kt,void 0,"f")},za=function(t){let r=fe(this,Fr,"f")[t.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},fe(this,Fr,"f")[t.index]=r,r)},Fi=function(t){var a,s,i,o,u,c,l,d,h,m,f,p,g,b,w;if(this.ended)return;const r=fe(this,we,"m",kc).call(this,t);this._emit("chunk",t,r);for(const _ of t.choices){const v=r.choices[_.index];_.delta.content!=null&&((a=v.message)==null?void 0:a.role)==="assistant"&&((s=v.message)!=null&&s.content)&&(this._emit("content",_.delta.content,v.message.content),this._emit("content.delta",{delta:_.delta.content,snapshot:v.message.content,parsed:v.message.parsed})),_.delta.refusal!=null&&((i=v.message)==null?void 0:i.role)==="assistant"&&((o=v.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:_.delta.refusal,snapshot:v.message.refusal}),((u=_.logprobs)==null?void 0:u.content)!=null&&((c=v.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=_.logprobs)==null?void 0:l.content,snapshot:((d=v.logprobs)==null?void 0:d.content)??[]}),((h=_.logprobs)==null?void 0:h.refusal)!=null&&((m=v.message)==null?void 0:m.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(f=_.logprobs)==null?void 0:f.refusal,snapshot:((p=v.logprobs)==null?void 0:p.refusal)??[]});const S=fe(this,we,"m",za).call(this,v);v.finish_reason&&(fe(this,we,"m",Ui).call(this,v),S.current_tool_call_index!=null&&fe(this,we,"m",Di).call(this,v,S.current_tool_call_index));for(const P of _.delta.tool_calls??[])S.current_tool_call_index!==P.index&&(fe(this,we,"m",Ui).call(this,v),S.current_tool_call_index!=null&&fe(this,we,"m",Di).call(this,v,S.current_tool_call_index)),S.current_tool_call_index=P.index;for(const P of _.delta.tool_calls??[]){const O=(g=v.message.tool_calls)==null?void 0:g[P.index];O!=null&&O.type&&((O==null?void 0:O.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(b=O.function)==null?void 0:b.name,index:P.index,arguments:O.function.arguments,parsed_arguments:O.function.parsed_arguments,arguments_delta:((w=P.function)==null?void 0:w.arguments)??""}):(O==null||O.type,void 0))}}},Di=function(t,r){var i,o,u;if(fe(this,we,"m",za).call(this,t).done_tool_calls.has(r))return;const s=(i=t.message.tool_calls)==null?void 0:i[r];if(!s)throw new Error("no tool call snapshot");if(!s.type)throw new Error("tool call snapshot missing `type`");if(s.type==="function"){const c=(u=(o=fe(this,Ft,"f"))==null?void 0:o.tools)==null?void 0:u.find(l=>l.type==="function"&&l.function.name===s.function.name);this._emit("tool_calls.function.arguments.done",{name:s.function.name,index:r,arguments:s.function.arguments,parsed_arguments:Ta(c)?c.$parseRaw(s.function.arguments):c!=null&&c.function.strict?JSON.parse(s.function.arguments):null})}else s.type},Ui=function(t){var a,s;const r=fe(this,we,"m",za).call(this,t);if(t.message.content&&!r.content_done){r.content_done=!0;const i=fe(this,we,"m",Bi).call(this);this._emit("content.done",{content:t.message.content,parsed:i?i.$parseRaw(t.message.content):null})}t.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(a=t.logprobs)!=null&&a.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(s=t.logprobs)!=null&&s.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},Za=function(){if(this.ended)throw new M("stream has ended, this shouldn't happen");const t=fe(this,Kt,"f");if(!t)throw new M("request ended without sending any chunks");return Mr(this,Kt,void 0,"f"),Mr(this,Fr,[],"f"),Ep(t,fe(this,Ft,"f"))},Bi=function(){var r;const t=(r=fe(this,Ft,"f"))==null?void 0:r.response_format;return gu(t)?t:null},kc=function(t){var r,a,s,i;let o=fe(this,Kt,"f");const{choices:u,...c}=t;o?Object.assign(o,c):o=Mr(this,Kt,{...c,choices:[]},"f");for(const{delta:l,finish_reason:d,index:h,logprobs:m=null,...f}of t.choices){let p=o.choices[h];if(p||(p=o.choices[h]={finish_reason:d,index:h,message:{},logprobs:m,...f}),m)if(!p.logprobs)p.logprobs=Object.assign({},m);else{const{content:P,refusal:O,...H}=m;Object.assign(p.logprobs,H),P&&((r=p.logprobs).content??(r.content=[]),p.logprobs.content.push(...P)),O&&((a=p.logprobs).refusal??(a.refusal=[]),p.logprobs.refusal.push(...O))}if(d&&(p.finish_reason=d,fe(this,Ft,"f")&&Wd(fe(this,Ft,"f")))){if(d==="length")throw new Pd;if(d==="content_filter")throw new Od}if(Object.assign(p,f),!l)continue;const{content:g,refusal:b,function_call:w,role:_,tool_calls:v,...S}=l;if(Object.assign(p.message,S),b&&(p.message.refusal=(p.message.refusal||"")+b),_&&(p.message.role=_),w&&(p.message.function_call?(w.name&&(p.message.function_call.name=w.name),w.arguments&&((s=p.message.function_call).arguments??(s.arguments=""),p.message.function_call.arguments+=w.arguments)):p.message.function_call=w),g&&(p.message.content=(p.message.content||"")+g,!p.message.refusal&&fe(this,we,"m",Bi).call(this)&&(p.message.parsed=Ac(p.message.content))),v){p.message.tool_calls||(p.message.tool_calls=[]);for(const{index:P,id:O,type:H,function:re,...oe}of v){const V=(i=p.message.tool_calls)[P]??(i[P]={});Object.assign(V,oe),O&&(V.id=O),H&&(V.type=H),re&&(V.function??(V.function={name:re.name??"",arguments:""})),re!=null&&re.name&&(V.function.name=re.name),re!=null&&re.arguments&&(V.function.arguments+=re.arguments,gp(fe(this,Ft,"f"),V)&&(V.function.parsed_arguments=Ac(V.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ia(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Ep(n,e){const{id:t,choices:r,created:a,model:s,system_fingerprint:i,...o}=n,u={...o,id:t,choices:r.map(({message:c,finish_reason:l,index:d,logprobs:h,...m})=>{if(!l)throw new M(`missing finish_reason for choice ${d}`);const{content:f=null,function_call:p,tool_calls:g,...b}=c,w=c.role;if(!w)throw new M(`missing role for choice ${d}`);if(p){const{arguments:_,name:v}=p;if(_==null)throw new M(`missing function_call.arguments for choice ${d}`);if(!v)throw new M(`missing function_call.name for choice ${d}`);return{...m,message:{content:f,function_call:{arguments:_,name:v},role:w,refusal:c.refusal??null},finish_reason:l,index:d,logprobs:h}}return g?{...m,index:d,finish_reason:l,logprobs:h,message:{...b,role:w,content:f,refusal:c.refusal??null,tool_calls:g.map((_,v)=>{const{function:S,type:P,id:O,...H}=_,{arguments:re,name:oe,...V}=S||{};if(O==null)throw new M(`missing choices[${d}].tool_calls[${v}].id
${Ha(n)}`);if(P==null)throw new M(`missing choices[${d}].tool_calls[${v}].type
${Ha(n)}`);if(oe==null)throw new M(`missing choices[${d}].tool_calls[${v}].function.name
${Ha(n)}`);if(re==null)throw new M(`missing choices[${d}].tool_calls[${v}].function.arguments
${Ha(n)}`);return{...H,id:O,type:P,function:{...V,name:oe,arguments:re}}})}}:{...m,message:{...b,content:f,role:w,refusal:c.refusal??null},finish_reason:l,index:d,logprobs:h}}),created:a,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}};return fp(u,e)}function Ha(n){return JSON.stringify(n)}class sn extends ua{static fromReadableStream(e){const t=new sn(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){const a=new sn(null),s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){const a=new sn(t),s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}}let ch=class extends ae{parse(e,t){return _p(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(r=>_u(r,e))}runFunctions(e,t){return e.stream?sn.runFunctions(this._client,e,t):oa.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?sn.runTools(this._client,e,t):oa.runTools(this._client,e,t)}stream(e,t){return ua.createChatCompletion(this._client,e,t)}};class Bo extends ae{constructor(){super(...arguments),this.completions=new ch(this._client)}}(function(n){n.Completions=ch})(Bo||(Bo={}));class lh extends ae{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class dh extends ae{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class ci extends ae{constructor(){super(...arguments),this.sessions=new lh(this._client),this.transcriptionSessions=new dh(this._client)}}ci.Sessions=lh;ci.TranscriptionSessions=dh;var L=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ge=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Re,zo,Rt,As,pt,Sr,Xr,xr,$s,Qe,ks,Ps,Qn,Wn,Jn,Pc,Oc,Tc,Ic,Rc,Cc,$c;class _t extends pu{constructor(){super(...arguments),Re.add(this),zo.set(this,[]),Rt.set(this,{}),As.set(this,{}),pt.set(this,void 0),Sr.set(this,void 0),Xr.set(this,void 0),xr.set(this,void 0),$s.set(this,void 0),Qe.set(this,void 0),ks.set(this,void 0),Ps.set(this,void 0),Qn.set(this,void 0)}[(zo=new WeakMap,Rt=new WeakMap,As=new WeakMap,pt=new WeakMap,Sr=new WeakMap,Xr=new WeakMap,xr=new WeakMap,$s=new WeakMap,Qe=new WeakMap,ks=new WeakMap,Ps=new WeakMap,Qn=new WeakMap,Re=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new _t;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var s;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const a=ia.fromReadableStream(e,this.controller);for await(const i of a)L(this,Re,"m",Wn).call(this,i);if((s=a.controller.signal)!=null&&s.aborted)throw new tt;return this._addRun(L(this,Re,"m",Jn).call(this))}toReadableStream(){return new ia(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a,s){const i=new _t;return i._run(()=>i._runToolAssistantStream(e,t,r,a,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,a,s){var c;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const o={...a,stream:!0},u=await e.submitToolOutputs(t,r,o,{...s,signal:this.controller.signal});this._connected();for await(const l of u)L(this,Re,"m",Wn).call(this,l);if((c=u.controller.signal)!=null&&c.aborted)throw new tt;return this._addRun(L(this,Re,"m",Jn).call(this))}static createThreadAssistantStream(e,t,r){const a=new _t;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){const s=new _t;return s._run(()=>s._runAssistantStream(e,t,r,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return L(this,ks,"f")}currentRun(){return L(this,Ps,"f")}currentMessageSnapshot(){return L(this,pt,"f")}currentRunStepSnapshot(){return L(this,Qn,"f")}async finalRunSteps(){return await this.done(),Object.values(L(this,Rt,"f"))}async finalMessages(){return await this.done(),Object.values(L(this,As,"f"))}async finalRun(){if(await this.done(),!L(this,Sr,"f"))throw Error("Final run was not received.");return L(this,Sr,"f")}async _createThreadAssistantStream(e,t,r){var o;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const s={...t,stream:!0},i=await e.createAndRun(s,{...r,signal:this.controller.signal});this._connected();for await(const u of i)L(this,Re,"m",Wn).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new tt;return this._addRun(L(this,Re,"m",Jn).call(this))}async _createAssistantStream(e,t,r,a){var u;const s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...r,stream:!0},o=await e.create(t,i,{...a,signal:this.controller.signal});this._connected();for await(const c of o)L(this,Re,"m",Wn).call(this,c);if((u=o.controller.signal)!=null&&u.aborted)throw new tt;return this._addRun(L(this,Re,"m",Jn).call(this))}static accumulateDelta(e,t){for(const[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let s=e[r];if(s==null){e[r]=a;continue}if(r==="index"||r==="type"){e[r]=a;continue}if(typeof s=="string"&&typeof a=="string")s+=a;else if(typeof s=="number"&&typeof a=="number")s+=a;else if(vs(s)&&vs(a))s=this.accumulateDelta(s,a);else if(Array.isArray(s)&&Array.isArray(a)){if(s.every(i=>typeof i=="string"||typeof i=="number")){s.push(...a);continue}for(const i of a){if(!vs(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const u=s[o];u==null?s.push(i):s[o]=this.accumulateDelta(u,i)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${s}`);e[r]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a,s){return await this._createToolAssistantStream(r,e,t,a,s)}}Wn=function(e){if(!this.ended)switch(Ge(this,ks,e,"f"),L(this,Re,"m",Tc).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":L(this,Re,"m",$c).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":L(this,Re,"m",Oc).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":L(this,Re,"m",Pc).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Jn=function(){if(this.ended)throw new M("stream has ended, this shouldn't happen");if(!L(this,Sr,"f"))throw Error("Final run has not been received");return L(this,Sr,"f")},Pc=function(e){const[t,r]=L(this,Re,"m",Rc).call(this,e,L(this,pt,"f"));Ge(this,pt,t,"f"),L(this,As,"f")[t.id]=t;for(const a of r){const s=t.content[a.index];(s==null?void 0:s.type)=="text"&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const a of e.data.delta.content){if(a.type=="text"&&a.text){let s=a.text,i=t.content[a.index];if(i&&i.type=="text")this._emit("textDelta",s,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(a.index!=L(this,Xr,"f")){if(L(this,xr,"f"))switch(L(this,xr,"f").type){case"text":this._emit("textDone",L(this,xr,"f").text,L(this,pt,"f"));break;case"image_file":this._emit("imageFileDone",L(this,xr,"f").image_file,L(this,pt,"f"));break}Ge(this,Xr,a.index,"f")}Ge(this,xr,t.content[a.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(L(this,Xr,"f")!==void 0){const a=e.data.content[L(this,Xr,"f")];if(a)switch(a.type){case"image_file":this._emit("imageFileDone",a.image_file,L(this,pt,"f"));break;case"text":this._emit("textDone",a.text,L(this,pt,"f"));break}}L(this,pt,"f")&&this._emit("messageDone",e.data),Ge(this,pt,void 0,"f")}},Oc=function(e){const t=L(this,Re,"m",Ic).call(this,e);switch(Ge(this,Qn,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const s of r.step_details.tool_calls)s.index==L(this,$s,"f")?this._emit("toolCallDelta",s,t.step_details.tool_calls[s.index]):(L(this,Qe,"f")&&this._emit("toolCallDone",L(this,Qe,"f")),Ge(this,$s,s.index,"f"),Ge(this,Qe,t.step_details.tool_calls[s.index],"f"),L(this,Qe,"f")&&this._emit("toolCallCreated",L(this,Qe,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Ge(this,Qn,void 0,"f"),e.data.step_details.type=="tool_calls"&&L(this,Qe,"f")&&(this._emit("toolCallDone",L(this,Qe,"f")),Ge(this,Qe,void 0,"f")),this._emit("runStepDone",e.data,t);break}},Tc=function(e){L(this,zo,"f").push(e),this._emit("event",e)},Ic=function(e){switch(e.event){case"thread.run.step.created":return L(this,Rt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=L(this,Rt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const a=_t.accumulateDelta(t,r.delta);L(this,Rt,"f")[e.data.id]=a}return L(this,Rt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":L(this,Rt,"f")[e.data.id]=e.data;break}if(L(this,Rt,"f")[e.data.id])return L(this,Rt,"f")[e.data.id];throw new Error("No snapshot available")},Rc=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(const s of a.delta.content)if(s.index in t.content){let i=t.content[s.index];t.content[s.index]=L(this,Re,"m",Cc).call(this,s,i)}else t.content[s.index]=s,r.push(s);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Cc=function(e,t){return _t.accumulateDelta(t,e)},$c=function(e){switch(Ge(this,Ps,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Ge(this,Sr,e.data,"f"),L(this,Qe,"f")&&(this._emit("toolCallDone",L(this,Qe,"f")),Ge(this,Qe,void 0,"f"));break}};let yu=class extends ae{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return Te(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,bu,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}};class bu extends Je{}yu.MessagesPage=bu;class wu extends ae{retrieve(e,t,r,a={},s){return Te(a)?this.retrieve(e,t,r,{},a):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,t,r={},a){return Te(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,vu,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}}class vu extends Je{}wu.RunStepsPage=vu;class Ia extends ae{constructor(){super(...arguments),this.steps=new wu(this._client)}create(e,t,r){const{include:a,...s}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:a},body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return Te(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,xu,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const a=await this.create(e,t,r);return await this.poll(e,a.id,r)}createAndStream(e,t,r){return _t.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){const a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:s,response:i}=await this.retrieve(e,t,{...r,headers:{...r==null?void 0:r.headers,...a}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=i.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await Pa(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,r){return _t.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,a){const s=await this.submitToolOutputs(e,t,r,a);return await this.poll(e,s.id,a)}submitToolOutputsStream(e,t,r,a){return _t.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,a)}}class xu extends Je{}Ia.RunsPage=xu;Ia.Steps=wu;Ia.RunStepsPage=vu;class yn extends ae{constructor(){super(...arguments),this.runs=new Ia(this._client),this.messages=new yu(this._client)}create(e={},t){return Te(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return _t.createThreadAssistantStream(e,this._client.beta.threads,t)}}yn.Runs=Ia;yn.RunsPage=xu;yn.Messages=yu;yn.MessagesPage=bu;let bn=class extends ae{constructor(){super(...arguments),this.realtime=new ci(this._client),this.chat=new Bo(this._client),this.assistants=new fu(this._client),this.threads=new yn(this._client)}};bn.Realtime=ci;bn.Assistants=fu;bn.AssistantsPage=mu;bn.Threads=yn;let hh=class extends ae{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};class fh extends ae{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}let Eu=class extends ae{create(e,t){return this._client.post("/files",ln({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Te(e)?this.list({},e):this._client.getAPIList("/files",Su,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){const a=new Set(["processed","error","deleted"]),s=Date.now();let i=await this.retrieve(e);for(;!i.status||!a.has(i.status);)if(await Pa(t),i=await this.retrieve(e),Date.now()-s>r)throw new ni({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}};class Su extends Je{}Eu.FileObjectsPage=Su;class Au extends ae{list(e,t={},r){return Te(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,ku,{query:t,...r})}}class ku extends Je{}Au.FineTuningJobCheckpointsPage=ku;class wn extends ae{constructor(){super(...arguments),this.checkpoints=new Au(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Te(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Pu,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return Te(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Ou,{query:t,...r})}}class Pu extends Je{}class Ou extends Je{}wn.FineTuningJobsPage=Pu;wn.FineTuningJobEventsPage=Ou;wn.Checkpoints=Au;wn.FineTuningJobCheckpointsPage=ku;class Ra extends ae{constructor(){super(...arguments),this.jobs=new wn(this._client)}}Ra.Jobs=wn;Ra.FineTuningJobsPage=Pu;Ra.FineTuningJobEventsPage=Ou;class mh extends ae{createVariation(e,t){return this._client.post("/images/variations",ln({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",ln({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}let Tu=class extends ae{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Iu,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}};class Iu extends lu{}Tu.ModelsPage=Iu;class ph extends ae{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function Sp(n,e){return!e||!kp(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(r=>({...r,parsed:null}))}:t)}:gh(n,e)}function gh(n,e){const t=n.output.map(a=>{if(a.type==="function_call")return{...a,parsed_arguments:Tp(e,a)};if(a.type==="message"){const s=a.content.map(i=>i.type==="output_text"?{...i,parsed:Ap(e,i.text)}:i);return{...a,content:s}}return a}),r=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||_h(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const a of r.output)if(a.type==="message"){for(const s of a.content)if(s.type==="output_text"&&s.parsed!==null)return s.parsed}return null}}),r}function Ap(n,e){var t,r,a,s;return((r=(t=n.text)==null?void 0:t.format)==null?void 0:r.type)!=="json_schema"?null:"$parseRaw"in((a=n.text)==null?void 0:a.format)?((s=n.text)==null?void 0:s.format).$parseRaw(e):JSON.parse(e)}function kp(n){var e;return!!gu((e=n.text)==null?void 0:e.format)}function Pp(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Op(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function Tp(n,e){const t=Op(n.tools??[],e.name);return{...e,...e,parsed_arguments:Pp(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function _h(n){const e=[];for(const t of n.output)if(t.type==="message")for(const r of t.content)r.type==="output_text"&&e.push(r.text);n.output_text=e.join("")}class yh extends ae{list(e,t={},r){return Te(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Rp,{query:t,...r})}}var Dr=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Xt=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ur,qa,Yt,Va,Nc,jc,Lc,Mc;class Ru extends pu{constructor(e){super(),Ur.add(this),qa.set(this,void 0),Yt.set(this,void 0),Va.set(this,void 0),Dr(this,qa,e,"f")}static createResponse(e,t,r){const a=new Ru(t);return a._run(()=>a._createResponse(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createResponse(e,t,r){var i;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),Xt(this,Ur,"m",Nc).call(this);const s=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of s)Xt(this,Ur,"m",jc).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new tt;return Xt(this,Ur,"m",Lc).call(this)}[(qa=new WeakMap,Yt=new WeakMap,Va=new WeakMap,Ur=new WeakSet,Nc=function(){this.ended||Dr(this,Yt,void 0,"f")},jc=function(t){if(this.ended)return;const r=Xt(this,Ur,"m",Mc).call(this,t);switch(this._emit("event",t),t.type){case"response.output_text.delta":{const a=r.output[t.output_index];if(!a)throw new M(`missing output at index ${t.output_index}`);if(a.type==="message"){const s=a.content[t.content_index];if(!s)throw new M(`missing content at index ${t.content_index}`);if(s.type!=="output_text")throw new M(`expected content to be 'output_text', got ${s.type}`);this._emit("response.output_text.delta",{...t,snapshot:s.text})}break}case"response.function_call_arguments.delta":{const a=r.output[t.output_index];if(!a)throw new M(`missing output at index ${t.output_index}`);a.type==="function_call"&&this._emit("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:this._emit(t.type,t);break}},Lc=function(){if(this.ended)throw new M("stream has ended, this shouldn't happen");const t=Xt(this,Yt,"f");if(!t)throw new M("request ended without sending any events");Dr(this,Yt,void 0,"f");const r=Ip(t,Xt(this,qa,"f"));return Dr(this,Va,r,"f"),r},Mc=function(t){let r=Xt(this,Yt,"f");if(!r){if(t.type!=="response.created")throw new M(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return r=Dr(this,Yt,t.response,"f"),r}switch(t.type){case"response.output_item.added":{r.output.push(t.item);break}case"response.content_part.added":{const a=r.output[t.output_index];if(!a)throw new M(`missing output at index ${t.output_index}`);a.type==="message"&&a.content.push(t.part);break}case"response.output_text.delta":{const a=r.output[t.output_index];if(!a)throw new M(`missing output at index ${t.output_index}`);if(a.type==="message"){const s=a.content[t.content_index];if(!s)throw new M(`missing content at index ${t.content_index}`);if(s.type!=="output_text")throw new M(`expected content to be 'output_text', got ${s.type}`);s.text+=t.delta}break}case"response.function_call_arguments.delta":{const a=r.output[t.output_index];if(!a)throw new M(`missing output at index ${t.output_index}`);a.type==="function_call"&&(a.arguments+=t.delta);break}case"response.completed":{Dr(this,Yt,t.response,"f");break}}return r},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Xt(this,Va,"f");if(!e)throw new M("stream ended without producing a ChatCompletion");return e}}function Ip(n,e){return Sp(n,e)}class Cu extends ae{constructor(){super(...arguments),this.inputItems=new yh(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&_h(r),r))}retrieve(e,t={},r){return Te(t)?this.retrieve(e,{},t):this._client.get(`/responses/${e}`,{query:t,...r})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(r=>gh(r,e))}stream(e,t){return Ru.createResponse(this._client,e,t)}}class Rp extends Je{}Cu.InputItems=yh;class bh extends ae{create(e,t,r){return this._client.post(`/uploads/${e}/parts`,ln({body:t,...r}))}}class $u extends ae{constructor(){super(...arguments),this.parts=new bh(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}}$u.Parts=bh;const Cp=async n=>{const e=await Promise.allSettled(n),t=e.filter(a=>a.status==="rejected");if(t.length){for(const a of t)console.error(a.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const r=[];for(const a of e)a.status==="fulfilled"&&r.push(a.value);return r};class li extends ae{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return Te(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,di,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const a=await this.create(e,t,r);return await this.poll(e,a.id,r)}async poll(e,t,r){const a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const s=await this.retrieve(e,t,{...r,headers:a}).withResponse(),i=s.data;switch(i.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=s.response.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await Pa(o);break;case"failed":case"completed":return i}}}async upload(e,t,r){const a=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:a.id},r)}async uploadAndPoll(e,t,r){const a=await this.upload(e,t,r);return await this.poll(e,a.id,r)}content(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Nu,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class di extends Je{}class Nu extends lu{}li.VectorStoreFilesPage=di;li.FileContentResponsesPage=Nu;class wh extends ae{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const a=await this.create(e,t);return await this.poll(e,a.id,r)}listFiles(e,t,r={},a){return Te(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,di,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}async poll(e,t,r){const a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:s,response:i}=await this.retrieve(e,t,{...r,headers:a}).withResponse();switch(s.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=i.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await Pa(o);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},a){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const s=(a==null?void 0:a.maxConcurrency)??5,i=Math.min(s,t.length),o=this._client,u=t.values(),c=[...r];async function l(h){for(let m of h){const f=await o.files.create({file:m,purpose:"assistants"},a);c.push(f.id)}}const d=Array(i).fill(u).map(l);return await Cp(d),await this.createAndPoll(e,{file_ids:c})}}class pr extends ae{constructor(){super(...arguments),this.files=new li(this._client),this.fileBatches=new wh(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return Te(e)?this.list({},e):this._client.getAPIList("/vector_stores",ju,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}search(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/search`,Lu,{body:t,method:"post",...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class ju extends Je{}class Lu extends lu{}pr.VectorStoresPage=ju;pr.VectorStoreSearchResponsesPage=Lu;pr.Files=li;pr.VectorStoreFilesPage=di;pr.FileContentResponsesPage=Nu;pr.FileBatches=wh;var $p={},vh;let Y=class extends Xm{constructor({baseURL:e=Er("OPENAI_BASE_URL"),apiKey:t=Er("OPENAI_API_KEY"),organization:r=Er("OPENAI_ORG_ID")??null,project:a=Er("OPENAI_PROJECT_ID")??null,...s}={}){if(t===void 0)throw new M("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:r,project:a,...s,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&up())throw new M(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new hh(this),this.chat=new ui(this),this.embeddings=new fh(this),this.files=new Eu(this),this.images=new mh(this),this.audio=new Oa(this),this.moderations=new ph(this),this.models=new Tu(this),this.fineTuning=new Ra(this),this.vectorStores=new pr(this),this.beta=new bn(this),this.batches=new du(this),this.uploads=new $u(this),this.responses=new Cu(this),this._options=i,this.apiKey=t,this.organization=r,this.project=a}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return $m(e,{arrayFormat:"brackets"})}};vh=Y;Y.OpenAI=vh;Y.DEFAULT_TIMEOUT=6e5;Y.OpenAIError=M;Y.APIError=We;Y.APIConnectionError=ri;Y.APIConnectionTimeoutError=ni;Y.APIUserAbortError=tt;Y.NotFoundError=xd;Y.ConflictError=Ed;Y.RateLimitError=Ad;Y.BadRequestError=bd;Y.AuthenticationError=wd;Y.InternalServerError=kd;Y.PermissionDeniedError=vd;Y.UnprocessableEntityError=Sd;Y.toFile=Cd;Y.fileFromPath=_d;Y.Completions=hh;Y.Chat=ui;Y.ChatCompletionsPage=oi;Y.Embeddings=fh;Y.Files=Eu;Y.FileObjectsPage=Su;Y.Images=mh;Y.Audio=Oa;Y.Moderations=ph;Y.Models=Tu;Y.ModelsPage=Iu;Y.FineTuning=Ra;Y.VectorStores=pr;Y.VectorStoresPage=ju;Y.VectorStoreSearchResponsesPage=Lu;Y.Beta=bn;Y.Batches=du;Y.BatchesPage=hu;Y.Uploads=$u;Y.Responses=Cu;let Np=class extends Y{constructor({baseURL:e=Er("OPENAI_BASE_URL"),apiKey:t=Er("AZURE_OPENAI_API_KEY"),apiVersion:r=Er("OPENAI_API_VERSION"),endpoint:a,deployment:s,azureADTokenProvider:i,dangerouslyAllowBrowser:o,...u}={}){if(!r)throw new M("The OPENAI_API_VERSION environment variable is missing or empty; either provide it, or instantiate the AzureOpenAI client with an apiVersion option, like new AzureOpenAI({ apiVersion: 'My API Version' }).");if(typeof i=="function"&&(o=!0),!i&&!t)throw new M("Missing credentials. Please pass one of `apiKey` and `azureADTokenProvider`, or set the `AZURE_OPENAI_API_KEY` environment variable.");if(i&&t)throw new M("The `apiKey` and `azureADTokenProvider` arguments are mutually exclusive; only one can be passed at a time.");if(t??(t=Fc),u.defaultQuery={...u.defaultQuery,"api-version":r},e){if(a)throw new M("baseURL and endpoint are mutually exclusive")}else{if(a||(a=$p.AZURE_OPENAI_ENDPOINT),!a)throw new M("Must provide one of the `baseURL` or `endpoint` arguments, or the `AZURE_OPENAI_ENDPOINT` environment variable");e=`${a}/openai`}super({apiKey:t,baseURL:e,...u,...o!==void 0?{dangerouslyAllowBrowser:o}:{}}),this.apiVersion="",this._azureADTokenProvider=i,this.apiVersion=r,this.deploymentName=s}buildRequest(e,t={}){var r;if(jp.has(e.path)&&e.method==="post"&&e.body!==void 0){if(!vs(e.body))throw new Error("Expected request body to be an object");const a=this.deploymentName||e.body.model||((r=e.__metadata)==null?void 0:r.model);a!==void 0&&!this.baseURL.includes("/deployments")&&(e.path=`/deployments/${a}${e.path}`)}return super.buildRequest(e,t)}async _getAzureADToken(){if(typeof this._azureADTokenProvider=="function"){const e=await this._azureADTokenProvider();if(!e||typeof e!="string")throw new M(`Expected 'azureADTokenProvider' argument to return a string but it returned ${e}`);return e}}authHeaders(e){return{}}async prepareOptions(e){var r;if((r=e.headers)!=null&&r["api-key"])return super.prepareOptions(e);const t=await this._getAzureADToken();if(e.headers??(e.headers={}),t)e.headers.Authorization=`Bearer ${t}`;else if(this.apiKey!==Fc)e.headers["api-key"]=this.apiKey;else throw new M("Unable to handle auth");return super.prepareOptions(e)}};const jp=new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations"]),Fc="<Missing Key>";function Dc(n,e=Mu){n=n.trim();const t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function Mu(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="";const t=[];let r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch{return null}}var Lp=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const Mp=cu(Lp);var xh={exports:{}};const Fp=/[\p{Lu}]/u,Dp=/[\p{Ll}]/u,Uc=/^[\p{Lu}](?![\p{Lu}])/gu,Eh=/([\p{Alpha}\p{N}_]|$)/u,Sh=/[_.\- ]+/,Up=new RegExp("^"+Sh.source),Bc=new RegExp(Sh.source+Eh.source,"gu"),zc=new RegExp("\\d+"+Eh.source,"gu"),Bp=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){const o=n[i];r&&Fp.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&Dp.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},zp=(n,e)=>(Uc.lastIndex=0,n.replace(Uc,t=>e(t))),Zp=(n,e)=>(Bc.lastIndex=0,zc.lastIndex=0,n.replace(Bc,(t,r)=>e(r)).replace(zc,t=>e(t))),Ah=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Bp(n,t,r)),n=n.replace(Up,""),e.preserveConsecutiveUppercase?n=zp(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),Zp(n,r))};xh.exports=Ah;xh.exports.default=Ah;function Hp(n,e){return(e==null?void 0:e[n])||Mp(n)}function qp(n,e,t){const r={};for(const a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function Zc(n){return Array.isArray(n)?[...n]:{...n}}function Vp(n,e){const t=Zc(n);for(const[r,a]of Object.entries(e)){const[s,...i]=r.split(".").reverse();let o=t;for(const u of i.reverse()){if(o[u]===void 0)break;o[u]=Zc(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function kh(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class Ir{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,kh(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([r])=>{var a;return(a=this.lc_serializable_keys)==null?void 0:a.includes(r)})):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Ir||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r;const[o,...u]=a.split(".").reverse();for(const c of u.reverse()){if(!(c in s)||s[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof s[c]=="object"&&s[c]!=null?i[c]={}:Array.isArray(s[c])&&(i[c]=[])),s=s[c],i=i[c]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:qp(Object.keys(t).length?Vp(r,t):r,Hp,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function vn(n,e){return typeof n=="string"?n===""?e:typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?hi(n,e)??[...n,...e]:e===""?n:[...n,{type:"text",text:e}]}function Wp(n,e){return n==="error"||e==="error"?"error":"success"}function Jp(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>t(i,a+1));const s={};for(const i of Object.keys(r))s[i]=t(r[i],a+1);return s}return JSON.stringify(t(n,0),null,2)}class xn extends Ir{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=Jp(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}}function ze(n,e){const t={...n};for(const[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=ze(t[r],a);else if(Array.isArray(t[r]))t[r]=hi(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function hi(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{const t=[...n];for(const r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){const a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=ze(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}function Gp(n,e){if(!n&&!e)throw new Error("Cannot merge two undefined objects.");if(!n||!e)return n||e;if(typeof n!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof n}
Right ${typeof e}`);if(typeof n=="string"&&typeof e=="string")return n+e;if(Array.isArray(n)&&Array.isArray(e))return hi(n,e);if(typeof n=="object"&&typeof e=="object")return ze(n,e);if(n===e)return n;throw new Error(`Can not merge objects of different types.
Left ${n}
Right ${e}`)}class En extends xn{}function Kp(n){return typeof n.role=="string"}function fi(n){return typeof(n==null?void 0:n._getType)=="function"}function Xp(n){return fi(n)&&typeof n.concat=="function"}class Yp extends xn{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class Fu extends En{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new Fu({content:vn(this.content,e.content),additional_kwargs:ze(this.additional_kwargs,e.additional_kwargs),response_metadata:ze(this.response_metadata,e.response_metadata),artifact:Gp(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Wp(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function Qp(n){const e=[],t=[];for(const r of n)if(r.function){const a=r.function.name;try{const s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch{t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}class Rr extends xn{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){var a;let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;const s=(a=r.additional_kwargs)==null?void 0:a.tool_calls,i=r.tool_calls;s!=null&&s.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(s!=null&&i===void 0){const[o,u]=Qp(s);r.tool_calls=o??[],r.invalid_tool_calls=u??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function Sn(n){return n._getType()==="ai"}function Hc(n){return n._getType()==="ai"}class xe extends En{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const r=[],a=[];for(const s of e.tool_call_chunks){let i={};try{if(i=Mu(s.args||"{}"),i===null||typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:s.name??"",args:i,id:s.id,type:"tool_call"})}catch{a.push({name:s.name,args:s.args,id:s.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){var r,a,s,i,o,u,c,l,d,h,m,f,p,g,b,w,_,v,S,P,O,H,re,oe,V,Fe,Pt,I,k,D,N,U,j,Z,ie,E,C,B,q,_e;const t={content:vn(this.content,e.content),additional_kwargs:ze(this.additional_kwargs,e.additional_kwargs),response_metadata:ze(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const be=hi(this.tool_call_chunks,e.tool_call_chunks);be!==void 0&&be.length>0&&(t.tool_call_chunks=be)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){const be={...(((a=(r=this.usage_metadata)==null?void 0:r.input_token_details)==null?void 0:a.audio)!==void 0||((i=(s=e.usage_metadata)==null?void 0:s.input_token_details)==null?void 0:i.audio)!==void 0)&&{audio:(((u=(o=this.usage_metadata)==null?void 0:o.input_token_details)==null?void 0:u.audio)??0)+(((l=(c=e.usage_metadata)==null?void 0:c.input_token_details)==null?void 0:l.audio)??0)},...(((h=(d=this.usage_metadata)==null?void 0:d.input_token_details)==null?void 0:h.cache_read)!==void 0||((f=(m=e.usage_metadata)==null?void 0:m.input_token_details)==null?void 0:f.cache_read)!==void 0)&&{cache_read:(((g=(p=this.usage_metadata)==null?void 0:p.input_token_details)==null?void 0:g.cache_read)??0)+(((w=(b=e.usage_metadata)==null?void 0:b.input_token_details)==null?void 0:w.cache_read)??0)},...(((v=(_=this.usage_metadata)==null?void 0:_.input_token_details)==null?void 0:v.cache_creation)!==void 0||((P=(S=e.usage_metadata)==null?void 0:S.input_token_details)==null?void 0:P.cache_creation)!==void 0)&&{cache_creation:(((H=(O=this.usage_metadata)==null?void 0:O.input_token_details)==null?void 0:H.cache_creation)??0)+(((oe=(re=e.usage_metadata)==null?void 0:re.input_token_details)==null?void 0:oe.cache_creation)??0)}},Jt={...(((Fe=(V=this.usage_metadata)==null?void 0:V.output_token_details)==null?void 0:Fe.audio)!==void 0||((I=(Pt=e.usage_metadata)==null?void 0:Pt.output_token_details)==null?void 0:I.audio)!==void 0)&&{audio:(((D=(k=this.usage_metadata)==null?void 0:k.output_token_details)==null?void 0:D.audio)??0)+(((U=(N=e.usage_metadata)==null?void 0:N.output_token_details)==null?void 0:U.audio)??0)},...(((Z=(j=this.usage_metadata)==null?void 0:j.output_token_details)==null?void 0:Z.reasoning)!==void 0||((E=(ie=e.usage_metadata)==null?void 0:ie.output_token_details)==null?void 0:E.reasoning)!==void 0)&&{reasoning:(((B=(C=this.usage_metadata)==null?void 0:C.output_token_details)==null?void 0:B.reasoning)??0)+(((_e=(q=e.usage_metadata)==null?void 0:q.output_token_details)==null?void 0:_e.reasoning)??0)}},_r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},Tn=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},tm={input_tokens:_r.input_tokens+Tn.input_tokens,output_tokens:_r.output_tokens+Tn.output_tokens,total_tokens:_r.total_tokens+Tn.total_tokens,...Object.keys(be).length>0&&{input_token_details:be},...Object.keys(Jt).length>0&&{output_token_details:Jt}};t.usage_metadata=tm}return new xe(t)}}class Ca extends xn{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Ca}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}}class mi extends En{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new mi({content:vn(this.content,e.content),additional_kwargs:ze(this.additional_kwargs,e.additional_kwargs),response_metadata:ze(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}class pi extends En{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new pi({content:vn(this.content,e.content),additional_kwargs:ze(this.additional_kwargs,e.additional_kwargs),response_metadata:ze(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class dn extends xn{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class gi extends En{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new gi({content:vn(this.content,e.content),additional_kwargs:ze(this.additional_kwargs,e.additional_kwargs),response_metadata:ze(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class qc extends xn{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class ca extends En{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new ca({content:vn(this.content,e.content),additional_kwargs:ze(this.additional_kwargs,e.additional_kwargs),response_metadata:ze(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function Ph(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function Oh(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}class eg extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}function tg(n){return Oh(n)?n:typeof n.id=="string"&&n.type==="function"&&typeof n.function=="object"&&n.function!==null&&"arguments"in n.function&&typeof n.function.arguments=="string"&&"name"in n.function&&typeof n.function.name=="string"?{id:n.id,args:JSON.parse(n.function.arguments),name:n.function.name,type:"tool_call"}:n}function rg(n){return typeof n=="object"&&n!=null&&n.lc===1&&Array.isArray(n.id)&&n.kwargs!=null&&typeof n.kwargs=="object"}function zi(n){let e,t;if(rg(n)){const r=n.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?e="function":r==="ToolMessage"||r==="ToolMessageChunk"?e="tool":e="unknown",t=n.kwargs}else{const{type:r,...a}=n;e=r,t=a}if(e==="human"||e==="user")return new dn(t);if(e==="ai"||e==="assistant"){const{tool_calls:r,...a}=t;if(!Array.isArray(r))return new Rr(t);const s=r.map(tg);return new Rr({...a,tool_calls:s})}else{if(e==="system")return new qc(t);if(e==="developer")return new qc({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new Yp({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});throw Ph(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(n,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Gn(n){if(typeof n=="string")return new dn(n);if(fi(n))return n;if(Array.isArray(n)){const[e,t]=n;return zi({type:e,content:t})}else if(Kp(n)){const{role:e,...t}=n;return zi({...t,type:e})}else return zi(n)}function Th(n,e="Human",t="AI"){const r=[];for(const a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);const i=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${s}: ${i}${o}`)}return r.join(`
`)}function ng(n){var t;const e=n._getType();if(e==="human")return new gi({...n});if(e==="ai"){let r={...n};return"tool_calls"in r&&(r={...r,tool_call_chunks:(t=r.tool_calls)==null?void 0:t.map(a=>({...a,type:"tool_call_chunk",index:void 0,args:JSON.stringify(a.args)}))}),new xe({...r})}else{if(e==="system")return new ca({...n});if(e==="function")return new pi({...n});if(Ca.isInstance(n))return new mi({...n});throw new Error("Unknown message type.")}}var se;(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{const s={};for(const i of a)s[i]=i;return s},n.getValidEnumValues=a=>{const s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(const o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{const s=[];for(const i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(const i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(se||(se={}));var Zo;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Zo||(Zo={}));const R=se.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Ht=n=>{switch(typeof n){case"undefined":return R.undefined;case"string":return R.string;case"number":return isNaN(n)?R.nan:R.number;case"boolean":return R.boolean;case"function":return R.function;case"bigint":return R.bigint;case"symbol":return R.symbol;case"object":return Array.isArray(n)?R.array:n===null?R.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?R.promise:typeof Map<"u"&&n instanceof Map?R.map:typeof Set<"u"&&n instanceof Set?R.set:typeof Date<"u"&&n instanceof Date?R.date:R.object;default:return R.unknown}},A=se.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),ag=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:");class rt extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(const i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){const c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return a(this),r}static assert(e){if(!(e instanceof rt))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,se.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}rt.create=n=>new rt(n);const hn=(n,e)=>{let t;switch(n.code){case A.invalid_type:n.received===R.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case A.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,se.jsonStringifyReplacer)}`;break;case A.unrecognized_keys:t=`Unrecognized key(s) in object: ${se.joinValues(n.keys,", ")}`;break;case A.invalid_union:t="Invalid input";break;case A.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${se.joinValues(n.options)}`;break;case A.invalid_enum_value:t=`Invalid enum value. Expected ${se.joinValues(n.options)}, received '${n.received}'`;break;case A.invalid_arguments:t="Invalid function arguments";break;case A.invalid_return_type:t="Invalid function return type";break;case A.invalid_date:t="Invalid date";break;case A.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:se.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case A.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case A.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case A.custom:t="Invalid input";break;case A.invalid_intersection_types:t="Intersection results could not be merged";break;case A.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case A.not_finite:t="Number must be finite";break;default:t=e.defaultError,se.assertNever(n)}return{message:t}};let Ih=hn;function sg(n){Ih=n}function Ns(){return Ih}const js=n=>{const{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s};if(a.message!==void 0)return{...a,path:s,message:a.message};let o="";const u=r.filter(c=>!!c).slice().reverse();for(const c of u)o=c(i,{data:e,defaultError:o}).message;return{...a,path:s,message:o}},ig=[];function T(n,e){const t=Ns(),r=js({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===hn?void 0:hn].filter(a=>!!a)});n.common.issues.push(r)}class Le{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const a of t){if(a.status==="aborted")return z;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const a of t){const s=await a.key,i=await a.value;r.push({key:s,value:i})}return Le.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const a of t){const{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return z;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value<"u"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}}const z=Object.freeze({status:"aborted"}),Yr=n=>({status:"dirty",value:n}),Ze=n=>({status:"valid",value:n}),Ho=n=>n.status==="aborted",qo=n=>n.status==="dirty",Cr=n=>n.status==="valid",la=n=>typeof Promise<"u"&&n instanceof Promise;function Ls(n,e,t,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(n)}function Rh(n,e,t,r,a){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}var $;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})($||($={}));var Kn,Xn;class Lt{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Vc=(n,e)=>{if(Cr(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new rt(n.common.issues);return this._error=t,this._error}}};function W(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>{var u,c;const{message:l}=n;return i.code==="invalid_enum_value"?{message:l??o.defaultError}:typeof o.data>"u"?{message:(u=l??r)!==null&&u!==void 0?u:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(c=l??t)!==null&&c!==void 0?c:o.defaultError}},description:a}}class X{get description(){return this._def.description}_getType(e){return Ht(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Ht(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Le,ctx:{common:e.parent.common,data:e.data,parsedType:Ht(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(la(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const a={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ht(e)},s=this._parseSync({data:e,path:a.path,parent:a});return Vc(a,s)}"~validate"(e){var t,r;const a={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ht(e)};if(!this["~standard"].async)try{const s=this._parseSync({data:e,path:[],parent:a});return Cr(s)?{value:s.value}:{issues:a.common.issues}}catch(s){!((r=(t=s==null?void 0:s.message)===null||t===void 0?void 0:t.toLowerCase())===null||r===void 0)&&r.includes("encountered")&&(this["~standard"].async=!0),a.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:a}).then(s=>Cr(s)?{value:s.value}:{issues:a.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ht(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(la(a)?a:Promise.resolve(a));return Vc(r,s)}refine(e,t){const r=a=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{const i=e(a),o=()=>s.addIssue({code:A.custom,...r(a)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new St({schema:this,typeName:x.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return vt.create(this,this._def)}nullable(){return lr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return wt.create(this)}promise(){return mn.create(this,this._def)}or(e){return ma.create([this,e],this._def)}and(e){return pa.create(this,e,this._def)}transform(e){return new St({...W(this._def),schema:this,typeName:x.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new wa({...W(this._def),innerType:this,defaultValue:t,typeName:x.ZodDefault})}brand(){return new Du({typeName:x.ZodBranded,type:this,...W(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new va({...W(this._def),innerType:this,catchValue:t,typeName:x.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return $a.create(this,e)}readonly(){return xa.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const og=/^c[^\s-]{8,}$/i,ug=/^[0-9a-z]+$/,cg=/^[0-9A-HJKMNP-TV-Z]{26}$/i,lg=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,dg=/^[a-z0-9_-]{21}$/i,hg=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,fg=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,mg=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,pg="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Zi;const gg=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,_g=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,yg=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,bg=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,wg=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,vg=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Ch="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",xg=new RegExp(`^${Ch}$`);function $h(n){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`),e}function Eg(n){return new RegExp(`^${$h(n)}$`)}function Nh(n){let e=`${Ch}T${$h(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Sg(n,e){return!!((e==="v4"||!e)&&gg.test(n)||(e==="v6"||!e)&&yg.test(n))}function Ag(n,e){if(!hg.test(n))return!1;try{const[t]=n.split("."),r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),a=JSON.parse(atob(r));return!(typeof a!="object"||a===null||!a.typ||!a.alg||e&&a.alg!==e)}catch{return!1}}function kg(n,e){return!!((e==="v4"||!e)&&_g.test(n)||(e==="v6"||!e)&&bg.test(n))}class yt extends X{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==R.string){const s=this._getOrReturnCtx(e);return T(s,{code:A.invalid_type,expected:R.string,received:s.parsedType}),z}const r=new Le;let a;for(const s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:A.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:A.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){const i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?T(a,{code:A.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&T(a,{code:A.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")mg.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"email",code:A.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")Zi||(Zi=new RegExp(pg,"u")),Zi.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"emoji",code:A.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")lg.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"uuid",code:A.invalid_string,message:s.message}),r.dirty());else if(s.kind==="nanoid")dg.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"nanoid",code:A.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")og.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cuid",code:A.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")ug.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cuid2",code:A.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")cg.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"ulid",code:A.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),T(a,{validation:"url",code:A.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"regex",code:A.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),T(a,{code:A.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),T(a,{code:A.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),T(a,{code:A.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?Nh(s).test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:A.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="date"?xg.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:A.invalid_string,validation:"date",message:s.message}),r.dirty()):s.kind==="time"?Eg(s).test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:A.invalid_string,validation:"time",message:s.message}),r.dirty()):s.kind==="duration"?fg.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"duration",code:A.invalid_string,message:s.message}),r.dirty()):s.kind==="ip"?Sg(e.data,s.version)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"ip",code:A.invalid_string,message:s.message}),r.dirty()):s.kind==="jwt"?Ag(e.data,s.alg)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"jwt",code:A.invalid_string,message:s.message}),r.dirty()):s.kind==="cidr"?kg(e.data,s.version)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cidr",code:A.invalid_string,message:s.message}),r.dirty()):s.kind==="base64"?wg.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"base64",code:A.invalid_string,message:s.message}),r.dirty()):s.kind==="base64url"?vg.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"base64url",code:A.invalid_string,message:s.message}),r.dirty()):se.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:A.invalid_string,...$.errToObj(r)})}_addCheck(e){return new yt({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...$.errToObj(e)})}url(e){return this._addCheck({kind:"url",...$.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...$.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...$.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...$.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...$.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...$.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...$.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...$.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...$.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...$.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...$.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...$.errToObj(e)})}datetime(e){var t,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,local:(r=e==null?void 0:e.local)!==null&&r!==void 0?r:!1,...$.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...$.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...$.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...$.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...$.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...$.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...$.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...$.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...$.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...$.errToObj(t)})}nonempty(e){return this.min(1,$.errToObj(e))}trim(){return new yt({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new yt({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new yt({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}yt.create=n=>{var e;return new yt({checks:[],typeName:x.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...W(n)})};function Pg(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}class or extends X{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==R.number){const s=this._getOrReturnCtx(e);return T(s,{code:A.invalid_type,expected:R.number,received:s.parsedType}),z}let r;const a=new Le;for(const s of this._def.checks)s.kind==="int"?se.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:A.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:A.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:A.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?Pg(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),T(r,{code:A.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:A.not_finite,message:s.message}),a.dirty()):se.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,$.toString(t))}gt(e,t){return this.setLimit("min",e,!1,$.toString(t))}lte(e,t){return this.setLimit("max",e,!0,$.toString(t))}lt(e,t){return this.setLimit("max",e,!1,$.toString(t))}setLimit(e,t,r,a){return new or({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:$.toString(a)}]})}_addCheck(e){return new or({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:$.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:$.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:$.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:$.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:$.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:$.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:$.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:$.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:$.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&se.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}or.create=n=>new or({checks:[],typeName:x.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...W(n)});class ur extends X{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==R.bigint)return this._getInvalidInput(e);let r;const a=new Le;for(const s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:A.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:A.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),T(r,{code:A.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):se.assertNever(s);return{status:a.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return T(t,{code:A.invalid_type,expected:R.bigint,received:t.parsedType}),z}gte(e,t){return this.setLimit("min",e,!0,$.toString(t))}gt(e,t){return this.setLimit("min",e,!1,$.toString(t))}lte(e,t){return this.setLimit("max",e,!0,$.toString(t))}lt(e,t){return this.setLimit("max",e,!1,$.toString(t))}setLimit(e,t,r,a){return new ur({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:$.toString(a)}]})}_addCheck(e){return new ur({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:$.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:$.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:$.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:$.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:$.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}ur.create=n=>{var e;return new ur({checks:[],typeName:x.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...W(n)})};class da extends X{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==R.boolean){const r=this._getOrReturnCtx(e);return T(r,{code:A.invalid_type,expected:R.boolean,received:r.parsedType}),z}return Ze(e.data)}}da.create=n=>new da({typeName:x.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...W(n)});class $r extends X{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==R.date){const s=this._getOrReturnCtx(e);return T(s,{code:A.invalid_type,expected:R.date,received:s.parsedType}),z}if(isNaN(e.data.getTime())){const s=this._getOrReturnCtx(e);return T(s,{code:A.invalid_date}),z}const r=new Le;let a;for(const s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:A.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:A.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):se.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new $r({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:$.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:$.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}$r.create=n=>new $r({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:x.ZodDate,...W(n)});class Ms extends X{_parse(e){if(this._getType(e)!==R.symbol){const r=this._getOrReturnCtx(e);return T(r,{code:A.invalid_type,expected:R.symbol,received:r.parsedType}),z}return Ze(e.data)}}Ms.create=n=>new Ms({typeName:x.ZodSymbol,...W(n)});class ha extends X{_parse(e){if(this._getType(e)!==R.undefined){const r=this._getOrReturnCtx(e);return T(r,{code:A.invalid_type,expected:R.undefined,received:r.parsedType}),z}return Ze(e.data)}}ha.create=n=>new ha({typeName:x.ZodUndefined,...W(n)});class fa extends X{_parse(e){if(this._getType(e)!==R.null){const r=this._getOrReturnCtx(e);return T(r,{code:A.invalid_type,expected:R.null,received:r.parsedType}),z}return Ze(e.data)}}fa.create=n=>new fa({typeName:x.ZodNull,...W(n)});class fn extends X{constructor(){super(...arguments),this._any=!0}_parse(e){return Ze(e.data)}}fn.create=n=>new fn({typeName:x.ZodAny,...W(n)});class kr extends X{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Ze(e.data)}}kr.create=n=>new kr({typeName:x.ZodUnknown,...W(n)});class Wt extends X{_parse(e){const t=this._getOrReturnCtx(e);return T(t,{code:A.invalid_type,expected:R.never,received:t.parsedType}),z}}Wt.create=n=>new Wt({typeName:x.ZodNever,...W(n)});class Fs extends X{_parse(e){if(this._getType(e)!==R.undefined){const r=this._getOrReturnCtx(e);return T(r,{code:A.invalid_type,expected:R.void,received:r.parsedType}),z}return Ze(e.data)}}Fs.create=n=>new Fs({typeName:x.ZodVoid,...W(n)});class wt extends X{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==R.array)return T(t,{code:A.invalid_type,expected:R.array,received:t.parsedType}),z;if(a.exactLength!==null){const i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(T(t,{code:i?A.too_big:A.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(T(t,{code:A.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(T(t,{code:A.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new Lt(t,i,t.path,o)))).then(i=>Le.mergeArray(r,i));const s=[...t.data].map((i,o)=>a.type._parseSync(new Lt(t,i,t.path,o)));return Le.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new wt({...this._def,minLength:{value:e,message:$.toString(t)}})}max(e,t){return new wt({...this._def,maxLength:{value:e,message:$.toString(t)}})}length(e,t){return new wt({...this._def,exactLength:{value:e,message:$.toString(t)}})}nonempty(e){return this.min(1,e)}}wt.create=(n,e)=>new wt({type:n,minLength:null,maxLength:null,exactLength:null,typeName:x.ZodArray,...W(e)});function Jr(n){if(n instanceof ge){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=vt.create(Jr(r))}return new ge({...n._def,shape:()=>e})}else return n instanceof wt?new wt({...n._def,type:Jr(n.element)}):n instanceof vt?vt.create(Jr(n.unwrap())):n instanceof lr?lr.create(Jr(n.unwrap())):n instanceof Mt?Mt.create(n.items.map(e=>Jr(e))):n}class ge extends X{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=se.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==R.object){const c=this._getOrReturnCtx(e);return T(c,{code:A.invalid_type,expected:R.object,received:c.parsedType}),z}const{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Wt&&this._def.unknownKeys==="strip"))for(const c in a.data)i.includes(c)||o.push(c);const u=[];for(const c of i){const l=s[c],d=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Lt(a,d,a.path,c)),alwaysSet:c in a.data})}if(this._def.catchall instanceof Wt){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:a.data[l]}});else if(c==="strict")o.length>0&&(T(a,{code:A.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of o){const d=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Lt(a,d,a.path,l)),alwaysSet:l in a.data})}}return a.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of u){const d=await l.key,h=await l.value;c.push({key:d,value:h,alwaysSet:l.alwaysSet})}return c}).then(c=>Le.mergeObjectSync(r,c)):Le.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return $.errToObj,new ge({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;const u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=$.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new ge({...this._def,unknownKeys:"strip"})}passthrough(){return new ge({...this._def,unknownKeys:"passthrough"})}extend(e){return new ge({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new ge({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:x.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new ge({...this._def,catchall:e})}pick(e){const t={};return se.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new ge({...this._def,shape:()=>t})}omit(e){const t={};return se.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new ge({...this._def,shape:()=>t})}deepPartial(){return Jr(this)}partial(e){const t={};return se.objectKeys(this.shape).forEach(r=>{const a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new ge({...this._def,shape:()=>t})}required(e){const t={};return se.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof vt;)s=s._def.innerType;t[r]=s}}),new ge({...this._def,shape:()=>t})}keyof(){return jh(se.objectKeys(this.shape))}}ge.create=(n,e)=>new ge({shape:()=>n,unknownKeys:"strip",catchall:Wt.create(),typeName:x.ZodObject,...W(e)});ge.strictCreate=(n,e)=>new ge({shape:()=>n,unknownKeys:"strict",catchall:Wt.create(),typeName:x.ZodObject,...W(e)});ge.lazycreate=(n,e)=>new ge({shape:n,unknownKeys:"strip",catchall:Wt.create(),typeName:x.ZodObject,...W(e)});class ma extends X{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(const o of s)if(o.result.status==="valid")return o.result;for(const o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=s.map(o=>new rt(o.ctx.common.issues));return T(t,{code:A.invalid_union,unionErrors:i}),z}if(t.common.async)return Promise.all(r.map(async s=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s;const i=[];for(const u of r){const c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;const o=i.map(u=>new rt(u));return T(t,{code:A.invalid_union,unionErrors:o}),z}}get options(){return this._def.options}}ma.create=(n,e)=>new ma({options:n,typeName:x.ZodUnion,...W(e)});const Zt=n=>n instanceof _a?Zt(n.schema):n instanceof St?Zt(n.innerType()):n instanceof ya?[n.value]:n instanceof cr?n.options:n instanceof ba?se.objectValues(n.enum):n instanceof wa?Zt(n._def.innerType):n instanceof ha?[void 0]:n instanceof fa?[null]:n instanceof vt?[void 0,...Zt(n.unwrap())]:n instanceof lr?[null,...Zt(n.unwrap())]:n instanceof Du||n instanceof xa?Zt(n.unwrap()):n instanceof va?Zt(n._def.innerType):[];class _i extends X{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.object)return T(t,{code:A.invalid_type,expected:R.object,received:t.parsedType}),z;const r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(T(t,{code:A.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),z)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const a=new Map;for(const s of t){const i=Zt(s.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new _i({typeName:x.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...W(r)})}}function Vo(n,e){const t=Ht(n),r=Ht(e);if(n===e)return{valid:!0,data:n};if(t===R.object&&r===R.object){const a=se.objectKeys(e),s=se.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(const o of s){const u=Vo(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===R.array&&r===R.array){if(n.length!==e.length)return{valid:!1};const a=[];for(let s=0;s<n.length;s++){const i=n[s],o=e[s],u=Vo(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===R.date&&r===R.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class pa extends X{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if(Ho(s)||Ho(i))return z;const o=Vo(s.value,i.value);return o.valid?((qo(s)||qo(i))&&t.dirty(),{status:t.value,value:o.data}):(T(r,{code:A.invalid_intersection_types}),z)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}pa.create=(n,e,t)=>new pa({left:n,right:e,typeName:x.ZodIntersection,...W(t)});class Mt extends X{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==R.array)return T(r,{code:A.invalid_type,expected:R.array,received:r.parsedType}),z;if(r.data.length<this._def.items.length)return T(r,{code:A.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),z;!this._def.rest&&r.data.length>this._def.items.length&&(T(r,{code:A.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...r.data].map((i,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new Lt(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>Le.mergeArray(t,i)):Le.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new Mt({...this._def,rest:e})}}Mt.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Mt({items:n,typeName:x.ZodTuple,rest:null,...W(e)})};class ga extends X{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==R.object)return T(r,{code:A.invalid_type,expected:R.object,received:r.parsedType}),z;const a=[],s=this._def.keyType,i=this._def.valueType;for(const o in r.data)a.push({key:s._parse(new Lt(r,o,r.path,o)),value:i._parse(new Lt(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?Le.mergeObjectAsync(t,a):Le.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof X?new ga({keyType:e,valueType:t,typeName:x.ZodRecord,...W(r)}):new ga({keyType:yt.create(),valueType:e,typeName:x.ZodRecord,...W(t)})}}class Ds extends X{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==R.map)return T(r,{code:A.invalid_type,expected:R.map,received:r.parsedType}),z;const a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:a._parse(new Lt(r,o,r.path,[c,"key"])),value:s._parse(new Lt(r,u,r.path,[c,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of i){const c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return z;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const u of i){const c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return z;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}}Ds.create=(n,e,t)=>new Ds({valueType:e,keyType:n,typeName:x.ZodMap,...W(t)});class Nr extends X{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==R.set)return T(r,{code:A.invalid_type,expected:R.set,received:r.parsedType}),z;const a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(T(r,{code:A.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(T(r,{code:A.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());const s=this._def.valueType;function i(u){const c=new Set;for(const l of u){if(l.status==="aborted")return z;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}const o=[...r.data.values()].map((u,c)=>s._parse(new Lt(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new Nr({...this._def,minSize:{value:e,message:$.toString(t)}})}max(e,t){return new Nr({...this._def,maxSize:{value:e,message:$.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Nr.create=(n,e)=>new Nr({valueType:n,minSize:null,maxSize:null,typeName:x.ZodSet,...W(e)});class on extends X{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.function)return T(t,{code:A.invalid_type,expected:R.function,received:t.parsedType}),z;function r(o,u){return js({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ns(),hn].filter(c=>!!c),issueData:{code:A.invalid_arguments,argumentsError:u}})}function a(o,u){return js({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ns(),hn].filter(c=>!!c),issueData:{code:A.invalid_return_type,returnTypeError:u}})}const s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof mn){const o=this;return Ze(async function(...u){const c=new rt([]),l=await o._def.args.parseAsync(u,s).catch(m=>{throw c.addIssue(r(u,m)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,s).catch(m=>{throw c.addIssue(a(d,m)),c})})}else{const o=this;return Ze(function(...u){const c=o._def.args.safeParse(u,s);if(!c.success)throw new rt([r(u,c.error)]);const l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,s);if(!d.success)throw new rt([a(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new on({...this._def,args:Mt.create(e).rest(kr.create())})}returns(e){return new on({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new on({args:e||Mt.create([]).rest(kr.create()),returns:t||kr.create(),typeName:x.ZodFunction,...W(r)})}}class _a extends X{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}_a.create=(n,e)=>new _a({getter:n,typeName:x.ZodLazy,...W(e)});class ya extends X{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return T(t,{received:t.data,code:A.invalid_literal,expected:this._def.value}),z}return{status:"valid",value:e.data}}get value(){return this._def.value}}ya.create=(n,e)=>new ya({value:n,typeName:x.ZodLiteral,...W(e)});function jh(n,e){return new cr({values:n,typeName:x.ZodEnum,...W(e)})}class cr extends X{constructor(){super(...arguments),Kn.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return T(t,{expected:se.joinValues(r),received:t.parsedType,code:A.invalid_type}),z}if(Ls(this,Kn)||Rh(this,Kn,new Set(this._def.values)),!Ls(this,Kn).has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return T(t,{received:t.data,code:A.invalid_enum_value,options:r}),z}return Ze(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return cr.create(e,{...this._def,...t})}exclude(e,t=this._def){return cr.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}}Kn=new WeakMap;cr.create=jh;class ba extends X{constructor(){super(...arguments),Xn.set(this,void 0)}_parse(e){const t=se.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==R.string&&r.parsedType!==R.number){const a=se.objectValues(t);return T(r,{expected:se.joinValues(a),received:r.parsedType,code:A.invalid_type}),z}if(Ls(this,Xn)||Rh(this,Xn,new Set(se.getValidEnumValues(this._def.values))),!Ls(this,Xn).has(e.data)){const a=se.objectValues(t);return T(r,{received:r.data,code:A.invalid_enum_value,options:a}),z}return Ze(e.data)}get enum(){return this._def.values}}Xn=new WeakMap;ba.create=(n,e)=>new ba({values:n,typeName:x.ZodNativeEnum,...W(e)});class mn extends X{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.promise&&t.common.async===!1)return T(t,{code:A.invalid_type,expected:R.promise,received:t.parsedType}),z;const r=t.parsedType===R.promise?t.data:Promise.resolve(t.data);return Ze(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}}mn.create=(n,e)=>new mn({type:n,typeName:x.ZodPromise,...W(e)});class St extends X{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===x.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{T(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){const i=a.transform(r.data,s);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return z;const u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?z:u.status==="dirty"||t.value==="dirty"?Yr(u.value):u});{if(t.value==="aborted")return z;const o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?z:o.status==="dirty"||t.value==="dirty"?Yr(o.value):o}}if(a.type==="refinement"){const i=o=>{const u=a.refinement(o,s);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?z:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?z:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Cr(i))return i;const o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>Cr(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);se.assertNever(a)}}St.create=(n,e,t)=>new St({schema:n,typeName:x.ZodEffects,effect:e,...W(t)});St.createWithPreprocess=(n,e,t)=>new St({schema:e,effect:{type:"preprocess",transform:n},typeName:x.ZodEffects,...W(t)});class vt extends X{_parse(e){return this._getType(e)===R.undefined?Ze(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}vt.create=(n,e)=>new vt({innerType:n,typeName:x.ZodOptional,...W(e)});class lr extends X{_parse(e){return this._getType(e)===R.null?Ze(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}lr.create=(n,e)=>new lr({innerType:n,typeName:x.ZodNullable,...W(e)});class wa extends X{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===R.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}wa.create=(n,e)=>new wa({innerType:n,typeName:x.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...W(e)});class va extends X{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return la(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new rt(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new rt(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}va.create=(n,e)=>new va({innerType:n,typeName:x.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...W(e)});class Us extends X{_parse(e){if(this._getType(e)!==R.nan){const r=this._getOrReturnCtx(e);return T(r,{code:A.invalid_type,expected:R.nan,received:r.parsedType}),z}return{status:"valid",value:e.data}}}Us.create=n=>new Us({typeName:x.ZodNaN,...W(n)});const Og=Symbol("zod_brand");class Du extends X{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class $a extends X{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?z:s.status==="dirty"?(t.dirty(),Yr(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{const a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?z:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new $a({in:e,out:t,typeName:x.ZodPipeline})}}class xa extends X{_parse(e){const t=this._def.innerType._parse(e),r=a=>(Cr(a)&&(a.value=Object.freeze(a.value)),a);return la(t)?t.then(a=>r(a)):r(t)}unwrap(){return this._def.innerType}}xa.create=(n,e)=>new xa({innerType:n,typeName:x.ZodReadonly,...W(e)});function Wc(n,e){const t=typeof n=="function"?n(e):typeof n=="string"?{message:n}:n;return typeof t=="string"?{message:t}:t}function Lh(n,e={},t){return n?fn.create().superRefine((r,a)=>{var s,i;const o=n(r);if(o instanceof Promise)return o.then(u=>{var c,l;if(!u){const d=Wc(e,r),h=(l=(c=d.fatal)!==null&&c!==void 0?c:t)!==null&&l!==void 0?l:!0;a.addIssue({code:"custom",...d,fatal:h})}});if(!o){const u=Wc(e,r),c=(i=(s=u.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0;a.addIssue({code:"custom",...u,fatal:c})}}):fn.create()}const Tg={object:ge.lazycreate};var x;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(x||(x={}));const Ig=(n,e={message:`Input not instance of ${n.name}`})=>Lh(t=>t instanceof n,e),Mh=yt.create,Fh=or.create,Rg=Us.create,Cg=ur.create,Dh=da.create,$g=$r.create,Ng=Ms.create,jg=ha.create,Lg=fa.create,Mg=fn.create,Fg=kr.create,Dg=Wt.create,Ug=Fs.create,Bg=wt.create,zg=ge.create,Zg=ge.strictCreate,Hg=ma.create,qg=_i.create,Vg=pa.create,Wg=Mt.create,Jg=ga.create,Gg=Ds.create,Kg=Nr.create,Xg=on.create,Yg=_a.create,Qg=ya.create,e_=cr.create,t_=ba.create,r_=mn.create,Jc=St.create,n_=vt.create,a_=lr.create,s_=St.createWithPreprocess,i_=$a.create,o_=()=>Mh().optional(),u_=()=>Fh().optional(),c_=()=>Dh().optional(),l_={string:n=>yt.create({...n,coerce:!0}),number:n=>or.create({...n,coerce:!0}),boolean:n=>da.create({...n,coerce:!0}),bigint:n=>ur.create({...n,coerce:!0}),date:n=>$r.create({...n,coerce:!0})},d_=z;var Pr=Object.freeze({__proto__:null,defaultErrorMap:hn,setErrorMap:sg,getErrorMap:Ns,makeIssue:js,EMPTY_PATH:ig,addIssueToContext:T,ParseStatus:Le,INVALID:z,DIRTY:Yr,OK:Ze,isAborted:Ho,isDirty:qo,isValid:Cr,isAsync:la,get util(){return se},get objectUtil(){return Zo},ZodParsedType:R,getParsedType:Ht,ZodType:X,datetimeRegex:Nh,ZodString:yt,ZodNumber:or,ZodBigInt:ur,ZodBoolean:da,ZodDate:$r,ZodSymbol:Ms,ZodUndefined:ha,ZodNull:fa,ZodAny:fn,ZodUnknown:kr,ZodNever:Wt,ZodVoid:Fs,ZodArray:wt,ZodObject:ge,ZodUnion:ma,ZodDiscriminatedUnion:_i,ZodIntersection:pa,ZodTuple:Mt,ZodRecord:ga,ZodMap:Ds,ZodSet:Nr,ZodFunction:on,ZodLazy:_a,ZodLiteral:ya,ZodEnum:cr,ZodNativeEnum:ba,ZodPromise:mn,ZodEffects:St,ZodTransformer:St,ZodOptional:vt,ZodNullable:lr,ZodDefault:wa,ZodCatch:va,ZodNaN:Us,BRAND:Og,ZodBranded:Du,ZodPipeline:$a,ZodReadonly:xa,custom:Lh,Schema:X,ZodSchema:X,late:Tg,get ZodFirstPartyTypeKind(){return x},coerce:l_,any:Mg,array:Bg,bigint:Cg,boolean:Dh,date:$g,discriminatedUnion:qg,effect:Jc,enum:e_,function:Xg,instanceof:Ig,intersection:Vg,lazy:Yg,literal:Qg,map:Gg,nan:Rg,nativeEnum:t_,never:Dg,null:Lg,nullable:a_,number:Fh,object:zg,oboolean:c_,onumber:u_,optional:n_,ostring:o_,pipeline:i_,preprocess:s_,promise:r_,record:Jg,set:Kg,strictObject:Zg,string:Mh,symbol:Ng,transformer:Jc,tuple:Wg,undefined:jg,union:Hg,unknown:Fg,void:Ug,NEVER:d_,ZodIssueCode:A,quotelessJson:ag,ZodError:rt}),yi={exports:{}},Uh={};function ut(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var h_=ut;ut.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};ut.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};ut.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};ut.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};ut.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};ut.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};ut.prototype.start=ut.prototype.try;ut.prototype.errors=function(){return this._errors};ut.prototype.attempts=function(){return this._attempts};ut.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e};(function(n){var e=h_;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var a in t)r[a]=t[a];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],i=0;i<r.retries;i++)s.push(this.createTimeout(i,r));return t&&t.forever&&!s.length&&s.push(this.createTimeout(i,r)),s.sort(function(o,u){return o-u}),s},n.createTimeout=function(t,r){var a=r.randomize?Math.random()+1:1,s=Math.round(a*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return s=Math.min(s,r.maxTimeout),s},n.wrap=function(t,r,a){if(r instanceof Array&&(a=r,r=null),!a){a=[];for(var s in t)typeof t[s]=="function"&&a.push(s)}for(var i=0;i<a.length;i++){var o=a[i],u=t[o];t[o]=(function(l){var d=n.operation(r),h=Array.prototype.slice.call(arguments,1),m=h.pop();h.push(function(f){d.retry(f)||(f&&(arguments[0]=d.mainError()),m.apply(this,arguments))}),d.attempt(function(){l.apply(t,h)})}).bind(t,u),t[o].options=r}}})(Uh);var f_=Uh;const m_=f_,p_=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class Bh extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const g_=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},__=n=>p_.includes(n),zh=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const a=m_.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof Bh)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!__(i.message))a.stop(),r(i);else{g_(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});yi.exports=zh;yi.exports.default=zh;yi.exports.AbortError=Bh;var y_=yi.exports;const Bs=cu(y_),b_=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function ea(n){return typeof n=="string"&&b_.test(n)}var Ie=[];for(var Hi=0;Hi<256;++Hi)Ie.push((Hi+256).toString(16).slice(1));function w_(n,e=0){return(Ie[n[e+0]]+Ie[n[e+1]]+Ie[n[e+2]]+Ie[n[e+3]]+"-"+Ie[n[e+4]]+Ie[n[e+5]]+"-"+Ie[n[e+6]]+Ie[n[e+7]]+"-"+Ie[n[e+8]]+Ie[n[e+9]]+"-"+Ie[n[e+10]]+Ie[n[e+11]]+Ie[n[e+12]]+Ie[n[e+13]]+Ie[n[e+14]]+Ie[n[e+15]]).toLowerCase()}var Wa,v_=new Uint8Array(16);function x_(){if(!Wa&&(Wa=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Wa))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Wa(v_)}var E_=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Gc={randomUUID:E_};function Be(n,e,t){if(Gc.randomUUID&&!n)return Gc.randomUUID();n=n||{};var r=n.random||(n.rng||x_)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,w_(r)}var Zh={},Hh={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function a(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function s(u,c,l,d,h){if(typeof l!="function")throw new TypeError("The listener must be a function");var m=new a(l,d||u,h),f=t?t+c:c;return u._events[f]?u._events[f].fn?u._events[f]=[u._events[f],m]:u._events[f].push(m):(u._events[f]=m,u._eventsCount++),u}function i(u,c){--u._eventsCount===0?u._events=new r:delete u._events[c]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,d;if(this._eventsCount===0)return c;for(d in l=this._events)e.call(l,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=t?t+c:c,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,m=d.length,f=new Array(m);h<m;h++)f[h]=d[h].fn;return f},o.prototype.listenerCount=function(c){var l=t?t+c:c,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,l,d,h,m,f){var p=t?t+c:c;if(!this._events[p])return!1;var g=this._events[p],b=arguments.length,w,_;if(g.fn){switch(g.once&&this.removeListener(c,g.fn,void 0,!0),b){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,l),!0;case 3:return g.fn.call(g.context,l,d),!0;case 4:return g.fn.call(g.context,l,d,h),!0;case 5:return g.fn.call(g.context,l,d,h,m),!0;case 6:return g.fn.call(g.context,l,d,h,m,f),!0}for(_=1,w=new Array(b-1);_<b;_++)w[_-1]=arguments[_];g.fn.apply(g.context,w)}else{var v=g.length,S;for(_=0;_<v;_++)switch(g[_].once&&this.removeListener(c,g[_].fn,void 0,!0),b){case 1:g[_].fn.call(g[_].context);break;case 2:g[_].fn.call(g[_].context,l);break;case 3:g[_].fn.call(g[_].context,l,d);break;case 4:g[_].fn.call(g[_].context,l,d,h);break;default:if(!w)for(S=1,w=new Array(b-1);S<b;S++)w[S-1]=arguments[S];g[_].fn.apply(g[_].context,w)}}return!0},o.prototype.on=function(c,l,d){return s(this,c,l,d,!1)},o.prototype.once=function(c,l,d){return s(this,c,l,d,!0)},o.prototype.removeListener=function(c,l,d,h){var m=t?t+c:c;if(!this._events[m])return this;if(!l)return i(this,m),this;var f=this._events[m];if(f.fn)f.fn===l&&(!h||f.once)&&(!d||f.context===d)&&i(this,m);else{for(var p=0,g=[],b=f.length;p<b;p++)(f[p].fn!==l||h&&!f[p].once||d&&f[p].context!==d)&&g.push(f[p]);g.length?this._events[m]=g.length===1?g[0]:g:i(this,m)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=t?t+c:c,this._events[l]&&i(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(Hh);var S_=Hh.exports,bi={exports:{}},A_=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const k_=A_;class qh extends Error{constructor(e){super(e),this.name="TimeoutError"}}const Vh=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){a(u)}return}const i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new qh(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);k_(n.then(r,a),()=>{clearTimeout(s)})});bi.exports=Vh;bi.exports.default=Vh;bi.exports.TimeoutError=qh;var P_=bi.exports,Uu={},Bu={};Object.defineProperty(Bu,"__esModule",{value:!0});function O_(n,e,t){let r=0,a=n.length;for(;a>0;){const s=a/2|0;let i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}Bu.default=O_;Object.defineProperty(Uu,"__esModule",{value:!0});const T_=Bu;class I_{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const a=T_.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}Uu.default=I_;Object.defineProperty(Zh,"__esModule",{value:!0});const R_=S_,Wh=P_,C_=Uu,Ja=()=>{},$_=new Wh.TimeoutError;class N_ extends R_{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Ja,this._resolveIdle=Ja,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:C_.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Ja,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Ja,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{const s=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&t.timeout===void 0?e():Wh.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a($_)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var Vt=Zh.default=N_;const j_=(...n)=>fetch(...n),L_=Symbol.for("ls:fetch_implementation"),F=()=>globalThis[L_]??j_,M_=[400,401,403,404,405,406,407,408],F_=[409];let Kc=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Vt?this.queue=new Vt.default({concurrency:this.maxConcurrency}):this.queue=new Vt({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>Bs(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||(a==null?void 0:a.code)==="ECONNABORTED")throw a;const s=a==null?void 0:a.response,i=s==null?void 0:s.status;if(i){if(M_.includes(+i))throw a;if(F_.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>F()(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Xc(n){return typeof(n==null?void 0:n._getType)=="function"}function Yc(n){const e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}function J(n,e){if(!ea(n)){const t=e!==void 0?`Invalid UUID for ${e}: ${n}`:`Invalid UUID: ${n}`;throw new Error(t)}return n}const Qc={};function Jh(n){Qc[n]||(console.warn(n),Qc[n]=!0)}var Wo={exports:{}};const D_="2.0.0",Gh=256,U_=Number.MAX_SAFE_INTEGER||9007199254740991,B_=16,z_=Gh-6,Z_=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var wi={MAX_LENGTH:Gh,MAX_SAFE_COMPONENT_LENGTH:B_,MAX_SAFE_BUILD_LENGTH:z_,MAX_SAFE_INTEGER:U_,RELEASE_TYPES:Z_,SEMVER_SPEC_VERSION:D_,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},qi={};const H_=typeof process=="object"&&qi&&qi.NODE_DEBUG&&/\bsemver\b/i.test(qi.NODE_DEBUG)?(...n)=>console.error("SEMVER",...n):()=>{};var vi=H_;(function(n,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:a}=wi,s=vi;e=n.exports={};const i=e.re=[],o=e.safeRe=[],u=e.src=[],c=e.safeSrc=[],l=e.t={};let d=0;const h="[a-zA-Z0-9-]",m=[["\\s",1],["\\d",a],[h,r]],f=g=>{for(const[b,w]of m)g=g.split(`${b}*`).join(`${b}{0,${w}}`).split(`${b}+`).join(`${b}{1,${w}}`);return g},p=(g,b,w)=>{const _=f(b),v=d++;s(g,v,b),l[g]=v,u[v]=b,c[v]=_,i[v]=new RegExp(b,w?"g":void 0),o[v]=new RegExp(_,w?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),p("MAINVERSION",`(${u[l.NUMERICIDENTIFIER]})\\.(${u[l.NUMERICIDENTIFIER]})\\.(${u[l.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${u[l.NUMERICIDENTIFIERLOOSE]})\\.(${u[l.NUMERICIDENTIFIERLOOSE]})\\.(${u[l.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${u[l.NUMERICIDENTIFIER]}|${u[l.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${u[l.NUMERICIDENTIFIERLOOSE]}|${u[l.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${u[l.PRERELEASEIDENTIFIER]}(?:\\.${u[l.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${u[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${u[l.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${h}+`),p("BUILD",`(?:\\+(${u[l.BUILDIDENTIFIER]}(?:\\.${u[l.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${u[l.MAINVERSION]}${u[l.PRERELEASE]}?${u[l.BUILD]}?`),p("FULL",`^${u[l.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${u[l.MAINVERSIONLOOSE]}${u[l.PRERELEASELOOSE]}?${u[l.BUILD]}?`),p("LOOSE",`^${u[l.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${u[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${u[l.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${u[l.XRANGEIDENTIFIER]})(?:\\.(${u[l.XRANGEIDENTIFIER]})(?:\\.(${u[l.XRANGEIDENTIFIER]})(?:${u[l.PRERELEASE]})?${u[l.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${u[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[l.XRANGEIDENTIFIERLOOSE]})(?:${u[l.PRERELEASELOOSE]})?${u[l.BUILD]}?)?)?`),p("XRANGE",`^${u[l.GTLT]}\\s*${u[l.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${u[l.GTLT]}\\s*${u[l.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),p("COERCE",`${u[l.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",u[l.COERCEPLAIN]+`(?:${u[l.PRERELEASE]})?(?:${u[l.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",u[l.COERCE],!0),p("COERCERTLFULL",u[l.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${u[l.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",p("TILDE",`^${u[l.LONETILDE]}${u[l.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${u[l.LONETILDE]}${u[l.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${u[l.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",p("CARET",`^${u[l.LONECARET]}${u[l.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${u[l.LONECARET]}${u[l.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${u[l.GTLT]}\\s*(${u[l.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${u[l.GTLT]}\\s*(${u[l.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${u[l.GTLT]}\\s*(${u[l.LOOSEPLAIN]}|${u[l.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${u[l.XRANGEPLAIN]})\\s+-\\s+(${u[l.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${u[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${u[l.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(Wo,Wo.exports);var Na=Wo.exports;const q_=Object.freeze({loose:!0}),V_=Object.freeze({}),W_=n=>n?typeof n!="object"?q_:n:V_;var zu=W_;const el=/^[0-9]+$/,Kh=(n,e)=>{const t=el.test(n),r=el.test(e);return t&&r&&(n=+n,e=+e),n===e?0:t&&!r?-1:r&&!t?1:n<e?-1:1},J_=(n,e)=>Kh(e,n);var Xh={compareIdentifiers:Kh,rcompareIdentifiers:J_};const Ga=vi,{MAX_LENGTH:tl,MAX_SAFE_INTEGER:Ka}=wi,{safeRe:rl,safeSrc:nl,t:Xa}=Na,G_=zu,{compareIdentifiers:Br}=Xh;let K_=class Tt{constructor(e,t){if(t=G_(t),e instanceof Tt){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>tl)throw new TypeError(`version is longer than ${tl} characters`);Ga("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?rl[Xa.LOOSE]:rl[Xa.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>Ka||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Ka||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Ka||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(a=>{if(/^[0-9]+$/.test(a)){const s=+a;if(s>=0&&s<Ka)return s}return a}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Ga("SemVer.compare",this.version,this.options,e),!(e instanceof Tt)){if(typeof e=="string"&&e===this.version)return 0;e=new Tt(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof Tt||(e=new Tt(e,this.options)),Br(this.major,e.major)||Br(this.minor,e.minor)||Br(this.patch,e.patch)}comparePre(e){if(e instanceof Tt||(e=new Tt(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],a=e.prerelease[t];if(Ga("prerelease compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return Br(r,a)}while(++t)}compareBuild(e){e instanceof Tt||(e=new Tt(e,this.options));let t=0;do{const r=this.build[t],a=e.build[t];if(Ga("build compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return Br(r,a)}while(++t)}inc(e,t,r){if(e.startsWith("pre")){if(!t&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(t){const a=new RegExp(`^${this.options.loose?nl[Xa.PRERELEASELOOSE]:nl[Xa.PRERELEASE]}$`),s=`-${t}`.match(a);if(!s||s[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const a=Number(r)?1:0;if(this.prerelease.length===0)this.prerelease=[a];else{let s=this.prerelease.length;for(;--s>=0;)typeof this.prerelease[s]=="number"&&(this.prerelease[s]++,s=-2);if(s===-1){if(t===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(a)}}if(t){let s=[t,a];r===!1&&(s=[t]),Br(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=s):this.prerelease=s}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var Zu=K_;const al=Zu,X_=(n,e,t)=>new al(n,t).compare(new al(e,t));var An=X_;const Y_=An,Q_=(n,e,t)=>Y_(n,e,t)>0;var ey=Q_;const ty=An,ry=(n,e,t)=>ty(n,e,t)<0;var ny=ry;const ay=An,sy=(n,e,t)=>ay(n,e,t)===0;var iy=sy;const oy=An,uy=(n,e,t)=>oy(n,e,t)!==0;var cy=uy;const ly=An,dy=(n,e,t)=>ly(n,e,t)>=0;var hy=dy;const fy=An,my=(n,e,t)=>fy(n,e,t)<=0;var py=my;const gy=iy,_y=cy,yy=ey,by=hy,wy=ny,vy=py,xy=(n,e,t,r)=>{switch(e){case"===":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n===t;case"!==":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n!==t;case"":case"=":case"==":return gy(n,t,r);case"!=":return _y(n,t,r);case">":return yy(n,t,r);case">=":return by(n,t,r);case"<":return wy(n,t,r);case"<=":return vy(n,t,r);default:throw new TypeError(`Invalid operator: ${e}`)}};var Ey=xy;const{safeRe:uE,t:cE}=Na;class Sy{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){const a=this.map.keys().next().value;this.delete(a)}this.map.set(e,t)}return this}}var Ay=Sy,Vi,sl;function kt(){if(sl)return Vi;sl=1;const n=/\s+/g;class e{constructor(k,D){if(D=a(D),k instanceof e)return k.loose===!!D.loose&&k.includePrerelease===!!D.includePrerelease?k:new e(k.raw,D);if(k instanceof s)return this.raw=k.value,this.set=[[k]],this.formatted=void 0,this;if(this.options=D,this.loose=!!D.loose,this.includePrerelease=!!D.includePrerelease,this.raw=k.trim().replace(n," "),this.set=this.raw.split("||").map(N=>this.parseRange(N.trim())).filter(N=>N.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const N=this.set[0];if(this.set=this.set.filter(U=>!p(U[0])),this.set.length===0)this.set=[N];else if(this.set.length>1){for(const U of this.set)if(U.length===1&&g(U[0])){this.set=[U];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let k=0;k<this.set.length;k++){k>0&&(this.formatted+="||");const D=this.set[k];for(let N=0;N<D.length;N++)N>0&&(this.formatted+=" "),this.formatted+=D[N].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(k){const N=((this.options.includePrerelease&&m)|(this.options.loose&&f))+":"+k,U=r.get(N);if(U)return U;const j=this.options.loose,Z=j?u[c.HYPHENRANGELOOSE]:u[c.HYPHENRANGE];k=k.replace(Z,Fe(this.options.includePrerelease)),i("hyphen replace",k),k=k.replace(u[c.COMPARATORTRIM],l),i("comparator trim",k),k=k.replace(u[c.TILDETRIM],d),i("tilde trim",k),k=k.replace(u[c.CARETTRIM],h),i("caret trim",k);let ie=k.split(" ").map(q=>w(q,this.options)).join(" ").split(/\s+/).map(q=>V(q,this.options));j&&(ie=ie.filter(q=>(i("loose invalid filter",q,this.options),!!q.match(u[c.COMPARATORLOOSE])))),i("range list",ie);const E=new Map,C=ie.map(q=>new s(q,this.options));for(const q of C){if(p(q))return[q];E.set(q.value,q)}E.size>1&&E.has("")&&E.delete("");const B=[...E.values()];return r.set(N,B),B}intersects(k,D){if(!(k instanceof e))throw new TypeError("a Range is required");return this.set.some(N=>b(N,D)&&k.set.some(U=>b(U,D)&&N.every(j=>U.every(Z=>j.intersects(Z,D)))))}test(k){if(!k)return!1;if(typeof k=="string")try{k=new o(k,this.options)}catch{return!1}for(let D=0;D<this.set.length;D++)if(Pt(this.set[D],k,this.options))return!0;return!1}}Vi=e;const t=Ay,r=new t,a=zu,s=xi(),i=vi,o=Zu,{safeRe:u,t:c,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:h}=Na,{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:f}=wi,p=I=>I.value==="<0.0.0-0",g=I=>I.value==="",b=(I,k)=>{let D=!0;const N=I.slice();let U=N.pop();for(;D&&N.length;)D=N.every(j=>U.intersects(j,k)),U=N.pop();return D},w=(I,k)=>(i("comp",I,k),I=P(I,k),i("caret",I),I=v(I,k),i("tildes",I),I=H(I,k),i("xrange",I),I=oe(I,k),i("stars",I),I),_=I=>!I||I.toLowerCase()==="x"||I==="*",v=(I,k)=>I.trim().split(/\s+/).map(D=>S(D,k)).join(" "),S=(I,k)=>{const D=k.loose?u[c.TILDELOOSE]:u[c.TILDE];return I.replace(D,(N,U,j,Z,ie)=>{i("tilde",I,N,U,j,Z,ie);let E;return _(U)?E="":_(j)?E=`>=${U}.0.0 <${+U+1}.0.0-0`:_(Z)?E=`>=${U}.${j}.0 <${U}.${+j+1}.0-0`:ie?(i("replaceTilde pr",ie),E=`>=${U}.${j}.${Z}-${ie} <${U}.${+j+1}.0-0`):E=`>=${U}.${j}.${Z} <${U}.${+j+1}.0-0`,i("tilde return",E),E})},P=(I,k)=>I.trim().split(/\s+/).map(D=>O(D,k)).join(" "),O=(I,k)=>{i("caret",I,k);const D=k.loose?u[c.CARETLOOSE]:u[c.CARET],N=k.includePrerelease?"-0":"";return I.replace(D,(U,j,Z,ie,E)=>{i("caret",I,U,j,Z,ie,E);let C;return _(j)?C="":_(Z)?C=`>=${j}.0.0${N} <${+j+1}.0.0-0`:_(ie)?j==="0"?C=`>=${j}.${Z}.0${N} <${j}.${+Z+1}.0-0`:C=`>=${j}.${Z}.0${N} <${+j+1}.0.0-0`:E?(i("replaceCaret pr",E),j==="0"?Z==="0"?C=`>=${j}.${Z}.${ie}-${E} <${j}.${Z}.${+ie+1}-0`:C=`>=${j}.${Z}.${ie}-${E} <${j}.${+Z+1}.0-0`:C=`>=${j}.${Z}.${ie}-${E} <${+j+1}.0.0-0`):(i("no pr"),j==="0"?Z==="0"?C=`>=${j}.${Z}.${ie}${N} <${j}.${Z}.${+ie+1}-0`:C=`>=${j}.${Z}.${ie}${N} <${j}.${+Z+1}.0-0`:C=`>=${j}.${Z}.${ie} <${+j+1}.0.0-0`),i("caret return",C),C})},H=(I,k)=>(i("replaceXRanges",I,k),I.split(/\s+/).map(D=>re(D,k)).join(" ")),re=(I,k)=>{I=I.trim();const D=k.loose?u[c.XRANGELOOSE]:u[c.XRANGE];return I.replace(D,(N,U,j,Z,ie,E)=>{i("xRange",I,N,U,j,Z,ie,E);const C=_(j),B=C||_(Z),q=B||_(ie),_e=q;return U==="="&&_e&&(U=""),E=k.includePrerelease?"-0":"",C?U===">"||U==="<"?N="<0.0.0-0":N="*":U&&_e?(B&&(Z=0),ie=0,U===">"?(U=">=",B?(j=+j+1,Z=0,ie=0):(Z=+Z+1,ie=0)):U==="<="&&(U="<",B?j=+j+1:Z=+Z+1),U==="<"&&(E="-0"),N=`${U+j}.${Z}.${ie}${E}`):B?N=`>=${j}.0.0${E} <${+j+1}.0.0-0`:q&&(N=`>=${j}.${Z}.0${E} <${j}.${+Z+1}.0-0`),i("xRange return",N),N})},oe=(I,k)=>(i("replaceStars",I,k),I.trim().replace(u[c.STAR],"")),V=(I,k)=>(i("replaceGTE0",I,k),I.trim().replace(u[k.includePrerelease?c.GTE0PRE:c.GTE0],"")),Fe=I=>(k,D,N,U,j,Z,ie,E,C,B,q,_e)=>(_(N)?D="":_(U)?D=`>=${N}.0.0${I?"-0":""}`:_(j)?D=`>=${N}.${U}.0${I?"-0":""}`:Z?D=`>=${D}`:D=`>=${D}${I?"-0":""}`,_(C)?E="":_(B)?E=`<${+C+1}.0.0-0`:_(q)?E=`<${C}.${+B+1}.0-0`:_e?E=`<=${C}.${B}.${q}-${_e}`:I?E=`<${C}.${B}.${+q+1}-0`:E=`<=${E}`,`${D} ${E}`.trim()),Pt=(I,k,D)=>{for(let N=0;N<I.length;N++)if(!I[N].test(k))return!1;if(k.prerelease.length&&!D.includePrerelease){for(let N=0;N<I.length;N++)if(i(I[N].semver),I[N].semver!==s.ANY&&I[N].semver.prerelease.length>0){const U=I[N].semver;if(U.major===k.major&&U.minor===k.minor&&U.patch===k.patch)return!0}return!1}return!0};return Vi}var Wi,il;function xi(){if(il)return Wi;il=1;const n=Symbol("SemVer ANY");class e{static get ANY(){return n}constructor(l,d){if(d=t(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),i("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===n?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(l){const d=this.options.loose?r[a.COMPARATORLOOSE]:r[a.COMPARATOR],h=l.match(d);if(!h)throw new TypeError(`Invalid comparator: ${l}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=n}toString(){return this.value}test(l){if(i("Comparator.test",l,this.options.loose),this.semver===n||l===n)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return s(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new u(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new u(this.value,d).test(l.semver):(d=t(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||s(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||s(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}Wi=e;const t=zu,{safeRe:r,t:a}=Na,s=Ey,i=vi,o=Zu,u=kt();return Wi}kt();kt();kt();kt();kt();kt();const ky=xi(),{ANY:lE}=ky;kt();kt();kt();const Hu=xi(),{ANY:dE}=Hu;new Hu(">=0.0.0-0");new Hu(">=0.0.0");const Ji=Na,ol=wi,ul=Xh;xi();kt();Ji.re,Ji.src,Ji.t,ol.SEMVER_SPEC_VERSION,ol.RELEASE_TYPES,ul.compareIdentifiers,ul.rcompareIdentifiers;function Qt(n){if(!n||n.split("/").length>2||n.startsWith("/")||n.endsWith("/")||n.split(":").length>2)throw new Error(`Invalid identifier format: ${n}`);const[e,t]=n.split(":"),r=t||"latest";if(e.includes("/")){const[a,s]=e.split("/",2);if(!a||!s)throw new Error(`Invalid identifier format: ${n}`);return[a,s,r]}else{if(!e)throw new Error(`Invalid identifier format: ${n}`);return["-",e,r]}}class Py extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function te(n,e,t){let r;if(n.ok){t&&(r=await n.text());return}r=await n.text();const a=`Failed to ${e}. Received status [${n.status}]: ${n.statusText}. Server response: ${r}`;throw n.status===409?new Py(a):new Error(a)}var cl="[...]",Oy={result:"[Circular]"},zs=[],Qr=[];const Ty=new TextEncoder;function Iy(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Ya(n){return Ty.encode(n)}function Xe(n,e,t,r){var a;try{const s=JSON.stringify(n,e,t);return Ya(s)}catch(s){if(!((a=s.message)!=null&&a.includes("Converting circular structure to JSON")))return console.warn("[WARNING]: LangSmith received unserializable value."),Ya("[Unserializable]");console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof r>"u"&&(r=Iy()),Jo(n,"",0,[],void 0,0,r);let i;try{Qr.length===0?i=JSON.stringify(n,e,t):i=JSON.stringify(n,Ry(e),t)}catch{return Ya("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;zs.length!==0;){const o=zs.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return Ya(i)}}function Gi(n,e,t,r){var a=Object.getOwnPropertyDescriptor(r,t);a.get!==void 0?a.configurable?(Object.defineProperty(r,t,{value:n}),zs.push([r,t,e,a])):Qr.push([e,t,n]):(r[t]=n,zs.push([r,t,e]))}function Jo(n,e,t,r,a,s,i){s+=1;var o;if(typeof n=="object"&&n!==null){for(o=0;o<r.length;o++)if(r[o]===n){Gi(Oy,n,e,a);return}if(typeof i.depthLimit<"u"&&s>i.depthLimit){Gi(cl,n,e,a);return}if(typeof i.edgesLimit<"u"&&t+1>i.edgesLimit){Gi(cl,n,e,a);return}if(r.push(n),Array.isArray(n))for(o=0;o<n.length;o++)Jo(n[o],o,o,r,n,s,i);else{var u=Object.keys(n);for(o=0;o<u.length;o++){var c=u[o];Jo(n[c],c,o,r,n,s,i)}}r.pop()}}function Ry(n){return n=typeof n<"u"?n:function(e,t){return t},function(e,t){if(Qr.length>0)for(var r=0;r<Qr.length;r++){var a=Qr[r];if(a[1]===e&&a[0]===t){t=a[2],Qr.splice(r,1);break}}return n.call(this,e,t)}}function ll(n){const e=ef(),t=Hy(),r=n.extra??{},a=r.metadata;return n.extra={...r,runtime:{...e,...r==null?void 0:r.runtime},metadata:{...t,...t.revision_id||n.revision_id?{revision_id:n.revision_id??t.revision_id}:{},...a}},n}const Cy=n=>{const e=(n==null?void 0:n.toString())??sr("TRACING_SAMPLING_RATE");if(e===void 0)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t},$y=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function Ny(n){const e=[];for await(const t of n)e.push(t);return e}function Ki(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const jy=async n=>{if((n==null?void 0:n.status)===429){const e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};function dl(n){return typeof n=="number"?Number(n.toFixed(4)):n}class Ly{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise(s=>{t=s}),a=Xe(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){var a;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let r=0;for(;r+(((a=this.peek())==null?void 0:a.size)??0)<e&&this.items.length>0;){const s=this.items.shift();s&&(t.push(s),r+=s.size,this.sizeBytes-=s.size)}if(t.length===0&&this.items.length>0){const s=this.items.shift();t.push(s),r+=s.size,this.sizeBytes-=s.size}return[t.map(s=>({action:s.action,item:s.payload})),()=>t.forEach(s=>s.itemPromiseResolve())]}}const My=20971520,Fy=2500;class Ea{constructor(e={}){var r;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ly}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Or("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1});const t=Ea.getDefaultClientConfig();if(this.tracingSampleRate=Cy(e.tracingSamplingRate),this.apiUrl=Ki(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Ki(e.apiKey??t.apiKey),this.webUrl=Ki(e.webUrl??t.webUrl),(r=this.webUrl)!=null&&r.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Kc(e.callerOptions??{}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new Kc({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:jy}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=sr("API_KEY"),t=sr("ENDPOINT")??"https://api.smith.langchain.com",r=sr("HIDE_INPUTS")==="true",a=sr("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:$y(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Yh}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=(t==null?void 0:t.toString())??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(F(),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(s,`Failed to fetch ${e}`),s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(s));const i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(F(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(o,`Failed to fetch ${e}`);const u=r?r(await o.json()):await o.json();if(u.length===0||(yield u,u.length<s))break;a+=u.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){const s=t?{...t}:{};for(;;){const o=await(await this.caller.call(F(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];const u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const a of e)this.filteredPostUuids.has(a.id)?this.filteredPostUuids.delete(a.id):r.push(a);return r}else{const r=[];for(const a of e){const s=a.trace_id??a.id;this.filteredPostUuids.has(s)||(a.id===s?this._shouldSample()?r.push(a):this.filteredPostUuids.add(s):r.push(a))}return r}}async _getBatchSizeLimitBytes(){var t;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((t=e.batch_ingest_config)==null?void 0:t.size_limit_bytes)??My}async _getMultiPartSupport(){var t;return((t=(await this._ensureServerInfo()).instance_flags)==null?void 0:t.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}const s=this._processBatch(r,a).catch(console.error);t.push(s)}return Promise.all(t)}async _processBatch(e,t){var r;if(!e.length){t();return}try{const a={runCreates:e.filter(i=>i.action==="create").map(i=>i.item),runUpdates:e.filter(i=>i.action==="update").map(i=>i.item)},s=await this._ensureServerInfo();(r=s==null?void 0:s.batch_ingest_config)!=null&&r.use_multipart_endpoint?await this.multipartIngestRuns(a):await this.batchIngestRuns(a)}finally{t()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=ll(e.item));const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await F()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(Fy),...this.fetchOptions});return await te(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch{console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}const s=ll(a),i=await this.caller.call(F(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:Xe(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=(e==null?void 0:e.map(o=>this.prepareRunCreateOrUpdateInputs(o)))??[],a=(t==null?void 0:t.map(o=>this.prepareRunCreateOrUpdateInputs(o)))??[];if(r.length>0&&a.length>0){const o=r.reduce((c,l)=>(l.id&&(c[l.id]=l),c),{}),u=[];for(const c of a)c.id!==void 0&&o[c.id]?o[c.id]={...o[c.id],...c}:u.push(c);r=Object.values(o),a=u}const s={post:r,patch:a};if(!s.post.length&&!s.patch.length)return;const i={post:[],patch:[]};for(const o of["post","patch"]){const u=o,c=s[u].reverse();let l=c.pop();for(;l!==void 0;)i[u].push(l),l=c.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(Xe(i))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(F(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;const r={};let a=[];for(const l of e??[]){const d=this.prepareRunCreateOrUpdateInputs(l);d.id!==void 0&&d.attachments!==void 0&&(r[d.id]=d.attachments),delete d.attachments,a.push(d)}let s=[];for(const l of t??[])s.push(this.prepareRunCreateOrUpdateInputs(l));if(a.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&s.length>0){const l=a.reduce((h,m)=>(m.id&&(h[m.id]=m),h),{}),d=[];for(const h of s)h.id!==void 0&&l[h.id]?l[h.id]={...l[h.id],...h}:d.push(h);a=Object.values(l),s=d}if(a.length===0&&s.length===0)return;const u=[],c=[];for(const[l,d]of[["post",a],["patch",s]])for(const h of d){const{inputs:m,outputs:f,events:p,attachments:g,...b}=h,w={inputs:m,outputs:f,events:p},_=Xe(b);c.push({name:`${l}.${b.id}`,payload:new Blob([_],{type:`application/json; length=${_.length}`})});for(const[v,S]of Object.entries(w)){if(S===void 0)continue;const P=Xe(S);c.push({name:`${l}.${b.id}.${v}`,payload:new Blob([P],{type:`application/json; length=${P.length}`})})}if(b.id!==void 0){const v=r[b.id];if(v){delete r[b.id];for(const[S,P]of Object.entries(v)){let O,H;if(Array.isArray(P)?[O,H]=P:(O=P.mimeType,H=P.data),S.includes(".")){console.warn(`Skipping attachment '${S}' for run ${b.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}c.push({name:`attachment.${b.id}.${S}`,payload:new Blob([H],{type:`${O}; length=${H.byteLength}`})})}}}u.push(`trace=${b.trace_id},id=${b.id}`)}await this._sendMultipartRequest(c,u.join("; "))}async _sendMultipartRequest(e,t){try{const r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=[];for(const u of e)a.push(new Blob([`--${r}\r
`])),a.push(new Blob([`Content-Disposition: form-data; name="${u.name}"\r
`,`Content-Type: ${u.payload.type}\r
\r
`])),a.push(u.payload),a.push(new Blob([`\r
`]));a.push(new Blob([`--${r}--\r
`]));const i=await new Blob(a).arrayBuffer(),o=await this.batchIngestCaller.call(F(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`},body:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(o,"ingest multipart runs",!0)}catch(r){console.warn(`${r.message.trim()}

Context: ${t}`)}}async updateRun(e,t){J(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:r}).catch(console.error);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(F(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:Xe(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(s,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){J(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r!=null&&r.projectName?a=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?a=r==null?void 0:r.projectId:a=(await this.readProject({projectName:sr("PROJECT")||"default"})).id;const s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){const a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await Ny(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>((s==null?void 0:s.dotted_order)??"").localeCompare((i==null?void 0:i.dotted_order)??""));for(const s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(const s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:c,runType:l,error:d,id:h,query:m,filter:f,traceFilter:p,treeFilter:g,limit:b,select:w}=e;let _=[];if(t&&(_=Array.isArray(t)?t:[t]),r){const O=Array.isArray(r)?r:[r],H=await Promise.all(O.map(re=>this.readProject({projectName:re}).then(oe=>oe.id)));_.push(...H)}const v=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],S={session:_.length?_:null,run_type:l,reference_example:i,query:m,filter:f,trace_filter:p,tree_filter:g,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:d,id:h,limit:b,trace:s,select:w||v,is_root:c};let P=0;for await(const O of this._getCursorPaginatedList("/runs/query",S))if(b){if(P>=b)break;if(O.length+P>b){yield*O.slice(0,b-P);break}P+=O.length,yield*O}else yield*O}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:s,projectIds:i,referenceExampleIds:o,startTime:u,endTime:c,error:l,query:d,filter:h,traceFilter:m,treeFilter:f,isRoot:p,dataSourceType:g}){let b=i||[];s&&(b=[...i||[],...await Promise.all(s.map(P=>this.readProject({projectName:P}).then(O=>O.id)))]);const _=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:b,reference_example:o,start_time:u,end_time:c,error:l,query:d,filter:h,trace_filter:m,tree_filter:f,is_root:p,data_source_type:g}).filter(([P,O])=>O!==void 0));return await(await this.caller.call(F(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(_),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||Be()};J(e);const s=await(await this.caller.call(F(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){J(e);const t=await this.caller.call(F(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(t,"unshare run",!0)}async readRunSharedLink(e){J(e);const r=await(await this.caller.call(F(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const i of t)r.append("id",i);return J(e),await(await this.caller.call(F(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),J(e);const a=await(await this.caller.call(F(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};J(e);const s=await(await this.caller.call(F(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){J(e);const t=await this.caller.call(F(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(t,"unshare dataset",!0)}async readSharedDataset(e){return J(e),await(await this.caller.call(F(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,t){const r={};t!=null&&t.exampleIds&&(r.id=t.exampleIds);const a=new URLSearchParams;Object.entries(r).forEach(([o,u])=>{Array.isArray(u)?u.forEach(c=>a.append(o,c)):a.append(o,u)});const s=await this.caller.call(F(),`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await s.json();if(!s.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${s.status}
Message: ${i.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){const o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=s||{};r&&(c.metadata=r);const l={name:e,extra:c,description:t};i!==null&&(l.reference_dataset_id=i);const d=await this.caller.call(F(),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(d,"create project"),await d.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=s;a&&(u={...u||{},metadata:a});const c={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(F(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(l,"update project"),await l.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)J(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");const s=await this.caller.call(F(),`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)J(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());const i=await this._get(a,s);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i,metadata:o}={}){const u=new URLSearchParams;if(e!==void 0)for(const c of e)u.append("id",c);if(t!==void 0&&u.append("name",t),r!==void 0&&u.append("name_contains",r),a!==void 0)u.append("reference_dataset",a);else if(s!==void 0){const c=await this.readDataset({datasetName:s});u.append("reference_dataset",c.id)}i!==void 0&&u.append("reference_free",i.toString()),o!==void 0&&u.append("metadata",JSON.stringify(o));for await(const c of this._getPaginated("/sessions",u))yield*c}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,J(r);const a=await this.caller.call(F(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(a,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){const u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(h=>{c.append("input_keys",h)}),a.forEach(h=>{c.append("output_keys",h)}),s&&c.append("description",s),i&&c.append("data_type",i),o&&c.append("name",o);const l=await this.caller.call(F(),u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(l,"upload CSV"),await l.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:s,metadata:i}={}){const o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),a&&(o.inputs_schema_definition=a),s&&(o.outputs_schema_definition=s);const u=await this.caller.call(F(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(u,"create dataset"),await u.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)J(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");const s=await this._get(r,a);let i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s,metadata:i}={}){const o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const c of r)u.append("id",c);a!==void 0&&u.append("name",a),s!==void 0&&u.append("name_contains",s),i!==void 0&&u.append("metadata",JSON.stringify(i));for await(const c of this._getPaginated(o,u))yield*c}async updateDataset(e){const{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:r})).id;J(s);const i=await this.caller.call(F(),`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(i,"update dataset"),await i.json()}async updateDatasetTag(e){const{datasetId:t,datasetName:r,asOf:a,tag:s}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:r})).id;J(i);const o=await this.caller.call(F(),`${this.apiUrl}/datasets/${i}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({as_of:typeof a=="string"?a:a.toISOString(),tag:s}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(o,"update dataset tags")}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)J(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");const s=await this.caller.call(F(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(s,`delete ${r}`),await s.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(!a&&!t)throw new Error("Must provide either datasetName or datasetId");if(a&&t)throw new Error("Must provide either datasetName or datasetId, not both");a||(a=(await this.readDataset({datasetName:t})).id),J(a);const s={tag:r},i=await this.caller.call(F(),`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:a}={}){const s={limit:r,inputs:e};a!==void 0&&(s.filter=a),J(t);const i=await this.caller.call(F(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,t,r){var l;if(hl(e)&&(t!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let a=t?r==null?void 0:r.datasetId:e.dataset_id;const s=t?r==null?void 0:r.datasetName:e.dataset_name;if(a===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:s})).id);const i=(t?r==null?void 0:r.createdAt:e.created_at)||new Date;let o;hl(e)?o=e:o={inputs:e,outputs:t,created_at:i==null?void 0:i.toISOString(),id:r==null?void 0:r.exampleId,metadata:r==null?void 0:r.metadata,split:r==null?void 0:r.split,source_run_id:r==null?void 0:r.sourceRunId,use_source_run_io:r==null?void 0:r.useSourceRunIO,use_source_run_attachments:r==null?void 0:r.useSourceRunAttachments,attachments:r==null?void 0:r.attachments};const u=await this._uploadExamplesMultipart(a,[o]);return await this.readExample(((l=u.example_ids)==null?void 0:l[0])??Be())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const w=e;let _=w[0].dataset_id;const v=w[0].dataset_name;if(_===void 0&&v===void 0)throw new Error("Must provide either datasetName or datasetId");if(_!==void 0&&v!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");_===void 0&&(_=(await this.readDataset({datasetName:v})).id);const S=await this._uploadExamplesMultipart(_,w);return await Promise.all(S.example_ids.map(O=>this.readExample(O)))}const{inputs:t,outputs:r,metadata:a,splits:s,sourceRunIds:i,useSourceRunIOs:o,useSourceRunAttachments:u,attachments:c,exampleIds:l,datasetId:d,datasetName:h}=e;if(t===void 0)throw new Error("Must provide inputs when using legacy parameters");let m=d;const f=h;if(m===void 0&&f===void 0)throw new Error("Must provide either datasetName or datasetId");if(m!==void 0&&f!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");m===void 0&&(m=(await this.readDataset({datasetName:f})).id);const p=t.map((w,_)=>({dataset_id:m,inputs:w,outputs:r==null?void 0:r[_],metadata:a==null?void 0:a[_],split:s==null?void 0:s[_],id:l==null?void 0:l[_],attachments:c==null?void 0:c[_],source_run_id:i==null?void 0:i[_],use_source_run_io:o==null?void 0:o[_],use_source_run_attachments:u==null?void 0:u[_]})),g=await this._uploadExamplesMultipart(m,p);return await Promise.all(g.example_ids.map(w=>this.readExample(w)))}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map(i=>Xc(i)?Yc(i):i),s=Xc(t)?Yc(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){J(e);const t=`/examples/${e}`,r=await this._get(t),{attachment_urls:a,...s}=r,i=s;return a&&(i.attachments=Object.entries(a).reduce((o,[u,c])=>(o[u.slice(11)]={presigned_url:c.presigned_url,mime_type:c.mime_type},o),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o,limit:u,offset:c,filter:l,includeAttachments:d}={}){let h;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(t!==void 0)h=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const m=new URLSearchParams({dataset:h}),f=a?typeof a=="string"?a:a==null?void 0:a.toISOString():void 0;f&&m.append("as_of",f);const p=i??!0;if(m.append("inline_s3_urls",p.toString()),r!==void 0)for(const b of r)m.append("id",b);if(s!==void 0)for(const b of s)m.append("splits",b);if(o!==void 0){const b=JSON.stringify(o);m.append("metadata",b)}u!==void 0&&m.append("limit",u.toString()),c!==void 0&&m.append("offset",c.toString()),l!==void 0&&m.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(b=>m.append("select",b));let g=0;for await(const b of this._getPaginated("/examples",m)){for(const w of b){const{attachment_urls:_,...v}=w,S=v;_&&(S.attachments=Object.entries(_).reduce((P,[O,H])=>(P[O.slice(11)]={presigned_url:H.presigned_url,mime_type:H.mime_type||void 0},P),{})),yield S,g++}if(u!==void 0&&g>=u)break}}async deleteExample(e){J(e);const t=`/examples/${e}`,r=await this.caller.call(F(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(r,`delete ${t}`),await r.json()}async updateExample(e,t){let r;t?r=e:r=e.id,J(r);let a;t?a={id:r,...t}:a=e;let s;return a.dataset_id!==void 0?s=a.dataset_id:s=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(s,[a])}async updateExamples(e){let t;return e[0].dataset_id===void 0?t=(await this.readExample(e[0].id)).dataset_id:t=e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:r,tag:a}){let s;if(e?s=e:s=(await this.readDataset({datasetName:t})).id,J(s),r&&a||!r&&!a)throw new Error("Exactly one of asOf and tag must be specified.");const i=new URLSearchParams;r!==void 0&&i.append("as_of",typeof r=="string"?r:r.toISOString()),a!==void 0&&i.append("tag",a);const o=await this.caller.call(F(),`${this.apiUrl}/datasets/${s}/version?${i.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(o,"read dataset version"),await o.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,J(a);const s=new URLSearchParams,i=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return i&&s.append("as_of",i),await this._get(`/datasets/${a}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:s=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,J(i);const o={split_name:r,examples:a.map(c=>(J(c),c)),remove:s},u=await this.caller.call(F(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(u,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){Jh("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,s),[u,c]=await this._logEvaluationFeedback(o,i,r);return c[0]}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d,projectId:h,comparativeExperimentId:m}){var w;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const f={type:u??"api",metadata:o??{}};c!==void 0&&(f==null?void 0:f.metadata)!==void 0&&!f.metadata.__run&&(f.metadata.__run={run_id:c}),(f==null?void 0:f.metadata)!==void 0&&((w=f.metadata.__run)==null?void 0:w.run_id)!==void 0&&J(f.metadata.__run.run_id);const p={id:l??Be(),run_id:e,key:t,score:dl(r),value:a,correction:s,comment:i,feedback_source:f,comparative_experiment_id:m,feedbackConfig:d,session_id:h},g=`${this.apiUrl}/feedback`,b=await this.caller.call(F(),g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(b,"create feedback",!0),p}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){const i={};t!=null&&(i.score=dl(t)),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),J(e);const o=await this.caller.call(F(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(o,"update feedback",!0)}async readFeedback(e){J(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){J(e);const t=`/feedback/${e}`,r=await this.caller.call(F(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const s of t)a.append("key",s);if(r)for(const s of r)a.append("source",s);for await(const s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){const s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(F(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){var l;if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(l=a??new Date)==null?void 0:l.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(F(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){J(e);const t=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:Array.isArray(e)?t=e:t=[e],t}async _logEvaluationFeedback(e,t,r){const a=this._selectEvalResults(e),s=[];for(const i of a){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let u=null;i.targetRunId?u=i.targetRunId:t&&(u=t.id),s.push(await this.createFeedback(u,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[a,s]}async logEvaluationFeedback(e,t,r){const[a]=await this._logEvaluationFeedback(e,t,r);return a}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:a,limit:s}=e,i=new URLSearchParams;t&&t.forEach((u,c)=>{J(u,`queueIds[${c}]`),i.append("ids",u)}),r&&i.append("name",r),a&&i.append("name_contains",a),i.append("limit",(s!==void 0?Math.min(s,100):100).toString());let o=0;for await(const u of this._getPaginated("/annotation-queues",i))if(yield*u,o++,s!==void 0&&o>=s)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:a}=e,s={name:t,description:r,id:a||Be()},i=await this.caller.call(F(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(s).filter(([u,c])=>c!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(i,"create annotation queue"),await i.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:r,description:a}=t,s=await this.caller.call(F(),`${this.apiUrl}/annotation-queues/${J(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(s,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(F(),`${this.apiUrl}/annotation-queues/${J(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const r=await this.caller.call(F(),`${this.apiUrl}/annotation-queues/${J(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((a,s)=>J(a,`runIds[${s}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${J(e,"queueId")}/run`,a=await this.caller.call(F(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(a,"get run from annotation queue"),await a.json()}async deleteRunFromAnnotationQueue(e,t){const r=await this.caller.call(F(),`${this.apiUrl}/annotation-queues/${J(e,"queueId")}/runs/${J(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(r,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){const t=await this.caller.call(F(),`${this.apiUrl}/annotation-queues/${J(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(t,"get size from annotation queue"),await t.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(F(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){const a=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),s=new Error(`Error ${t.status}: ${t.statusText}
${a}`);throw s.statusCode=t.status,s}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,a,s]=Qt(e),i=await this.caller.call(F(),`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(i,`${t?"like":"unlike"} prompt`),await i.json()}async _getPromptUrl(e){const[t,r,a]=Qt(e);if(await this._currentTenantIsOwner(t)){const s=await this._getSettings();return a!=="latest"?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${s.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${s.id}`}else return a!=="latest"?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&t.append("is_public",e.isPublic.toString()),e!=null&&e.query&&t.append("query",e.query);for await(const r of this._getPaginated("/repos",t,a=>a.repos))yield*r}async getPrompt(e){const[t,r,a]=Qt(e),s=await this.caller.call(F(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(s.status===404)return null;await te(s,"get prompt");const i=await s.json();return i.repo?i.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t!=null&&t.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[a,s,i]=Qt(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);const o={repo_handle:s,...(t==null?void 0:t.description)&&{description:t.description},...(t==null?void 0:t.readme)&&{readme:t.readme},...(t==null?void 0:t.tags)&&{tags:t.tags},is_public:!!(t!=null&&t.isPublic)},u=await this.caller.call(F(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(u,"create prompt");const{repo:c}=await u.json();return c}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[a,s,i]=Qt(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${a}/${s}`):r==null?void 0:r.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=await this.caller.call(F(),`${this.apiUrl}/commits/${a}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(c,"create commit");const l=await c.json();return this._getPromptUrl(`${a}/${s}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){var o;if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const u of t){const c=u.id,l={...u.metadata&&{metadata:u.metadata},...u.split&&{split:u.split}},d=Xe(l),h=new Blob([d],{type:"application/json"});if(r.append(c,h),u.inputs){const m=Xe(u.inputs),f=new Blob([m],{type:"application/json"});r.append(`${c}.inputs`,f)}if(u.outputs){const m=Xe(u.outputs),f=new Blob([m],{type:"application/json"});r.append(`${c}.outputs`,f)}if(u.attachments)for(const[m,f]of Object.entries(u.attachments)){let p,g;Array.isArray(f)?[p,g]=f:(p=f.mimeType,g=f.data);const b=new Blob([g],{type:`${p}; length=${g.byteLength}`});r.append(`${c}.attachment.${m}`,b)}if(u.attachments_operations){const m=Xe(u.attachments_operations),f=new Blob([m],{type:"application/json"});r.append(`${c}.attachments_operations`,f)}}const a=e??((o=t[0])==null?void 0:o.dataset_id);return await(await this.caller.call(F(),`${this.apiUrl}/v1/platform/datasets/${a}/examples`,{method:"PATCH",headers:this.headers,body:r})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const i of t){const o=(i.id??Be()).toString(),u={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},c=Xe(u),l=new Blob([c],{type:"application/json"});if(r.append(o,l),i.inputs){const d=Xe(i.inputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.inputs`,h)}if(i.outputs){const d=Xe(i.outputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.outputs`,h)}if(i.attachments)for(const[d,h]of Object.entries(i.attachments)){let m,f;Array.isArray(h)?[m,f]=h:(m=h.mimeType,f=h.data);const p=new Blob([f],{type:`${m}; length=${f.byteLength}`});r.append(`${o}.attachment.${d}`,p)}}return await(await this.caller.call(F(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,a]=Qt(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const s={};if((t==null?void 0:t.description)!==void 0&&(s.description=t.description),(t==null?void 0:t.readme)!==void 0&&(s.readme=t.readme),(t==null?void 0:t.tags)!==void 0&&(s.tags=t.tags),(t==null?void 0:t.isPublic)!==void 0&&(s.is_public=t.isPublic),(t==null?void 0:t.isArchived)!==void 0&&(s.is_archived=t.isArchived),Object.keys(s).length===0)throw new Error("No valid update options provided");const i=await this.caller.call(F(),`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",body:JSON.stringify(s),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await te(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,a]=Qt(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return await(await this.caller.call(F(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,t){const[r,a,s]=Qt(e),i=await this.caller.call(F(),`${this.apiUrl}/commits/${r}/${a}/${s}${t!=null&&t.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await te(i,"pull prompt commit");const o=await i.json();return{owner:r,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t==null?void 0:t.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(a=>a!=="object")&&await this.updatePrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}):await this.createPrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}),t!=null&&t.object?await this.createCommit(e,t==null?void 0:t.object,{parentCommitHash:t==null?void 0:t.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[s,i]=this.parseTokenOrUrl(e,r),o=new Ea({apiUrl:s,apiKey:"placeholder"}),u=await o.readSharedDataset(i),c=a||u.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(i),d=await this.createDataset(c,{description:u.description,dataType:u.data_type||"kv",inputsSchema:u.inputs_schema_definition??void 0,outputsSchema:u.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(h=>h.inputs),outputs:l.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),h}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return J(e),[t,e]}catch{}try{const i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){const o=i[i.length-r];return[t,o]}else throw new Error(`Invalid public ${a} URL: ${e}`)}catch{throw new Error(`Invalid public ${a} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}}function hl(n){return"dataset_id"in n||"dataset_name"in n}const Yh="0.3.14";var ta={};let Dt;const Dy=()=>typeof window<"u"&&typeof window.document<"u",Uy=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",By=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Qh=()=>typeof Deno<"u",zy=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Qh(),Zy=()=>Dt||(Dy()?Dt="browser":zy()?Dt="node":Uy()?Dt="webworker":By()?Dt="jsdom":Qh()?Dt="deno":Dt="other",Dt);let Xi;function ef(){if(Xi===void 0){const n=Zy(),e=Vy();Xi={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Yh,...e}}return Xi}function Hy(){const n=qy()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,a]of Object.entries(n))(r.startsWith("LANGCHAIN_")||r.startsWith("LANGSMITH_"))&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function qy(){try{return typeof process<"u"&&ta?Object.entries(ta).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function Or(n){try{return typeof process<"u"?ta==null?void 0:ta[n]:void 0}catch{return}}function sr(n){return Or(`LANGSMITH_${n}`)||Or(`LANGCHAIN_${n}`)}let Yi;function Vy(){if(Yi!==void 0)return Yi;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=Or(t);r!==void 0&&(e[t]=r)}return Yi=e,e}const Wy=n=>!!["TRACING_V2","TRACING"].find(t=>sr(t)==="true"),Qi=Symbol.for("lc:context_variables");function Jy(n){return n.replace(/[-:.]/g,"")}function Gy(n,e,t=1){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return Jy(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}class Zs{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){const t=e.split(",");let r={},a=[];for(const s of t){const[i,o]=s.split("="),u=decodeURIComponent(o);i==="langsmith-metadata"?r=JSON.parse(u):i==="langsmith-tags"&&(a=u.split(","))}return new Zs(r,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}}class et{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),tf(e)){Object.assign(this,{...e});return}const t=et.getDefaultConfig(),{metadata:r,...a}=e,s=a.client??et.getSharedClient(),i={...r,...(o=a==null?void 0:a.extra)==null?void 0:o.metadata};if(a.extra={...a.extra,metadata:i},Object.assign(this,{...t,...a,client:s}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const u=Gy(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+u:this.dotted_order=u}}static getDefaultConfig(){return{id:Be(),run_type:"chain",project_name:sr("PROJECT")??Or("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:Or("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Or("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return et.sharedClient||(et.sharedClient=new Ea),et.sharedClient}createChild(e){var u,c,l,d,h,m;const t=this.child_execution_order+1,r=new et({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Qi in this&&(r[Qi]=this[Qi]);const a=Symbol.for("lc:child_config"),s=((u=e.extra)==null?void 0:u[a])??this.extra[a];if(Xy(s)){const f={...s},p=Ky(f.callbacks)?(l=(c=f.callbacks).copy)==null?void 0:l.call(c):void 0;p&&(Object.assign(p,{_parentRunId:r.id}),(m=(h=(d=p.handlers)==null?void 0:d.find(rf))==null?void 0:h.updateFromRunTree)==null||m.call(h,r),f.callbacks=p),r.extra[a]=f}const i=new Set;let o=this;for(;o!=null&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),a){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){var u;const a=e.extra??{};if(a.runtime||(a.runtime={}),t)for(const[c,l]of Object.entries(t))a.runtime[c]||(a.runtime[c]=l);let s,i;return r?(i=(u=e.parent_run)==null?void 0:u.id,s=[]):(s=e.child_runs.map(c=>this._convertToCreate(c,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:a,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:s,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const t=ef(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e){Jh("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const a of this.child_runs)await a.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(){var e;try{const t={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:(e=this.parent_run)==null?void 0:e.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,t)}catch(t){console.error(`Error in patchRun for run ${this.id}`,t)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){var c,l,d,h;const r=e==null?void 0:e.callbacks;let a,s,i,o=Wy();if(r){const m=((c=r==null?void 0:r.getParentRunId)==null?void 0:c.call(r))??"",f=(l=r==null?void 0:r.handlers)==null?void 0:l.find(p=>(p==null?void 0:p.name)=="langchain_tracer");a=(d=f==null?void 0:f.getRun)==null?void 0:d.call(f,m),s=f==null?void 0:f.projectName,i=f==null?void 0:f.client,o=o||!!f}return a?new et({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:i,tracingEnabled:o,project_name:s,tags:[...new Set(((a==null?void 0:a.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(h=a==null?void 0:a.extra)==null?void 0:h.metadata,...e==null?void 0:e.metadata}}}).createChild(t):new et({...t,client:i,tracingEnabled:o,project_name:s})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){var c;const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||typeof a!="string")return;const s=a.trim(),i=s.split(".").map(l=>{const[d,h]=l.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=i[0].uuid,u={...t,name:(t==null?void 0:t.name)??"parent",run_type:(t==null?void 0:t.run_type)??"chain",start_time:(t==null?void 0:t.start_time)??Date.now(),id:(c=i.at(-1))==null?void 0:c.uuid,trace_id:o,dotted_order:s};if(r.baggage&&typeof r.baggage=="string"){const l=Zs.fromHeader(r.baggage);u.metadata=l.metadata,u.tags=l.tags}return new et(u)}toHeaders(e){var r;const t={"langsmith-trace":this.dotted_order,baggage:new Zs((r=this.extra)==null?void 0:r.metadata,this.tags).toHeader()};if(e)for(const[a,s]of Object.entries(t))e.set(a,s);return t}}Object.defineProperty(et,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function tf(n){return n!==void 0&&typeof n.createChild=="function"&&typeof n.postRun=="function"}function rf(n){return typeof n=="object"&&n!=null&&typeof n.name=="string"&&n.name==="langchain_tracer"}function fl(n){return Array.isArray(n)&&n.some(e=>rf(e))}function Ky(n){return typeof n=="object"&&n!=null&&Array.isArray(n.handlers)}function Xy(n){var e;return n!==void 0&&typeof n.callbacks=="object"&&(fl((e=n.callbacks)==null?void 0:e.handlers)||fl(n.callbacks))}let Yy=class{getStore(){}run(e,t){return t()}};const eo=Symbol.for("ls:tracing_async_local_storage"),Qy=new Yy;let eb=class{getInstance(){return globalThis[eo]??Qy}initializeGlobalInstance(e){globalThis[eo]===void 0&&(globalThis[eo]=e)}};const tb=new eb,rb=()=>{const n=tb.getInstance().getStore();if(!tf(n))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function and that tracing is enabled."].join(`
`));return n};function qu(n){return typeof n=="function"&&"langsmith:traceable"in n}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const nb=Object.prototype.hasOwnProperty;function Go(n,e){return nb.call(n,e)}function Ko(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Go(n,t)&&e.push(t);return e}function $t(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Xo(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function zr(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function ab(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function Yo(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(Yo(n[t]))return!0}else if(typeof n=="object"){const t=Ko(n),r=t.length;for(var e=0;e<r;e++)if(Yo(n[t[e]]))return!0}}return!1}function ml(n,e){const t=[n];for(const r in e){const a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}class sb extends Error{constructor(e,t,r,a,s){super(ml(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=ml(e,{name:t,index:r,operation:a,tree:s})}}const ye=sb,en={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Qo(t,this.path);r&&(r=$t(r));const a=ra(t,{op:"remove",path:this.from}).removed;return ra(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=Qo(t,this.from);return ra(t,{op:"add",path:this.path,value:$t(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:qs(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var ib={add:function(n,e,t){return Xo(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:en.move,copy:en.copy,test:en.test,_get:en._get};function Qo(n,e){if(e=="")return n;var t={op:"_get",path:e};return ra(n,t),t.value}function ra(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):eu(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Qo(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=qs(n,e.value),i.test===!1)throw new ye("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new ye("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=$t(n));const o=(e.path||"").split("/");let u=n,c=1,l=o.length,d,h,m;for(typeof t=="function"?m=t:m=eu;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=ab(h)),a&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&m(e,0,n,d)),c++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!Xo(h))throw new ye("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);Xo(h)&&(h=~~h)}if(c>=l){if(t&&e.op==="add"&&h>u.length)throw new ye("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);const f=ib[e.op].call(e,u,h,n);if(f.test===!1)throw new ye("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return f}}else if(c>=l){const f=en[e.op].call(e,u,h,n);if(f.test===!1)throw new ye("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return f}if(u=u[h],t&&c<l&&(!u||typeof u!="object"))throw new ye("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function Hs(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new ye("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=$t(n));const s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=ra(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function eu(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new ye("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(en[n.op]){if(typeof n.path!="string")throw new ye("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new ye('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new ye("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new ye("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&Yo(n.value))throw new ye("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new ye("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new ye("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=ob([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new ye("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new ye("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function ob(n,e,t){try{if(!Array.isArray(n))throw new ye("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Hs($t(e),$t(n),t||!0);else{t=t||eu;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof ye)return a;throw a}}function qs(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!qs(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!qs(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2013-2021 Joachim Wester
 * MIT license
 */function nf(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=Ko(e),i=Ko(n),o=!1,u=i.length-1;u>=0;u--){var c=i[u],l=n[c];if(Go(e,c)&&!(e[c]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof l=="object"&&l!=null&&typeof d=="object"&&d!=null&&Array.isArray(l)===Array.isArray(d)?nf(l,d,t,r+"/"+zr(c),a):l!==d&&(a&&t.push({op:"test",path:r+"/"+zr(c),value:$t(l)}),t.push({op:"replace",path:r+"/"+zr(c),value:$t(d)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+zr(c),value:$t(l)}),t.push({op:"remove",path:r+"/"+zr(c)}),o=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}))}if(!(!o&&s.length==i.length))for(var u=0;u<s.length;u++){var c=s[u];!Go(n,c)&&e[c]!==void 0&&t.push({op:"add",path:r+"/"+zr(c),value:$t(e[c])})}}}function ub(n,e,t=!1){var r=[];return nf(n,e,r,"",t),r}var to={};const cb=()=>typeof window<"u"&&typeof window.document<"u",lb=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",db=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Vu=()=>typeof Deno<"u",hb=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Vu(),af=()=>{let n;return cb()?n="browser":hb()?n="node":lb()?n="webworker":db()?n="jsdom":Vu()?n="deno":n="other",n};let ro;async function fb(){return ro===void 0&&(ro={library:"langchain-js",runtime:af()}),ro}function ke(n){try{return typeof process<"u"?to==null?void 0:to[n]:Vu()?Deno==null?void 0:Deno.env.get(n):void 0}catch{return}}class mb{}function pb(n){return"lc_prefer_streaming"in n&&n.lc_prefer_streaming}class ja extends mb{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,kh(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:ke("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Ir.prototype.toJSON.call(this)}toJSONNotImplemented(){return Ir.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends ja{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Be()}),Object.assign(this,e)}}return new t}}const gb=n=>{const e=n;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"};function no(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function _b(n){return n.replace(/[-:.]/g,"")}function yb(n,e,t){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return _b(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}function Rn(n){return typeof n._addRunToRunMap=="function"}class La extends ja{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=yb(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){const a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,s,i,o,u){const c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,a,s,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,a,s,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onLLMStart)==null?void 0:d.call(this,c)),c}_createRunForChatModelStart(e,t,r,a,s,i,o,u){const c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,a,s,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,a,s,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onLLMStart)==null?void 0:d.call(this,c)),c}async handleLLMEnd(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...s},await((o=this.onLLMEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleLLMError(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...s},await((o=this.onLLMError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForChainStart(e,t,r,a,s,i,o,u){const c=this._getExecutionOrder(a),l=Date.now(),d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,r,a,s,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForChainStart(e,t,r,a,s,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onChainStart)==null?void 0:d.call(this,c)),c}async handleChainEnd(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=no(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=no(s.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=no(s.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForToolStart(e,t,r,a,s,i,o){const u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,r,a,s,i,o){var c,l;const u=this.runMap.get(r)??this._createRunForToolStart(e,t,r,a,s,i,o);return await((c=this.onRunCreate)==null?void 0:c.call(this,u)),await((l=this.onToolStart)==null?void 0:l.call(this,u)),u}async handleToolEnd(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onToolEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onToolError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentAction)==null?void 0:s.call(this,r))}async handleAgentEnd(e,t){var a;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentEnd)==null?void 0:a.call(this,r)))}_createRunForRetrieverStart(e,t,r,a,s,i,o){const u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,r,a,s,i,o){var c,l;const u=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,a,s,i,o);return await((c=this.onRunCreate)==null?void 0:c.call(this,u)),await((l=this.onRetrieverStart)==null?void 0:l.call(this,u)),u}async handleRetrieverEnd(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var a;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((a=this.onText)==null?void 0:a.call(this,r)))}async handleLLMNewToken(e,t,r,a,s,i){var u;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}}var Wu={exports:{}};Wu.exports;(function(n){const t=(s=0)=>i=>`\x1B[${38+s};5;${i}m`,r=(s=0)=>(i,o,u)=>`\x1B[${38+s};2;${i};${o};${u}m`;function a(){const s=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,u]of Object.entries(i)){for(const[c,l]of Object.entries(u))i[c]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},u[c]=i[c],s.set(l[0],l[1]);Object.defineProperty(i,o,{value:u,enumerable:!1})}return Object.defineProperty(i,"codes",{value:s,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=t(),i.color.ansi16m=r(),i.bgColor.ansi256=t(10),i.bgColor.ansi16m=r(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,u,c)=>o===u&&u===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:c}=u.groups;c.length===3&&(c=c.split("").map(d=>d+d).join(""));const l=Number.parseInt(c,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(n,"exports",{enumerable:!0,get:a})})(Wu);var bb=Wu.exports;const sf=cu(bb);function De(n,e){return`${n.open}${e}${n.close}`}function it(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function pl(n){return typeof n=="string"?n.trim():n==null?n:it(n,n.toString())}function er(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:He}=sf;class gl extends La{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{const o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?De(sf.bold,o):o}).join(" > ");return De(He.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.green,"[chain/start]")} [${t}] Entering Chain run with input: ${it(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.cyan,"[chain/end]")} [${t}] [${er(e)}] Exiting Chain run with output: ${it(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.red,"[chain/error]")} [${t}] [${er(e)}] Chain run errored with error: ${it(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${De(He.green,"[llm/start]")} [${t}] Entering LLM run with input: ${it(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.cyan,"[llm/end]")} [${t}] [${er(e)}] Exiting LLM run with output: ${it(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.red,"[llm/error]")} [${t}] [${er(e)}] LLM run errored with error: ${it(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.green,"[tool/start]")} [${t}] Entering Tool run with input: "${pl(e.inputs.input)}"`)}onToolEnd(e){var r;const t=this.getBreadcrumbs(e);console.log(`${De(He.cyan,"[tool/end]")} [${t}] [${er(e)}] Exiting Tool run with output: "${pl((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.red,"[tool/error]")} [${t}] [${er(e)}] Tool run errored with error: ${it(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${it(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.cyan,"[retriever/end]")} [${t}] [${er(e)}] Exiting Retriever run with output: ${it(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${De(He.red,"[retriever/error]")} [${t}] [${er(e)}] Retriever run errored with error: ${it(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${De(He.blue,"[agent/action]")} [${r}] Agent selected action: ${it(t.actions[t.actions.length-1],"[action]")}`)}}let ao;const wb=()=>{if(ao===void 0){const n=ke("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};ao=new Ea(n)}return ao};class na extends La{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??ke("LANGCHAIN_PROJECT")??ke("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??wb();const s=na.getTraceableRunTree();s&&this.updateFromRunTree(s)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await fb()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id,extra:e.extra};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e;const r=new Set;for(;t.parent_run&&!(r.has(t.id)||(r.add(t.id),!t.parent_run));)t=t.parent_run;r.clear();const a=[t];for(;a.length>0;){const s=a.shift();!s||r.has(s.id)||(r.add(s.id),this.runMap.set(s.id,s),s.child_runs&&a.push(...s.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const t={},r=[];for(const[a,s]of this.runMap){const i=new et({...s,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[a]=i,r.push([a,s.dotted_order])}r.sort((a,s)=>!a[1]||!s[1]?0:a[1].localeCompare(s[1]));for(const[a]of r){const s=this.runMap.get(a),i=t[a];if(!(!s||!i)&&s.parent_run_id){const o=t[s.parent_run_id];o&&(o.child_runs.push(i),i.parent_run=o)}}return t[e]}static getTraceableRunTree(){try{return rb()}catch{return}}}const of=Symbol.for("ls:tracing_async_local_storage"),Os=Symbol.for("lc:context_variables"),vb=n=>{globalThis[of]=n},Sa=()=>globalThis[of];let aa;function xb(){const n="default"in Vt?Vt.default:Vt;return new n({autoStart:!0,concurrency:1})}function Eb(){return typeof aa>"u"&&(aa=xb()),aa}async function Ee(n,e){if(e===!0){const t=Sa();t!==void 0?await t.run(void 0,async()=>n()):await n()}else aa=Eb(),aa.add(async()=>{const t=Sa();t!==void 0?await t.run(void 0,async()=>n()):await n()})}const Sb=n=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>ke(t)==="true");function uf(n){var r;const e=Sa();if(e===void 0)return;const t=e.getStore();return(r=t==null?void 0:t[Os])==null?void 0:r[n]}const Ab=Symbol("lc:configure_hooks"),kb=()=>uf(Ab)||[];class Pb{setHandler(e){return this.setHandlers([e])}}class Ei{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,t,this.runId,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}}class Ob extends Ei{getChild(e){const t=new Ve(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw a}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`),t.raiseError)throw e}},t.awaitHandlers)))}}class _l extends Ei{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>Ee(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`),o.raiseError)throw c}},o.awaitHandlers)))}async handleLLMError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleLLMEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}}class Tb extends Ei{getChild(e){const t=new Ve(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}}class Ib extends Ei{getChild(e){const t=new Ve(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}}class Ve extends Pb{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(t==null?void 0:t.handlers)??this.handlers,this.inheritableHandlers=(t==null?void 0:t.inheritableHandlers)??this.inheritableHandlers,this.tags=(t==null?void 0:t.tags)??this.tags,this.inheritableTags=(t==null?void 0:t.inheritableTags)??this.inheritableTags,this.metadata=(t==null?void 0:t.metadata)??this.metadata,this.inheritableMetadata=(t==null?void 0:t.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{const d=l===0&&r?r:Be();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return Rn(h)&&h._createRunForLLMStart(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u),Ee(async()=>{var m;try{await((m=h.handleLLMStart)==null?void 0:m.call(h,e,[c],d,this._parentRunId,s,this.tags,this.metadata,u))}catch(f){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${f}`),h.raiseError)throw f}},h.awaitHandlers)})),new _l(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{const d=l===0&&r?r:Be();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return Rn(h)&&h._createRunForChatModelStart(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u),Ee(async()=>{var m,f;try{if(h.handleChatModelStart)await((m=h.handleChatModelStart)==null?void 0:m.call(h,e,[c],d,this._parentRunId,s,this.tags,this.metadata,u));else if(h.handleLLMStart){const p=Th(c);await((f=h.handleLLMStart)==null?void 0:f.call(h,e,[p],d,this._parentRunId,s,this.tags,this.metadata,u))}}catch(p){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`),h.raiseError)throw p}},h.awaitHandlers)})),new _l(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=Be(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return Rn(u)&&u._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,o),Ee(async()=>{var c;try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,a,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Tb(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=Be(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return Rn(u)&&u._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),Ee(async()=>{var c;try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Ib(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=Be(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return Rn(u)&&u._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),Ee(async()=>{var c;try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Ob(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ee(async()=>{var o;if(!i.ignoreCustomEvent)try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,t,r,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new Ve(this._parentRunId);for(const a of this.handlers){const s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(const a of this.tags){const s=this.inheritableTags.includes(a);r.addTags([a],s)}for(const a of Object.keys(this.metadata)){const s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(const a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends ja{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Be()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static configure(e,t,r,a,s,i,o){return this._configureSync(e,t,r,a,s,i,o)}static _configureSync(e,t,r,a,s,i,o){var h,m;let u;(e||t)&&(Array.isArray(e)||!e?(u=new Ve,u.setHandlers((e==null?void 0:e.map(Vs))??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(Vs):t==null?void 0:t.handlers,!1));const c=ke("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=((h=na.getTraceableRunTree())==null?void 0:h.tracingEnabled)||Sb(),d=l||(ke("LANGCHAIN_TRACING")??!1);if(c||d){if(u||(u=new Ve),c&&!u.handlers.some(f=>f.name===gl.prototype.name)){const f=new gl;u.addHandler(f,!0)}if(d&&!u.handlers.some(f=>f.name==="langchain_tracer")&&l){const f=new na;u.addHandler(f,!0),u._parentRunId=((m=na.getTraceableRunTree())==null?void 0:m.id)??u._parentRunId}}for(const{contextVar:f,inheritable:p=!0,handlerClass:g,envVar:b}of kb()){const w=b&&ke(b)==="true"&&g;let _;const v=f!==void 0?uf(f):void 0;v&&gb(v)?_=v:w&&(_=new g({})),_!==void 0&&(u||(u=new Ve),u.handlers.some(S=>S.name===_.name)||u.addHandler(_,p))}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}}function Vs(n){return"name"in n?n:ja.fromMethods(n)}class Rb{getStore(){}run(e,t){return t()}enterWith(e){}}const Cb=new Rb,yl=Symbol.for("lc:child_config");class $b{getInstance(){return Sa()??Cb}getRunnableConfig(){var t,r;return(r=(t=this.getInstance().getStore())==null?void 0:t.extra)==null?void 0:r[yl]}runWithConfig(e,t,r){var l;const a=Ve._configureSync(e==null?void 0:e.callbacks,void 0,e==null?void 0:e.tags,void 0,e==null?void 0:e.metadata),s=this.getInstance(),i=s.getStore(),o=a==null?void 0:a.getParentRunId(),u=(l=a==null?void 0:a.handlers)==null?void 0:l.find(d=>(d==null?void 0:d.name)==="langchain_tracer");let c;return u&&o?c=u.convertToRunTree(o):r||(c=new et({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[yl]:e}),i!==void 0&&i[Os]!==void 0&&(c===void 0&&(c={}),c[Os]=i[Os]),s.run(c,t)}initializeGlobalInstance(e){Sa()===void 0&&vb(e)}}const dr=new $b,so=25;async function xt(n){return Ve._configureSync(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function bl(...n){const e={};for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){const a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(r==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(r==="callbacks"){const a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{const i=a.copy();for(const o of s)i.addHandler(Vs(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){const i=s.copy();for(const o of a)i.addHandler(Vs(o),!0);e.callbacks=i}else e.callbacks=new Ve(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{const a=r;e[a]=t[a]??e[a]}return e}const Nb=new Set(["string","number","boolean"]);function ce(n){var r;const e=dr.getRunnableConfig();let t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:a,runName:s,...i}=e;t=Object.entries(i).reduce((o,[u,c])=>(c!==void 0&&(o[u]=c),o),t)}if(n&&(t=Object.entries(n).reduce((a,[s,i])=>(i!==void 0&&(a[s]=i),a),t)),t!=null&&t.configurable)for(const a of Object.keys(t.configurable))Nb.has(typeof t.configurable[a])&&!((r=t.metadata)!=null&&r[a])&&(t.metadata||(t.metadata={}),t.metadata[a]=t.configurable[a]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");const a=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,a])):t.signal=a,delete t.timeout}return t}function je(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){const o=ce(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}function pn(n){return n?{configurable:n.configurable,recursionLimit:n.recursionLimit,callbacks:n.callbacks,tags:n.tags,metadata:n.metadata,maxConcurrency:n.maxConcurrency,timeout:n.timeout,signal:n.signal}:void 0}async function hr(n,e){if(e===void 0)return n;let t;return Promise.race([n.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,a)=>{t=()=>{a(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&a(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}class nt extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new nt({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new nt({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function cf(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){const s=await n.next();for(const i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function Et(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Et(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class kn{constructor(e){var t;Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??((t=this.config)==null?void 0:t.signal),this.setup=new Promise((r,a)=>{dr.runWithConfig(pn(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(r,a):this.firstResult.then(s=>r(void 0),a)},!0)})}async next(...e){var t;return(t=this.signal)==null||t.throwIfAborted(),this.firstResultUsed?dr.runWithConfig(pn(this.config),this.signal?async()=>hr(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function jb(n,e,t,r,...a){const s=new kn({generator:e,startSetup:t,signal:r}),i=await s.setup;return{output:n(s,i,...a),setup:i}}class ar{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=Hs({},t);return new Aa({ops:t,state:r[r.length-1].newDocument})}}class Aa extends ar{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=Hs(this.state,e.ops);return new Aa({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=Hs({},e.ops);return new Aa({ops:e.ops,state:t[t.length-1].newDocument})}}const Lb=n=>n.name==="log_stream_tracer";async function wl(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function vl(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function Mb(n){return n!==void 0&&n.message!==void 0}class xl extends La{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=nt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>{var s;return(s=this.includeTags)==null?void 0:s.includes(a)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>{var s;return!((s=this.excludeTags)!=null&&s.includes(a))})),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const a=this.keyMapByRunId[e];a&&await this.writer.write(new ar({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var a;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new ar({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await wl(e,this._schemaFormat)),await this.writer.write(new ar({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await wl(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await vl(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new ar({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new ar({ops:[{op:"replace",path:"/final_output",value:await vl(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const a=this.keyMapByRunId[e.id];if(a===void 0)return;const s=e.inputs.messages!==void 0;let i;s?Mb(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new xe({id:`run-${e.id}`,content:t}):i=t;const o=new ar({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}}const El="__run";class gn{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new gn({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class fr extends gn{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new fr({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function Qa({name:n,serialized:e}){return n!==void 0?n:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const Fb=n=>n.name==="event_stream_tracer";class Db extends La{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=nt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>{var s;return(s=this.includeTags)==null?void 0:s.includes(a)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>{var s;return!((s=this.excludeTags)!=null&&s.includes(a))})),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}function s(o,u){return o==="llm"&&typeof u=="string"?new gn({text:u}):u}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(u=>{o=u}),this.tappedPromises.set(e,i);try{const u={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...u,data:{chunk:s(a.runType,r.value)}},a),yield r.value;for await(const c of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...u,data:{chunk:s(a.runType,c)}},a),yield c}finally{o()}}else{yield r.value;for await(const o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){var i,o;const t=Qa(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);const s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},a)}async onLLMNewToken(e,t,r){const a=this.runInfoMap.get(e.id);let s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(a.runType==="chat_model")i="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?s=new xe({content:t,id:`run-${e.id}`}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",(r==null?void 0:r.chunk)===void 0?s=new gn({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}}async onLLMEnd(e){var i,o,u;const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const a=(i=e.outputs)==null?void 0:i.generations;let s;if(t.runType==="chat_model"){for(const c of a??[]){if(s!==void 0)break;s=(o=c[0])==null?void 0:o.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a==null?void 0:a.map(c=>c.map(l=>({text:l.text,generationInfo:l.generationInfo}))),llmOutput:((u=e.outputs)==null?void 0:u.llmOutput)??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){var i,o;const t=Qa(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:t,runType:e.run_type};let s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},a)}async onChainEnd(e){var o;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){var a,s;const t=Qa(e),r={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{}},r)}async onToolEnd(e){var a;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=((a=e.outputs)==null?void 0:a.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){var s,i;const t=Qa(e),a={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:((i=e.extra)==null?void 0:i.metadata)??{}},a)}async onRetrieverEnd(e){var r;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((r=e.outputs)==null?void 0:r.documents)??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}const Ub=[400,401,402,403,404,405,406,407,409],Bb=n=>{var t,r;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=((t=n==null?void 0:n.response)==null?void 0:t.status)??(n==null?void 0:n.status);if(e&&Ub.includes(+e))throw n;if(((r=n==null?void 0:n.error)==null?void 0:r.code)==="insufficient_quota"){const a=new Error(n==null?void 0:n.message);throw a.name="InsufficientQuotaError",a}};class Ju{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Bb;const t="default"in Vt?Vt.default:Vt;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Bs(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}class lf extends La{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function Gu(n){return n?n.lc_runnable:!1}class zb{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}}const Zb=Symbol("Let zodToJsonSchema decide on which parser to use"),Hb={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},qb=n=>({...Hb,...n}),Vb=n=>{const e=qb(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function df(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function de(n,e,t,r,a){n[e]=t,df(n,e,r,a)}function Wb(){return{}}function Jb(n,e){var r,a,s;const t={type:"array"};return(r=n.type)!=null&&r._def&&((s=(a=n.type)==null?void 0:a._def)==null?void 0:s.typeName)!==x.ZodAny&&(t.items=le(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&de(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&de(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(de(t,"minItems",n.exactLength.value,n.exactLength.message,e),de(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Gb(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?de(t,"minimum",r.value,r.message,e):de(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),de(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?de(t,"maximum",r.value,r.message,e):de(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),de(t,"maximum",r.value,r.message,e));break;case"multipleOf":de(t,"multipleOf",r.value,r.message,e);break}return t}function Kb(){return{type:"boolean"}}function hf(n,e){return le(n.type._def,e)}const Xb=(n,e)=>le(n.innerType._def,e);function ff(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>ff(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Yb(n,e)}}const Yb=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":de(t,"minimum",r.value,r.message,e);break;case"max":de(t,"maximum",r.value,r.message,e);break}return t};function Qb(n,e){return{...le(n.innerType._def,e),default:n.defaultValue()}}function ew(n,e){return e.effectStrategy==="input"?le(n.schema._def,e):{}}function tw(n){return{type:"string",enum:Array.from(n.values)}}const rw=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function nw(n,e){const t=[le(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),le(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(s=>{if(rw(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){const{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function aw(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let io;const ct={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(io===void 0&&(io=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),io),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function mf(n,e){const t={type:"string"};if(n.checks)for(const r of n.checks)switch(r.kind){case"min":de(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":de(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":lt(t,"email",r.message,e);break;case"format:idn-email":lt(t,"idn-email",r.message,e);break;case"pattern:zod":Ue(t,ct.email,r.message,e);break}break;case"url":lt(t,"uri",r.message,e);break;case"uuid":lt(t,"uuid",r.message,e);break;case"regex":Ue(t,r.regex,r.message,e);break;case"cuid":Ue(t,ct.cuid,r.message,e);break;case"cuid2":Ue(t,ct.cuid2,r.message,e);break;case"startsWith":Ue(t,RegExp(`^${oo(r.value,e)}`),r.message,e);break;case"endsWith":Ue(t,RegExp(`${oo(r.value,e)}$`),r.message,e);break;case"datetime":lt(t,"date-time",r.message,e);break;case"date":lt(t,"date",r.message,e);break;case"time":lt(t,"time",r.message,e);break;case"duration":lt(t,"duration",r.message,e);break;case"length":de(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),de(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":{Ue(t,RegExp(oo(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&lt(t,"ipv4",r.message,e),r.version!=="v4"&&lt(t,"ipv6",r.message,e);break}case"base64url":Ue(t,ct.base64url,r.message,e);break;case"jwt":Ue(t,ct.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&Ue(t,ct.ipv4Cidr,r.message,e),r.version!=="v4"&&Ue(t,ct.ipv6Cidr,r.message,e);break}case"emoji":Ue(t,ct.emoji(),r.message,e);break;case"ulid":{Ue(t,ct.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{lt(t,"binary",r.message,e);break}case"contentEncoding:base64":{de(t,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{Ue(t,ct.base64,r.message,e);break}}break}case"nanoid":Ue(t,ct.nanoid,r.message,e)}return t}function oo(n,e){return e.patternStrategy==="escape"?iw(n):n}const sw=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function iw(n){let e="";for(let t=0;t<n.length;t++)sw.has(n[t])||(e+="\\"),e+=n[t];return e}function lt(n,e,t,r){var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):de(n,"format",e,t,r)}function Ue(n,e,t,r){var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Sl(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):de(n,"pattern",Sl(e,r),t,r)}function Sl(n,e){var u;if(!e.applyRegexFlags||!n.flags)return n.source;const t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source;let a="",s=!1,i=!1,o=!1;for(let c=0;c<r.length;c++){if(s){a+=r[c],s=!1;continue}if(t.i){if(i){if(r[c].match(/[a-z]/)){o?(a+=r[c],a+=`${r[c-2]}-${r[c]}`.toUpperCase(),o=!1):r[c+1]==="-"&&((u=r[c+2])!=null&&u.match(/[a-z]/))?(a+=r[c],o=!0):a+=`${r[c]}${r[c].toUpperCase()}`;continue}}else if(r[c].match(/[a-z]/)){a+=`[${r[c]}${r[c].toUpperCase()}]`;continue}}if(t.m){if(r[c]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[c]==="$"){a+=`($|(?=[\r
]))`;continue}}if(t.s&&r[c]==="."){a+=i?`${r[c]}\r
`:`[${r[c]}\r
]`;continue}a+=r[c],r[c]==="\\"?s=!0:i&&r[c]==="]"?i=!1:!i&&r[c]==="["&&(i=!0)}try{new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a}function pf(n,e){var r,a,s,i,o,u;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===x.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((c,l)=>({...c,[l]:le(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??{}}),{}),additionalProperties:e.rejectedAdditionalProperties};const t={type:"object",additionalProperties:le(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===x.ZodString&&((s=n.keyType._def.checks)!=null&&s.length)){const{type:c,...l}=mf(n.keyType._def,e);return{...t,propertyNames:l}}else{if(((i=n.keyType)==null?void 0:i._def.typeName)===x.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(((o=n.keyType)==null?void 0:o._def.typeName)===x.ZodBranded&&n.keyType._def.type._def.typeName===x.ZodString&&((u=n.keyType._def.type._def.checks)!=null&&u.length)){const{type:c,...l}=hf(n.keyType._def,e);return{...t,propertyNames:l}}}return t}function ow(n,e){if(e.mapStrategy==="record")return pf(n,e);const t=le(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=le(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function uw(n){const e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function cw(){return{not:{}}}function lw(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Ws={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function dw(n,e){if(e.target==="openApi3")return Al(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Ws&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((a,s)=>{const i=Ws[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((a,s)=>{const i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){const a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Al(n,e)}const Al=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>le(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function hw(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Ws[n.innerType._def.typeName],nullable:!0}:{type:[Ws[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=le(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=le(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function fw(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",df(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?de(t,"minimum",r.value,r.message,e):de(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),de(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?de(t,"maximum",r.value,r.message,e):de(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),de(t,"maximum",r.value,r.message,e));break;case"multipleOf":de(t,"multipleOf",r.value,r.message,e);break}return t}function mw(n,e){const t=e.target==="openAi",r={type:"object",properties:{}},a=[],s=n.shape();for(const o in s){let u=s[o];if(u===void 0||u._def===void 0)continue;let c=gw(u);c&&t&&(u instanceof vt&&(u=u._def.innerType),u.isNullable()||(u=u.nullable()),c=!1);const l=le(u._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});l!==void 0&&(r.properties[o]=l,c||a.push(o))}a.length&&(r.required=a);const i=pw(n,e);return i!==void 0&&(r.additionalProperties=i),r}function pw(n,e){if(n.catchall._def.typeName!=="ZodNever")return le(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(n.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function gw(n){try{return n.isOptional()}catch{return!0}}const _w=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return le(n.innerType._def,e);const t=le(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},yw=(n,e)=>{if(e.pipeStrategy==="input")return le(n.in._def,e);if(e.pipeStrategy==="output")return le(n.out._def,e);const t=le(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=le(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function bw(n,e){return le(n.type._def,e)}function ww(n,e){const r={type:"array",uniqueItems:!0,items:le(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&de(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&de(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function vw(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>le(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:le(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>le(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function xw(){return{not:{}}}function Ew(){return{}}const Sw=(n,e)=>le(n.innerType._def,e),Aw=(n,e,t)=>{switch(e){case x.ZodString:return mf(n,t);case x.ZodNumber:return fw(n,t);case x.ZodObject:return mw(n,t);case x.ZodBigInt:return Gb(n,t);case x.ZodBoolean:return Kb();case x.ZodDate:return ff(n,t);case x.ZodUndefined:return xw();case x.ZodNull:return lw(t);case x.ZodArray:return Jb(n,t);case x.ZodUnion:case x.ZodDiscriminatedUnion:return dw(n,t);case x.ZodIntersection:return nw(n,t);case x.ZodTuple:return vw(n,t);case x.ZodRecord:return pf(n,t);case x.ZodLiteral:return aw(n,t);case x.ZodEnum:return tw(n);case x.ZodNativeEnum:return uw(n);case x.ZodNullable:return hw(n,t);case x.ZodOptional:return _w(n,t);case x.ZodMap:return ow(n,t);case x.ZodSet:return ww(n,t);case x.ZodLazy:return()=>n.getter()._def;case x.ZodPromise:return bw(n,t);case x.ZodNaN:case x.ZodNever:return cw();case x.ZodEffects:return ew(n,t);case x.ZodAny:return Wb();case x.ZodUnknown:return Ew();case x.ZodDefault:return Qb(n,t);case x.ZodBranded:return hf(n,t);case x.ZodReadonly:return Sw(n,t);case x.ZodCatch:return Xb(n,t);case x.ZodPipeline:return yw(n,t);case x.ZodFunction:case x.ZodVoid:case x.ZodSymbol:return;default:return(r=>{})()}};function le(n,e,t=!1){var o;const r=e.seen.get(n);if(e.override){const u=(o=e.override)==null?void 0:o.call(e,n,e,r,t);if(u!==Zb)return u}if(r&&!t){const u=kw(r,e);if(u!==void 0)return u}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const s=Aw(n,n.typeName,e),i=typeof s=="function"?le(s(),e):s;if(i&&Ow(n,e,i),e.postProcess){const u=e.postProcess(i,n,e);return a.jsonSchema=i,u}return a.jsonSchema=i,i}const kw=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:Pw(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Pw=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Ow=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),jr=(n,e)=>{const t=Vb(e),r=void 0,a=e==null?void 0:e.name,s=le(n._def,t,!1)??{},i=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function uo(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}const Tw=["*","_","`"];function Iw(n){let e="";for(const[t,r]of Object.entries(n))e+=`	classDef ${t} ${r};
`;return e}function Rw(n,e,t){const{firstNode:r,lastNode:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{};let c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){const m="default",f={[m]:"{0}({1})"};r!==void 0&&(f[r]="{0}([{1}]):::first"),a!==void 0&&(f[a]="{0}([{1}]):::last");for(const[p,g]of Object.entries(n)){const b=g.name.split(":").pop()??"";let _=Tw.some(S=>b.startsWith(S)&&b.endsWith(S))?`<p>${b}</p>`:b;Object.keys(g.metadata??{}).length&&(_+=`<hr/><small><em>${Object.entries(g.metadata??{}).map(([S,P])=>`${S} = ${P}`).join(`
`)}</em></small>`);const v=(f[p]??f[m]).replace("{0}",uo(p)).replace("{1}",_);c+=`	${v}
`}}const l={};for(const m of e){const f=m.source.split(":"),p=m.target.split(":"),g=f.filter((b,w)=>b===p[w]).join(":");l[g]||(l[g]=[]),l[g].push(m)}const d=new Set;function h(m,f){const p=m.length===1&&m[0].source===m[0].target;if(f&&!p){const g=f.split(":").pop();if(d.has(g))throw new Error(`Found duplicate subgraph '${g}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(g),c+=`	subgraph ${g}
`}for(const g of m){const{source:b,target:w,data:_,conditional:v}=g;let S="";if(_!==void 0){let P=_;const O=P.split(" ");O.length>u&&(P=Array.from({length:Math.ceil(O.length/u)},(H,re)=>O.slice(re*u,(re+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),S=v?` -. &nbsp;${P}&nbsp; .-> `:` -- &nbsp;${P}&nbsp; --> `}else S=v?" -.-> ":" --> ";c+=`	${uo(b)}${S}${uo(w)};
`}for(const g in l)g.startsWith(`${f}:`)&&g!==f&&h(l[g],g);f&&!p&&(c+=`	end
`)}h(l[""]??[],"");for(const m in l)!m.includes(":")&&m!==""&&h(l[m],m);return i&&(c+=Iw(s??{})),c}async function Cw(n,e){let{backgroundColor:t="white"}=e??{};const r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));const a=`https://mermaid.ink/img/${r}?bgColor=${t}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}function $w(n,e){if(n!==void 0&&!ea(n))return n;if(Gu(e))try{let t=e.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t}catch{return e.getName()}else return e.name??"UnknownSchema"}function Nw(n){return Gu(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...jr(n.data.schema),title:n.data.name}}}class Si{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=ea(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...Nw(t)})),edges:this.edges.map(t=>{const r={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(r.data=t.data),typeof t.conditional<"u"&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const a=t??Be(),s={id:a,data:e,name:$w(t,e),metadata:r};return this.nodes[a]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const s={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(s),s}firstNode(){return kl(this)}lastNode(){return Pl(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(c=>c.id).every(ea)&&(r="");const s=c=>r?`${r}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[s(c)]={...l,id:s(c)}});const i=e.edges.map(c=>({...c,source:s(c.source),target:s(c.target)}));this.edges=[...this.edges,...i];const o=e.firstNode(),u=e.lastNode();return[o?{id:s(o.id),data:o.data}:void 0,u?{id:s(u.id),data:u.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&kl(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&Pl(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(a=>[a.id,a.name])),t=new Map;Object.values(e).forEach(a=>{t.set(a,(t.get(a)||0)+1)});const r=a=>{const s=e[a];return ea(a)&&t.get(s)===1?s:a};return new Si({nodes:Object.fromEntries(Object.entries(this.nodes).map(([a,s])=>[r(a),{...s,id:r(a)}])),edges:this.edges.map(a=>({...a,source:r(a.source),target:r(a.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:s}=e??{},i=this.reid(),o=i.firstNode(),u=i.lastNode();return Rw(i.nodes,i.edges,{firstNode:o==null?void 0:o.id,lastNode:u==null?void 0:u.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:s})}async drawMermaidPng(e){const t=this.drawMermaid(e);return Cw(t,{backgroundColor:e==null?void 0:e.backgroundColor})}}function kl(n,e=[]){const t=new Set(n.edges.filter(a=>!e.includes(a.source)).map(a=>a.target)),r=[];for(const a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function Pl(n,e=[]){const t=new Set(n.edges.filter(a=>!e.includes(a.target)).map(a=>a.source)),r=[];for(const a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function jw(n){const e=new TextEncoder,t=new ReadableStream({async start(r){for await(const a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return nt.fromReadableStream(t)}function Ol(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}const Lw=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function tu(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*Tl(n,e){for(;;){const{value:t,done:r}=dr.runWithConfig(pn(n),e.next.bind(e),!0);if(r)break;yield t}}async function*ru(n,e){const t=e[Symbol.asyncIterator]();for(;;){const{value:r,done:a}=await dr.runWithConfig(pn(n),t.next.bind(e),!0);if(a)break;yield r}}function Pe(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class Oe extends Ir{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Tr({bound:this,kwargs:e,config:{}})}map(){return new Js({bound:this})}withRetry(e){return new Mw({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Tr({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new Dw({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(ce);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>ce(s===0?e:r))}return Array.from({length:t},()=>ce(e))}async batch(e,t,r){var u;const a=this._getOptionsList(t??{},e.length),s=((u=a[0])==null?void 0:u.maxConcurrency)??(r==null?void 0:r.maxConcurrency),i=new Ju({maxConcurrency:s,onFailedAttempt:c=>{throw c}}),o=e.map((c,l)=>i.call(async()=>{try{return await this.invoke(c,a[l])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=ce(t),a=new kn({generator:this._streamIterator(e,r),config:r});return await a.setup,nt.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=ce(e):t=ce({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const a=ce(r),s=await xt(a),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),Pe(t,"input"),a.runId,a==null?void 0:a.runType,void 0,void 0,(a==null?void 0:a.runName)??this.getName()));delete a.runId;let o;try{const u=e.call(this,t,a,i);o=await hr(u,r==null?void 0:r.signal)}catch(u){throw await(i==null?void 0:i.handleChainError(u)),u}return await(i==null?void 0:i.handleChainEnd(Pe(o,"output"))),o}async _batchWithConfig(e,t,r,a){var c;const s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(xt)),o=await Promise.all(i.map(async(l,d)=>{const h=await(l==null?void 0:l.handleChainStart(this.toJSON(),Pe(t[d],"input"),s[d].runId,s[d].runType,void 0,void 0,s[d].runName??this.getName()));return delete s[d].runId,h}));let u;try{const l=e.call(this,t,s,o,a);u=await hr(l,(c=s==null?void 0:s[0])==null?void 0:c.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(Pe(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0;const u=ce(r),c=await xt(u);async function*l(){for await(const h of e){if(s)if(a===void 0)a=h;else try{a=Et(a,h)}catch{a=void 0,s=!1}yield h}}let d;try{const h=await jb(t.bind(this),l(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),r==null?void 0:r.signal,u);delete u.runId,d=h.setup;const m=d==null?void 0:d.handlers.find(Fb);let f=h.output;m!==void 0&&d!==void 0&&(f=m.tapOutputIterable(d.runId,f));const p=d==null?void 0:d.handlers.find(Lb);p!==void 0&&d!==void 0&&(f=p.tapOutputIterable(d.runId,f));for await(const g of f)if(yield g,o)if(i===void 0)i=g;else try{i=Et(i,g)}catch{i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:Pe(a,"input")})),h}await(d==null?void 0:d.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:Pe(a,"input")}))}getGraph(e){const t=new Si,r=t.addNode({name:`${this.getName()}Input`,schema:Pr.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:Pr.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new Nt({first:this,last:Ar(e)})}pick(e){return this.pipe(new Uw(e))}assign(e){return this.pipe(new gf(new Pn({steps:e})))}async*transform(e,t){let r;for await(const a of e)r===void 0?r=a:r=Et(r,a);yield*this._streamIterator(r,ce(t))}async*streamLog(e,t,r){const a=new xl({...r,autoClose:!1,_schemaFormat:"original"}),s=ce(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){const{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{const u=a.copy();u.addHandler(t,!0),r.callbacks=u}const s=this.stream(e,r);async function i(){try{const u=await s;for await(const c of u){const l=new ar({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}const o=i();try{for await(const u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?jw(a):nt.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){var f;const a=new Db({...r,autoClose:!1}),s=ce(t),i=s.runId??Be();s.runId=i;const o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{const p=o.copy();p.addHandler(a,!0),s.callbacks=p}const u=new AbortController,c=this;async function l(){try{let p;t!=null&&t.signal?"any"in AbortSignal?p=AbortSignal.any([u.signal,t.signal]):(p=t.signal,t.signal.addEventListener("abort",()=>{u.abort()},{once:!0})):p=u.signal;const g=await c.stream(e,{...s,signal:p}),b=a.tapOutputIterable(i,g);for await(const w of b)if(u.signal.aborted)break}finally{await a.finish()}}const d=l();let h=!1,m;try{for await(const p of a){if(!h){p.data.input=e,h=!0,m=p.run_id,yield p;continue}p.run_id===m&&p.event.endsWith("_end")&&(f=p.data)!=null&&f.input&&delete p.data.input,yield p}}finally{u.abort(),await d}}async*_streamEventsV1(e,t,r){let a,s=!1;const i=ce(t),o=i.tags??[],u=i.metadata??{},c=i.runName??this.getName(),l=new xl({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new zb({...r}),h=this._streamLog(e,l,i);for await(const f of h){if(a?a=a.concat(f):a=Aa.fromRunLogPatch(f),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;const w={...a.state},_={run_id:w.id,event:`on_${w.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(_,w.type)&&(yield _)}const p=f.ops.filter(w=>w.path.startsWith("/logs/")).map(w=>w.path.split("/")[2]),g=[...new Set(p)];for(const w of g){let _,v={};const S=a.state.logs[w];if(S.end_time===void 0?S.streamed_output.length>0?_="stream":_="start":_="end",_==="start")S.inputs!==void 0&&(v.input=S.inputs);else if(_==="end")S.inputs!==void 0&&(v.input=S.inputs),v.output=S.final_output;else if(_==="stream"){const P=S.streamed_output.length;if(P!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${P} instead. Encountered in: "${S.name}"`);v={chunk:S.streamed_output[0]},S.streamed_output=[]}yield{event:`on_${S.type}_${_}`,name:S.name,run_id:S.id,tags:S.tags,metadata:S.metadata,data:v}}const{state:b}=a;if(b.streamed_output.length>0){const w=b.streamed_output.length;if(w!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${w} instead. Encountered in: "${b.name}"`);const _={chunk:b.streamed_output[0]};b.streamed_output=[];const v={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:u,name:c,data:_};d.includeEvent(v,b.type)&&(yield v)}}const m=a==null?void 0:a.state;if(m!==void 0){const f={event:`on_${m.type}_end`,name:c,run_id:m.id,tags:o,metadata:u,data:{output:m.final_output}};d.includeEvent(f,m.type)&&(yield f)}}static isRunnable(e){return Gu(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Tr({bound:this,config:{},configFactories:[a=>({callbacks:[new lf({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return Bw(this,e)}}class Tr extends Oe{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=bl(this.config,...e);return bl(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(ce(t),this.kwargs))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(ce(s),this.kwargs))):await this._mergeConfig(ce(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(ce(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(ce(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(ce(t),this.kwargs))}streamEvents(e,t,r){const a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(ce(t),a.kwargs),version:t.version},r)};return nt.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&Oe.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new Tr({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new lf({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class Js extends Oe{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Js({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,je(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new Js({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class Mw extends Tr{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return je(t,{callbacks:r==null?void 0:r.getChild(a)})}async _invoke(e,t,r){return Bs(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){const s={};try{await Bs(async i=>{const o=e.map((h,m)=>m).filter(h=>s[h.toString()]===void 0||s[h.toString()]instanceof Error),u=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),l=await super.batch(u,c,{...a,returnExceptions:!0});let d;for(let h=0;h<l.length;h+=1){const m=l[h],f=o[h];m instanceof Error&&d===void 0&&(d=m,d.input=u[h]),s[f.toString()]=m}if(d)throw d;return l},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((a==null?void 0:a.returnExceptions)!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class Nt extends Oe{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){var u;const r=ce(t),a=await xt(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),Pe(e,"input"),r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i=e,o;try{const c=[this.first,...this.middle];for(let l=0;l<c.length;l+=1){const h=c[l].invoke(i,je(r,{callbacks:s==null?void 0:s.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));i=await hr(h,t==null?void 0:t.signal)}if((u=t==null?void 0:t.signal)!=null&&u.aborted)throw new Error("Aborted");o=await this.last.invoke(i,je(r,{callbacks:s==null?void 0:s.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}return await(s==null?void 0:s.handleChainEnd(Pe(o,"output"))),o}async batch(e,t,r){var u;const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(xt)),i=await Promise.all(s.map(async(c,l)=>{const d=await(c==null?void 0:c.handleChainStart(this.toJSON(),Pe(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName));return delete a[l].runId,d}));let o=e;try{for(let c=0;c<this.steps.length;c+=1){const d=this.steps[c].batch(o,i.map((h,m)=>{const f=h==null?void 0:h.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`);return je(a[m],{callbacks:f})}),r);o=await hr(d,(u=a[0])==null?void 0:u.signal)}}catch(c){throw await Promise.all(i.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(i.map(c=>c==null?void 0:c.handleChainEnd(Pe(o,"output")))),o}async*_streamIterator(e,t){var d;const r=await xt(t),{runId:a,...s}=t??{},i=await(r==null?void 0:r.handleChainStart(this.toJSON(),Pe(e,"input"),a,void 0,void 0,void 0,s==null?void 0:s.runName)),o=[this.first,...this.middle,this.last];let u=!0,c;async function*l(){yield e}try{let h=o[0].transform(l(),je(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let m=1;m<o.length;m+=1)h=await o[m].transform(h,je(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));for await(const m of h)if((d=t==null?void 0:t.signal)==null||d.throwIfAborted(),yield m,u)if(c===void 0)c=m;else try{c=Et(c,m)}catch{c=void 0,u=!1}}catch(h){throw await(i==null?void 0:i.handleChainError(h)),h}await(i==null?void 0:i.handleChainEnd(Pe(c,"output")))}getGraph(e){const t=new Si;let r=null;return this.steps.forEach((a,s)=>{const i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return Nt.isRunnableSequence(e)?new Nt({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Nt({first:this.first,middle:[...this.middle,this.last],last:Ar(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Oe.isRunnable(e)}static from([e,...t],r){let a={};return typeof r=="string"?a.name=r:r!==void 0&&(a=r),new Nt({...a,first:Ar(e),middle:t.slice(0,-1).map(Ar),last:Ar(t[t.length-1])})}}class Pn extends Oe{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=Ar(r)}static from(e){return new Pn({steps:e})}async invoke(e,t){const r=ce(t),a=await xt(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;const i={};try{const o=Object.entries(this.steps).map(async([u,c])=>{i[u]=await c.invoke(e,je(r,{callbacks:s==null?void 0:s.getChild(`map:key:${u}`)}))});await hr(Promise.all(o),t==null?void 0:t.signal)}catch(o){throw await(s==null?void 0:s.handleChainError(o)),o}return await(s==null?void 0:s.handleChainEnd(i)),i}async*_transform(e,t,r){const a={...this.steps},s=cf(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],c)=>{const l=u.transform(s[c],je(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){const o=Promise.race(i.values()),{key:u,result:c,gen:l}=await hr(o,r==null?void 0:r.signal);i.delete(u),c.done||(yield{[u]:c.value},i.set(u,l.next().then(d=>({key:u,gen:l,result:d}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=ce(t),s=new kn({generator:this.transform(r(),a),config:a});return await s.setup,nt.fromAsyncGenerator(s)}}class Ku extends Oe{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!qu(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[r]=this._getOptionsList(t??{},1),a=await xt(r),s=this.func(je(r,{callbacks:a}),e);return hr(s,r==null?void 0:r.signal)}async*_streamIterator(e,t){var s,i;const[r]=this._getOptionsList(t??{},1),a=await this.invoke(e,t);if(tu(a)){for await(const o of a)(s=r==null?void 0:r.signal)==null||s.throwIfAborted(),yield o;return}if(Lw(a)){for(;;){(i=r==null?void 0:r.signal)==null||i.throwIfAborted();const o=a.next();if(o.done)break;yield o.value}return}yield a}static from(e){return new Ku({func:e})}}function Fw(n){if(qu(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class On extends Oe{static lc_name(){return"RunnableLambda"}constructor(e){if(qu(e.func))return Ku.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Fw(e.func),this.func=e.func}static from(e){return new On({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{const i=je(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((t==null?void 0:t.recursionLimit)??so)-1});dr.runWithConfig(pn(i),async()=>{var o,u;try{let c=await this.func(e,{...i});if(c&&Oe.isRunnable(c)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");c=await c.invoke(e,{...i,recursionLimit:(i.recursionLimit??so)-1})}else if(tu(c)){let l;for await(const d of ru(i,c))if((o=t==null?void 0:t.signal)==null||o.throwIfAborted(),l===void 0)l=d;else try{l=Et(l,d)}catch{l=d}c=l}else if(Ol(c)){let l;for(const d of Tl(i,c))if((u=t==null?void 0:t.signal)==null||u.throwIfAborted(),l===void 0)l=d;else try{l=Et(l,d)}catch{l=d}c=l}a(c)}catch(c){s(c)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){var o,u;let a;for await(const c of e)if(a===void 0)a=c;else try{a=Et(a,c)}catch{a=c}const s=je(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??so)-1}),i=await new Promise((c,l)=>{dr.runWithConfig(pn(s),async()=>{try{const d=await this.func(a,{...s,config:s});c(d)}catch(d){l(d)}})});if(i&&Oe.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const c=await i.stream(a,s);for await(const l of c)yield l}else if(tu(i))for await(const c of ru(s,i))(o=r==null?void 0:r.signal)==null||o.throwIfAborted(),yield c;else if(Ol(i))for(const c of Tl(s,i))(u=r==null?void 0:r.signal)==null||u.throwIfAborted(),yield c;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=ce(t),s=new kn({generator:this.transform(r(),a),config:a});return await s.setup,nt.fromAsyncGenerator(s)}}class Dw extends Oe{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=ce(t),a=await xt(r),{runId:s,...i}=r,o=await(a==null?void 0:a.handleChainStart(this.toJSON(),Pe(e,"input"),s,void 0,void 0,void 0,i==null?void 0:i.runName)),u=je(i,{callbacks:o==null?void 0:o.getChild()});return await dr.runWithConfig(u,async()=>{var d;let l;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{const m=await h.invoke(e,u);return await(o==null?void 0:o.handleChainEnd(Pe(m,"output"))),m}catch(m){l===void 0&&(l=m)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,t){var d;const r=ce(t),a=await xt(r),{runId:s,...i}=r,o=await(a==null?void 0:a.handleChainStart(this.toJSON(),Pe(e,"input"),s,void 0,void 0,void 0,i==null?void 0:i.runName));let u,c;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();const m=je(i,{callbacks:o==null?void 0:o.getChild()});try{const f=await h.stream(e,m);c=ru(m,f);break}catch(f){u===void 0&&(u=f)}}if(c===void 0){const h=u??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let l;try{for await(const h of c){yield h;try{l=l===void 0?l:Et(l,h)}catch{l=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(Pe(l,"output")))}async batch(e,t,r){var u;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(c=>xt(c))),i=await Promise.all(s.map(async(c,l)=>{const d=await(c==null?void 0:c.handleChainStart(this.toJSON(),Pe(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName));return delete a[l].runId,d}));let o;for(const c of this.runnables()){(u=a[0].signal)==null||u.throwIfAborted();try{const l=await c.batch(e,i.map((d,h)=>je(a[h],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(i.map((d,h)=>d==null?void 0:d.handleChainEnd(Pe(l[h],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function Ar(n){if(typeof n=="function")return new On({func:n});if(Oe.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=Ar(r);return new Pn({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class gf extends Oe{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Pn&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const a=this.mapper.getStepsKeys(),[s,i]=cf(e),o=this.mapper.transform(i,je(r,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(const c of s){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([d])=>!a.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(const c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=ce(t),s=new kn({generator:this.transform(r(),a),config:a});return await s.setup,nt.fromAsyncGenerator(s)}}class Uw extends Oe{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=ce(t),s=new kn({generator:this.transform(r(),a),config:a});return await s.setup,nt.fromAsyncGenerator(s)}}class Il extends Tr{constructor(e){const t=Nt.from([On.from(async r=>{let a;if(Oh(r))try{a=await this.schema.parseAsync(r.args)}catch{throw new eg("Received tool input did not match expected schema",JSON.stringify(r.args))}else a=r;return a}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function Bw(n,e){var a;const t=e.name??n.getName(),r=e.description??((a=e.schema)==null?void 0:a.description);return e.schema.constructor===Pr.ZodString?new Il({name:t,description:r,schema:Pr.object({input:Pr.string()}).transform(s=>s.input),bound:n}):new Il({name:t,description:r,schema:e.schema,bound:n})}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var zw=typeof window=="object"?window:{},G="0123456789abcdef".split(""),Zw=[-2147483648,8388608,32768,128],dt=[24,16,8,0],Se=[];function At(n){n?(Se[0]=Se[16]=Se[1]=Se[2]=Se[3]=Se[4]=Se[5]=Se[6]=Se[7]=Se[8]=Se[9]=Se[10]=Se[11]=Se[12]=Se[13]=Se[14]=Se[15]=0,this.blocks=Se):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}At.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===zw.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<dt[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<dt[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<dt[a++&3],i[a>>2]|=(128|t&63)<<dt[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<dt[a++&3],i[a>>2]|=(128|t>>6&63)<<dt[a++&3],i[a>>2]|=(128|t&63)<<dt[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<dt[a++&3],i[a>>2]|=(128|t>>12&63)<<dt[a++&3],i[a>>2]|=(128|t>>6&63)<<dt[a++&3],i[a>>2]|=(128|t&63)<<dt[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};At.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=Zw[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};At.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};At.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return G[n>>28&15]+G[n>>24&15]+G[n>>20&15]+G[n>>16&15]+G[n>>12&15]+G[n>>8&15]+G[n>>4&15]+G[n&15]+G[e>>28&15]+G[e>>24&15]+G[e>>20&15]+G[e>>16&15]+G[e>>12&15]+G[e>>8&15]+G[e>>4&15]+G[e&15]+G[t>>28&15]+G[t>>24&15]+G[t>>20&15]+G[t>>16&15]+G[t>>12&15]+G[t>>8&15]+G[t>>4&15]+G[t&15]+G[r>>28&15]+G[r>>24&15]+G[r>>20&15]+G[r>>16&15]+G[r>>12&15]+G[r>>8&15]+G[r>>4&15]+G[r&15]+G[a>>28&15]+G[a>>24&15]+G[a>>20&15]+G[a>>16&15]+G[a>>12&15]+G[a>>8&15]+G[a>>4&15]+G[a&15]};At.prototype.toString=At.prototype.hex;At.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};At.prototype.array=At.prototype.digest;At.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};const Hw=n=>new At(!0).update(n).hex(),Rl=(...n)=>Hw(n.join("_"));class qw{}const Vw=new Map;class Xu extends qw{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Rl(e,t))??null)}async update(e,t,r){this.cache.set(Rl(e,t),r)}static global(){return new Xu(Vw)}}class _f extends Ir{}class Ww extends _f{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new dn(this.value)]}}class Jw extends _f{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Th(this.messages)}toChatMessages(){return this.messages}}var Ai={};Ai.byteLength=Xw;Ai.toByteArray=Qw;Ai.fromByteArray=rv;var Ct=[],ot=[],Gw=typeof Uint8Array<"u"?Uint8Array:Array,co="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Zr=0,Kw=co.length;Zr<Kw;++Zr)Ct[Zr]=co[Zr],ot[co.charCodeAt(Zr)]=Zr;ot[45]=62;ot[95]=63;function yf(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function Xw(n){var e=yf(n),t=e[0],r=e[1];return(t+r)*3/4-r}function Yw(n,e,t){return(e+t)*3/4-t}function Qw(n){var e,t=yf(n),r=t[0],a=t[1],s=new Gw(Yw(n,r,a)),i=0,o=a>0?r-4:r,u;for(u=0;u<o;u+=4)e=ot[n.charCodeAt(u)]<<18|ot[n.charCodeAt(u+1)]<<12|ot[n.charCodeAt(u+2)]<<6|ot[n.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=ot[n.charCodeAt(u)]<<2|ot[n.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=ot[n.charCodeAt(u)]<<10|ot[n.charCodeAt(u+1)]<<4|ot[n.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function ev(n){return Ct[n>>18&63]+Ct[n>>12&63]+Ct[n>>6&63]+Ct[n&63]}function tv(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(ev(r));return a.join("")}function rv(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(tv(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(Ct[e>>2]+Ct[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(Ct[e>>10]+Ct[e>>4&63]+Ct[e<<2&63]+"=")),a.join("")}var nv=Object.defineProperty,av=(n,e,t)=>e in n?nv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,sv=(n,e,t)=>(av(n,e+"",t),t);function iv(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){const s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){const a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function ov(n,e){return n.length===1?[e.get(n.join(","))]:iv(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function uv(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var nu=class{constructor(n,e){Gt(this,"specialTokens");Gt(this,"inverseSpecialTokens");Gt(this,"patStr");Gt(this,"textEncoder",new TextEncoder);Gt(this,"textDecoder",new TextDecoder("utf-8"));Gt(this,"rankMap",new Map);Gt(this,"textMap",new Map);this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{const[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(const[r,a]of Object.entries(t)){const s=Ai.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),a=nu.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(c=>!i.has(c)):t);if(o.size>0){const c=nu.specialTokenRegex([...o]),l=n.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;a.lastIndex=l,c=a.exec(n),!(c==null||i.has(c[0]));)l=c.index+1;const d=(c==null?void 0:c.index)??n.length;for(const m of n.substring(u,d).matchAll(r)){const f=this.textEncoder.encode(m[0]),p=this.rankMap.get(f.join(","));if(p!=null){s.push(p);continue}s.push(...ov(f,this.rankMap))}if(c==null)break;let h=this.specialTokens[c[0]];s.push(h),u=c.index+c[0].length}return s}decode(n){const e=[];let t=0;for(let s=0;s<n.length;++s){const i=n[s],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let a=0;for(const s of e)r.set(s,a),a+=s.length;return this.textDecoder.decode(r)}},bf=nu;sv(bf,"specialTokenRegex",n=>new RegExp(n.map(e=>uv(e)).join("|"),"g"));function cv(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"o3-mini":case"o3-mini-2025-01-31":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}const es={},lv=new Ju({});async function dv(n){return n in es||(es[n]=lv.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new bf(e)).catch(e=>{throw delete es[n],e})),await es[n]}async function hv(n){return dv(cv(n))}const fv=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;function Yu(n){return typeof n!="object"||!n?!1:!!("type"in n&&n.type==="function"&&"function"in n&&typeof n.function=="object"&&n.function&&"name"in n.function&&"parameters"in n.function)}const mv=()=>!1;class pv extends Oe{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??mv(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class gv extends pv{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){const{cache:a,...s}=r;super({callbacks:e??t,...s}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof a=="object"?this.cache=a:a?this.cache=Xu.global():this.cache=void 0,this.caller=new Ju(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await hv("modelName"in this?fv(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new Ww(e):Array.isArray(e)?new Jw(e.map(Gn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class _n extends Oe{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const r=ce(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){const r=ce(t);let a,s=!0;for await(const i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=Et(a,i)}catch{a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new gf(new Pn({steps:e}))}}function Qu(n){return typeof(n==null?void 0:n.parse)=="function"}class qt extends gv{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){const r=qt._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){var r;if(this._streamResponseChunks===qt.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const s=qt._convertInputToPromptValue(e).toChatMessages(),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(t),u={...i.metadata,...this.getLsParams(o)},c=await Ve.configure(i.callbacks,this.callbacks,i.tags,this.tags,u,this.metadata,{verbose:this.verbose}),l={options:o,invocation_params:this==null?void 0:this.invocationParams(o),batch_size:1},d=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),[s],i.runId,void 0,l,void 0,void 0,i.runName));let h,m;try{for await(const f of this._streamResponseChunks(s,o,d==null?void 0:d[0])){if(f.message.id==null){const p=(r=d==null?void 0:d.at(0))==null?void 0:r.runId;p!=null&&f.message._updateId(`run-${p}`)}f.message.response_metadata={...f.generationInfo,...f.message.response_metadata},yield f.message,h?h=h.concat(f):h=f,Hc(f.message)&&f.message.usage_metadata!==void 0&&(m={tokenUsage:{promptTokens:f.message.usage_metadata.input_tokens,completionTokens:f.message.usage_metadata.output_tokens,totalTokens:f.message.usage_metadata.total_tokens}})}}catch(f){throw await Promise.all((d??[]).map(p=>p==null?void 0:p.handleLLMError(f))),f}await Promise.all((d??[]).map(f=>f==null?void 0:f.handleLLMEnd({generations:[[h]],llmOutput:m})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r,a){var d,h;const s=e.map(m=>m.map(Gn));let i;if(a!==void 0&&a.length===s.length)i=a;else{const m={...r.metadata,...this.getLsParams(t)},f=await Ve.configure(r.callbacks,this.callbacks,r.tags,this.tags,m,this.metadata,{verbose:this.verbose}),p={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1};i=await(f==null?void 0:f.handleChatModelStart(this.toJSON(),s,r.runId,void 0,p,void 0,void 0,r.runName))}const o=[],u=[];if(!!(i!=null&&i[0].handlers.find(pb))&&!this.disableStreaming&&s.length===1&&this._streamResponseChunks!==qt.prototype._streamResponseChunks)try{const m=await this._streamResponseChunks(s[0],t,i==null?void 0:i[0]);let f,p;for await(const g of m){if(g.message.id==null){const b=(d=i==null?void 0:i.at(0))==null?void 0:d.runId;b!=null&&g.message._updateId(`run-${b}`)}f===void 0?f=g:f=Et(f,g),Hc(g.message)&&g.message.usage_metadata!==void 0&&(p={tokenUsage:{promptTokens:g.message.usage_metadata.input_tokens,completionTokens:g.message.usage_metadata.output_tokens,totalTokens:g.message.usage_metadata.total_tokens}})}if(f===void 0)throw new Error("Received empty response from chat model call.");o.push([f]),await(i==null?void 0:i[0].handleLLMEnd({generations:o,llmOutput:p}))}catch(m){throw await(i==null?void 0:i[0].handleLLMError(m)),m}else{const m=await Promise.allSettled(s.map((f,p)=>this._generate(f,{...t,promptIndex:p},i==null?void 0:i[p])));await Promise.all(m.map(async(f,p)=>{var g,b,w;if(f.status==="fulfilled"){const _=f.value;for(const v of _.generations){if(v.message.id==null){const S=(g=i==null?void 0:i.at(0))==null?void 0:g.runId;S!=null&&v.message._updateId(`run-${S}`)}v.message.response_metadata={...v.generationInfo,...v.message.response_metadata}}return _.generations.length===1&&(_.generations[0].message.response_metadata={..._.llmOutput,..._.generations[0].message.response_metadata}),o[p]=_.generations,u[p]=_.llmOutput,(b=i==null?void 0:i[p])==null?void 0:b.handleLLMEnd({generations:[_.generations],llmOutput:_.llmOutput})}else return await((w=i==null?void 0:i[p])==null?void 0:w.handleLLMError(f.reason)),Promise.reject(f.reason)}))}const l={generations:o,llmOutput:u.length?(h=this._combineLLMOutput)==null?void 0:h.call(this,...u):void 0};return Object.defineProperty(l,El,{value:i?{runIds:i==null?void 0:i.map(m=>m.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){const i=e.map(g=>g.map(Gn)),o={...s.metadata,...this.getLsParams(a)},u=await Ve.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},l=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),i,s.runId,void 0,c,void 0,void 0,s.runName)),d=[],m=(await Promise.allSettled(i.map(async(g,b)=>{const w=qt._convertInputToPromptValue(g).toString(),_=await t.lookup(w,r);return _==null&&d.push(b),_}))).map((g,b)=>({result:g,runManager:l==null?void 0:l[b]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),f=[];await Promise.all(m.map(async({result:g,runManager:b},w)=>{if(g.status==="fulfilled"){const _=g.value;return f[w]=_.map(v=>("message"in v&&fi(v.message)&&Sn(v.message)&&(v.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),v.generationInfo={...v.generationInfo,tokenUsage:{}},v)),_.length&&await(b==null?void 0:b.handleLLMNewToken(_[0].text)),b==null?void 0:b.handleLLMEnd({generations:[_]},void 0,void 0,void 0,{cached:!0})}else return await(b==null?void 0:b.handleLLMError(g.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(g.reason)}));const p={generations:f,missingPromptIndices:d,startedRunManagers:l};return Object.defineProperty(p,El,{value:l?{runIds:l==null?void 0:l.map(g=>g.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){let a;Array.isArray(t)?a={stop:t}:a=t;const s=e.map(f=>f.map(Gn)),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(a);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(s,o,i);const{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({messages:s,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:i});let m={};if(d.length>0){const f=await this._generateUncached(d.map(p=>s[p]),o,i,h!==void 0?d.map(p=>h==null?void 0:h[p]):void 0);await Promise.all(f.generations.map(async(p,g)=>{const b=d[g];l[b]=p;const w=qt._convertInputToPromptValue(s[b]).toString();return u.update(w,c,p)})),m=f.llmOutput??{}}return{generations:l,llmOutput:m}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(Gn)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const a=new dn(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t!=null&&t.strict)throw new Error('"strict" mode is not supported for this model by default.');const r=e,a=t==null?void 0:t.name,s=r.description??"A function available to call.",i=t==null?void 0:t.method,o=t==null?void 0:t.includeRaw;if(i==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=a??"extract",c;Qu(r)?c=[{type:"function",function:{name:u,description:s,parameters:jr(r)}}]:("name"in r&&(u=r.name),c=[{type:"function",function:{name:u,description:s,parameters:r}}]);const l=this.bindTools(c),d=On.from(p=>{if(!p.tool_calls||p.tool_calls.length===0)throw new Error("No tool calls found in the response.");const g=p.tool_calls.find(b=>b.name===u);if(!g)throw new Error(`No tool call found with name ${u}.`);return g.args});if(!o)return l.pipe(d).withConfig({runName:"StructuredOutput"});const h=_n.assign({parsed:(p,g)=>d.invoke(p.raw,g)}),m=_n.assign({parsed:()=>null}),f=h.withFallbacks({fallbacks:[m]});return Nt.from([{raw:l},f]).withConfig({runName:"StructuredOutputRunnable"})}}class wf extends Oe{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"})}}class vf extends wf{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class ka extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Ph(this,"OUTPUT_PARSING_FAILURE")}}function au(n,e){const t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;const r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!au(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;const r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(const i of r)if(!au(n[i],e[i]))return!1;return!0}return n===e}class _v extends vf{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class xf extends _v{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let t,r;for await(const a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if(Xp(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new fr({message:a,text:a.content})}else if(fi(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new fr({message:ng(a),text:a.content})}else s=new gn({text:a});r===void 0?r=s:r=r.concat(s);const i=await this.parsePartialResult([r]);i!=null&&!au(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}getFormatInstructions(){return""}}class Cl extends vf{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const t=Pr.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,Pr.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(jr(this.schema))}
\`\`\`
`}async parse(e){try{const r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new ka(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class $l extends xf{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?ub(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Dc(e[0].text)}async parse(e){return Dc(e,JSON.parse)}getFormatInstructions(){return""}}function ec(n,e){if(n.function===void 0)return;let t;if(e!=null&&e.partial)try{t=Mu(n.function.arguments??"{}")}catch{return}else try{t=JSON.parse(n.function.arguments)}catch(a){throw new ka([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${a.message}`].join(`
`))}const r={name:n.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(r.id=n.id),r}function yv(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function Ef(n,e){var t,r;return{name:(t=n.function)==null?void 0:t.name,args:(r=n.function)==null?void 0:r.arguments,id:n.id,error:e,type:"invalid_tool_call"}}class bv extends xf{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var i;const r=e[0].message;let a;if(Sn(r)&&((i=r.tool_calls)!=null&&i.length)?a=r.tool_calls.map(o=>{const{id:u,...c}=o;return this.returnId?{id:u,...c}:c}):r.additional_kwargs.tool_calls!==void 0&&(a=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(u=>ec(u,{returnId:this.returnId,partial:t}))),!a)return[];const s=[];for(const o of a)if(o!==void 0){const u={type:o.name,args:o.args,id:o.id};s.push(u)}return s}}class Nl extends bv{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new ka(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const r=(await super.parsePartialResult(e)).filter(s=>s.type===this.keyName);let a=r;if(r.length)return this.returnId||(a=r.map(s=>s.args)),this.returnSingle?a[0]:a}async parseResult(e){const r=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName);let a=r;return r.length?(this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))):void 0}}const wv=Symbol("Let zodToJsonSchema decide on which parser to use"),jl={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},vv=n=>typeof n=="string"?{...jl,basePath:["#"],definitions:{},name:n}:{...jl,basePath:["#"],definitions:{},...n},su=n=>"_def"in n?n._def:n;function xv(n){if(!n)return!0;for(const e in n)return!1;return!0}const Ev=n=>{const e=vv(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[su(a),{def:su(a),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function Sf(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function he(n,e,t,r,a){n[e]=t,Sf(n,e,r,a)}function Sv(){return{}}function Av(n,e){var r,a;const t={type:"array"};return((a=(r=n.type)==null?void 0:r._def)==null?void 0:a.typeName)!==x.ZodAny&&(t.items=ue(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&he(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&he(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(he(t,"minItems",n.exactLength.value,n.exactLength.message,e),he(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function kv(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?he(t,"minimum",r.value,r.message,e):he(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),he(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?he(t,"maximum",r.value,r.message,e):he(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),he(t,"maximum",r.value,r.message,e));break;case"multipleOf":he(t,"multipleOf",r.value,r.message,e);break}return t}function Pv(){return{type:"boolean"}}function Ov(n,e){return ue(n.type._def,e)}const Tv=(n,e)=>ue(n.innerType._def,e);function Af(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>Af(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Iv(n,e)}}const Iv=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":he(t,"minimum",r.value,r.message,e);break;case"max":he(t,"maximum",r.value,r.message,e);break}return t};function Rv(n,e){return{...ue(n.innerType._def,e),default:n.defaultValue()}}function Cv(n,e,t){return e.effectStrategy==="input"?ue(n.schema._def,e,t):{}}function $v(n){return{type:"string",enum:[...n.values]}}const Nv=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function jv(n,e){const t=[ue(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),ue(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(s=>{if(Nv(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){const{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function Lv(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let lo;const br={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(lo===void 0&&(lo=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),lo),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function kf(n,e){const t={type:"string"};function r(a){return e.patternStrategy==="escape"?Mv(a):a}if(n.checks)for(const a of n.checks)switch(a.kind){case"min":he(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":he(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":ht(t,"email",a.message,e);break;case"format:idn-email":ht(t,"idn-email",a.message,e);break;case"pattern:zod":ft(t,br.email,a.message,e);break}break;case"url":ht(t,"uri",a.message,e);break;case"uuid":ht(t,"uuid",a.message,e);break;case"regex":ft(t,a.regex,a.message,e);break;case"cuid":ft(t,br.cuid,a.message,e);break;case"cuid2":ft(t,br.cuid2,a.message,e);break;case"startsWith":ft(t,RegExp(`^${r(a.value)}`),a.message,e);break;case"endsWith":ft(t,RegExp(`${r(a.value)}$`),a.message,e);break;case"datetime":ht(t,"date-time",a.message,e);break;case"date":ht(t,"date",a.message,e);break;case"time":ht(t,"time",a.message,e);break;case"duration":ht(t,"duration",a.message,e);break;case"length":he(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),he(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{ft(t,RegExp(r(a.value)),a.message,e);break}case"ip":{a.version!=="v6"&&ht(t,"ipv4",a.message,e),a.version!=="v4"&&ht(t,"ipv6",a.message,e);break}case"emoji":ft(t,br.emoji,a.message,e);break;case"ulid":{ft(t,br.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{ht(t,"binary",a.message,e);break}case"contentEncoding:base64":{he(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{ft(t,br.base64,a.message,e);break}}break}case"nanoid":ft(t,br.nanoid,a.message,e)}return t}const Mv=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),ht=(n,e,t,r)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):he(n,"format",e,t,r)},ft=(n,e,t,r)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Ll(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):he(n,"pattern",Ll(e,r),t,r)},Ll=(n,e)=>{var c;const t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;const r={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},a=r.i?t.source.toLowerCase():t.source;let s="",i=!1,o=!1,u=!1;for(let l=0;l<a.length;l++){if(i){s+=a[l],i=!1;continue}if(r.i){if(o){if(a[l].match(/[a-z]/)){u?(s+=a[l],s+=`${a[l-2]}-${a[l]}`.toUpperCase(),u=!1):a[l+1]==="-"&&((c=a[l+2])!=null&&c.match(/[a-z]/))?(s+=a[l],u=!0):s+=`${a[l]}${a[l].toUpperCase()}`;continue}}else if(a[l].match(/[a-z]/)){s+=`[${a[l]}${a[l].toUpperCase()}]`;continue}}if(r.m){if(a[l]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(a[l]==="$"){s+=`($|(?=[\r
]))`;continue}}if(r.s&&a[l]==="."){s+=o?`${a[l]}\r
`:`[${a[l]}\r
]`;continue}s+=a[l],a[l]==="\\"?i=!0:o&&a[l]==="]"?o=!1:!o&&a[l]==="["&&(o=!0)}try{const l=new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s};function Pf(n,e){var r,a,s,i;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===x.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((o,u)=>({...o,[u]:ue(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:ue(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===x.ZodString&&((s=n.keyType._def.checks)!=null&&s.length)){const o=Object.entries(kf(n.keyType._def,e)).reduce((u,[c,l])=>c==="type"?u:{...u,[c]:l},{});return{...t,propertyNames:o}}else if(((i=n.keyType)==null?void 0:i._def.typeName)===x.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function Fv(n,e){if(e.mapStrategy==="record")return Pf(n,e);const t=ue(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=ue(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Dv(n){const e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function Uv(){return{not:{}}}function Bv(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Gs={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function zv(n,e){if(e.target==="openApi3")return Ml(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Gs&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((a,s)=>{const i=Gs[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((a,s)=>{const i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){const a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Ml(n,e)}const Ml=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>ue(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function Zv(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Gs[n.innerType._def.typeName],nullable:!0}:{type:[Gs[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=ue(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=ue(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Hv(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",Sf(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?he(t,"minimum",r.value,r.message,e):he(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),he(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?he(t,"maximum",r.value,r.message,e):he(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),he(t,"maximum",r.value,r.message,e));break;case"multipleOf":he(t,"multipleOf",r.value,r.message,e);break}return t}function qv(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":ue(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":ue(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Vv(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((r,[a,s])=>{if(s===void 0||s._def===void 0)return r;const i=ue(s._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return i===void 0?r:{properties:{...r.properties,[a]:i},required:s.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,a]}},{properties:{},required:[]}),additionalProperties:qv(n,e)};return t.required.length||delete t.required,t}const Wv=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return ue(n.innerType._def,e);const t=ue(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Jv=(n,e)=>{if(e.pipeStrategy==="input")return ue(n.in._def,e);if(e.pipeStrategy==="output")return ue(n.out._def,e);const t=ue(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=ue(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function Gv(n,e){return ue(n.type._def,e)}function Kv(n,e){const r={type:"array",uniqueItems:!0,items:ue(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&he(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&he(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Xv(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>ue(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:ue(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>ue(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function Yv(){return{not:{}}}function Qv(){return{}}const e0=(n,e)=>ue(n.innerType._def,e);function ue(n,e,t=!1){var i;const r=e.seen.get(n);if(e.override){const o=(i=e.override)==null?void 0:i.call(e,n,e,r,t);if(o!==wv)return o}if(r&&!t){const o=t0(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const s=n0(n,n.typeName,e,t);return s&&a0(n,e,s),a.jsonSchema=s,s}const t0=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"extract-to-root":const t=n.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=n.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:r0(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((r,a)=>e.currentPath[a]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},r0=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},n0=(n,e,t,r)=>{switch(e){case x.ZodString:return kf(n,t);case x.ZodNumber:return Hv(n,t);case x.ZodObject:return Vv(n,t);case x.ZodBigInt:return kv(n,t);case x.ZodBoolean:return Pv();case x.ZodDate:return Af(n,t);case x.ZodUndefined:return Yv();case x.ZodNull:return Bv(t);case x.ZodArray:return Av(n,t);case x.ZodUnion:case x.ZodDiscriminatedUnion:return zv(n,t);case x.ZodIntersection:return jv(n,t);case x.ZodTuple:return Xv(n,t);case x.ZodRecord:return Pf(n,t);case x.ZodLiteral:return Lv(n,t);case x.ZodEnum:return $v(n);case x.ZodNativeEnum:return Dv(n);case x.ZodNullable:return Zv(n,t);case x.ZodOptional:return Wv(n,t);case x.ZodMap:return Fv(n,t);case x.ZodSet:return Kv(n,t);case x.ZodLazy:return ue(n.getter()._def,t);case x.ZodPromise:return Gv(n,t);case x.ZodNaN:case x.ZodNever:return Uv();case x.ZodEffects:return Cv(n,t,r);case x.ZodAny:return Sv();case x.ZodUnknown:return Qv();case x.ZodDefault:return Rv(n,t);case x.ZodBranded:return Ov(n,t);case x.ZodReadonly:return e0(n,t);case x.ZodCatch:return Tv(n,t);case x.ZodPipeline:return Jv(n,t);case x.ZodFunction:case x.ZodVoid:case x.ZodSymbol:return;default:return(a=>{})()}},a0=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),s0=(n,e)=>{const t=Ev(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,a=ue(n._def,r===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,r]},!1)??{},s=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;s!==void 0&&(a.title=s);const i=(()=>{if(xv(t.definitions))return;const u={},c=new Set;for(let l=0;l<500;l++){const d=Object.entries(t.definitions).filter(([h])=>!c.has(h));if(d.length===0)break;for(const[h,m]of d)u[h]=ue(su(m),{...t,currentPath:[...t.basePath,t.definitionPath,h]},!0)??{},c.add(h)}return u})(),o=r===void 0?i?{...a,[t.definitionPath]:i}:a:t.nameStrategy==="duplicate-ref"?{...a,...i||t.seenRefs.size?{[t.definitionPath]:{...i,...t.seenRefs.size?{[r]:a}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,r].join("/"),[t.definitionPath]:{...i,[r]:a}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function Of(n,e){return s0(n,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function i0(n,e,t){return dp({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:Of(n,{name:e})}},r=>n.parse(JSON.parse(r)))}function o0(n){return hp({type:"function",function:{name:n.name,parameters:Of(n.parameters,{name:n.name}),strict:!0,...n.description?{description:n.description}:void 0}},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))})}function Tf(n){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i,azureOpenAIEndpoint:o}=n;if((r||i)&&a&&e)return`${a}/${e}`;if((r||i)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||i){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return s}function u0(n,e){const t=typeof e=="number"?void 0:e;return{name:n.name,description:n.description,parameters:jr(n.schema),...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}}function c0(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function l0(n){return n!==void 0&&Oe.isRunnable(n)&&"lc_name"in n.constructor&&typeof n.constructor.lc_name=="function"&&n.constructor.lc_name()==="RunnableToolLike"}function d0(n){return!!n&&typeof n=="object"&&"name"in n&&"schema"in n&&Qu(n.schema)}function If(n){return d0(n)||l0(n)||c0(n)}function ts(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function ho(n){let e;return n.constructor.name===ni.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===tt.name?(e=new Error(n.message),e.name="AbortError"):n.status===400&&n.message.includes("tool_calls")?e=ts(n,"INVALID_TOOL_RESULTS"):n.status===401?e=ts(n,"MODEL_AUTHENTICATION"):n.status===429?e=ts(n,"MODEL_RATE_LIMIT"):n.status===404?e=ts(n,"MODEL_NOT_FOUND"):e=n,e}function Fl(n){if(n)return n==="any"||n==="required"?"required":n==="auto"?"auto":n==="none"?"none":typeof n=="string"?{type:"function",function:{name:n}}:n}function h0(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function f0(n){const e=["namespace functions {",""];for(const t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(Rf(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Rf(n,e){var r;const t=[];for(const[a,s]of Object.entries(n.properties??{}))s.description&&e<2&&t.push(`// ${s.description}`),(r=n.required)!=null&&r.includes(a)?t.push(`${a}: ${Ks(s,e)},`):t.push(`${a}?: ${Ks(s,e)},`);return t.map(a=>" ".repeat(e)+a).join(`
`)}function Ks(n,e){if(h0(n))return n.anyOf.map(t=>Ks(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Rf(n,e+2),"}"].join(`
`);case"array":return n.items?`${Ks(n.items,e)}[]`:"any[]";default:return""}}function m0(n,e){let t;if(If(n)){const r=o0({name:n.name,parameters:n.schema,description:n.description});r.function.parameters?t={type:r.type,function:{name:r.function.name,description:r.function.description,parameters:r.function.parameters,...(e==null?void 0:e.strict)!==void 0?{strict:e.strict}:{}}}:t={type:"function",function:u0(n,e)}}else t=n;return(e==null?void 0:e.strict)!==void 0&&(t.function.strict=e.strict),t}function p0(n){return n.role!=="system"&&n.role!=="developer"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function tc(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Ca.isInstance(n))throw new Error("Invalid generic chat message");return p0(n)}default:throw new Error(`Unknown message type: ${e}`)}}function Dl(n,e){return n.flatMap(t=>{var s;let r=tc(t);r==="system"&&rc(e)&&(r="developer");const a={role:r,content:t.content};if(t.name!=null&&(a.name=t.name),t.additional_kwargs.function_call!=null&&(a.function_call=t.additional_kwargs.function_call,a.content=null),Sn(t)&&((s=t.tool_calls)!=null&&s.length)?(a.tool_calls=t.tool_calls.map(yv),a.content=null):(t.additional_kwargs.tool_calls!=null&&(a.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(a.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){const i={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[a,i]}return a})}const tn="__openai_function_call_ids__";function Ul(n,e){return n.flatMap(t=>{var a,s;let r=tc(t);if(r==="system"&&rc(e)&&(r="developer"),r==="function")throw new Error("Function messages are not supported in Responses API");if(r==="tool"){const i=t;return((a=i.additional_kwargs)==null?void 0:a.type)==="computer_call_output"?{type:"computer_call_output",output:typeof i.content=="string"?{type:"computer_screenshot",image_url:i.content}:Array.isArray(i.content)?i.content.find(u=>u.type==="computer_screenshot"):i.content,call_id:i.tool_call_id}:{type:"function_call_output",call_id:i.tool_call_id,id:i.id,output:typeof i.content!="string"?JSON.stringify(i.content):i.content}}if(r==="assistant"){const i=t.additional_kwargs[tn];if(Sn(t)&&((s=t.tool_calls)!=null&&s.length))return t.tool_calls.map(u=>({type:"function_call",name:u.name,arguments:JSON.stringify(u.args),call_id:u.id,id:i==null?void 0:i[u.id]}));if(t.additional_kwargs.tool_calls!=null)return t.additional_kwargs.tool_calls.map(u=>({type:"function_call",name:u.function.name,call_id:u.id,id:i==null?void 0:i[u.id],arguments:u.function.arguments}));let{content:o}=t;return t.additional_kwargs.refusal!=null&&(typeof o=="string"&&(o=[{type:"output_text",text:o,annotations:[]}]),o=[...o,{type:"refusal",refusal:t.additional_kwargs.refusal}]),{type:"message",role:"assistant",content:typeof o=="string"?o:o.flatMap(u=>u.type==="text"?{type:"output_text",text:u.text,annotations:u.annotations??[]}:u.type==="output_text"||u.type==="refusal"?u:[])}}return r==="user"?{type:"message",role:"user",content:typeof t.content=="string"?t.content:t.content.flatMap(i=>{if(i.type==="text")return{type:"input_text",text:i.text};if(i.type==="image_url"){const o=typeof i.image_url=="string"?i.image_url:i.image_url.url,u=typeof i.image_url=="string"?"auto":i.image_url.detail;return{type:"input_image",image_url:o,detail:u}}return i.type==="input_text"||i.type==="input_image"||i.type==="input_file"?i:[]})}:[]})}function Cf(n){if(n.error){const i=new Error(n.error.message);throw i.name=n.error.code,i}const e=[],t=[],r=[],a={model:n.model,created_at:n.created_at,id:n.id,incomplete_details:n.incomplete_details,metadata:n.metadata,object:n.object,status:n.status,user:n.user,model_name:n.model},s={};for(const i of n.output)if(i.type==="message")e.push(...i.content.map(o=>o.type==="output_text"?("parsed"in o&&o.parsed!=null&&(s.parsed=o.parsed),{type:"text",text:o.text,annotations:o.annotations}):o));else if(i.type==="function_call"){const o={function:{name:i.name,arguments:i.arguments},id:i.call_id};try{t.push(ec(o,{returnId:!0}))}catch(u){let c;typeof u=="object"&&u!=null&&"message"in u&&typeof u.message=="string"&&(c=u.message),r.push(Ef(o,c))}s[tn]??(s[tn]={}),s[tn][i.call_id]=i.id}else i.type==="reasoning"?s.reasoning=i:(s.tool_outputs??(s.tool_outputs=[]),s.tool_outputs.push(i));return new Rr({id:n.id,content:e,tool_calls:t,invalid_tool_calls:r,usage_metadata:n.usage,additional_kwargs:s,response_metadata:a})}function g0(n){var u,c;const e=[];let t={},r;const a=[],s={},i={};let o;if(n.type==="response.output_text.delta")e.push({type:"text",text:n.delta,index:n.content_index});else if(n.type==="response.output_text.annotation.added")e.push({type:"text",text:"",annotations:[n.annotation],index:n.content_index});else if(n.type==="response.output_item.added"&&n.item.type==="message")o=n.item.id;else if(n.type==="response.output_item.added"&&n.item.type==="function_call")a.push({type:"tool_call_chunk",name:n.item.name,args:n.item.arguments,id:n.item.id,index:n.output_index}),i[tn]={[n.item.call_id]:n.item.id};else if(n.type==="response.output_item.done"&&(n.item.type==="web_search_call"||n.item.type==="file_search_call"))i.tool_outputs=[n.item];else if(n.type==="response.created")s.id=n.response.id,s.model_name=n.response.model,s.model=n.response.model;else if(n.type==="response.completed"){const l=Cf(n.response);r=n.response.usage,((c=(u=n.response.text)==null?void 0:u.format)==null?void 0:c.type)==="json_schema"&&(i.parsed??(i.parsed=JSON.parse(l.text)));for(const[d,h]of Object.entries(n.response))d!=="id"&&(s[d]=h)}else if(n.type==="response.function_call_arguments.delta")a.push({type:"tool_call_chunk",args:n.delta,index:n.output_index});else if(n.type==="response.web_search_call.completed"||n.type==="response.file_search_call.completed")t={tool_outputs:{id:n.item_id,type:n.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(n.type==="response.refusal.done")i.refusal=n.refusal;else return null;return new fr({text:e.map(l=>l.text).join(""),message:new xe({id:o,content:e,tool_call_chunks:a,usage_metadata:r,additional_kwargs:i,response_metadata:s}),generationInfo:t})}function fo(n){return"type"in n&&n.type!=="function"}function _0(n){return n!=null&&typeof n=="object"&&"type"in n&&n.type!=="function"}function Bl(n,e){return Yu(n)?(e==null?void 0:e.strict)!==void 0?{...n,function:{...n.function,strict:e.strict}}:n:m0(n,e)}function rc(n){return(n==null?void 0:n.startsWith("o1"))||(n==null?void 0:n.startsWith("o3"))}class nc extends qt{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming"]}constructor(e){var t,r;super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.openAIApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.openAIApiKey)??((t=e==null?void 0:e.configuration)==null?void 0:t.apiKey)??ke("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=((r=e==null?void 0:e.configuration)==null?void 0:r.organization)??ke("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelName=this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this==null?void 0:this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=e==null?void 0:e.reasoningEffort,this.maxTokens=(e==null?void 0:e.maxCompletionTokens)??(e==null?void 0:e.maxTokens),this.useResponsesApi=(e==null?void 0:e.useResponsesApi)??this.useResponsesApi,this.model==="o1"&&(this.disableStreaming=!0),this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return(t==null?void 0:t.strict)!==void 0?r=t.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(a=>fo(a)?a:Bl(a,{strict:r})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&rs(e.json_schema.schema)?i0(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){var o,u;let r;if((e==null?void 0:e.strict)!==void 0?r=e.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this._useResponseApi(e)){const c={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e==null?void 0:e.previous_response_id,truncation:e==null?void 0:e.truncation,include:e==null?void 0:e.include,tools:(o=e==null?void 0:e.tools)!=null&&o.length?e.tools.map(d=>fo(d)?d:Yu(d)?{type:"function",name:d.function.name,parameters:d.function.parameters,description:d.function.description,strict:r}:null).filter(d=>d!==null):void 0,tool_choice:_0(e==null?void 0:e.tool_choice)?e==null?void 0:e.tool_choice:(()=>{const d=Fl(e==null?void 0:e.tool_choice);if(typeof d=="object"&&"type"in d)return{type:"function",name:d.function.name}})(),text:(()=>{if(e!=null&&e.text)return e.text;const d=this.createResponseFormat(e==null?void 0:e.response_format);return(d==null?void 0:d.type)==="json_schema"?d.json_schema.schema!=null?{format:{type:"json_schema",schema:d.json_schema.schema,description:d.json_schema.description,name:d.json_schema.name,strict:d.json_schema.strict}}:void 0:{format:d}})(),parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,...this.modelKwargs},l=(e==null?void 0:e.reasoning_effort)??this.reasoningEffort;return l!==void 0&&(c.reasoning={effort:l}),c}let a={};(e==null?void 0:e.stream_options)!==void 0?a={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t!=null&&t.streaming)&&(a={stream_options:{include_usage:!0}});const s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(u=e==null?void 0:e.tools)!=null&&u.length?e.tools.map(c=>Bl(c,{strict:r})):void 0,tool_choice:Fl(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...a,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(s.prediction=e.prediction);const i=(e==null?void 0:e.reasoning_effort)??this.reasoningEffort;return i!==void 0&&(s.reasoning_effort=i),rc(s.model)?s.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:s.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,s}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const r=e.tool_calls;switch(e.role){case"assistant":{const a=[],s=[];for(const u of r??[])try{a.push(ec(u,{returnId:!0}))}catch(c){s.push(Ef(u,c.message))}const i={function_call:e.function_call,tool_calls:r};this.__includeRawResponse!==void 0&&(i.__raw_response=t);const o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(i.audio=e.audio),new Rr({content:e.content||"",tool_calls:a,invalid_tool_calls:s,additional_kwargs:i,response_metadata:o,id:t.id})}default:return new Ca(e.content||"",e.role??"unknown")}}_convertOpenAIDeltaToBaseMessageChunk(e,t,r){var u,c;const a=e.role??r,s=e.content??"";let i;e.function_call?i={function_call:e.function_call}:e.tool_calls?i={tool_calls:e.tool_calls}:i={},this.__includeRawResponse&&(i.__raw_response=t),e.audio&&(i.audio={...e.audio,index:t.choices[0].index});const o={usage:{...t.usage}};if(a==="user")return new gi({content:s,response_metadata:o});if(a==="assistant"){const l=[];if(Array.isArray(e.tool_calls))for(const d of e.tool_calls)l.push({name:(u=d.function)==null?void 0:u.name,args:(c=d.function)==null?void 0:c.arguments,id:d.id,index:d.index,type:"tool_call_chunk"});return new xe({content:s,tool_call_chunks:l,additional_kwargs:i,id:t.id,response_metadata:o})}else return a==="system"?new ca({content:s,response_metadata:o}):a==="developer"?new ca({content:s,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):a==="function"?new pi({content:s,additional_kwargs:i,name:e.name,response_metadata:o}):a==="tool"?new Fu({content:s,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:o}):new mi({content:s,role:a,response_metadata:o})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var c,l,d,h,m,f,p,g,b,w;if(this._useResponseApi(t)){const _=await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:Ul(e,this.model),stream:!0},t);for await(const v of _){const S=g0(v);S!=null&&(yield S)}return}const a=Dl(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:a,stream:!0};let i;const o=await this.completionWithRetry(s,t);let u;for await(const _ of o){const v=(c=_==null?void 0:_.choices)==null?void 0:c[0];if(_.usage&&(u=_.usage),!v)continue;const{delta:S}=v;if(!S)continue;const P=this._convertOpenAIDeltaToBaseMessageChunk(S,_,i);i=S.role??i;const O={prompt:t.promptIndex??0,completion:v.index??0};if(typeof P.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const H={...O};v.finish_reason!=null&&(H.finish_reason=v.finish_reason,H.system_fingerprint=_.system_fingerprint,H.model_name=_.model),this.logprobs&&(H.logprobs=v.logprobs);const re=new fr({message:P,text:P.content,generationInfo:H});yield re,await(r==null?void 0:r.handleLLMNewToken(re.text??"",O,void 0,void 0,void 0,{chunk:re}))}if(u){const _={...((l=u.prompt_tokens_details)==null?void 0:l.audio_tokens)!==null&&{audio:(d=u.prompt_tokens_details)==null?void 0:d.audio_tokens},...((h=u.prompt_tokens_details)==null?void 0:h.cached_tokens)!==null&&{cache_read:(m=u.prompt_tokens_details)==null?void 0:m.cached_tokens}},v={...((f=u.completion_tokens_details)==null?void 0:f.audio_tokens)!==null&&{audio:(p=u.completion_tokens_details)==null?void 0:p.audio_tokens},...((g=u.completion_tokens_details)==null?void 0:g.reasoning_tokens)!==null&&{reasoning:(b=u.completion_tokens_details)==null?void 0:b.reasoning_tokens}};yield new fr({message:new xe({content:"",response_metadata:{usage:{...u}},usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens,...Object.keys(_).length>0&&{input_token_details:_},...Object.keys(v).length>0&&{output_token_details:v}}}),text:""})}if((w=t.signal)!=null&&w.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,r){var o;const a=this.invocationParams(t);if(a.stream){const u=this._streamResponseChunks(e,t,r);let c;for await(const l of u)l.message.response_metadata={...l.generationInfo,...l.message.response_metadata},c=(c==null?void 0:c.concat(l))??l;return{generations:c?[c]:[],llmOutput:{estimatedTokenUsage:(o=c==null?void 0:c.message)==null?void 0:o.usage_metadata}}}const s=Ul(e,this.model),i=await this.responseApiWithRetry({input:s,...a},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});return{generations:[{text:i.output_text,message:Cf(i)}],llmOutput:{id:i.id,estimatedTokenUsage:i.usage?{promptTokens:i.usage.input_tokens,completionTokens:i.usage.output_tokens,totalTokens:i.usage.total_tokens}:void 0}}}_useResponseApi(e){var a;const t=(a=e==null?void 0:e.tools)==null?void 0:a.some(fo),r=(e==null?void 0:e.previous_response_id)!=null||(e==null?void 0:e.text)!=null||(e==null?void 0:e.truncation)!=null||(e==null?void 0:e.include)!=null;return this.useResponsesApi||t||r}async _generate(e,t,r){var o,u;if(this._useResponseApi(t))return this._responseApiGenerate(e,t,r);const a={},s=this.invocationParams(t),i=Dl(e,this.model);if(s.stream){const c=this._streamResponseChunks(e,t,r),l={};for await(const g of c){g.message.response_metadata={...g.generationInfo,...g.message.response_metadata};const b=((o=g.generationInfo)==null?void 0:o.completion)??0;l[b]===void 0?l[b]=g:l[b]=l[b].concat(g)}const d=Object.entries(l).sort(([g],[b])=>parseInt(g,10)-parseInt(b,10)).map(([g,b])=>b),{functions:h,function_call:m}=this.invocationParams(t),f=await this.getEstimatedTokenCountFromPrompt(e,h,m),p=await this.getNumTokensFromGenerations(d);return a.input_tokens=f,a.output_tokens=p,a.total_tokens=f+p,{generations:d,llmOutput:{estimatedTokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}else{let c;t.response_format&&t.response_format.type==="json_schema"?c=await this.betaParsedCompletionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}):c=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});const{completion_tokens:l,prompt_tokens:d,total_tokens:h,prompt_tokens_details:m,completion_tokens_details:f}=(c==null?void 0:c.usage)??{};l&&(a.output_tokens=(a.output_tokens??0)+l),d&&(a.input_tokens=(a.input_tokens??0)+d),h&&(a.total_tokens=(a.total_tokens??0)+h),((m==null?void 0:m.audio_tokens)!==null||(m==null?void 0:m.cached_tokens)!==null)&&(a.input_token_details={...(m==null?void 0:m.audio_tokens)!==null&&{audio:m==null?void 0:m.audio_tokens},...(m==null?void 0:m.cached_tokens)!==null&&{cache_read:m==null?void 0:m.cached_tokens}}),((f==null?void 0:f.audio_tokens)!==null||(f==null?void 0:f.reasoning_tokens)!==null)&&(a.output_token_details={...(f==null?void 0:f.audio_tokens)!==null&&{audio:f==null?void 0:f.audio_tokens},...(f==null?void 0:f.reasoning_tokens)!==null&&{reasoning:f==null?void 0:f.reasoning_tokens}});const p=[];for(const g of(c==null?void 0:c.choices)??[]){const w={text:((u=g.message)==null?void 0:u.content)??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(g.message??{role:"assistant"},c)};w.generationInfo={...g.finish_reason?{finish_reason:g.finish_reason}:{},...g.logprobs?{logprobs:g.logprobs}:{}},Sn(w.message)&&(w.message.usage_metadata=a),w.message=new Rr(Object.fromEntries(Object.entries(w.message).filter(([_])=>!_.startsWith("lc_")))),p.push(w)}return{generations:p,llmOutput:{tokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){const s=f0(t);a+=await this.getNumTokens(s),a+=9}return t&&e.find(s=>s._getType()==="system")&&(a-=4),r==="none"?a+=1:typeof r=="object"&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var a;return(a=r.message.additional_kwargs)!=null&&a.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,a)=>r+a,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;this.model==="gpt-3.5-turbo-0301"?(r=4,a=-1):(r=3,a=1);const s=await Promise.all(e.map(async i=>{var h,m,f,p,g,b;const o=await this.getNumTokens(i.content),u=await this.getNumTokens(tc(i)),c=i.name!==void 0?a+await this.getNumTokens(i.name):0;let l=o+r+u+c;const d=i;if(d._getType()==="function"&&(l-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(l+=3),(m=d==null?void 0:d.additional_kwargs.function_call)!=null&&m.name&&(l+=await this.getNumTokens((f=d.additional_kwargs.function_call)==null?void 0:f.name)),(p=d.additional_kwargs.function_call)!=null&&p.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((g=d.additional_kwargs.function_call)==null?void 0:g.arguments)))}catch(w){console.error("Error parsing function arguments",w,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((b=d.additional_kwargs.function_call)==null?void 0:b.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(a){throw ho(a)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{var a,s;const r=this._getClientOptions(t);try{return((s=(a=e.text)==null?void 0:a.format)==null?void 0:s.type)==="json_schema"&&!e.stream?await this.client.responses.parse(e,r):await this.client.responses.create(e,r)}catch(i){throw ho(i)}})}async betaParsedCompletionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(a){throw ho(a)}})}_getClientOptions(e){if(!this.client){const r={baseURL:this.clientConfig.baseURL},a=Tf(r),s={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new Y(s)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let r,a,s,i;y0(e)?(r=e.schema,a=e.name,s=e.method,i=e.includeRaw):(r=e,a=t==null?void 0:t.name,s=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw);let o,u;if((t==null?void 0:t.strict)!==void 0&&s==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"?s===void 0&&(s="jsonSchema"):s==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`),s==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),rs(r)?u=Cl.fromZodSchema(r):u=new $l;else if(s==="jsonSchema")if(o=this.bind({response_format:{type:"json_schema",json_schema:{name:a??"extract",description:r.description,schema:r,strict:t==null?void 0:t.strict}}}),rs(r)){const h=Cl.fromZodSchema(r);u=On.from(m=>"parsed"in m.additional_kwargs?m.additional_kwargs.parsed:h)}else u=new $l;else{let h=a??"extract";if(rs(r)){const m=jr(r);o=this.bind({tools:[{type:"function",function:{name:h,description:m.description,parameters:m}}],tool_choice:{type:"function",function:{name:h}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),u=new Nl({returnSingle:!0,keyName:h,zodSchema:r})}else{let m;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(m=r,h=r.name):(h=r.title??h,m={name:h,description:r.description??"",parameters:r}),o=this.bind({tools:[{type:"function",function:m}],tool_choice:{type:"function",function:{name:h}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),u=new Nl({returnSingle:!0,keyName:h})}}if(!i)return o.pipe(u);const c=_n.assign({parsed:(h,m)=>u.invoke(h.raw,m)}),l=_n.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return Nt.from([{raw:o},d])}}function rs(n){return typeof(n==null?void 0:n.parse)=="function"}function y0(n){return n!==void 0&&typeof n.schema=="object"}class b0 extends nc{_llmType(){return"azure_openai"}get lc_aliases(){return{...super.lc_aliases,openAIApiKey:"openai_api_key",openAIApiVersion:"openai_api_version",openAIBasePath:"openai_api_base",deploymentName:"deployment_name",azureOpenAIEndpoint:"azure_endpoint",azureOpenAIApiVersion:"openai_api_version",azureOpenAIBasePath:"openai_api_base",azureOpenAIApiDeploymentName:"deployment_name"}}get lc_secrets(){return{...super.lc_secrets,azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}get lc_serializable_keys(){return[...super.lc_serializable_keys,"azureOpenAIApiKey","azureOpenAIApiVersion","azureOpenAIBasePath","azureOpenAIEndpoint","azureOpenAIApiInstanceName","azureOpenAIApiDeploymentName","deploymentName","openAIApiKey","openAIApiVersion"]}constructor(e){if(super(e),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.azureOpenAIApiKey=(e==null?void 0:e.azureOpenAIApiKey)??(e==null?void 0:e.openAIApiKey)??(e==null?void 0:e.apiKey)??ke("AZURE_OPENAI_API_KEY"),this.azureOpenAIApiInstanceName=(e==null?void 0:e.azureOpenAIApiInstanceName)??ke("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e==null?void 0:e.azureOpenAIApiDeploymentName)??(e==null?void 0:e.deploymentName)??ke("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(e==null?void 0:e.azureOpenAIApiVersion)??(e==null?void 0:e.openAIApiVersion)??ke("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(e==null?void 0:e.azureOpenAIBasePath)??ke("AZURE_OPENAI_BASE_PATH"),this.azureOpenAIEndpoint=(e==null?void 0:e.azureOpenAIEndpoint)??ke("AZURE_OPENAI_ENDPOINT"),this.azureADTokenProvider=e==null?void 0:e.azureADTokenProvider,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("Azure OpenAI API key or Token Provider not found")}getLsParams(e){const t=super.getLsParams(e);return t.ls_provider="azure",t}_getClientOptions(e){var r;if(!this.client){const a={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},s=Tf(a),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=a.azureOpenAIApiKey),i.baseURL||delete i.baseURL;let o=af();(o==="node"||o==="deno")&&(o=`(${o}/${process.version}; ${process.platform}; ${process.arch})`);const u=(r=i.defaultHeaders)==null?void 0:r["User-Agent"];i.defaultHeaders={...i.defaultHeaders,"User-Agent":`langchainjs-azure-openai/2.0.0 (${o})${u?` ${u}`:""}`},this.client=new Np({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,deployment:this.azureOpenAIApiDeploymentName,...i})}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}toJSON(){const e=super.toJSON();function t(r){return typeof r=="object"&&r!=null}if(t(e)&&t(e.kwargs)){if(delete e.kwargs.azure_openai_base_path,delete e.kwargs.azure_openai_api_deployment_name,delete e.kwargs.azure_openai_api_key,delete e.kwargs.azure_openai_api_version,delete e.kwargs.azure_open_ai_base_path,!e.kwargs.azure_endpoint&&this.azureOpenAIEndpoint&&(e.kwargs.azure_endpoint=this.azureOpenAIEndpoint),!e.kwargs.azure_endpoint&&this.azureOpenAIBasePath){const r=this.azureOpenAIBasePath.split("/openai/deployments/");if(r.length===2&&r[0].startsWith("http")){const[a]=r;e.kwargs.azure_endpoint=a}}if(!e.kwargs.azure_endpoint&&this.azureOpenAIApiInstanceName&&(e.kwargs.azure_endpoint=`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/`),!e.kwargs.deployment_name&&this.azureOpenAIApiDeploymentName&&(e.kwargs.deployment_name=this.azureOpenAIApiDeploymentName),!e.kwargs.deployment_name&&this.azureOpenAIBasePath){const r=this.azureOpenAIBasePath.split("/openai/deployments/");if(r.length===2){const[,a]=r;e.kwargs.deployment_name=a}}e.kwargs.azure_endpoint&&e.kwargs.deployment_name&&e.kwargs.openai_api_base&&delete e.kwargs.openai_api_base,e.kwargs.azure_openai_api_instance_name&&e.kwargs.azure_endpoint&&delete e.kwargs.azure_openai_api_instance_name}return e}withStructuredOutput(e,t){const r={...t};return this.model.startsWith("gpt-4o")&&(r==null?void 0:r.method)===void 0&&(r.method="functionCalling"),super.withStructuredOutput(e,r)}}class w0 extends nc{static lc_name(){return"ChatDeepSeek"}_llmType(){return"deepseek"}get lc_secrets(){return{apiKey:"DEEPSEEK_API_KEY"}}constructor(e){const t=(e==null?void 0:e.apiKey)||ke("DEEPSEEK_API_KEY");if(!t)throw new Error('Deepseek API key not found. Please set the DEEPSEEK_API_KEY environment variable or pass the key into "apiKey" field.');super({...e,apiKey:t,configuration:{baseURL:"https://api.deepseek.com",...e==null?void 0:e.configuration}}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","deepseek"]})}_convertOpenAIDeltaToBaseMessageChunk(e,t,r){const a=super._convertOpenAIDeltaToBaseMessageChunk(e,t,r);return a.additional_kwargs.reasoning_content=e.reasoning_content,a}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const r=super._convertOpenAIChatCompletionMessageToBaseMessage(e,t);return r.additional_kwargs.reasoning_content=e.reasoning_content,r}withStructuredOutput(e,t){const r={...t};return(r==null?void 0:r.method)===void 0&&(r.method="functionCalling"),super.withStructuredOutput(e,r)}}const Gr="0.37.0";let zl=!1,sa,$f,iu,Nf,jf,Lf;function v0(n,e={auto:!1}){if(zl)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${n.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(sa)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${n.kind}'\` after \`import '@anthropic-ai/sdk/shims/${sa}'\``);zl=e.auto,sa=n.kind,$f=n.fetch,iu=n.File,Nf=n.ReadableStream,jf=n.getDefaultAgent,Lf=n.fileFromPath}class x0{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function E0({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import … from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new x0(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:i=>!1}}sa||v0(E0(),{auto:!0});class ne extends Error{}class Me extends ne{constructor(e,t,r,a){super(`${Me.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a==null?void 0:a["request-id"],this.error=t}static makeMessage(e,t,r){const a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e||!a)return new ki({message:r,cause:ou(t)});const s=t;return e===400?new Ff(e,s,r,a):e===401?new Df(e,s,r,a):e===403?new Uf(e,s,r,a):e===404?new Bf(e,s,r,a):e===409?new zf(e,s,r,a):e===422?new Zf(e,s,r,a):e===429?new Hf(e,s,r,a):e>=500?new qf(e,s,r,a):new Me(e,s,r,a)}}class bt extends Me{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class ki extends Me{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Mf extends ki{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Ff extends Me{}class Df extends Me{}class Uf extends Me{}class Bf extends Me{}class zf extends Me{}class Zf extends Me{}class Hf extends Me{}class qf extends Me{}var ns=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},wr=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ye;class Ma{constructor(){Ye.set(this,void 0),this.buffer=new Uint8Array,ns(this,Ye,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let r=new Uint8Array(this.buffer.length+t.length);r.set(this.buffer),r.set(t,this.buffer.length),this.buffer=r;const a=[];let s;for(;(s=S0(this.buffer,wr(this,Ye,"f")))!=null;){if(s.carriage&&wr(this,Ye,"f")==null){ns(this,Ye,s.index,"f");continue}if(wr(this,Ye,"f")!=null&&(s.index!==wr(this,Ye,"f")+1||s.carriage)){a.push(this.decodeText(this.buffer.slice(0,wr(this,Ye,"f")-1))),this.buffer=this.buffer.slice(wr(this,Ye,"f")),ns(this,Ye,null,"f");continue}const i=wr(this,Ye,"f")!==null?s.preceding-1:s.preceding,o=this.decodeText(this.buffer.slice(0,i));a.push(o),this.buffer=this.buffer.slice(s.index),ns(this,Ye,null,"f")}return a}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new ne(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new ne(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new ne("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}Ye=new WeakMap;Ma.NEWLINE_CHARS=new Set([`
`,"\r"]);Ma.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function S0(n,e){for(let a=e??0;a<n.length;a++){if(n[a]===10)return{preceding:a,index:a+1,carriage:!1};if(n[a]===13)return{preceding:a,index:a+1,carriage:!0}}return null}function A0(n){for(let r=0;r<n.length-1;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}function ac(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class jt{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(const i of k0(e,t)){if(i.event==="completion")try{yield JSON.parse(i.data)}catch(o){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),o}if(i.event==="message_start"||i.event==="message_delta"||i.event==="message_stop"||i.event==="content_block_start"||i.event==="content_block_delta"||i.event==="content_block_stop")try{yield JSON.parse(i.data)}catch(o){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),o}if(i.event!=="ping"&&i.event==="error")throw Me.generate(void 0,`SSE Error: ${i.data}`,i.data,Jf(e.headers))}s=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{s||t.abort()}}return new jt(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){const i=new Ma,o=ac(e);for await(const u of o)for(const c of i.decode(u))yield c;for(const u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new jt(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){const i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new jt(()=>a(e),this.controller),new jt(()=>a(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new Nf({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{const{value:s,done:i}=await t.next();if(i)return a.close();const o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}}async function*k0(n,e){if(!n.body)throw e.abort(),new ne("Attempted to iterate over a response with no body");const t=new O0,r=new Ma,a=ac(n.body);for await(const s of P0(a))for(const i of r.decode(s)){const o=t.decode(i);o&&(yield o)}for(const s of r.flush()){const i=t.decode(s);i&&(yield i)}}async function*P0(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let a=new Uint8Array(e.length+r.length);a.set(e),a.set(r,e.length),e=a;let s;for(;(s=A0(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}class O0{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=T0(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}}function T0(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}const I0=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",R0=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Pi(n),Pi=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function";async function C0(n,e,t){var a;if(n=await n,R0(n))return n;if(I0(n)){const s=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=Pi(s)?[await s.arrayBuffer()]:[s];return new iu(i,e,t)}const r=await $0(n);if(e||(e=j0(n)??"unknown_file"),!(t!=null&&t.type)){const s=(a=r[0])==null?void 0:a.type;typeof s=="string"&&(t={...t,type:s})}return new iu(r,e,t)}async function $0(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Pi(n))e.push(await n.arrayBuffer());else if(L0(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${N0(n)}`);return e}function N0(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function j0(n){var e;return mo(n.name)||mo(n.filename)||((e=mo(n.path))==null?void 0:e.split(/[\\/]/).pop())}const mo=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},L0=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Zl=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var un={},M0=function(n,e,t,r,a){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t},F0=function(n,e,t,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},as;async function Vf(n){const{response:e}=n;if(n.options.stream)return cn("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):jt.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){const s=await e.json();return cn("response",e.status,e.url,e.headers,s),Wf(s,e)}const a=await e.text();return cn("response",e.status,e.url,e.headers,a),a}function Wf(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}class Oi extends Promise{constructor(e,t=Vf){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Oi(this.responsePromise,async t=>Wf(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class D0{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=po("maxRetries",t),this.timeout=po("timeout",r),this.httpAgent=a,this.fetch=s??$f}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...q0(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${K0()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async a=>{const s=a&&Pi(a==null?void 0:a.body)?new DataView(await a.body.arrayBuffer()):(a==null?void 0:a.body)instanceof DataView?a.body:(a==null?void 0:a.body)instanceof ArrayBuffer?new DataView(a.body):a&&ArrayBuffer.isView(a==null?void 0:a.body)?new DataView(a.body.buffer):a==null?void 0:a.body;return{method:e,path:t,...a,body:s}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var f;e={...e};const{method:r,path:a,query:s,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:Zl(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),c=this.buildURL(a,s);"timeout"in e&&po("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const l=e.httpAgent??this.httpAgent??jf(c),d=e.timeout+1e3;typeof((f=l==null?void 0:l.options)==null?void 0:f.timeout)=="number"&&d>(l.options.timeout??0)&&(l.options.timeout=d),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:e,headers:i,contentLength:u,retryCount:t});return{req:{method:r,...o&&{body:o},headers:h,...l&&{agent:l},signal:e.signal??null},url:c,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:a}){const s={};r&&(s["content-length"]=r);const i=this.defaultHeaders(e);return Wl(s,i),Wl(s,t),Zl(e.body)&&sa!=="node"&&delete s["content-type"],ss(i,"x-stainless-retry-count")===void 0&&ss(t,"x-stainless-retry-count")===void 0&&(s["x-stainless-retry-count"]=String(a)),ss(i,"x-stainless-timeout")===void 0&&ss(t,"x-stainless-timeout")===void 0&&e.timeout&&(s["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(s,t),s}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new ne("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return Me.generate(e,t,r,a)}request(e,t=null){return new Oi(this.makeRequest(e,t))}async makeRequest(e,t){var d,h;const r=await e,a=r.maxRetries??this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);const{req:s,url:i,timeout:o}=this.buildRequest(r,{retryCount:a-t});if(await this.prepareRequest(s,{url:i,options:r}),cn("request",i,r,s.headers),(d=r.signal)!=null&&d.aborted)throw new bt;const u=new AbortController,c=await this.fetchWithTimeout(i,s,o,u).catch(ou);if(c instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new bt;if(t)return this.retryRequest(r,t);throw c.name==="AbortError"?new Mf:new ki({cause:c})}const l=Jf(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const w=`retrying, ${t} attempts remaining`;return cn(`response (error; ${w})`,c.status,i,l),this.retryRequest(r,t,l)}const m=await c.text().catch(w=>ou(w).message),f=V0(m),p=f?void 0:m;throw cn(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,p),this.makeStatusError(c.status,f,p,l)}return{response:c,options:r,controller:u}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new B0(this,r,e)}buildURL(e,t){const r=J0(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Xs(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new ne(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){const{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());const o=setTimeout(()=>a.abort(),r),u={signal:a.signal,...i};u.method&&(u.method=u.method.toUpperCase());const c=60*1e3,l=setTimeout(()=>{var d,h;if(u&&((d=u==null?void 0:u.agent)!=null&&d.sockets))for(const m of Object.values((h=u==null?void 0:u.agent)==null?void 0:h.sockets).flat())m!=null&&m.setKeepAlive&&m.setKeepAlive(!0,c)},c);return this.fetch.call(void 0,e,u).finally(()=>{clearTimeout(o),clearTimeout(l)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let a;const s=r==null?void 0:r["retry-after-ms"];if(s){const o=parseFloat(s);Number.isNaN(o)||(a=o)}const i=r==null?void 0:r["retry-after"];if(i&&!a){const o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){const o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await G0(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Gr}`}}class U0{constructor(e,t,r,a){as.set(this,void 0),M0(this,as,e),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new ne("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await F0(this,as,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(as=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class B0 extends Oi{constructor(e,t,r){super(t,async a=>new r(e,a.response,await Vf(a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const Jf=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),z0={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ir=n=>typeof n=="object"&&n!==null&&!Xs(n)&&Object.keys(n).every(e=>Gf(z0,e)),Z0=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gr,"X-Stainless-OS":ql(Deno.build.os),"X-Stainless-Arch":Hl(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gr,"X-Stainless-OS":ql(process.platform),"X-Stainless-Arch":Hl(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=H0();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function H0(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}const Hl=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",ql=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Vl;const q0=()=>Vl??(Vl=Z0()),V0=n=>{try{return JSON.parse(n)}catch{return}},W0=/^[a-z][a-z0-9+.-]*:/i,J0=n=>W0.test(n),G0=n=>new Promise(e=>setTimeout(e,n)),po=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new ne(`${n} must be an integer`);if(e<0)throw new ne(`${n} must be a positive integer`);return e},ou=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(String(n))},go=n=>{var e,t,r,a;if(typeof process<"u")return((e=un==null?void 0:un[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(a=(r=(t=Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:a.trim()};function Xs(n){if(!n)return!0;for(const e in n)return!1;return!0}function Gf(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Wl(n,e){for(const t in e){if(!Gf(e,t))continue;const r=t.toLowerCase();if(!r)continue;const a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function cn(n,...e){typeof process<"u"&&(un==null?void 0:un.DEBUG)==="true"&&console.log(`Anthropic:DEBUG:${n}`,...e)}const K0=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),X0=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Y0=n=>typeof(n==null?void 0:n.get)=="function",ss=(n,e)=>{var r;const t=e.toLowerCase();if(Y0(n)){const a=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(s,i,o)=>i+o.toUpperCase());for(const s of[e,t,e.toUpperCase(),a]){const i=n.get(s);if(i)return i}}for(const[a,s]of Object.entries(n))if(a.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s};class Ti extends U0{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.has_more=r.has_more||!1,this.first_id=r.first_id||null,this.last_id=r.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var t;if((t=this.options.query)!=null&&t.before_id){const r=this.first_id;return r?{params:{before_id:r}}:null}const e=this.last_id;return e?{params:{after_id:e}}:null}}class gr{constructor(e){this._client=e}}let sc=class extends gr{retrieve(e,t){return this._client.get(`/v1/models/${e}?beta=true`,t)}list(e={},t){return ir(e)?this.list({},e):this._client.getAPIList("/v1/models?beta=true",ic,{query:e,...t})}};class ic extends Ti{}sc.BetaModelInfosPage=ic;class Ii{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){const e=new Ma;for await(const t of this.iterator)for(const r of e.decode(t))yield JSON.parse(r);for(const t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new ne("Attempted to iterate over a response with no body");return new Ii(ac(e.body),t)}}let oc=class extends gr{create(e,t){const{betas:r,...a}=e;return this._client.post("/v1/messages/batches?beta=true",{body:a,...t,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...t==null?void 0:t.headers}})}retrieve(e,t={},r){if(ir(t))return this.retrieve(e,{},t);const{betas:a}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...r,headers:{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}list(e={},t){if(ir(e))return this.list({},e);const{betas:r,...a}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",uc,{query:a,...t,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...t==null?void 0:t.headers}})}delete(e,t={},r){if(ir(t))return this.delete(e,{},t);const{betas:a}=t;return this._client.delete(`/v1/messages/batches/${e}?beta=true`,{...r,headers:{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}cancel(e,t={},r){if(ir(t))return this.cancel(e,{},t);const{betas:a}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...r,headers:{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}async results(e,t={},r){if(ir(t))return this.results(e,{},t);const a=await this.retrieve(e);if(!a.results_url)throw new ne(`No batch \`results_url\`; Has it finished processing? ${a.processing_status} - ${a.id}`);const{betas:s}=t;return this._client.get(a.results_url,{...r,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...r==null?void 0:r.headers},__binaryResponse:!0})._thenUnwrap((i,o)=>Ii.fromResponse(o.response,o.controller))}};class uc extends Ti{}oc.BetaMessageBatchesPage=uc;const Q0=n=>{let e=0,t=[];for(;e<n.length;){let r=n[e];if(r==="\\"){e++;continue}if(r==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(r==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(r==="["){t.push({type:"paren",value:"["}),e++;continue}if(r==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(r===":"){t.push({type:"separator",value:":"}),e++;continue}if(r===","){t.push({type:"delimiter",value:","}),e++;continue}if(r==='"'){let o="",u=!1;for(r=n[++e];r!=='"';){if(e===n.length){u=!0;break}if(r==="\\"){if(e++,e===n.length){u=!0;break}o+=r+n[e],r=n[++e]}else o+=r,r=n[++e]}r=n[++e],u||t.push({type:"string",value:o});continue}if(r&&/\s/.test(r)){e++;continue}let s=/[0-9]/;if(r&&s.test(r)||r==="-"||r==="."){let o="";for(r==="-"&&(o+=r,r=n[++e]);r&&s.test(r)||r===".";)o+=r,r=n[++e];t.push({type:"number",value:o});continue}let i=/[a-z]/i;if(r&&i.test(r)){let o="";for(;r&&i.test(r)&&e!==n.length;)o+=r,r=n[++e];if(o=="true"||o=="false"||o==="null")t.push({type:"name",value:o});else{e++;continue}continue}e++}return t},Kr=n=>{if(n.length===0)return n;let e=n[n.length-1];switch(e.type){case"separator":return n=n.slice(0,n.length-1),Kr(n);case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return n=n.slice(0,n.length-1),Kr(n);case"string":let r=n[n.length-2];if((r==null?void 0:r.type)==="delimiter")return n=n.slice(0,n.length-1),Kr(n);if((r==null?void 0:r.type)==="brace"&&r.value==="{")return n=n.slice(0,n.length-1),Kr(n);break;case"delimiter":return n=n.slice(0,n.length-1),Kr(n)}return n},ex=n=>{let e=[];return n.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?n.push({type:"brace",value:"}"}):t==="]"&&n.push({type:"paren",value:"]"})}),n},tx=n=>{let e="";return n.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Kf=n=>JSON.parse(tx(ex(Kr(Q0(n)))));var Ce=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Q=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},at,tr,Cn,is,$n,Nn,os,jn,Ut,Ln,us,cs,Hr,ls,ds,_o,Jl,yo,bo,wo,vo,Gl;const Kl="__json_buf";class Ys{constructor(){at.add(this),this.messages=[],this.receivedMessages=[],tr.set(this,void 0),this.controller=new AbortController,Cn.set(this,void 0),is.set(this,()=>{}),$n.set(this,()=>{}),Nn.set(this,void 0),os.set(this,()=>{}),jn.set(this,()=>{}),Ut.set(this,{}),Ln.set(this,!1),us.set(this,!1),cs.set(this,!1),Hr.set(this,!1),ls.set(this,void 0),ds.set(this,void 0),yo.set(this,e=>{if(Ce(this,us,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new bt),e instanceof bt)return Ce(this,cs,!0,"f"),this._emit("abort",e);if(e instanceof ne)return this._emit("error",e);if(e instanceof Error){const t=new ne(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new ne(String(e)))}),Ce(this,Cn,new Promise((e,t)=>{Ce(this,is,e,"f"),Ce(this,$n,t,"f")}),"f"),Ce(this,Nn,new Promise((e,t)=>{Ce(this,os,e,"f"),Ce(this,jn,t,"f")}),"f"),Q(this,Cn,"f").catch(()=>{}),Q(this,Nn,"f").catch(()=>{})}get response(){return Q(this,ls,"f")}get request_id(){return Q(this,ds,"f")}async withResponse(){const e=await Q(this,Cn,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){const t=new Ys;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){const a=new Ys;for(const s of t.messages)a._addMessageParam(s);return a._run(()=>a._createMessage(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},Q(this,yo,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){var o;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),Q(this,at,"m",bo).call(this);const{response:s,data:i}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(s);for await(const u of i)Q(this,at,"m",wo).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new bt;Q(this,at,"m",vo).call(this)}_connected(e){this.ended||(Ce(this,ls,e,"f"),Ce(this,ds,e==null?void 0:e.headers.get("request-id"),"f"),Q(this,is,"f").call(this,e),this._emit("connect"))}get ended(){return Q(this,Ln,"f")}get errored(){return Q(this,us,"f")}get aborted(){return Q(this,cs,"f")}abort(){this.controller.abort()}on(e,t){return(Q(this,Ut,"f")[e]||(Q(this,Ut,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=Q(this,Ut,"f")[e];if(!r)return this;const a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(Q(this,Ut,"f")[e]||(Q(this,Ut,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{Ce(this,Hr,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){Ce(this,Hr,!0,"f"),await Q(this,Nn,"f")}get currentMessage(){return Q(this,tr,"f")}async finalMessage(){return await this.done(),Q(this,at,"m",_o).call(this)}async finalText(){return await this.done(),Q(this,at,"m",Jl).call(this)}_emit(e,...t){if(Q(this,Ln,"f"))return;e==="end"&&(Ce(this,Ln,!0,"f"),Q(this,os,"f").call(this));const r=Q(this,Ut,"f")[e];if(r&&(Q(this,Ut,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){const a=t[0];!Q(this,Hr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),Q(this,$n,"f").call(this,a),Q(this,jn,"f").call(this,a),this._emit("end");return}if(e==="error"){const a=t[0];!Q(this,Hr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),Q(this,$n,"f").call(this,a),Q(this,jn,"f").call(this,a),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",Q(this,at,"m",_o).call(this))}async _fromReadableStream(e,t){var s;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Q(this,at,"m",bo).call(this),this._connected(null);const a=jt.fromReadableStream(e,this.controller);for await(const i of a)Q(this,at,"m",wo).call(this,i);if((s=a.controller.signal)!=null&&s.aborted)throw new bt;Q(this,at,"m",vo).call(this)}[(tr=new WeakMap,Cn=new WeakMap,is=new WeakMap,$n=new WeakMap,Nn=new WeakMap,os=new WeakMap,jn=new WeakMap,Ut=new WeakMap,Ln=new WeakMap,us=new WeakMap,cs=new WeakMap,Hr=new WeakMap,ls=new WeakMap,ds=new WeakMap,yo=new WeakMap,at=new WeakSet,_o=function(){if(this.receivedMessages.length===0)throw new ne("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Jl=function(){if(this.receivedMessages.length===0)throw new ne("stream ended without producing a Message with role=assistant");const t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new ne("stream ended without producing a content block with type=text");return t.join(" ")},bo=function(){this.ended||Ce(this,tr,void 0,"f")},wo=function(t){if(this.ended)return;const r=Q(this,at,"m",Gl).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{const a=r.content.at(-1);switch(t.delta.type){case"text_delta":{a.type==="text"&&this._emit("text",t.delta.text,a.text||"");break}case"citations_delta":{a.type==="text"&&this._emit("citation",t.delta.citation,a.citations??[]);break}case"input_json_delta":{a.type==="tool_use"&&a.input&&this._emit("inputJson",t.delta.partial_json,a.input);break}case"thinking_delta":{a.type==="thinking"&&this._emit("thinking",t.delta.thinking,a.thinking);break}case"signature_delta":{a.type==="thinking"&&this._emit("signature",a.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{Ce(this,tr,r,"f");break}}},vo=function(){if(this.ended)throw new ne("stream has ended, this shouldn't happen");const t=Q(this,tr,"f");if(!t)throw new ne("request ended without sending any chunks");return Ce(this,tr,void 0,"f"),t},Gl=function(t){let r=Q(this,tr,"f");if(t.type==="message_start"){if(r)throw new ne(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new ne(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,r;case"content_block_start":return r.content.push(t.content_block),r;case"content_block_delta":{const a=r.content.at(t.index);switch(t.delta.type){case"text_delta":{(a==null?void 0:a.type)==="text"&&(a.text+=t.delta.text);break}case"citations_delta":{(a==null?void 0:a.type)==="text"&&(a.citations??(a.citations=[]),a.citations.push(t.delta.citation));break}case"input_json_delta":{if((a==null?void 0:a.type)==="tool_use"){let s=a[Kl]||"";s+=t.delta.partial_json,Object.defineProperty(a,Kl,{value:s,enumerable:!1,writable:!0}),s&&(a.input=Kf(s))}break}case"thinking_delta":{(a==null?void 0:a.type)==="thinking"&&(a.thinking+=t.delta.thinking);break}case"signature_delta":{(a==null?void 0:a.type)==="thinking"&&(a.signature=t.delta.signature);break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("streamEvent",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new jt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}const Xl={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};let Ri=class extends gr{constructor(){super(...arguments),this.batches=new oc(this._client)}create(e,t){const{betas:r,...a}=e;return a.model in Xl&&console.warn(`The model '${a.model}' is deprecated and will reach end-of-life on ${Xl[a.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:a,timeout:this._client._options.timeout??(a.stream?6e5:this._client._calculateNonstreamingTimeout(a.max_tokens)),...t,headers:{...(r==null?void 0:r.toString())!=null?{"anthropic-beta":r==null?void 0:r.toString()}:void 0,...t==null?void 0:t.headers},stream:e.stream??!1})}stream(e,t){return Ys.createMessage(this,e,t)}countTokens(e,t){const{betas:r,...a}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:a,...t,headers:{"anthropic-beta":[...r??[],"token-counting-2024-11-01"].toString(),...t==null?void 0:t.headers}})}};Ri.Batches=oc;Ri.BetaMessageBatchesPage=uc;class Fa extends gr{constructor(){super(...arguments),this.models=new sc(this._client),this.messages=new Ri(this._client)}}Fa.Models=sc;Fa.BetaModelInfosPage=ic;Fa.Messages=Ri;class Xf extends gr{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}}class cc extends gr{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/v1/messages/batches/${e}`,t)}list(e={},t){return ir(e)?this.list({},e):this._client.getAPIList("/v1/messages/batches",lc,{query:e,...t})}delete(e,t){return this._client.delete(`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){const r=await this.retrieve(e);if(!r.results_url)throw new ne(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);return this._client.get(r.results_url,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})._thenUnwrap((a,s)=>Ii.fromResponse(s.response,s.controller))}}class lc extends Ti{}cc.MessageBatchesPage=lc;var $e=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},ee=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},st,rr,Mn,hs,Fn,Dn,fs,Un,Bt,Bn,ms,ps,qr,gs,_s,xo,Yl,Eo,So,Ao,ko,Ql;const ed="__json_buf";class Qs{constructor(){st.add(this),this.messages=[],this.receivedMessages=[],rr.set(this,void 0),this.controller=new AbortController,Mn.set(this,void 0),hs.set(this,()=>{}),Fn.set(this,()=>{}),Dn.set(this,void 0),fs.set(this,()=>{}),Un.set(this,()=>{}),Bt.set(this,{}),Bn.set(this,!1),ms.set(this,!1),ps.set(this,!1),qr.set(this,!1),gs.set(this,void 0),_s.set(this,void 0),Eo.set(this,e=>{if($e(this,ms,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new bt),e instanceof bt)return $e(this,ps,!0,"f"),this._emit("abort",e);if(e instanceof ne)return this._emit("error",e);if(e instanceof Error){const t=new ne(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new ne(String(e)))}),$e(this,Mn,new Promise((e,t)=>{$e(this,hs,e,"f"),$e(this,Fn,t,"f")}),"f"),$e(this,Dn,new Promise((e,t)=>{$e(this,fs,e,"f"),$e(this,Un,t,"f")}),"f"),ee(this,Mn,"f").catch(()=>{}),ee(this,Dn,"f").catch(()=>{})}get response(){return ee(this,gs,"f")}get request_id(){return ee(this,_s,"f")}async withResponse(){const e=await ee(this,Mn,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){const t=new Qs;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){const a=new Qs;for(const s of t.messages)a._addMessageParam(s);return a._run(()=>a._createMessage(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},ee(this,Eo,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){var o;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),ee(this,st,"m",So).call(this);const{response:s,data:i}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(s);for await(const u of i)ee(this,st,"m",Ao).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new bt;ee(this,st,"m",ko).call(this)}_connected(e){this.ended||($e(this,gs,e,"f"),$e(this,_s,e==null?void 0:e.headers.get("request-id"),"f"),ee(this,hs,"f").call(this,e),this._emit("connect"))}get ended(){return ee(this,Bn,"f")}get errored(){return ee(this,ms,"f")}get aborted(){return ee(this,ps,"f")}abort(){this.controller.abort()}on(e,t){return(ee(this,Bt,"f")[e]||(ee(this,Bt,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=ee(this,Bt,"f")[e];if(!r)return this;const a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(ee(this,Bt,"f")[e]||(ee(this,Bt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{$e(this,qr,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){$e(this,qr,!0,"f"),await ee(this,Dn,"f")}get currentMessage(){return ee(this,rr,"f")}async finalMessage(){return await this.done(),ee(this,st,"m",xo).call(this)}async finalText(){return await this.done(),ee(this,st,"m",Yl).call(this)}_emit(e,...t){if(ee(this,Bn,"f"))return;e==="end"&&($e(this,Bn,!0,"f"),ee(this,fs,"f").call(this));const r=ee(this,Bt,"f")[e];if(r&&(ee(this,Bt,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){const a=t[0];!ee(this,qr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),ee(this,Fn,"f").call(this,a),ee(this,Un,"f").call(this,a),this._emit("end");return}if(e==="error"){const a=t[0];!ee(this,qr,"f")&&!(r!=null&&r.length)&&Promise.reject(a),ee(this,Fn,"f").call(this,a),ee(this,Un,"f").call(this,a),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",ee(this,st,"m",xo).call(this))}async _fromReadableStream(e,t){var s;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),ee(this,st,"m",So).call(this),this._connected(null);const a=jt.fromReadableStream(e,this.controller);for await(const i of a)ee(this,st,"m",Ao).call(this,i);if((s=a.controller.signal)!=null&&s.aborted)throw new bt;ee(this,st,"m",ko).call(this)}[(rr=new WeakMap,Mn=new WeakMap,hs=new WeakMap,Fn=new WeakMap,Dn=new WeakMap,fs=new WeakMap,Un=new WeakMap,Bt=new WeakMap,Bn=new WeakMap,ms=new WeakMap,ps=new WeakMap,qr=new WeakMap,gs=new WeakMap,_s=new WeakMap,Eo=new WeakMap,st=new WeakSet,xo=function(){if(this.receivedMessages.length===0)throw new ne("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Yl=function(){if(this.receivedMessages.length===0)throw new ne("stream ended without producing a Message with role=assistant");const t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new ne("stream ended without producing a content block with type=text");return t.join(" ")},So=function(){this.ended||$e(this,rr,void 0,"f")},Ao=function(t){if(this.ended)return;const r=ee(this,st,"m",Ql).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{const a=r.content.at(-1);switch(t.delta.type){case"text_delta":{a.type==="text"&&this._emit("text",t.delta.text,a.text||"");break}case"citations_delta":{a.type==="text"&&this._emit("citation",t.delta.citation,a.citations??[]);break}case"input_json_delta":{a.type==="tool_use"&&a.input&&this._emit("inputJson",t.delta.partial_json,a.input);break}case"thinking_delta":{a.type==="thinking"&&this._emit("thinking",t.delta.thinking,a.thinking);break}case"signature_delta":{a.type==="thinking"&&this._emit("signature",a.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{$e(this,rr,r,"f");break}}},ko=function(){if(this.ended)throw new ne("stream has ended, this shouldn't happen");const t=ee(this,rr,"f");if(!t)throw new ne("request ended without sending any chunks");return $e(this,rr,void 0,"f"),t},Ql=function(t){let r=ee(this,rr,"f");if(t.type==="message_start"){if(r)throw new ne(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new ne(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,r;case"content_block_start":return r.content.push(t.content_block),r;case"content_block_delta":{const a=r.content.at(t.index);switch(t.delta.type){case"text_delta":{(a==null?void 0:a.type)==="text"&&(a.text+=t.delta.text);break}case"citations_delta":{(a==null?void 0:a.type)==="text"&&(a.citations??(a.citations=[]),a.citations.push(t.delta.citation));break}case"input_json_delta":{if((a==null?void 0:a.type)==="tool_use"){let s=a[ed]||"";s+=t.delta.partial_json,Object.defineProperty(a,ed,{value:s,enumerable:!1,writable:!0}),s&&(a.input=Kf(s))}break}case"thinking_delta":{(a==null?void 0:a.type)==="thinking"&&(a.thinking+=t.delta.thinking);break}case"signature_delta":{(a==null?void 0:a.type)==="thinking"&&(a.signature=t.delta.signature);break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("streamEvent",a=>{const s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(const s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new jt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}class Ci extends gr{constructor(){super(...arguments),this.batches=new cc(this._client)}create(e,t){return e.model in td&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${td[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??(e.stream?6e5:this._client._calculateNonstreamingTimeout(e.max_tokens)),...t,stream:e.stream??!1})}stream(e,t){return Qs.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}}const td={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};Ci.Batches=cc;Ci.MessageBatchesPage=lc;class dc extends gr{retrieve(e,t){return this._client.get(`/v1/models/${e}`,t)}list(e={},t){return ir(e)?this.list({},e):this._client.getAPIList("/v1/models",hc,{query:e,...t})}}class hc extends Ti{}dc.ModelInfosPage=hc;var Yf;class me extends D0{constructor({baseURL:e=go("ANTHROPIC_BASE_URL"),apiKey:t=go("ANTHROPIC_API_KEY")??null,authToken:r=go("ANTHROPIC_AUTH_TOKEN")??null,...a}={}){const s={apiKey:t,authToken:r,...a,baseURL:e||"https://api.anthropic.com"};if(!s.dangerouslyAllowBrowser&&X0())throw new ne(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Xf(this),this.messages=new Ci(this),this.models=new dc(this),this.beta=new Fa(this),this._options=s,this.apiKey=t,this.authToken=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"])&&t["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&t.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){const t=this.apiKeyAuth(e),r=this.bearerAuth(e);return t!=null&&!Xs(t)?t:r!=null&&!Xs(r)?r:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}}Yf=me;me.Anthropic=Yf;me.HUMAN_PROMPT=`

Human:`;me.AI_PROMPT=`

Assistant:`;me.DEFAULT_TIMEOUT=6e5;me.AnthropicError=ne;me.APIError=Me;me.APIConnectionError=ki;me.APIConnectionTimeoutError=Mf;me.APIUserAbortError=bt;me.NotFoundError=Bf;me.ConflictError=zf;me.RateLimitError=Hf;me.BadRequestError=Ff;me.AuthenticationError=Df;me.InternalServerError=qf;me.PermissionDeniedError=Uf;me.UnprocessableEntityError=Zf;me.toFile=C0;me.fileFromPath=Lf;me.Completions=Xf;me.Messages=Ci;me.Models=dc;me.ModelInfosPage=hc;me.Beta=Fa;const{HUMAN_PROMPT:vE,AI_PROMPT:xE}=me;class rd extends wf{static lc_name(){return"AnthropicToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","anthropic","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){let t=e;if(typeof e=="string")try{t=JSON.parse(e)}catch(a){throw new ka(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(a.message)}`,e)}else t=e;if(this.zodSchema===void 0)return t;const r=await this.zodSchema.safeParseAsync(t);if(r.success)return r.data;throw new ka(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(r.error.errors)}`,JSON.stringify(t,null,2))}async parseResult(e){const t=e.flatMap(s=>{const{message:i}=s;return Array.isArray(i.content)?Qf(i.content)[0]:[]});if(t[0]===void 0)throw new Error("No parseable tool calls provided to AnthropicToolsOutputParser.");const[r]=t;return await this._validateResult(r.args)}}function Qf(n){const e=[];for(const t of n)t.type==="tool_use"&&e.push({name:t.name,args:t.input,id:t.id,type:"tool_call"});return e}function rx(n){if(n)return n==="any"?{type:"any"}:n==="auto"?{type:"auto"}:typeof n=="string"?{type:"tool",name:n}:n}function nd(n){const e=/^data:(image\/.+);base64,(.+)$/,t=n.match(e);if(t===null)throw new Error(["Anthropic only supports base64-encoded images currently.","Example: data:image/png;base64,/9j/4AAQSk..."].join(`

`));return{type:"base64",media_type:t[1]??"",data:t[2]??""}}function nx(n){const e=[];for(const t of n)if(t._getType()==="tool")if(typeof t.content=="string"){const r=e[e.length-1];(r==null?void 0:r._getType())==="human"&&Array.isArray(r.content)&&"type"in r.content[0]&&r.content[0].type==="tool_result"?r.content.push({type:"tool_result",content:t.content,tool_use_id:t.tool_call_id}):e.push(new dn({content:[{type:"tool_result",content:t.content,tool_use_id:t.tool_call_id}]}))}else e.push(new dn({content:[{type:"tool_result",content:uu(t.content),tool_use_id:t.tool_call_id}]}));else e.push(t);return e}function ad(n){if(n.id===void 0)throw new Error('Anthropic requires all tool calls to have an "id".');return{type:"tool_use",id:n.id,name:n.name,input:n.args}}function uu(n){const e=["tool_use","tool_result","input_json_delta"],t=["text","text_delta"];return typeof n=="string"?n:n.map(a=>{const s="cache_control"in a?a.cache_control:void 0;if(a.type==="image_url"){let i;return typeof a.image_url=="string"?i=nd(a.image_url):i=nd(a.image_url.url),{type:"image",source:i,...s?{cache_control:s}:{}}}else{if(a.type==="document")return{...a,...s?{cache_control:s}:{}};if(a.type==="thinking")return{type:"thinking",thinking:a.thinking,signature:a.signature,...s?{cache_control:s}:{}};if(a.type==="redacted_thinking")return{type:"redacted_thinking",data:a.data,...s?{cache_control:s}:{}};if(t.find(i=>i===a.type)&&"text"in a)return{type:"text",text:a.text,...s?{cache_control:s}:{}};if(e.find(i=>i===a.type)){const i={...a};if("index"in i&&delete i.index,i.type==="input_json_delta"&&(i.type="tool_use"),"input"in i)try{i.input=JSON.parse(i.input)}catch{}return{...i,...s?{cache_control:s}:{}}}else throw new Error("Unsupported message content format")}})}function sd(n){const e=nx(n);let t;e.length>0&&e[0]._getType()==="system"&&(t=n[0].content);const a=(t!==void 0?e.slice(1):e).map(s=>{var o;let i;if(s._getType()==="human")i="user";else if(s._getType()==="ai")i="assistant";else if(s._getType()==="tool")i="user";else throw s._getType()==="system"?new Error("System messages are only permitted as the first passed message."):new Error(`Message type "${s._getType()}" is not supported.`);if(Sn(s)&&((o=s.tool_calls)!=null&&o.length)){if(typeof s.content=="string")return s.content===""?{role:i,content:s.tool_calls.map(ad)}:{role:i,content:[{type:"text",text:s.content},...s.tool_calls.map(ad)]};{const{content:u}=s;return!s.tool_calls.every(l=>u.find(d=>(d.type==="tool_use"||d.type==="input_json_delta")&&d.id===l.id))&&console.warn('The "tool_calls" field on a message is only respected if content is a string.'),{role:i,content:uu(s.content)}}}else return{role:i,content:uu(s.content)}});return{messages:ax(a),system:t}}function ax(n){if(!n||n.length<=1)return n;const e=[];let t=n[0];const r=s=>typeof s=="string"?[{type:"text",text:s}]:s,a=s=>s.role!=="user"||typeof s.content=="string"?!1:Array.isArray(s.content)&&s.content.every(i=>i.type==="tool_result");for(let s=1;s<n.length;s+=1){const i=n[s];a(t)&&a(i)?t={...t,content:[...r(t.content),...r(i.content)]}:(e.push(t),t=i)}return e.push(t),e}function sx(n,e){var t;if(n.type==="message_start"){const{content:r,usage:a,...s}=n.message,i={};for(const[d,h]of Object.entries(s))h!=null&&(i[d]=h);const{input_tokens:o,output_tokens:u,...c}=a??{},l={input_tokens:o,output_tokens:u,total_tokens:o+u,input_token_details:{cache_creation:c.cache_creation_input_tokens,cache_read:c.cache_read_input_tokens}};return{chunk:new xe({content:e.coerceContentToString?"":[],additional_kwargs:i,usage_metadata:e.streamUsage?l:void 0,response_metadata:{usage:{...c}},id:n.message.id})}}else if(n.type==="message_delta"){const r={input_tokens:0,output_tokens:n.usage.output_tokens,total_tokens:n.usage.output_tokens,input_token_details:{cache_creation:n.usage.cache_creation_input_tokens,cache_read:n.usage.cache_read_input_tokens}};return{chunk:new xe({content:e.coerceContentToString?"":[],additional_kwargs:{...n.delta},usage_metadata:e.streamUsage?r:void 0})}}else if(n.type==="content_block_start"&&["tool_use","document"].includes(n.content_block.type)){const r=n.content_block;let a;return r.type==="tool_use"?a=[{id:r.id,index:n.index,name:r.name,args:""}]:a=[],{chunk:new xe({content:e.coerceContentToString?"":[{index:n.index,...n.content_block,input:""}],additional_kwargs:{},tool_call_chunks:a})}}else if(n.type==="content_block_delta"&&["text_delta","citations_delta","thinking_delta","signature_delta"].includes(n.delta.type)){if(e.coerceContentToString&&"text"in n.delta)return{chunk:new xe({content:n.delta.text})};{const r=n.delta;return"citation"in r&&(r.citations=[r.citation],delete r.citation),r.type==="thinking_delta"||r.type==="signature_delta"?{chunk:new xe({content:[{index:n.index,...r,type:"thinking"}]})}:{chunk:new xe({content:[{index:n.index,...r,type:"text"}]})}}}else{if(n.type==="content_block_delta"&&n.delta.type==="input_json_delta")return{chunk:new xe({content:e.coerceContentToString?"":[{index:n.index,input:n.delta.partial_json,type:n.delta.type}],additional_kwargs:{},tool_call_chunks:[{index:n.index,args:n.delta.partial_json}]})};if(n.type==="content_block_start"&&n.content_block.type==="text"){const r=(t=n.content_block)==null?void 0:t.text;if(r!==void 0)return{chunk:new xe({content:e.coerceContentToString?r:[{index:n.index,...n.content_block}],additional_kwargs:{}})}}else{if(n.type==="content_block_start"&&n.content_block.type==="redacted_thinking")return{chunk:new xe({content:e.coerceContentToString?"":[{index:n.index,...n.content_block}]})};if(n.type==="content_block_start"&&n.content_block.type==="thinking"){const r=n.content_block.thinking;return{chunk:new xe({content:e.coerceContentToString?r:[{index:n.index,...n.content_block}]})}}}}return null}function ix(n,e){const t=e.usage,r=t!=null?{input_tokens:t.input_tokens??0,output_tokens:t.output_tokens??0,total_tokens:(t.input_tokens??0)+(t.output_tokens??0),input_token_details:{cache_creation:t.cache_creation_input_tokens,cache_read:t.cache_read_input_tokens}}:void 0;if(n.length===1&&n[0].type==="text")return[{text:n[0].text,message:new Rr({content:n[0].text,additional_kwargs:e,usage_metadata:r,response_metadata:e,id:e.id})}];{const a=Qf(n);return[{text:"",message:new Rr({content:n,additional_kwargs:e,tool_calls:a,usage_metadata:r,response_metadata:e,id:e.id})}]}}function ys(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function id(n){let e;return n.status===400&&n.message.includes("tool")?e=ys(n,"INVALID_TOOL_RESULTS"):n.status===401?e=ys(n,"MODEL_AUTHENTICATION"):n.status===404?e=ys(n,"MODEL_NOT_FOUND"):n.status===429?e=ys(n,"MODEL_RATE_LIMIT"):e=n,e}function ox(n){return!!(n.tools&&n.tools.length>0)}function ux(n){for(const e of n.messages??[])if(typeof e.content!="string"){for(const t of e.content??[])if(typeof t=="object"&&t!=null&&t.type==="document"&&typeof t.citations=="object"&&t.citations.enabled)return!0}return!1}function cx(n){return!!(n.thinking&&n.thinking.type==="enabled")}function lx(n){return"input_schema"in n}function dx(n){if(typeof n.content=="string")return n.content;if(Array.isArray(n.content)&&n.content.length>=1&&"input"in n.content[0])return typeof n.content[0].input=="string"?n.content[0].input:JSON.stringify(n.content[0].input);if(Array.isArray(n.content)&&n.content.length>=1&&"text"in n.content[0])return n.content[0].text}class hx extends qt{static lc_name(){return"ChatAnthropic"}get lc_secrets(){return{anthropicApiKey:"ANTHROPIC_API_KEY",apiKey:"ANTHROPIC_API_KEY"}}get lc_aliases(){return{modelName:"model"}}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"anthropicApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"invocationKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clientOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thinking",{enumerable:!0,configurable:!0,writable:!0,value:{type:"disabled"}}),Object.defineProperty(this,"batchClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamingClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"createClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.anthropicApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.anthropicApiKey)??ke("ANTHROPIC_API_KEY"),!this.anthropicApiKey&&!(e!=null&&e.createClient))throw new Error("Anthropic API key not found");this.clientOptions=(e==null?void 0:e.clientOptions)??{},this.apiKey=this.anthropicApiKey,this.apiUrl=e==null?void 0:e.anthropicApiUrl,this.modelName=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.model=this.modelName,this.invocationKwargs=(e==null?void 0:e.invocationKwargs)??{},this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topK=(e==null?void 0:e.topK)??this.topK,this.topP=(e==null?void 0:e.topP)??this.topP,this.maxTokens=(e==null?void 0:e.maxTokensToSample)??(e==null?void 0:e.maxTokens)??this.maxTokens,this.stopSequences=(e==null?void 0:e.stopSequences)??this.stopSequences,this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.thinking=(e==null?void 0:e.thinking)??this.thinking,this.createClient=(e==null?void 0:e.createClient)??(t=>new me(t))}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"anthropic",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}formatStructuredToolToAnthropic(e){if(!(!e||!e.length))return e.map(t=>{if(lx(t))return t;if(Yu(t))return{name:t.function.name,description:t.function.description,input_schema:t.function.parameters};if(If(t))return{name:t.name,description:t.description,input_schema:jr(t.schema)};throw new Error(`Unknown tool type passed to ChatAnthropic: ${JSON.stringify(t,null,2)}`)})}bindTools(e,t){return this.bind({tools:this.formatStructuredToolToAnthropic(e),...t})}invocationParams(e){const t=rx(e==null?void 0:e.tool_choice);if(this.thinking.type==="enabled"){if(this.topK!==-1)throw new Error("topK is not supported when thinking is enabled");if(this.topP!==-1)throw new Error("topP is not supported when thinking is enabled");if(this.temperature!==1)throw new Error("temperature is not supported when thinking is enabled");return{model:this.model,stop_sequences:(e==null?void 0:e.stop)??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e==null?void 0:e.tools),tool_choice:t,thinking:this.thinking,...this.invocationKwargs}}return{model:this.model,temperature:this.temperature,top_k:this.topK,top_p:this.topP,stop_sequences:(e==null?void 0:e.stop)??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e==null?void 0:e.tools),tool_choice:t,thinking:this.thinking,...this.invocationKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams()}}identifyingParams(){return{model_name:this.model,...this.invocationParams()}}async*_streamResponseChunks(e,t,r){var c;const a=this.invocationParams(t),s=sd(e),i={...a,...s,stream:!0},o=!ox(i)&&!ux(i)&&!cx(i),u=await this.createStreamWithRetry(i,{headers:t.headers});for await(const l of u){if((c=t.signal)!=null&&c.aborted)throw u.controller.abort(),new Error("AbortError: User aborted the request.");const d=this.streamUsage??t.streamUsage,h=sx(l,{streamUsage:d,coerceContentToString:o});if(!h)continue;const{chunk:m}=h,f=dx(m),p=new fr({message:new xe({content:m.content,additional_kwargs:m.additional_kwargs,tool_call_chunks:m.tool_call_chunks,usage_metadata:d?m.usage_metadata:void 0,response_metadata:m.response_metadata,id:m.id}),text:f??""});yield p,await(r==null?void 0:r.handleLLMNewToken(f??"",void 0,void 0,void 0,void 0,{chunk:p}))}}async _generateNonStreaming(e,t,r){const a=await this.completionWithRetry({...t,stream:!1,...sd(e)},r),{content:s,...i}=a,o=ix(s,i),{role:u,type:c,...l}=i;return{generations:o,llmOutput:l}}async _generate(e,t,r){if(this.stopSequences&&t.stop)throw new Error('"stopSequence" parameter found in input and default params');const a=this.invocationParams(t);if(a.stream){let s;const i=this._streamResponseChunks(e,t,r);for await(const o of i)s===void 0?s=o:s=s.concat(o);if(s===void 0)throw new Error("No chunks returned from Anthropic API.");return{generations:[{text:s.text,message:s.message}]}}else return this._generateNonStreaming(e,a,{signal:t.signal,headers:t.headers})}async createStreamWithRetry(e,t){if(!this.streamingClient){const a=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.streamingClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...a,apiKey:this.apiKey,maxRetries:0})}const r=async()=>{try{return await this.streamingClient.messages.create({...e,...this.invocationKwargs,stream:!0},t)}catch(a){throw id(a)}};return this.caller.call(r)}async completionWithRetry(e,t){if(!this.batchClient){const a=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.batchClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...a,apiKey:this.apiKey,maxRetries:0})}const r=async()=>{try{return await this.batchClient.messages.create({...e,...this.invocationKwargs},t)}catch(a){throw id(a)}};return this.caller.callWithOptions({signal:t.signal??void 0},r)}_llmType(){return"anthropic"}withStructuredOutput(e,t){var f;const r=e,a=t==null?void 0:t.name,s=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw;if(s==="jsonMode")throw new Error('Anthropic only supports "functionCalling" as a method.');let o=a??"extract",u,c;if(Qu(r)){const p=jr(r);c=[{name:o,description:p.description??"A function available to call.",input_schema:p}],u=new rd({returnSingle:!0,keyName:o,zodSchema:r})}else{let p;typeof r.name=="string"&&typeof r.description=="string"&&typeof r.input_schema=="object"&&r.input_schema!=null?(p=r,o=r.name):p={name:o,description:r.description??"",input_schema:r},c=[p],u=new rd({returnSingle:!0,keyName:o})}let l;if(((f=this.thinking)==null?void 0:f.type)==="enabled"){const p="Anthropic structured output relies on forced tool calling, which is not supported when `thinking` is enabled. This method will raise OutputParserException if tool calls are not generated. Consider disabling `thinking` or adjust your prompt to ensure the tool is called.";console.warn(p),l=this.bind({tools:c});const g=b=>{if(!b.tool_calls||b.tool_calls.length===0)throw new Error(p);return b};l=l.pipe(g)}else l=this.bind({tools:c,tool_choice:{type:"tool",name:o}});if(!i)return l.pipe(u).withConfig({runName:"ChatAnthropicStructuredOutput"});const d=_n.assign({parsed:(p,g)=>u.invoke(p.raw,g)}),h=_n.assign({parsed:()=>null}),m=d.withFallbacks({fallbacks:[h]});return Nt.from([{raw:l},m]).withConfig({runName:"StructuredOutputRunnable"})}}class fx extends hx{}let vr=null;const mx=()=>{if(!vr)throw new Error("API not configured");switch(vr.provider){case"azure":const n=vr;return console.log("Azure config",n),new b0({azureOpenAIApiKey:n.apiKey,azureOpenAIApiInstanceName:n.azureInstanceName,azureOpenAIEndpoint:n.azureEndpoint,azureOpenAIApiDeploymentName:n.azureDeployment,azureOpenAIApiVersion:n.azureApiVersion,modelName:n.model});case"deepseek":const e=vr;return new w0({apiKey:e.apiKey,modelName:e.model});case"anthropic":const t=vr;return new fx({anthropicApiKey:t.apiKey,modelName:t.model});case"openai":default:const r=vr;return new nc({openAIApiKey:r.apiKey,modelName:r.model})}},ei=n=>{vr=n},px=async(n,e,t)=>{var i,o;const r=mx(),a=(i=Ts.find(u=>u.code===e))==null?void 0:i.name,s=(o=Ts.find(u=>u.code===t))==null?void 0:o.name;try{const u=await r.invoke([{role:"system",content:`You are a language bot that generate words to train users vocabulary.
        You must return in format ${a} - ${s}, one word per line.
        Example:
        hello - hola
        world - mundo
        good - bueno
        bye - adiós
        please - por favor
        `},{role:"user",content:n}]);return{targetText:u.content}}catch(u){throw console.error("Translation failed:",u),new Error(`Translation failed: ${u instanceof Error?u.message:"Unknown error"}`)}};function gx(){const[n,e]=K.useState(""),[t,r]=K.useState("en"),[a,s]=K.useState("ja"),[i,o]=K.useState([]),[u,c]=K.useState([]),[l,d]=K.useState(void 0),[h,m]=K.useState(void 0),[f,p]=K.useState([]),[g,b]=K.useState([]),[w,_]=K.useState(!1),[v,S]=K.useState(!1),[P,O]=K.useState(-1),[H,re]=K.useState(1),[oe,V]=K.useState(""),[Fe,Pt]=K.useState(!1),I=K.useRef(!1);K.useEffect(()=>{(async()=>{try{const B=await vm();b(B)}catch(B){console.error("Error loading TTS pairs:",B)}})(),(async()=>{try{const B=await mc();k(B,t,a)}catch(B){V("Failed to load voices. Please try again."),console.error("Error loading voices:",B)}})()},[]),K.useEffect(()=>{(async()=>{try{const C=await mc();k(C,t,a)}catch(C){V("Failed to update voices. Please try again."),console.error("Error updating voices:",C)}})()},[t,a]);const k=(E,C,B)=>{const q=E.filter(be=>be.lang.includes(C)),_e=E.filter(be=>be.lang.includes(B));o(q),c(_e),q.length>0&&!l&&d(q[0]),_e.length>0&&!h&&m(_e[0])},D=async()=>{if(!n.trim()){V("Please enter some text to generate language pairs.");return}V(""),_(!0);try{const C=(await px(n.trim(),t,a)).targetText.split(`
`).filter(q=>q.trim()!==""),B=[...f];for(const q of C){const _e=q.split("-").map(be=>be.trim());if(_e.length>=2){const be=_e[0],Jt=_e.slice(1).join(" - ").trim(),_r={id:Date.now().toString()+Math.random().toString(36).substring(2,9),sourceText:be,targetText:Jt,sourceLang:t,targetLang:a,timestamp:new Date().toISOString()};B.push(_r)}}p(B),await _m(B),e("")}catch(E){V(`Failed to generate language pairs: ${E instanceof Error?E.message:"Unknown error"}`),console.error("Error generating pairs:",E)}finally{_(!1)}},N=async(E,C)=>{try{const B={id:Date.now().toString()+Math.random().toString(36).substring(2,9),text:E,voice:{name:C.name,lang:C.lang},rate:H,timestamp:new Date().toISOString()};await wm(B),b([...g,B])}catch(B){console.error("Error saving TTS pair:",B),V("Failed to save TTS pair")}},U=async E=>{if(E<0||E>=f.length)return;let C=!0;O(E),S(!0);const B=async(q,_e,be=2)=>{for(let Jt=0;Jt<=be;Jt++)try{if(!_e)throw new Error("No voice selected");await bs(q,_e,H);return}catch(_r){if(Jt===be)throw _r;await new Promise(Tn=>setTimeout(Tn,500))}};try{await B(f[E].sourceText,l),l&&await N(f[E].sourceText,l),await new Promise(q=>setTimeout(q,1e3)),C&&(await B(f[E].targetText,h),h&&await N(f[E].targetText,h))}catch(q){console.error("Detailed speaking error:",q),V(`Failed to speak text: ${q instanceof Error?q.message:"Unknown error"}`)}finally{S(!1),O(-1)}},j=()=>{ws(),S(!1),O(-1)},Z=async(E,C,B=2)=>{for(let q=0;q<=B;q++)try{if(!C)throw new Error("No voice selected");await bs(E,C,H);return}catch(_e){if(q===B)throw _e;await new Promise(be=>setTimeout(be,500))}},ie=async()=>{if(!l||!h){V("Please select both source and target voices");return}I.current=!0,S(!0);try{for(let E=0;E<f.length&&!(!I.current||(O(E),await Z(f[E].sourceText,l),!I.current));E++)await new Promise(C=>setTimeout(C,1e3)),await Z(f[E].targetText,h),E<f.length-1&&await new Promise(C=>setTimeout(C,2e3))}catch(E){V(`Failed to speak: ${E instanceof Error?E.message:"Unknown error"}`)}finally{I.current=!1,S(!1),O(-1)}};return y.jsxs("div",{className:"card p-6",children:[y.jsxs("div",{className:"flex justify-between items-center mb-4",children:[y.jsx("h2",{className:"text-xl font-semibold",children:"Text-to-Speech Generator"}),y.jsx("button",{className:"btn btn-primary",onClick:()=>Pt(!Fe),children:Fe?"Hide TTS Menu":"Show TTS Menu"})]}),Fe?y.jsxs("div",{className:"mb-6",children:[y.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Saved TTS Pairs"}),y.jsx("div",{className:"space-y-4",children:g.map(E=>y.jsxs("div",{className:"flex items-center justify-between p-3 border rounded",children:[y.jsxs("div",{children:[y.jsx("p",{className:"font-medium",children:E.text}),y.jsxs("p",{className:"text-sm text-gray-600",children:["Voice: ",E.voice.name," (",E.voice.lang,") - Rate: ",E.rate]})]}),y.jsxs("div",{className:"flex space-x-2",children:[y.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>{const C=i.find(B=>B.name===E.voice.name)||u.find(B=>B.name===E.voice.name);C&&bs(E.text,C,E.rate)},children:"Play"}),y.jsx("button",{className:"btn btn-sm btn-error",onClick:async()=>{await xm(E.id),b(g.filter(C=>C.id!==E.id))},children:"Delete"})]})]},E.id))})]}):null,oe&&y.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4",role:"alert",children:y.jsx("p",{children:oe})}),y.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[y.jsxs("div",{children:[y.jsx("label",{htmlFor:"sourceLang",className:"block text-sm font-medium text-gray-700 mb-1",children:"Source Language"}),y.jsx("select",{id:"sourceLang",className:"select w-full",value:t,onChange:E=>r(E.target.value),disabled:v,children:Ts.map(E=>y.jsx("option",{value:E.code,children:E.name},E.code))})]}),y.jsxs("div",{children:[y.jsx("label",{htmlFor:"targetLang",className:"block text-sm font-medium text-gray-700 mb-1",children:"Target Language"}),y.jsx("select",{id:"targetLang",className:"select w-full",value:a,onChange:E=>s(E.target.value),disabled:v,children:Ts.map(E=>y.jsx("option",{value:E.code,children:E.name},E.code))})]})]}),y.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[y.jsxs("div",{children:[y.jsx("label",{htmlFor:"sourceVoice",className:"block text-sm font-medium text-gray-700 mb-1",children:"Source Voice"}),y.jsx("select",{id:"sourceVoice",className:"select w-full",value:l?l.name:"",onChange:E=>{const C=i.find(B=>B.name===E.target.value);d(C)},disabled:v||i.length===0,children:i.length===0?y.jsx("option",{value:"",children:"No voices available"}):i.map(E=>y.jsxs("option",{value:E.name,children:[E.name," (",E.lang,")"]},E.name))})]}),y.jsxs("div",{children:[y.jsx("label",{htmlFor:"targetVoice",className:"block text-sm font-medium text-gray-700 mb-1",children:"Target Voice"}),y.jsx("select",{id:"targetVoice",className:"select w-full",value:h?h.name:"",onChange:E=>{const C=u.find(B=>B.name===E.target.value);m(C)},disabled:v||u.length===0,children:u.length===0?y.jsx("option",{value:"",children:"No voices available"}):u.map(E=>y.jsxs("option",{value:E.name,children:[E.name," (",E.lang,")"]},E.name))})]})]}),y.jsxs("div",{className:"mb-4",children:[y.jsxs("label",{htmlFor:"rate",className:"block text-sm font-medium text-gray-700 mb-1",children:["Speech Rate: ",H.toFixed(1)]}),y.jsx("input",{id:"rate",type:"range",min:"0.5",max:"2",step:"0.1",value:H,onChange:E=>re(parseFloat(E.target.value)),className:"w-full",disabled:v})]}),y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"text",className:"block text-sm font-medium text-gray-700 mb-1",children:"Text"}),y.jsx("textarea",{id:"text",className:"input w-full h-24",value:n,onChange:E=>e(E.target.value),placeholder:"Enter text to generate language pairs...",disabled:v||w})]}),y.jsx("div",{className:"flex justify-end mb-6",children:y.jsx("button",{className:"btn btn-primary",onClick:D,disabled:v||w||!n.trim(),children:w?"Generating...":"Generate Pair"})}),y.jsxs("div",{children:[y.jsxs("h3",{className:"text-lg font-medium mb-2",children:["Generated Pairs (",f.length,")"]}),f.length===0?y.jsx("p",{className:"text-gray-500 italic",children:"No pairs generated yet. Enter text above to get started."}):y.jsxs(y.Fragment,{children:[y.jsx("div",{className:"flex justify-end mb-3",children:y.jsx("button",{className:"btn btn-secondary",onClick:ie,disabled:v||f.length===0,children:v?"Stop Speaking":"Speak All Pairs"})}),y.jsx("div",{className:"space-y-3",children:f.map((E,C)=>y.jsx("div",{className:`p-3 border rounded-md ${P===C?"border-primary-500 bg-primary-50":"border-gray-200"}`,children:y.jsxs("div",{className:"flex justify-between items-start mb-2",children:[y.jsxs("div",{children:[y.jsx("p",{className:"font-medium",children:E.sourceText}),y.jsx("p",{className:"text-gray-600",children:E.targetText})]}),y.jsx("div",{className:"flex space-x-2",children:y.jsx("button",{className:`p-2 rounded-full ${v&&P===C?"bg-red-100 text-red-600":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,onClick:()=>v&&P===C?j():U(C),title:v&&P===C?"Stop Speaking":"Speak",children:v&&P===C?y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}):y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10c0-1.105-.448-2.105-1.172-2.828a1 1 0 010-1.415z",clipRule:"evenodd"})})})})]})},E.id))})]})]})]})}function _x(){const[n,e]=K.useState([]),[t,r]=K.useState(0),[a,s]=K.useState(!1),[i,o]=K.useState(!1),[u,c]=K.useState(!0),[l,d]=K.useState(""),[h,m]=K.useState("");K.useEffect(()=>{(async()=>{try{c(!0);const P=await ym();e(P)}catch(P){d("Failed to load flashcards. Please try again."),console.error("Error loading flashcards:",P)}finally{c(!1)}})()},[]);const f=h?n.filter(S=>S.sourceLang===h||S.targetLang===h):n,p=f[t]||null,g=()=>{s(!a)},b=()=>{ws(),o(!1),s(!1),r(S=>S>=f.length-1?0:S+1)},w=()=>{ws(),o(!1),s(!1),r(S=>S<=0?f.length-1:S-1)},_=async()=>{if(p){o(!0);try{const S=a?p.targetText:p.sourceText;await bs(S)}catch(S){console.error("Error speaking text:",S)}finally{o(!1)}}},v=async()=>{if(p)try{await bm(p.id),e(S=>S.filter(P=>P.id!==p.id)),t>=f.length-1&&r(Math.max(0,f.length-2))}catch(S){d("Failed to delete flashcard. Please try again."),console.error("Error deleting flashcard:",S)}};return y.jsxs("div",{className:"card p-6",children:[y.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Flashcards"}),l&&y.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4",role:"alert",children:y.jsx("p",{children:l})}),y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"filterLang",className:"block text-sm font-medium text-gray-700 mb-1",children:"Filter by Language"}),y.jsxs("select",{id:"filterLang",className:"select w-full",value:h,onChange:S=>{m(S.target.value),r(0),s(!1)},children:[y.jsx("option",{value:"",children:"All Languages"}),y.jsx("option",{value:"en-US",children:"English (US)"}),y.jsx("option",{value:"es-ES",children:"Spanish (Spain)"}),y.jsx("option",{value:"fr-FR",children:"French (France)"}),y.jsx("option",{value:"de-DE",children:"German (Germany)"}),y.jsx("option",{value:"it-IT",children:"Italian (Italy)"}),y.jsx("option",{value:"ja-JP",children:"Japanese (Japan)"}),y.jsx("option",{value:"ko-KR",children:"Korean (Korea)"}),y.jsx("option",{value:"zh-CN",children:"Chinese (China)"})]})]}),u?y.jsx("div",{className:"flex justify-center items-center py-12",children:y.jsxs("svg",{className:"animate-spin h-8 w-8 text-primary-600",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[y.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),y.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):f.length===0?y.jsxs("div",{className:"text-center py-8",children:[y.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","aria-hidden":"true",children:y.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"})}),y.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No flashcards"}),y.jsx("p",{className:"mt-1 text-sm text-gray-500",children:h?"No flashcards match your filter.":"Generate some language pairs in the Text-to-Speech tab to get started."})]}):y.jsxs("div",{children:[y.jsxs("div",{className:`relative h-64 w-full cursor-pointer transition-transform duration-500 ${a?"rotate-y-180":""}`,onClick:g,children:[y.jsxs("div",{className:`absolute inset-0 flex flex-col items-center justify-center p-6 border-2 rounded-lg ${a?"hidden":"block"} ${i?"border-primary-500":"border-gray-200"}`,children:[y.jsx("p",{className:"text-sm text-gray-500 mb-2",children:p==null?void 0:p.sourceLang}),y.jsx("p",{className:"text-xl text-center",children:p==null?void 0:p.sourceText}),y.jsx("p",{className:"text-sm text-gray-500 mt-4",children:"Tap to flip"})]}),y.jsxs("div",{className:`absolute inset-0 flex flex-col items-center justify-center p-6 border-2 rounded-lg ${a?"block":"hidden"} ${i?"border-primary-500":"border-gray-200"}`,children:[y.jsx("p",{className:"text-sm text-gray-500 mb-2",children:p==null?void 0:p.targetLang}),y.jsx("p",{className:"text-xl text-center",children:p==null?void 0:p.targetText}),y.jsx("p",{className:"text-sm text-gray-500 mt-4",children:"Tap to flip"})]})]}),y.jsxs("div",{className:"flex justify-between items-center mt-6",children:[y.jsxs("div",{className:"flex space-x-2",children:[y.jsx("button",{className:"p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:w,title:"Previous Card",children:y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z",clipRule:"evenodd"})})}),y.jsx("button",{className:"p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:b,title:"Next Card",children:y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z",clipRule:"evenodd"})})})]}),y.jsx("p",{className:"text-sm text-gray-500",children:f.length>0?`${t+1} / ${f.length}`:"0 / 0"}),y.jsxs("div",{className:"flex space-x-2",children:[y.jsx("button",{className:`p-2 rounded-full ${i?"bg-red-100 text-red-600":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,onClick:i?ws:_,title:i?"Stop Speaking":"Speak",disabled:!p,children:i?y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}):y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z",clipRule:"evenodd"})})}),y.jsx("button",{className:"p-2 rounded-full bg-gray-100 text-red-600 hover:bg-red-100",onClick:v,title:"Delete Card",disabled:!p,children:y.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:y.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})]})]})]})}const yx=["claude-3-haiku-20240307"],bx=["deepseek-chat","deepseek-reasoning"],Po=["gpt-4","gpt4o-copilot"],wx=n=>{switch(n){case"openai":return Po[0];case"azure":return Po[1];case"deepseek":return bx[0];case"anthropic":return yx[0];default:return Po[0]}};function vx(){const[n,e]=K.useState(""),[t,r]=K.useState(""),[a,s]=K.useState("2023-05-15"),[i,o]=K.useState(""),[u,c]=K.useState("openai"),[l,d]=K.useState(!1),[h,m]=K.useState(!1),[f,p]=K.useState("");K.useEffect(()=>{(async()=>{try{const w=await gt("api_provider"),_=await gt("azure_instance_name"),v=await gt("azure_api_version"),S=await gt("azure_api_base");w&&c(w),_&&r(_),v&&s(v),S&&o(S);const O=`${w||"openai"}_api_key`,H=await gt(O);H&&e(H)}catch(w){p("Failed to load settings. Please try again."),console.error("Error loading settings:",w)}})()},[]),K.useEffect(()=>{(async()=>{try{const w=`${u}_api_key`,_=await gt(w);e(_||"")}catch(w){console.error("Error loading API key for provider:",w)}})()},[u]);const g=async b=>{b.preventDefault(),d(!0),m(!1),p("");try{const w=`${u}_api_key`;await In(w,n),await In("azure_instance_name",t),await In("azure_api_version",a),await In("azure_api_base",i),await In("api_provider",u);try{const _=wx(u),v={provider:u,apiKey:n,model:_};ei(u==="azure"?{...v,provider:"azure",azureInstanceName:t,azureEndpoint:i,azureDeployment:"gpt4o-copilot",azureApiVersion:a}:v)}catch(_){console.error("Error configuring API:",_)}m(!0),setTimeout(()=>{m(!1)},3e3)}catch(w){p("Failed to save settings. Please try again."),console.error("Error saving settings:",w)}finally{d(!1)}};return y.jsxs("div",{className:"card p-6",children:[y.jsx("h2",{className:"text-xl font-semibold mb-4",children:"API Settings"}),f&&y.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4",role:"alert",children:y.jsx("p",{children:f})}),h&&y.jsx("div",{className:"bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4",role:"alert",children:y.jsx("p",{children:"Settings saved successfully!"})}),y.jsxs("form",{onSubmit:g,children:[y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"apiProvider",className:"block text-sm font-medium text-gray-700 mb-1",children:"API Provider"}),y.jsxs("select",{id:"apiProvider",className:"input w-full",value:u,onChange:b=>c(b.target.value),children:[y.jsx("option",{value:"openai",children:"OpenAI"}),y.jsx("option",{value:"azure",children:"Azure OpenAI"}),y.jsx("option",{value:"deepseek",children:"Deepseek"}),y.jsx("option",{value:"anthropic",children:"Anthropic"})]})]}),y.jsxs("div",{className:"mb-4",children:[y.jsxs("label",{htmlFor:"apiKey",className:"block text-sm font-medium text-gray-700 mb-1",children:[u.charAt(0).toUpperCase()+u.slice(1)," API Key"]}),y.jsx("input",{type:"password",id:"apiKey",className:"input w-full",value:n,onChange:b=>e(b.target.value),placeholder:`Enter your ${u.charAt(0).toUpperCase()+u.slice(1)} API key`}),y.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Your API key will be stored securely in your browser."})]}),u==="azure"&&y.jsxs(y.Fragment,{children:[y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"azureApiBase",className:"block text-sm font-medium text-gray-700 mb-1",children:"Azure API Base URL"}),y.jsx("input",{type:"text",id:"azureApiBase",className:"input w-full",value:i,onChange:b=>o(b.target.value),placeholder:"e.g., https://your-resource.openai.azure.com"})]}),y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"azureInstanceName",className:"block text-sm font-medium text-gray-700 mb-1",children:"Azure Instance Name"}),y.jsx("input",{type:"text",id:"azureInstanceName",className:"input w-full",value:t,onChange:b=>r(b.target.value),placeholder:"e.g., your-resource"})]}),y.jsxs("div",{className:"mb-4",children:[y.jsx("label",{htmlFor:"azureApiVersion",className:"block text-sm font-medium text-gray-700 mb-1",children:"Azure API Version"}),y.jsx("input",{type:"text",id:"azureApiVersion",className:"input w-full",value:a,onChange:b=>s(b.target.value),placeholder:"e.g., 2023-05-15"})]})]}),y.jsx("button",{type:"submit",className:"btn btn-primary w-full",children:l?"Saving...":"Save Settings"})]})]})}function xx(){const[n,e]=K.useState("tts"),[t,r]=K.useState(!0);return K.useEffect(()=>{const a="speechSynthesis"in window;r(a),a&&Em(),(async()=>{try{const i=await gt("api_provider");if(!i)return;const o=`${i}_api_key`,u=await gt(o);if(!u)return;const l={provider:i,apiKey:u,model:i==="openai"?"gpt-4":i==="azure"?"gpt4o-copilot":i==="deepseek"?"deepseek-chat":i==="anthropic"?"claude-3-haiku-20240307":"gpt-4"};ei(i==="azure"?{...l,provider:"azure",azureEndpoint:await gt("azure_api_base"),azureInstanceName:await gt("azure_instance_name"),azureDeployment:"gpt4o-copilot",azureApiVersion:await gt("azure_api_version")}:l),console.log("API configured successfully on startup"),console.log("API configuration:",l)}catch(i){console.error("Error loading API configuration on startup:",i)}})()},[]),y.jsxs("div",{className:"min-h-screen flex flex-col",children:[y.jsx(fm,{}),y.jsxs("main",{className:"flex-grow container mx-auto px-4 py-6",children:[!t&&y.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6",role:"alert",children:y.jsx("p",{children:"Your browser doesn't support Text-to-Speech functionality. Please try a different browser."})}),y.jsx("div",{className:"flex justify-center mb-6",children:y.jsxs("div",{className:"inline-flex rounded-md shadow-sm",role:"group",children:[y.jsx("button",{type:"button",className:`px-4 py-2 text-sm font-medium ${n==="tts"?"bg-primary-600 text-white":"bg-white text-gray-700 hover:bg-gray-50"} ${n==="tts"?"":"border-r border-gray-200"} rounded-l-lg`,onClick:()=>e("tts"),children:"Text-to-Speech"}),y.jsx("button",{type:"button",className:`px-4 py-2 text-sm font-medium ${n==="flashcards"?"bg-primary-600 text-white":"bg-white text-gray-700 hover:bg-gray-50"} ${n==="flashcards"?"":"border-r border-gray-200"}`,onClick:()=>e("flashcards"),children:"Flashcards"}),y.jsx("button",{type:"button",className:`px-4 py-2 text-sm font-medium rounded-r-lg ${n==="settings"?"bg-primary-600 text-white":"bg-white text-gray-700 hover:bg-gray-50"}`,onClick:()=>e("settings"),children:"Settings"})]})}),n==="tts"?y.jsx(gx,{}):n==="flashcards"?y.jsx(_x,{}):y.jsx(vx,{})]}),y.jsx(mm,{})]})}const em=document.getElementById("root");if(!em)throw new Error("Failed to find the root element");Oo.createRoot(em).render(y.jsx(sm.StrictMode,{children:y.jsx(xx,{})}));
